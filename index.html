<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Positioning Blueprint Series</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="public/src/session/schema.js"></script>
    <script src="public/src/session/session-manager.js"></script>
    <script src="public/src/session/file-io.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700&family=Work+Sans:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f6f6f6;
        }
        
        .scale-green-bg {
            background-color: #10b981;
        }
        
        .scale-green-text {
            color: #10b981;
        }
        
        .scale-gold-text {
            color: #d97706;
        }
    </style>
</head>
<body class="text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        // Cache-bust timestamp: 2025-01-19T23:45:00Z - Force browser refresh
        // Get all React hooks we need
        const { useState, useEffect, useRef } = React;
        const APP_VERSION = '1.0.0';
        const SessionManager = window.SessionManager;
        // Note: Access SessionFileIO directly from window.SessionFileIO instead of using const

        // Enhanced logging that sends to server
        const serverLog = async (level, message, error = null) => {
            // Temporarily disabled to prevent infinite loops
            return;
        };

        // Console overrides temporarily disabled to prevent infinite loops
        // const originalConsoleError = console.error;
        // const originalConsoleLog = console.log;
        // const originalConsoleWarn = console.warn;

        // Error listeners temporarily disabled to prevent infinite loops
        // window.addEventListener('error', (event) => {
        //     serverLog('error', `Unhandled error: ${event.message}`, event.error);
        // });

        // window.addEventListener('unhandledrejection', (event) => {
        //     serverLog('error', `Unhandled promise rejection: ${event.reason}`);
        // });


        // localStorage helper functions
        const saveAppState = (state) => {
          try {
            const stateWithTimestamp = {
              ...state,
              lastSaved: new Date().toISOString()
            };
            localStorage.setItem('categoryBlueprintState', JSON.stringify(stateWithTimestamp));
          } catch (error) {
            console.error('Could not save state to localStorage', error);
          }
        };

        const SessionNotice = ({ notice, onDismiss }) => {
          useEffect(() => {
            if (!notice) return;
            const timer = setTimeout(() => {
              onDismiss();
            }, 5000);
            return () => clearTimeout(timer);
          }, [notice, onDismiss]);

          if (!notice) return null;

          const baseClass = notice.type === 'error'
            ? 'bg-red-100 border border-red-400 text-red-800'
            : 'bg-green-100 border border-green-400 text-green-800';

          return (
            <div className={`fixed top-20 right-4 max-w-sm px-4 py-3 rounded shadow-md ${baseClass}`}>
              <div className="flex items-start justify-between gap-4">
                <span className="text-sm font-medium leading-5">{notice.message}</span>
                <button
                  type="button"
                  className="text-lg leading-none"
                  aria-label="Dismiss notification"
                  onClick={onDismiss}
                >
                  &times;
                </button>
              </div>
            </div>
          );
        };

        const SessionMenu = ({ onImport, onExport, disabled }) => {
          const [open, setOpen] = useState(false);
          const menuRef = useRef(null);


          useEffect(() => {
            if (!open) return;
            const handleClickOutside = (event) => {
              if (menuRef.current && !menuRef.current.contains(event.target)) {
                setOpen(false);
              }
            };
            document.addEventListener('mousedown', handleClickOutside);
            return () => document.removeEventListener('mousedown', handleClickOutside);
          }, [open]);

          const handleToggle = () => {
            if (disabled) return;
            setOpen(prev => !prev);
          };

          const handleImport = () => {
            setOpen(false);
            onImport?.();
          };

          const handleExport = () => {
            setOpen(false);
            onExport?.();
          };

          return (
            <div className="relative inline-block text-left" ref={menuRef}>
              <button
                type="button"
                onClick={handleToggle}
                disabled={disabled}
                className={`inline-flex items-center gap-2 rounded-md border border-gray-300 bg-white px-3 py-2 text-sm font-medium shadow-sm transition ${disabled ? 'cursor-not-allowed opacity-60' : 'hover:bg-gray-100'}`}
              >
                Session
                <svg className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path fillRule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 011.08 1.04l-4.25 4.25a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z" clipRule="evenodd" />
                </svg>
              </button>
              {open && (
                <div
                  className="absolute right-0 z-[70] mt-2 w-56 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none"
                >
                  <div className="py-1">
                    <button
                      type="button"
                      className="block w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100"
                      onClick={handleImport}
                    >
                      Import Blueprint from File...
                    </button>
                    <button
                      type="button"
                      className="block w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100"
                      onClick={handleExport}
                    >
                      Export Blueprint to File...
                    </button>
                  </div>
                </div>
              )}
            </div>
          );
        };

        const SessionImportModal = ({ isOpen, fileName, onCancel, onConfirm, isProcessing }) => {
          if (!isOpen) return null;

          return (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40">
              <div className="w-full max-w-md rounded-lg bg-white p-6 shadow-xl">
                <h2 className="text-lg font-semibold text-gray-900">Overwrite Current Blueprint?</h2>
                <p className="mt-3 text-sm text-gray-700">Importing this file will overwrite all current progress in your session. This action cannot be undone directly, though a temporary backup will be made.</p>
                {fileName && (
                  <p className="mt-3 text-xs text-gray-500">Selected file: <span className="font-medium">{fileName}</span></p>
                )}
                <div className="mt-6 flex justify-end gap-3">
                  <button
                    type="button"
                    onClick={onCancel}
                    className="rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
                  >
                    Cancel
                  </button>
                  <button
                    type="button"
                    onClick={onConfirm}
                    disabled={isProcessing}
                    className={`rounded-md px-4 py-2 text-sm font-medium text-white transition ${isProcessing ? 'bg-red-400 cursor-not-allowed' : 'bg-red-600 hover:bg-red-700'}`}
                  >
                    {isProcessing ? 'Importing...' : 'Confirm & Import'}
                  </button>
                </div>
              </div>
            </div>
          );
        };

        // Deep Research Prompt Generation Engine
        const generateDeepResearchPrompt = (companyData) => {
          try {
            // Ensure we have safe defaults for all required fields
            const safeData = {
              companyName: companyData?.companyName?.trim() || 'Your Company',
              companyWebsite: companyData?.companyWebsite?.trim() || 'your-website.com',
              productName: companyData?.productName?.trim() || 'Your Product',
              targetMarket: companyData?.targetMarket || 'B2B',
              competitorNames: companyData?.competitorNames || ['', '', '']
            };

            // Format competitors list
            const competitors = safeData.competitorNames
              .filter(comp => comp && comp.trim())
              .join(', ') || 'Competitor 1, Competitor 2, Competitor 3';

            // Updated template from docs/specifications/prompt-deep-research.md
            const promptTemplate = `# PROMPT: Positioning and Category Deep Research Brief

## PRIMARY DIRECTIVE: TEMPLATE PROCESSOR PROTOCOL
Your sole, exclusive, and non-negotiable function is to act as a TEMPLATE PROCESSOR. You will be given a detailed blueprint below. Your only task is to populate every single field in that blueprint with information gathered from outside-in research. You are forbidden from altering the structure, headings, or formatting of the blueprint in any way. Any deviation is a critical failure.

## SYSTEM ROLE
You are a **Senior Go-to-Market Analyst & Intelligence Architect**.
Your research (methodical, evidence-driven) and analysis is guided by a composite of four expert mindsets:

* **The Customer Theorist (Bob Moesta):** You will ground all analysis in the "Job to be Done." Your primary focus for Part 1 (Segment Foundation) is to uncover the deep, underlying "struggle" that causes a customer to act and the "progress" they are trying to make.
* **The Positioner (April Dunford):** You will be relentlessly focused on the customer's point of view. For Part 3 (Positioning), your task is to cut through marketing fluff to find the "obvious" insight that makes a product uniquely valuable to a specific market by clearly defining its context.
* **The Strategist (Michael Porter):** You will analyze the competitive landscape (Part 3A) with academic rigor, focusing on industry structure, competitive forces, and the creation of sustainable, unique advantages.
* **The Monetizer (Madhavan Ramanujam):** You will operate on the principle that GTM strategy begins with price and value. As you analyze the product's attributes (Part 3C), you will constantly connect them to the customer's **willingness to pay** (Part 1C) and the metrics they use to **measure value**.

Your *output format* is strictly governed by the TEMPLATE PROCESSOR PROTOCOL.
Your voice must remain that of an objective, third-party analyst.

## PROMPT TITLE
Positioning and Category Deep Research Brief for {{Company Name}}

## OBJECTIVE
To conduct comprehensive, outside-in research into **{{Company Name}}** and its product **{{Product Name}}**. The structure of your output MUST be a perfect 1-to-1 mirror of the application framework outlined below.

### Critical Output Constraints (Anti-Patterns)
- **ANTI-PATTERN 1 (No Narrative):** Do NOT write in a narrative, marketing, or whitepaper style. The output must be a clinical, evidence-based intelligence brief.
- **ANTI-PATTERN 2 (No Summaries):** Do NOT write an "Executive Summary," "Introduction," or "Conclusion." Your response must begin *immediately* with \`### Part 1\`.
- **ANTI-PATTERN 3 (No Invented Sections):** Do NOT generate sections that are not in the blueprint, such as "SWOT Analysis" or "Strategic Recommendations." Your output must ONLY contain the headings and sub-headings specified below.

### Critical Scoping Constraint
- **FOCUS ON ARCHITECT ONLY:** Your research and analysis must be exclusively focused on the **{{Product Name}}** product. The target company, {{Company Name}}, may have other products that you are to actively ignore and exclude any information, features, use cases, or value propositions that relate to products other than {{Product Name}}. Your entire report must reflect the perspective of a buyer for **{{Product Name}}**.


### Research Parameters
- **Target Company:** {{Company Name}}
- **Company Website:** {{Company Website}}
- **Product Name:** {{Product Name}}
- **User-Provided Competitors (Starting Point):** {{List of Competitors}}

---

## METHODOLOGY: Phased Research Protocol
**(You MUST follow this process)**

Before generating the final report, you will execute the following research plan:

1.  **Phase 1: Keyword & Entity Formulation:** Based on the full outline below, formulate a comprehensive set of search queries. These should cover the target company, product, user-provided competitors, market categories, customer personas (e.g.,  "pain points with [Product] alternatives"), and related JTBD concepts.
2.  **Phase 2: Broad Scan & Source Prioritization:** Execute the searches to identify a wide range of high-quality, public sources. Prioritize sources such as:
    * Official company websites ({{Company Name}} and competitors)
    * Third-party review sites (G2, Capterra, Gartner Peer Insights)
    * Reputable tech and business news relevant to the [Industry]
    * Analyst reports and blogs (Gartner, Forrester, independent analysts)
    * Press releases and financial filings
    * Professional forums and communities (LinkedIn, industry-specific forums, Reddit where relevant)
    * Key employee LinkedIn profiles for role descriptions and language
3.  **Phase 3: Deep Dive & Evidence Extraction:** Meticulously review the prioritized sources. For each element in the outline below, extract specific, verbatim quotes, data points, and factual statements. Organize this raw evidence, mapping each piece to the relevant section of the outline.
4. **Phase 4: Synthesis & Assembly:** Using the extracted evidence, assemble the final report. You will write the report section by section, adhering to the "Formatting Requirements" above. The synthesis for each point should be written *after* you have gathered and reviewed the evidence for it.
5. **Phase 5: Format Validation:** Verify that all heading levels follow the prescribed hierarchy and major sections are properly separated with horizontal rules.

---

## FORMATTING REQUIREMENTS

### Markdown Hierarchy Rules:
- Use ## for major parts (Parts 1-4)
- Use ### for main sections (1A, 1B, 1C, 2A, 2B, etc.)
- Use #### for subsection elements (Context, Struggling Moments, etc.)
- Use ##### for numbered items (buyer personas, unique attributes)
- Add horizontal rules (---) between major parts only
- Maintain 2 line breaks before major parts, 1 line break elsewhere

---

## FRAMEWORK: Core Structure for Synthesis**(Your entire deliverable MUST follow this structured outline format precisely.)**

### Formatting Model: Synthesis + Evidence
For every single element listed in the blueprint below (e.g., "Context," "Functional Value," "Firmographics," etc.), you MUST apply the following **"Synthesis + Evidence"** model precisely. This is the master format for the entire report.

==== FORMATTING EXAMPLE BEGINS ====


## Part 1: The Segment Foundation (The Market's "Why")
### 1A. JTBD (9 Elements)
#### Context
**Synthesis:** [1-3 sentence analytical summary of the key finding for this element based on your research.]
**Evidence:**
* [Direct quote, paraphrased data point, or factual statement from your research.] [Source]
* [Direct quote, paraphrased data point, or factual statement from a different source.] [Source]

#### Struggling Moments
**Synthesis:** [1-3 sentence analytical summary]
**Evidence:**
* [Quote/data point] [Source]
* [Quote/data point] [Source]

---


## Part 2: The Customer & Their Problem
### **2A. Operational ICP**
#### Firmographics
* Common industries, company sizes, and revenue stages.
#### Technographics
* The technology stack or specific tools used by ideal customers.

==== FORMATTING EXAMPLE ENDS ====

**IMPORTANT:** The content above between the "====" markers is ONLY a formatting example. Your actual report begins below with the framework outline and must follow this exact format structure.

### Part 1: The Segment Foundation (The Market's "Why")
*(You must apply the "Synthesis + Evidence" model to all elements below)*

#### 1A. JTBD (9 Elements)
- **Context:** The business situation or operating environment.
- **Struggling Moments:** The breakdowns, inefficiencies, or risks that trigger the search.
- **Pushes & Pulls:** Internal and external forces moving them toward or away from change.
- **Anxieties & Habits:** Concerns about adopting something new and inertia with current processes.
- **Desired Outcomes:** The business goals and success metrics they want to achieve.
- **Basic Quality (Table Stakes):** Minimum standards a solution must meet to be considered.
- **Hiring Criteria:** Differentiators that make them select one vendor over another.
- **Firing Criteria:** Triggers that get a vendor rejected or replaced.
- **Key Trade-offs:** Acceptable compromises customers are willing to make.

#### 1B. Customer Value (5 Elements)
- **Table Stakes:** Non-negotiables for credibility (compliance, security, integrations).
- **Functional Value:** Tangible, measurable business outcomes (ROI, efficiency gains, cost savings).
- **Ease of Doing Business:** Simplicity of adoption, implementation, and use.
- **Individual Value:** Personal wins for stakeholders (status, workload relief, career wins).
- **Aspirational Value:** Alignment with the customer's vision or higher-order goals.

#### 1C. Willingness to Pay (5 Elements)
- **Ability to Pay:** Evidence of budget and capacity to spend.
- **Economic Justification:** The ROI and payback case that makes financial sense.
- **Relative Value vs. Alternatives:** How the solution's value compares to competitors or the status quo.
- **Risk & Switching Costs:** The perceived risk or friction in making a change.
- **Market Reference Points:** The pricing anchors customers use from competitors or prior spend.

### Part 2: The Customer & Their Problem
*(You must apply the "Synthesis + Evidence" model to all elements below)*

#### **2A. Operational ICP:**
- **Firmographics:** Common industries, company sizes, and revenue stages.
- **Technographics:** The technology stack or specific tools used by ideal customers.
- **Behavioral:** Observable actions that signal a 'change-ready' mindset (e.g., job postings).
- **Quick Decision Making:** Evidence of who the economic buyer is and their purchasing authority.
- **Prioritized Requirements:** What they appear to value most in a solution.
- **Implementation Readiness:** Public signals of their ability to adopt a new product.

#### 2B. Key Buyer Personas (4 Roles)
Collect evidence for:
    1.  **Economic Buyer:** The person who owns the budget and is ultimately responsible for the financial viability of the purchase (e.g., CFO, CAO).
    2.  **Champion (Influencer):** The internal advocate who feels the acute pain and drives the evaluation (e.g., VP/Director of Revenue, Operations, or Transformation).
    3.  **End User:** The hands-on practitioner who will use the product regularly (e.g., Financial Analyst, Revenue Accountant).
    4.  **Blocker / Evaluator:** The individual with veto power who assesses risk and technical feasibility (e.g., Director of IT Security, General Counsel).

### Part 3: Positioning
*(You must apply the "Synthesis + Evidence" model to all elements below)*

#### 3A. The Product
* A factual, non-marketing description of what the product is and does.

#### **3B. Competitive Alternatives:**
-  **Initial Focus:** Begin your research with the user-provided starting point: **{{List of Competitors}}**.
-  **Discovery of Other Alternatives:** Next, expand your research to identify and analyze 2 to 5 other key alternatives the customer uses if {{Product Name}} doesn't exist, including:
    * **Publicly-Identified Direct Competitors**
    * **Indirect Competitors** (solving the same JTBD differently)
    * **The Status Quo** (manual processes, internal tools, etc.)
-  **Detailed Analysis (For EACH Alternative):** For every alternative you identify, you must provide the following three points of analysis in your final deliverable:
    * **Why Customers Choose This Alternative:** The primary reasons customers adopt this solution (e.g., *Low cost, simplicity, familiarity, existing vendor relationship*).
    * **Weaknesses or Gaps:** The primary weaknesses of the alternative when compared to **[Product or Service Name]** (e.g., *Time-consuming, prone to errors, does not scale, lacks key features*).
    * **Customer Proof:** Find and list the names of customers or include verbatim quotes from users (from sites like G2, Capterra, etc.) that provide evidence for the "Reasons for Choice" and "Weaknesses" you identified.

#### 3C. Unique Attributes, Value, and Proof
- 3 to 5 truly unique features/capabilities of {{Product Name}}
- Name of each attribute
- Short description of each attribute
- Customer Benefits delivered by each attribute
- Measurable outcomes/KPIs improved by each attribute

#### 3D. Target Market Characteristics
Summarize SECTION 1: Jobs-to-Be-Done & Value and SECTION 2: ICP & Buyer Personas

#### 3E. Market Category
- Existing/New/Sub-category determination
- Category name and rationale

#### 3F. Relevant Trends
- Identify the following major market trends that make the solution timely:
    * Trends that align with and enhance the product.
    * Trends that make the product more appealing.
    * Trends that create urgency for the product.
    * Trends that impact the underlying need for the product.

### Part 4: Category Narrative & Messaging
*(You must apply the "Synthesis + Evidence" model to all elements below)*

#### 4A. The Point of View (From/To Shift)
* The "old way" the world works that is no longer sufficient, and the "new way" the company enables.

#### 4B. The New Opportunity
* The positive future state or new capability that the solution makes possible.

#### 4C. Core Messaging Pillars
* The 2-3 core themes that appear consistently in the company's marketing and content.

#### 4D. Narrative Synthesis
* A brief synthesis of the overarching story the company is telling the market.

---

`;

            // Replace all placeholders with actual data
            const placeholders = {
              '{{Company Name}}': safeData.companyName,
              '{{Company Website}}': safeData.companyWebsite,
              '{{Product Name}}': safeData.productName,
              '{{List of Competitors}}': competitors
            };

            let finalPrompt = promptTemplate;
            Object.entries(placeholders).forEach(([placeholder, value]) => {
              finalPrompt = finalPrompt.replace(new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), value);
            });

            return finalPrompt;

          } catch (error) {
            console.error('Error generating deep research prompt:', error);
            return 'Error generating prompt. Please check your company data and try again.';
          }
        };

        // Enhanced array merging function to ensure backward compatibility for alternatives structure
        const ensureAlternativesStructure = (alternatives) => {
          if (!Array.isArray(alternatives)) {
            return [{ val1: '', val2: '', val3: '', val4: '', val5: '' }];
          }
          return alternatives.map(alt => ({
            val1: alt.val1 || '',
            val2: alt.val2 || '',
            val3: alt.val3 || '',
            val4: alt.val4 || '',
            val5: alt.val5 || ''
          }));
        };

        // Function to flatten organized segment data back to flat structure
        const flattenSegmentData = (organizedSegmentData) => {
          if (!organizedSegmentData || typeof organizedSegmentData !== 'object') {
            return {};
          }

          const flattened = {};

          // Handle organized structure (jobsToBeDone, customerValue, willingnessToPay, other)
          if (organizedSegmentData.jobsToBeDone) {
            Object.assign(flattened, organizedSegmentData.jobsToBeDone);
          }
          if (organizedSegmentData.customerValue) {
            Object.assign(flattened, organizedSegmentData.customerValue);
          }
          if (organizedSegmentData.willingnessToPay) {
            Object.assign(flattened, organizedSegmentData.willingnessToPay);
          }
          if (organizedSegmentData.other) {
            Object.assign(flattened, organizedSegmentData.other);
          }

          // If it's already flat, return as-is
          if (Object.keys(flattened).length === 0) {
            return organizedSegmentData;
          }

          return flattened;
        };

        const loadAppState = () => {
          try {
            const savedState = localStorage.getItem('categoryBlueprintState');
            if (!savedState) {
              return null;
            }
            
            const parsedState = JSON.parse(savedState);
            
            // Merge with initial state to ensure all new properties exist
            const initialState = getInitialState();
            const mergedState = {
              ...initialState,
              ...parsedState,
              // Ensure nested objects are properly merged with enhanced alternatives structure
              positioningData: {
                ...initialState.positioningData,
                ...(parsedState.positioningData || {}),
                alternatives: ensureAlternativesStructure(parsedState.positioningData?.alternatives)
              },
              categoryData: { ...initialState.categoryData, ...(parsedState.categoryData || {}) },
              segmentData: {
                ...initialState.segmentData,
                ...flattenSegmentData(parsedState.segmentData || {})
              },
              companyContext: { ...initialState.companyContext, ...(parsedState.companyContext || {}) },
              navigationProgress: { 
                ...initialState.navigationProgress, 
                ...(parsedState.navigationProgress || {}),
                partCompletionData: {
                  ...initialState.navigationProgress.partCompletionData,
                  ...(parsedState.navigationProgress?.partCompletionData || {})
                }
              }
            };
            return mergedState;
          } catch (error) {
            console.error('Could not load state from localStorage', error);
            return null;
          }
        };

        const getInitialState = () => {
          return {
            positioningData: {
              icp_common_needs: '',
              icp_desired_business_value: '',
              icp_problem_urgency: '',
              icp_quick_decision_making: '',
              icp_prioritized_requirements: '',
              icp_willingness_to_pay: '',
              icp_implementation_readiness: '',
              icp_firmographic: '',
              icp_technographic: '',
              icp_behavioral: '',
              icp_summary: '',
              'market-context': '',
              'market-context-other': '',
              alternatives: [{ val1: '', val2: '', val3: '', val4: '', val5: '' }],
              pillars: [{ id: 1, name: '', benefit: '' }],
              values: [{ val1: '', val2: '', val3: '', val4: '', pillarId: null }],
              trend1_desc: '',
              trend2_desc: '',
              trend3_desc: '',
              trend4_desc: ''
            },
            categoryData: {
              'from-statement': '',
              'to-statement': '',
              'new-opportunity': '',
              'category-name': '',
              'category-definition': '',
              'manifesto': ''
            },
            segmentData: {},
            companyContext: {
              isSetupComplete: false,
              companyName: '',
              companyWebsite: '',
              industry: '',
              productName: '',
              targetMarket: 'B2B',
              caseStudyUrls: [],
              documentationUrls: [],
              competitorNames: ['', '', '']
            },
            navigationProgress: {
              completedParts: [],
              currentPart: 'segment',
              partCompletionData: {
                segment: { completed: false, completedAt: null },
                icp: { completed: false, completedAt: null },
                positioning: { completed: false, completedAt: null },
                category: { completed: false, completedAt: null }
              }
            },
            currentView: 'home',
            aiSuggestions: {
              'Segment Foundation': null,
              'ICP Definition': null,
              'Positioning': null,
              'Category Design': null
            }
          };
        };

        // Enhanced Interactive Progress Stepper Component
        const ProgressStepper = ({ currentPart, completedParts, onNavigate, appState, saveAppState, onImport, onExport, disabled }) => {
            const parts = [
                { id: 'segment', name: 'Foundation', number: 1, fullName: 'Segment Foundation' },
                { id: 'icp', name: 'ICP Definition', number: 2, fullName: 'ICP Definition' },
                { id: 'positioning', name: 'Positioning', number: 3, fullName: 'Positioning' },
                { id: 'category', name: 'Category Design', number: 4, fullName: 'Category Design' }
            ];

            const [isMobile, setIsMobile] = useState(window.innerWidth < 640);

            useEffect(() => {
                const handleResize = () => setIsMobile(window.innerWidth < 640);
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            const isNavigable = (partId) => {
                // Can navigate to completed parts or the current part
                if (completedParts.includes(partId) || partId === currentPart) {
                    return true;
                }
                
                // Auto-allow navigation to previous parts if we're on a later part
                const partOrder = ['segment', 'icp', 'positioning', 'category'];
                const partIndex = partOrder.indexOf(partId);
                const currentIndex = partOrder.indexOf(currentPart);
                
                // If the part comes before the current part, it should be navigable
                return partIndex < currentIndex && currentIndex > 0;
            };

            const getStepStatus = (partId) => {
                if (partId === currentPart) return 'current';
                if (completedParts.includes(partId)) return 'completed';
                
                // Show previous parts as completed if we're on a later part
                const partOrder = ['segment', 'icp', 'positioning', 'category'];
                const partIndex = partOrder.indexOf(partId);
                const currentIndex = partOrder.indexOf(currentPart);
                
                if (partIndex < currentIndex && currentIndex > 0) {
                    return 'completed';
                }
                
                return 'upcoming';
            };

            const handleStepClick = (partId) => {
                if (!isNavigable(partId)) return;
                
                // Save current state before navigation
                if (saveAppState && appState) {
                    saveAppState(appState);
                }
                
                // Navigate to the selected part
                onNavigate(partId);
                
                // Smooth scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const handleHomeClick = () => {
                // Save current state before navigating home
                if (saveAppState && appState) {
                    saveAppState(appState);
                }
                
                // Navigate to home
                onNavigate('home');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const getStepStyles = (status, isHoverable) => {
                const baseStyles = {
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.5rem',
                    padding: '0.75rem 1rem',
                    borderRadius: '0.5rem',
                    transition: 'all 0.2s ease',
                    cursor: isHoverable ? 'pointer' : 'not-allowed',
                    userSelect: 'none',
                    position: 'relative',
                    border: 'none',
                    outline: 'none'
                };

                const statusStyles = {
                    completed: {
                        backgroundColor: '#10b981',
                        color: 'white',
                        opacity: 1
                    },
                    current: {
                        backgroundColor: '#3b82f6',
                        color: 'white',
                        opacity: 1,
                        boxShadow: '0 0 0 3px rgba(59, 130, 246, 0.1)'
                    },
                    upcoming: {
                        backgroundColor: '#f3f4f6',
                        color: '#6b7280',
                        opacity: 0.6
                    }
                };

                return { ...baseStyles, ...statusStyles[status] };
            };

            return (
                <div style={{ 
                    display: 'flex', 
                    justifyContent: 'space-between',  // Changed from 'center'
                    alignItems: 'center',
                    padding: '1rem',
                    backgroundColor: 'white',
                    borderBottom: '1px solid #e5e7eb',
                    position: 'sticky',
                    top: 0,
                    zIndex: 50,
                    boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)'
                }}>
                    {/* Home Button - Left Side */}
                    <button
                        onClick={handleHomeClick}
                        style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '0.5rem',
                            padding: '0.5rem 1rem',
                            borderRadius: '0.5rem',
                            backgroundColor: '#f3f4f6',
                            color: '#374151',
                            border: 'none',
                            cursor: 'pointer',
                            transition: 'all 0.2s ease',
                            fontSize: '0.9rem',
                            fontWeight: '500'
                        }}
                        onMouseEnter={(e) => {
                            e.currentTarget.style.backgroundColor = '#e5e7eb';
                        }}
                        onMouseLeave={(e) => {
                            e.currentTarget.style.backgroundColor = '#f3f4f6';
                        }}
                        title="Return to Home"
                        aria-label="Return to Home Screen"
                    >
                        {/* Home Icon SVG */}
                        <svg 
                            width="16" 
                            height="16" 
                            viewBox="0 0 20 20" 
                            fill="currentColor"
                            style={{ marginRight: '0.25rem' }}
                        >
                            <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                        </svg>
                        <span className="hidden sm:inline">Positioning Blueprint</span>
                        <span className="sm:hidden">Home</span>
                    </button>

                    {/* Progress Steps - Center */}
                    <nav role="navigation" aria-label="Blueprint progress">
                        <ol role="list" style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', listStyle: 'none', margin: 0, padding: 0 }}>
                            {parts.map((part, index) => {
                                const status = getStepStatus(part.id);
                                const isHoverable = isNavigable(part.id);
                                
                                return (
                                    <React.Fragment key={part.id}>
                                        <li role="listitem">
                                            <button
                                                onClick={() => handleStepClick(part.id)}
                                                onKeyDown={(e) => {
                                                    if (e.key === 'Enter' || e.key === ' ') {
                                                        e.preventDefault();
                                                        handleStepClick(part.id);
                                                    }
                                                }}
                                                disabled={!isHoverable}
                                                aria-label={`Part ${part.number}: ${part.fullName} - ${status}`}
                                                aria-current={part.id === currentPart ? 'step' : undefined}
                                                style={getStepStyles(status, isHoverable)}
                                                onMouseEnter={(e) => {
                                                    if (isHoverable) {
                                                        e.currentTarget.style.transform = 'scale(1.02)';
                                                        e.currentTarget.style.opacity = '0.9';
                                                    }
                                                }}
                                                onMouseLeave={(e) => {
                                                    e.currentTarget.style.transform = 'scale(1)';
                                                    e.currentTarget.style.opacity = '1';
                                                }}
                                                onFocus={(e) => {
                                                    if (isHoverable) {
                                                        e.currentTarget.style.boxShadow = status === 'current' ? 
                                                            '0 0 0 3px rgba(59, 130, 246, 0.3)' : 
                                                            '0 0 0 3px rgba(16, 185, 129, 0.3)';
                                                    }
                                                }}
                                                onBlur={(e) => {
                                                    e.currentTarget.style.boxShadow = status === 'current' ? 
                                                        '0 0 0 3px rgba(59, 130, 246, 0.1)' : 
                                                        'none';
                                                }}
                                                title={
                                                    isHoverable 
                                                        ? `Navigate to Part ${part.number}: ${part.fullName}`
                                                        : `Part ${part.number}: ${part.fullName} (Not yet available)`
                                                }
                                            >
                                                {status === 'completed' ? (
                                                    <span style={{ fontSize: '1.1rem' }}>✓</span>
                                                ) : (
                                                    <span style={{ 
                                                        fontWeight: 'bold',
                                                        fontSize: '0.9rem',
                                                        minWidth: '1.5rem',
                                                        textAlign: 'center'
                                                    }}>{part.number}</span>
                                                )}
                                                <span style={{ fontSize: '0.9rem', fontWeight: '500' }}>
                                                    {isMobile ? (
                                                        part.number
                                                    ) : (
                                                        part.name
                                                    )}
                                                </span>
                                            </button>
                                        </li>
                                        {index < parts.length - 1 && (
                                            <li role="presentation" aria-hidden="true">
                                                <div style={{ 
                                                    width: '2rem',
                                                    height: '2px',
                                                    backgroundColor: completedParts.includes(parts[index + 1].id) || parts[index + 1].id === currentPart ? '#10b981' : '#d1d5db',
                                                    transition: 'background-color 0.3s ease'
                                                }} />
                                            </li>
                                        )}
                                    </React.Fragment>
                                );
                            })}
                        </ol>
                    </nav>

                    {/* Session Menu - Right side */}
                    {React.createElement(SessionMenu, {
                        onImport: onImport,
                        onExport: onExport,
                        disabled: disabled
                    })}
                </div>
            );
        };

        // Primary Action Buttons Component
        const PrimaryActions = ({ currentPart, onExport, onContinue, onReset, onImport }) => {
            
            const getButtonConfig = (part) => {
                const configs = {
                    'segment': {
                        continue: 'Continue to ICP Definition',
                        export: 'Export Foundation'
                    },
                    'icp': {
                        continue: 'Continue to Positioning',
                        export: 'Export ICP'
                    },
                    'positioning': {
                        continue: 'Continue to Category Design',
                        export: 'Export Positioning'
                    },
                    'category': { 
                        continue: 'Complete Blueprint',
                        export: 'Export Category Design'
                    }
                };
                return configs[part] || { continue: 'Continue →', export: 'Export' };
            };

            const config = getButtonConfig(currentPart);
            
            return (
                <div style={{ display: 'flex', gap: '0.75rem', alignItems: 'center' }}>
                    {onReset && (
                        <button 
                            onClick={onReset}
                            style={{
                                background: 'transparent',
                                color: '#6b7280',
                                fontWeight: 500,
                                padding: '0.5rem 0.75rem',
                                borderRadius: '0.5rem',
                                border: '1px solid #d1d5db',
                                cursor: 'pointer'
                            }}
                        >
                            Reset
                        </button>
                    )}
                    {onImport && (currentPart === 'segment' || currentPart === 'icp' || currentPart === 'positioning' || currentPart === 'category') && (
                        <button 
                            onClick={onImport}
                            style={{
                                background: '#3b82f6',
                                color: 'white',
                                fontWeight: 500,
                                padding: '0.5rem 0.75rem',
                                borderRadius: '0.5rem',
                                border: 'none',
                                cursor: 'pointer'
                            }}
                        >
                            Import Part Data
                        </button>
                    )}
                    <button 
                        onClick={onExport}
                        style={{
                            background: '#f3f4f6',
                            color: '#374151',
                            fontWeight: 600,
                            padding: '0.5rem 1rem',
                            borderRadius: '0.5rem',
                            border: 'none',
                            cursor: 'pointer'
                        }}
                    >
                        {config.export}
                    </button>
                    <button 
                        onClick={onContinue}
                        style={{
                            background: '#10b981',
                            color: 'white',
                            fontWeight: 600,
                            padding: '0.5rem 1rem',
                            borderRadius: '0.5rem',
                            border: 'none',
                            cursor: 'pointer'
                        }}
                    >
                        {config.continue}
                    </button>
                </div>
            );
        };

        // Export Modal Component
        const ExportModal = ({ isOpen, onClose, title, content, appState, filename = 'category-blueprint-export', partData = null }) => {
            const [copied, setCopied] = useState(false);

            const handleCopy = () => {
                navigator.clipboard.writeText(content).then(() => {
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                });
            };

            const handleDownloadJSON = () => {
                // Use part-specific data if available, otherwise fall back to full appState
                const jsonData = JSON.stringify(partData || appState, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
                        <div className="flex justify-between items-center p-4 border-b">
                            <h2 className="text-2xl font-bold scale-green-text">{title}</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-800 text-3xl font-light">×</button>
                        </div>
                        <div className="p-6 overflow-y-auto">
                            <pre className="whitespace-pre-wrap text-sm bg-gray-50 p-4 rounded-md font-mono">{content}</pre>
                        </div>
                        <div className="p-4 border-t bg-gray-50 flex justify-end space-x-3">
                            <button 
                                onClick={handleDownloadJSON}
                                className="border border-gray-300 text-gray-600 font-bold py-2 px-4 rounded-lg hover:bg-gray-50 transition-colors"
                            >
                                Download JSON
                            </button>
                            <button 
                                onClick={handleCopy}
                                className="scale-green-bg text-white font-bold py-2 px-4 rounded-lg hover:bg-opacity-90"
                            >
                                {copied ? 'Copied!' : 'Copy to Clipboard'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // PromptDisplayModal Component
        const PromptDisplayModal = ({ isOpen, onClose, promptText, title = "Deep Research Prompt" }) => {
            const [copied, setCopied] = useState(false);

            const handleCopy = async () => {
                try {
                    await navigator.clipboard.writeText(promptText);
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = promptText;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                }
            };

            const handleDownload = () => {
                try {
                    const blob = new Blob([promptText], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${title.toLowerCase().replace(/\s+/g, '-')}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (err) {
                    console.error('Failed to download file: ', err);
                }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-6xl h-[95vh] flex flex-col">
                        <div className="flex justify-between items-center p-6 border-b">
                            <h2 className="text-2xl font-bold scale-green-text">{title}</h2>
                            <button 
                                onClick={onClose} 
                                className="text-gray-400 hover:text-gray-800 text-3xl font-light transition-colors"
                                aria-label="Close modal"
                            >
                                ×
                            </button>
                        </div>
                        
                        <div className="p-8 flex-1 overflow-hidden flex flex-col">
                            <p className="text-base text-gray-600 mb-6">
                                Your customized deep research prompt is ready. Copy it to use with your preferred AI assistant or download as a text file.
                            </p>
                            
                            <textarea
                                className="w-full flex-1 p-6 border border-gray-300 rounded-lg font-mono text-sm bg-gray-50 resize-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                value={promptText}
                                readOnly
                                placeholder="Generated prompt will appear here..."
                                style={{ minHeight: '400px' }}
                            />
                        </div>
                        
                        <div className="p-6 border-t bg-gray-50 flex justify-between items-center">
                            <div className="text-sm text-gray-500">
                                Prompt length: {promptText ? promptText.length.toLocaleString() : 0} characters
                            </div>
                            
                            <div className="flex gap-3">
                                <button 
                                    onClick={handleDownload}
                                    className="border border-gray-300 text-gray-600 font-bold py-2 px-4 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2"
                                    disabled={!promptText}
                                >
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    Download as .txt
                                </button>
                                
                                <button 
                                    onClick={handleCopy}
                                    className="scale-green-bg text-white font-bold py-2 px-4 rounded-lg hover:bg-opacity-90 transition-colors flex items-center gap-2"
                                    disabled={!promptText}
                                >
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                    {copied ? 'Copied!' : 'Copy to Clipboard'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // CompanySetupModal Component
        const CompanySetupModal = ({ isOpen, onComplete, companyData, setCompanyData }) => {
          console.log('CompanySetupModal rendered, isOpen:', isOpen, 'companyData:', companyData);
          
          if (!isOpen) return null;

          // Ensure companyData has all required properties with defaults
          const safeCompanyData = {
            companyName: '',
            companyWebsite: '',
            industry: '',
            productName: '',
            targetMarket: 'B2B',
            competitorNames: ['', '', ''],
            caseStudyUrls: [],
            documentationUrls: [],
            isSetupComplete: false,
            ...companyData
          };

          const [errors, setErrors] = useState({});
          
          const industries = [
            'SaaS/Software',
            'Financial Services', 
            'Healthcare',
            'E-commerce',
            'Manufacturing',
            'Professional Services',
            'Other'
          ];

          const validateForm = () => {
            const newErrors = {};
            
            // Validate required fields
            if (!safeCompanyData.companyName || safeCompanyData.companyName.length < 2) {
              newErrors.companyName = 'Company name must be at least 2 characters';
            }
            
            if (!safeCompanyData.companyWebsite) {
              newErrors.companyWebsite = 'Website is required';
            } else if (!/^[a-zA-Z0-9][a-zA-Z0-9-_.]*\.[a-zA-Z]{2,}/.test(safeCompanyData.companyWebsite.replace(/^https?:\/\//, ''))) {
              newErrors.companyWebsite = 'Please enter a valid domain (e.g., example.com)';
            }

            // Industry validation temporarily disabled - field is hidden
            // if (!safeCompanyData.industry) {
            //   newErrors.industry = 'Please select an industry';
            // }

            if (!safeCompanyData.productName || safeCompanyData.productName.length < 2) {
              newErrors.productName = 'Product name must be at least 2 characters';
            }
            
            setErrors(newErrors);
            return Object.keys(newErrors).length === 0;
          };

          const handleSubmit = () => {
            if (validateForm()) {
              // Ensure website has https:// prefix
              const websiteWithProtocol = safeCompanyData.companyWebsite.startsWith('http://') || safeCompanyData.companyWebsite.startsWith('https://') 
                ? safeCompanyData.companyWebsite 
                : `https://${safeCompanyData.companyWebsite}`;
              
              setCompanyData(prev => ({ 
                ...safeCompanyData, 
                ...prev, 
                companyWebsite: websiteWithProtocol,
                isSetupComplete: true 
              }));
              onComplete();
            }
          };


          const updateCompetitor = (index, value) => {
            const newCompetitors = [...safeCompanyData.competitorNames];
            newCompetitors[index] = value;
            setCompanyData(prev => ({ ...safeCompanyData, ...prev, competitorNames: newCompetitors }));
          };

          return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div className="p-6">
                  <h2 className="text-2xl font-bold mb-2">Welcome! Let's set up your company context</h2>
                  <p className="text-gray-600 mb-6">This information helps our AI provide more accurate insights and recommendations.</p>
                  
                  {/* Required Fields Section */}
                  <div className="mb-8">
                    <h3 className="text-lg font-semibold mb-4 flex items-center">
                      <span className="text-red-500 mr-2">*</span>Required Information
                    </h3>
                    
                    {/* Company Name */}
                    <div className="mb-4">
                      <label className="block font-bold text-gray-700 mb-1">Company Name</label>
                      <input
                        type="text"
                        className={`w-full p-2 border rounded-md ${errors.companyName ? 'border-red-500' : 'border-gray-300'}`}
                        value={safeCompanyData.companyName}
                        onChange={(e) => setCompanyData(prev => ({ ...safeCompanyData, ...prev, companyName: e.target.value }))}
                        placeholder="e.g., Acme Corporation"
                      />
                      {errors.companyName && <p className="text-red-500 text-sm mt-1">{errors.companyName}</p>}
                    </div>

                    {/* Company Website */}
                    <div className="mb-4">
                      <label className="block font-bold text-gray-700 mb-1">Company Website</label>
                      <input
                        type="url"
                        className={`w-full p-2 border rounded-md ${errors.companyWebsite ? 'border-red-500' : 'border-gray-300'}`}
                        value={safeCompanyData.companyWebsite}
                        onChange={(e) => setCompanyData(prev => ({ ...safeCompanyData, ...prev, companyWebsite: e.target.value }))}
                        placeholder="example.com"
                      />
                      {errors.companyWebsite && <p className="text-red-500 text-sm mt-1">{errors.companyWebsite}</p>}
                    </div>

                    {/* Industry - TEMPORARILY HIDDEN per user decision (can be restored by removing style={{display:'none'}}) */}
                    <div className="mb-4" style={{ display: 'none' }}>
                      <label className="block font-bold text-gray-700 mb-1">Industry</label>
                      <select
                        className={`w-full p-2 border rounded-md ${errors.industry ? 'border-red-500' : 'border-gray-300'}`}
                        value={safeCompanyData.industry}
                        onChange={(e) => setCompanyData(prev => ({ ...safeCompanyData, ...prev, industry: e.target.value }))}
                      >
                        <option value="">Select an industry</option>
                        {industries.map(ind => (
                          <option key={ind} value={ind}>{ind}</option>
                        ))}
                      </select>
                      {errors.industry && <p className="text-red-500 text-sm mt-1">{errors.industry}</p>}
                    </div>

                    {/* Product Name */}
                    <div className="mb-4">
                      <label className="block font-bold text-gray-700 mb-1">Product/Service Name</label>
                      <input
                        type="text"
                        className={`w-full p-2 border rounded-md ${errors.productName ? 'border-red-500' : 'border-gray-300'}`}
                        value={safeCompanyData.productName}
                        onChange={(e) => setCompanyData(prev => ({ ...safeCompanyData, ...prev, productName: e.target.value }))}
                        placeholder="e.g., Analytics Platform"
                      />
                      {errors.productName && <p className="text-red-500 text-sm mt-1">{errors.productName}</p>}
                    </div>

                  </div>

                  {/* Optional Fields Section */}
                  <div className="mb-8">
                    <h3 className="text-lg font-semibold mb-4">Optional Information</h3>
                    
                    {/* Top 3 Competitors */}
                    <div className="mb-4">
                      <label className="block font-bold text-gray-700 mb-1">Top 3 Competitors</label>
                      <p className="text-sm text-gray-600 mb-2">Helps us understand your competitive landscape</p>
                      {[0, 1, 2].map(i => (
                        <input
                          key={i}
                          type="text"
                          className="w-full p-2 border border-gray-300 rounded-md mb-2"
                          value={safeCompanyData.competitorNames[i]}
                          onChange={(e) => updateCompetitor(i, e.target.value)}
                          placeholder={`Competitor ${i + 1}`}
                        />
                      ))}
                    </div>
                  </div>

                  {/* Action Buttons */}
                  <div className="flex justify-end gap-4 pt-4 border-t">
                    <button
                      onClick={handleSubmit}
                      className="scale-green-bg text-white font-bold py-2 px-6 rounded-lg hover:bg-opacity-90"
                    >
                      Get Started
                    </button>
                  </div>
                </div>
              </div>
            </div>
          );
        };

        // AIResearchModal Component
        const AIResearchModal = ({ isOpen, onClose, onApplySuggestions, appState, setAppState }) => {
            const [file, setFile] = useState(null);
            const [uploading, setUploading] = useState(false);
            const [processing, setProcessing] = useState(false);
            const [results, setResults] = useState(null);
            const [error, setError] = useState(null);
            const [uploadProgress, setUploadProgress] = useState(0);

            if (!isOpen) return null;

            const handleFileChange = (event) => {
                const selectedFile = event.target.files[0];
                if (selectedFile) {
                    // Validate file type
                    const allowedTypes = ['text/markdown', 'text/plain', '.md', '.txt'];
                    const fileExtension = selectedFile.name.split('.').pop().toLowerCase();
                    const fileType = selectedFile.type;

                    if (fileType === 'text/markdown' || fileType === 'text/plain' ||
                        fileExtension === 'md' || fileExtension === 'txt') {
                        setFile(selectedFile);
                        setError(null);
                    } else {
                        setError('Please upload a markdown (.md) or text (.txt) file');
                        setFile(null);
                    }
                }
            };

            const handleUploadAndProcess = async () => {
                if (!file) {
                    setError('Please select a file first');
                    return;
                }

                setUploading(true);
                setProcessing(false);
                setError(null);
                setUploadProgress(0);

                try {
                    // Read file content
                    const fileContent = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = (e) => reject(new Error('Failed to read file'));
                        reader.readAsText(file);
                    });

                    setUploadProgress(50);
                    setUploading(false);
                    setProcessing(true);

                    // Send to API
                    const response = await fetch('/api/mine-research-report', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            reportText: fileContent
                        })
                    });

                    // Handle both full success (200) and partial success (207)
                    if (response.status !== 200 && response.status !== 207) {
                        throw new Error(`API call failed: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();
                    console.log('API response:', data);

                    // Handle both full success and partial success
                    if (data.success || (data.results && data.summary && data.summary.successful > 0)) {
                        setResults(data.results);
                        setUploadProgress(100);

                        // Log summary for user feedback
                        if (data.summary) {
                            console.log(`Processing complete: ${data.summary.successful}/${data.summary.total} parts successful`);
                        }
                    } else {
                        throw new Error(data.message || 'Processing failed');
                    }

                } catch (err) {
                    console.error('Upload/Processing error:', err);
                    setError(err.message || 'Failed to process research report');
                } finally {
                    setUploading(false);
                    setProcessing(false);
                }
            };

            const downloadResults = () => {
                if (!results) return;

                // Extract and populate form fields from AI suggestions
                const populateSegmentData = () => {
                    const segmentContent = results['Segment Foundation']?.content || {};
                    const jobsToBeDone = segmentContent.jobsToBeDone || {};
                    const customerValue = segmentContent.customerValue || {};
                    const willingnessToPay = segmentContent.willingnessToPay || {};

                    return {
                        ...jobsToBeDone,
                        ...customerValue,
                        ...willingnessToPay
                    };
                };

                const populatePositioningData = () => {
                    const positioningContent = results['Positioning']?.content || {};
                    const icpContent = results['ICP Definition']?.content || {};

                    return {
                        ...icpContent.icpDefinition || {},
                        competitiveAlternatives: positioningContent.competitiveAlternatives || [],
                        uniqueValueAndProof: positioningContent.uniqueValueAndProof || [],
                        marketCategory: positioningContent.marketCategory || '',
                        categoryName: positioningContent.categoryName || '',
                        relevantTrends: positioningContent.relevantTrends || {}
                    };
                };

                const populateCategoryData = () => {
                    const categoryContent = results['Category Design']?.content || {};

                    return {
                        'from-statement': categoryContent.pointOfView?.fromStatement || '',
                        'to-statement': categoryContent.pointOfView?.toStatement || '',
                        'new-opportunity': categoryContent.newOpportunity || '',
                        'category-name': categoryContent.categoryNameAndDefinition?.name || '',
                        'category-definition': categoryContent.categoryNameAndDefinition?.definition || '',
                        'manifesto': categoryContent.manifesto || '',
                        'market-category': categoryContent.marketCategory || '',
                        'target-market-summary': categoryContent.targetMarketCharacteristics?.summary || '',
                        'target-market-firmographic': categoryContent.targetMarketCharacteristics?.firmographic || '',
                        'target-market-technographic': categoryContent.targetMarketCharacteristics?.technographic || '',
                        'target-market-behavioral': categoryContent.targetMarketCharacteristics?.behavioral || '',
                        'target-market-readiness': categoryContent.targetMarketCharacteristics?.implementationReadiness || ''
                    };
                };

                // Create export data using same format as session export
                const exportData = {
                    formatVersion: "1.0.0",
                    appVersion: APP_VERSION,
                    exportTimestamp: new Date().toISOString(),
                    data: {
                        companyContext: appState.companyContext || {},
                        segmentData: populateSegmentData(),
                        positioningData: populatePositioningData(),
                        categoryData: populateCategoryData(),
                        aiSuggestions: results,
                        navigationProgress: {
                            completedParts: [],
                            currentPart: "home",
                            partCompletionData: {}
                        },
                        currentView: "home",
                        lastSaved: new Date().toISOString()
                    }
                };

                // Use SessionFileIO for consistent download experience
                if (window.SessionFileIO) {
                    const filename = `ai-research-results-${new Date().toISOString().split('T')[0]}.json`;
                    window.SessionFileIO.triggerDownload(filename, JSON.stringify(exportData, null, 2));
                } else {
                    // Fallback download method
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `ai-research-results-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
            };

            const handleApplySuggestions = () => {
                if (!results) return;

                // Update app state with AI suggestions
                setAppState(prev => ({
                    ...prev,
                    aiSuggestions: {
                        'Segment Foundation': results['Segment Foundation']?.content || null,
                        'ICP Definition': results['ICP Definition']?.content || null,
                        'Positioning': results['Positioning']?.content || null,
                        'Category Design': results['Category Design']?.content || null
                    }
                }));

                // Optionally auto-populate fields if user confirms
                if (window.confirm('Would you like to automatically populate available fields with AI suggestions? You can review and edit them afterwards.')) {
                    setAppState(prev => {
                        console.log('Applying AI suggestions to app state...');
                        const newState = { ...prev };

                        // V8 deoptimization - minimal approach to prevent TurboFan property assignment bugs
                        const v8DeoptTrigger = (value) => {
                            // Minimal deoptimization - just reference the value to prevent optimization
                            void value;
                        };

                        // Apply Segment Foundation suggestions with V8 deoptimization timing fix
                        if (results['Segment Foundation']?.content) {
                            const sfContent = results['Segment Foundation'].content;

                            // Individual field mapping for Jobs to be Done with V8 timing fix
                            if (sfContent.jobsToBeDone) {
                                Object.keys(sfContent.jobsToBeDone).forEach(key => {
                                    if (sfContent.jobsToBeDone[key] && sfContent.jobsToBeDone[key].trim()) {
                                        newState.segmentData[key] = sfContent.jobsToBeDone[key];
                                        // V8 deoptimization trigger - prevents TurboFan property assignment optimization bug
                                        v8DeoptTrigger(sfContent.jobsToBeDone[key]);
                                    }
                                });
                            }

                            // Individual field mapping for Customer Value with V8 timing fix
                            if (sfContent.customerValue) {
                                Object.keys(sfContent.customerValue).forEach(key => {
                                    if (sfContent.customerValue[key] && sfContent.customerValue[key].trim()) {
                                        newState.segmentData[key] = sfContent.customerValue[key];
                                        // V8 deoptimization trigger - prevents TurboFan property assignment optimization bug
                                        v8DeoptTrigger(sfContent.customerValue[key]);
                                    }
                                });
                            }

                            // Individual field mapping for Willingness to Pay with V8 timing fix
                            if (sfContent.willingnessToPay) {
                                Object.keys(sfContent.willingnessToPay).forEach(key => {
                                    if (sfContent.willingnessToPay[key] && sfContent.willingnessToPay[key].trim()) {
                                        newState.segmentData[key] = sfContent.willingnessToPay[key];
                                        // V8 deoptimization trigger - prevents TurboFan property assignment optimization bug
                                        v8DeoptTrigger(sfContent.willingnessToPay[key]);
                                    }
                                });
                            }
                        }

                        // Apply ICP Definition suggestions with V8 timing fix
                        if (results['ICP Definition']?.content?.icpDefinition) {
                            const icpContent = results['ICP Definition'].content.icpDefinition;

                            // Map ICP fields to positioningData with icp_ prefixes
                            const icpFieldMapping = {
                                quickDecisionMaking: 'icp_quick_decision_making',
                                prioritizedRequirements: 'icp_prioritized_requirements',
                                implementationReadiness: 'icp_implementation_readiness',
                                firmographic: 'icp_firmographic',
                                technographic: 'icp_technographic',
                                behavioral: 'icp_behavioral'
                            };

                            Object.keys(icpFieldMapping).forEach(apiKey => {
                                const formKey = icpFieldMapping[apiKey];
                                if (icpContent[apiKey]) {
                                    newState.positioningData[formKey] = icpContent[apiKey];
                                    // V8 deoptimization trigger - prevents TurboFan property assignment optimization bug
                                    void 0; // V8 deopt timing fix
                                }
                            });
                        }

                        // Apply Positioning suggestions with array transformation
                        if (results['Positioning']?.content) {
                            const posContent = results['Positioning'].content;

                            // Transform competitive alternatives array - enhanced 5-field structure
                            if (posContent.competitiveAlternatives && Array.isArray(posContent.competitiveAlternatives)) {
                                newState.positioningData.alternatives = posContent.competitiveAlternatives.map(alt => ({
                                    val1: alt.alternative || '',
                                    val2: alt.description || '',
                                    val3: alt.whyCustomersChoose || '',
                                    val4: alt.weaknessesOrGaps || '',
                                    val5: alt.customerProof || ''
                                }));
                            }

                            // Transform unique value and proof array
                            if (posContent.uniqueValueAndProof && Array.isArray(posContent.uniqueValueAndProof)) {
                                newState.positioningData.values = posContent.uniqueValueAndProof.map(val => ({
                                    val1: val.attributeName || '',
                                    val2: val.attributeDescription || '',
                                    val3: val.benefit || '',
                                    val4: val.value || '',
                                    pillarId: null
                                }));
                            }

                            // Map positioning fields with V8 timing fix
                            // Map market category (corrected field name)
                            if (posContent.marketCategory && posContent.marketCategory.trim()) {
                                newState.positioningData['market-context'] = posContent.marketCategory;
                                // V8 deoptimization trigger - prevents TurboFan property assignment optimization bug
                                void 0; // V8 deopt timing fix
                            }

                            // Map category name (corrected field name)
                            if (posContent.categoryName && posContent.categoryName.trim()) {
                                newState.positioningData['category-name'] = posContent.categoryName;
                                // V8 deoptimization trigger - prevents TurboFan property assignment optimization bug
                                void 0; // V8 deopt timing fix
                            }

                            // Transform trends: {trend1, trend2, trend3, trend4} → trend1_desc, trend2_desc, etc.
                            if (posContent.relevantTrends && typeof posContent.relevantTrends === 'object') {
                                Object.entries(posContent.relevantTrends).forEach(([key, value]) => {
                                    if (value && value.trim()) {
                                        const fieldName = `${key}_desc`;
                                        newState.positioningData[fieldName] = value;
                                        // V8 deoptimization trigger - prevents TurboFan property assignment optimization bug
                                        v8DeoptTrigger(value);
                                    }
                                });
                            }
                        }

                        // Apply Category Design suggestions with V8 timing fix
                        if (results['Category Design']?.content) {
                            const cdContent = results['Category Design'].content;

                            // Map Point of View fields with V8 timing fix
                            if (cdContent.pointOfView) {
                                if (cdContent.pointOfView.fromStatement) {
                                    newState.categoryData['from-statement'] = cdContent.pointOfView.fromStatement;
                                    // V8 deoptimization trigger - prevents TurboFan property assignment optimization bug
                                    void 0; // V8 deopt timing fix
                                }
                                if (cdContent.pointOfView.toStatement) {
                                    newState.categoryData['to-statement'] = cdContent.pointOfView.toStatement;
                                    // V8 deoptimization trigger - prevents TurboFan property assignment optimization bug
                                    void 0; // V8 deopt timing fix
                                }
                            }

                            // Map other Category Design fields with V8 timing fix
                            if (cdContent.newOpportunity) {
                                newState.categoryData['new-opportunity'] = cdContent.newOpportunity;
                                // V8 deoptimization trigger - prevents TurboFan property assignment optimization bug
                                void 0; // V8 deopt timing fix
                            }

                            if (cdContent.categoryNameAndDefinition) {
                                if (cdContent.categoryNameAndDefinition.name) {
                                    newState.categoryData['category-name'] = cdContent.categoryNameAndDefinition.name;
                                    // V8 deoptimization trigger - prevents TurboFan property assignment optimization bug
                                    void 0; // V8 deopt timing fix
                                }
                                if (cdContent.categoryNameAndDefinition.definition) {
                                    newState.categoryData['category-definition'] = cdContent.categoryNameAndDefinition.definition;
                                    // V8 deoptimization trigger - prevents TurboFan property assignment optimization bug
                                    void 0; // V8 deopt timing fix
                                }
                            }

                            if (cdContent.manifesto) {
                                newState.categoryData['manifesto'] = cdContent.manifesto;
                                // V8 deoptimization trigger - prevents TurboFan property assignment optimization bug
                                void 0; // V8 deopt timing fix
                            }

                            if (cdContent.marketCategory) {
                                newState.categoryData['market-category'] = cdContent.marketCategory;
                                // V8 deoptimization trigger - prevents TurboFan property assignment optimization bug
                                void 0; // V8 deopt timing fix
                            }

                            // Map Target Market Characteristics with V8 timing fix
                            if (cdContent.targetMarketCharacteristics) {
                                const tm = cdContent.targetMarketCharacteristics;
                                if (tm.summary) {
                                    newState.categoryData['target-market-summary'] = tm.summary;
                                    void 0; // V8 deopt timing fix
                                }
                                if (tm.firmographic) {
                                    newState.categoryData['target-market-firmographic'] = tm.firmographic;
                                    void 0; // V8 deopt timing fix
                                }
                                if (tm.technographic) {
                                    newState.categoryData['target-market-technographic'] = tm.technographic;
                                    void 0; // V8 deopt timing fix
                                }
                                if (tm.behavioral) {
                                    newState.categoryData['target-market-behavioral'] = tm.behavioral;
                                    void 0; // V8 deopt timing fix
                                }
                                if (tm.implementationReadiness) {
                                    newState.categoryData['target-market-readiness'] = tm.implementationReadiness;
                                    void 0; // V8 deopt timing fix
                                }
                            }
                        }

                        return newState;
                    });
                }

                onClose();
            };

            const resetModal = () => {
                setFile(null);
                setUploading(false);
                setProcessing(false);
                setResults(null);
                setError(null);
                setUploadProgress(0);
            };

            const handleClose = () => {
                resetModal();
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                        <div className="flex justify-between items-center p-6 border-b">
                            <div className="flex items-center space-x-3">
                                <div className="w-8 h-8 scale-green-bg rounded-lg flex items-center justify-center">
                                    <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                    </svg>
                                </div>
                                <h2 className="text-2xl font-bold scale-green-text">AI Processing Assistant</h2>
                            </div>
                            <button onClick={handleClose} className="text-gray-400 hover:text-gray-800 text-3xl font-light">×</button>
                        </div>

                        <div className="p-6 overflow-y-auto flex-1">
                            {!results ? (
                                <div className="space-y-6">
                                    <div className="text-center">
                                        <p className="text-gray-600 mb-4">Upload your research report (markdown or text file) and let AI extract insights for your Positioning Blueprint.</p>
                                    </div>

                                    {/* File Upload Area */}
                                    <div className="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                                        <input
                                            type="file"
                                            id="research-file"
                                            accept=".md,.txt,text/markdown,text/plain"
                                            onChange={handleFileChange}
                                            className="hidden"
                                        />
                                        <label htmlFor="research-file" className="cursor-pointer">
                                            <div className="space-y-3">
                                                <svg className="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                                                </svg>
                                                <div>
                                                    <span className="text-purple-600 hover:text-purple-700 font-medium">Choose a file</span>
                                                    <span className="text-gray-500"> or drag and drop</span>
                                                </div>
                                                <p className="text-xs text-gray-500">Markdown (.md) or Text (.txt) files only</p>
                                            </div>
                                        </label>
                                    </div>

                                    {file && (
                                        <div className="bg-gray-50 p-4 rounded-lg">
                                            <div className="flex items-center space-x-3">
                                                <svg className="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                </svg>
                                                <div>
                                                    <p className="font-medium text-gray-900">{file.name}</p>
                                                    <p className="text-sm text-gray-500">{(file.size / 1024).toFixed(1)} KB</p>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {error && (
                                        <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
                                            <div className="flex items-center">
                                                <svg className="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                                                </svg>
                                                {error}
                                            </div>
                                        </div>
                                    )}

                                    {(uploading || processing) && (
                                        <div className="bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded-lg">
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center">
                                                    <svg className="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                    </svg>
                                                    {uploading ? 'Reading file...' : 'Processing with AI...'}
                                                </div>
                                                <span className="text-sm">{uploadProgress}%</span>
                                            </div>
                                            {uploadProgress > 0 && (
                                                <div className="mt-2 bg-blue-200 rounded-full h-2">
                                                    <div className="bg-blue-600 h-2 rounded-full transition-all duration-300" style={{ width: `${uploadProgress}%` }}></div>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <div className="space-y-6">
                                    <div className="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg">
                                        <div className="flex items-center">
                                            <svg className="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                                            </svg>
                                            Research report processed successfully! Review the extracted insights below.
                                        </div>
                                    </div>

                                    {/* Results Display */}
                                    <div className="space-y-4">
                                        {Object.entries(results).map(([partName, partResult]) => (
                                            <div key={partName} className="border border-gray-200 rounded-lg overflow-hidden">
                                                <div className="bg-gray-50 px-4 py-3 border-b border-gray-200">
                                                    <h3 className="font-semibold text-gray-900 flex items-center justify-between">
                                                        {partName}
                                                        {partResult.error ? (
                                                            <span className="text-red-600 text-sm">Failed</span>
                                                        ) : (
                                                            <span className="text-green-600 text-sm">✓ Extracted</span>
                                                        )}
                                                    </h3>
                                                </div>
                                                <div className="p-4">
                                                    {partResult.error ? (
                                                        <p className="text-red-600 text-sm">{partResult.error}</p>
                                                    ) : (
                                                        <pre className="text-sm text-gray-700 whitespace-pre-wrap bg-gray-50 p-3 rounded overflow-x-auto">
                                                            {JSON.stringify(partResult.content, null, 2)}
                                                        </pre>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="p-6 border-t bg-gray-50 flex justify-end space-x-3">
                            {!results ? (
                                <>
                                    <button
                                        onClick={handleClose}
                                        className="border border-gray-300 text-gray-600 font-bold py-2 px-4 rounded-lg hover:bg-gray-50 transition-colors"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={handleUploadAndProcess}
                                        disabled={!file || uploading || processing}
                                        className="scale-green-bg text-white font-bold py-2 px-4 rounded-lg hover:bg-opacity-90 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                    >
                                        {uploading || processing ? 'Processing...' : 'Process Research Report'}
                                    </button>
                                </>
                            ) : (
                                <>
                                    <button
                                        onClick={downloadResults}
                                        className="border border-blue-500 text-blue-600 font-bold py-2 px-4 rounded-lg hover:bg-blue-50 transition-colors flex items-center gap-2"
                                    >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                        </svg>
                                        Save these Results
                                    </button>
                                    <button
                                        onClick={handleApplySuggestions}
                                        className="scale-green-bg text-white font-bold py-2 px-4 rounded-lg hover:bg-opacity-90 transition-colors"
                                    >
                                        Apply Results to Framework
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // SubSectionNav Component
        const SubSectionNav = ({ sections, activeSection, currentPart }) => {
            return React.createElement('div', {
                style: { display: 'none' }
            }, 'Navigation temporarily disabled');
        };

        // AnalysisView Component - REMOVED for simplification
        // Navigation now goes directly from Home to Segment Foundation

        // SegmentFoundationTool Component
        const SegmentFoundationTool = ({ appState, setAppState, onNavigate, markPartAsCompleted, openTourAtStep }) => {
            console.log('SegmentFoundationTool rendering, appState:', appState);
            const [exportModalOpen, setExportModalOpen] = useState(false);
            const [exportContent, setExportContent] = useState('');
            const [exportData, setExportData] = useState(null);
            const [validationState, setValidationState] = useState({});
            
            // Import state variables
            const [importMessage, setImportMessage] = useState(null);
            const [importMessageType, setImportMessageType] = useState(''); // 'success', 'error', 'warning'
            
            // AI Draft State Variables
            const [aiDraftLoading, setAiDraftLoading] = useState(false);
            const [aiDraftsAvailable, setAiDraftsAvailable] = useState(false);
            const [aiDraftError, setAiDraftError] = useState(null);
            
            // WTP AI Draft State Variables
            const [wtpDraftLoading, setWtpDraftLoading] = useState(false);
            const [wtpDraftsAvailable, setWtpDraftsAvailable] = useState(false);
            const [wtpDraftError, setWtpDraftError] = useState(null);

            const handleValidateJtbd = async (jtbdElementName, userInput) => {
                // Check if company context is properly set up (industry no longer required)
                if (!appState.companyContext?.productName) {
                    setValidationState(prev => ({
                        ...prev,
                        [jtbdElementName]: {
                            status: 'error', 
                            result: {
                                alignmentScore: 0,
                                marketLanguage: [],
                                refinementSuggestions: ['Please complete the Company Context setup first by clicking "Dev Tools: Reset Company Context" in the footer and filling out your company information.']
                            }
                        }
                    }));
                    return;
                }
                
                setValidationState(prev => ({ ...prev, [jtbdElementName]: { status: 'validating' } }));
                try {
                    const response = await fetch('/api/validate-jtbd?debug=true', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            companyContext: appState.companyContext,
                            jtbdElementName,
                            userInput
                        })
                    });
                    if (!response.ok) {
                        throw new Error('Validation failed');
                    }
                    const results = await response.json();
                    
                    // Log debug information to console
                    console.log(`🔍 VAL-FEAT-001 Debug: ${jtbdElementName}`, {
                        userInput: userInput,
                        queries: results.debug?.queries,
                        searchResults: {
                            snippetCount: results.debug?.searchResultsCount.snippets,
                            titleCount: results.debug?.searchResultsCount.titles,
                            sampleSnippets: results.debug?.sampleSnippets
                        },
                        analysis: {
                            alignmentScore: results.alignmentScore,
                            marketLanguage: results.marketLanguage,
                            suggestions: results.refinementSuggestions
                        }
                    });
                    
                    setValidationState(prev => ({ ...prev, [jtbdElementName]: { status: 'success', results } }));
                } catch (error) {
                    console.error(`❌ VAL-FEAT-001 Error: ${jtbdElementName}`, error);
                    setValidationState(prev => ({ ...prev, [jtbdElementName]: { status: 'error', error: error.message } }));
                }
            };

            const renderValidationResult = (elementName) => {
                const state = validationState[elementName];
                if (!state) return null;
                if (state.status === 'validating') {
                    return <div className="text-sm text-gray-500 italic mt-2">Validating...</div>;
                }
                if (state.status === 'error') {
                    const errorMessage = state.error || 'Validation service is unavailable. Please try again later.';
                    return <div className="text-sm text-red-500 mt-2">Error: {errorMessage}</div>;
                }
                if (state.status === 'success' && state.results) {
                    const { alignmentScore, marketLanguage, refinementSuggestions } = state.results;
                    return (
                        <div className="mt-2 p-3 bg-gray-50 border border-gray-200 rounded-md">
                            <h4 className="text-sm font-bold text-gray-700 mb-2">
                                Validation Results 
                                <span className="ml-2 text-xs text-blue-600 cursor-help" title="Check browser console for detailed analysis">
                                    (Debug: Check Console)
                                </span>
                            </h4>
                            <p className="text-sm text-gray-600"><strong>Alignment Score:</strong> {alignmentScore}%</p>
                            <p className="text-sm text-gray-600"><strong>Market Language:</strong> {marketLanguage.join(', ')}</p>
                            <div>
                                <p className="text-sm font-bold text-gray-700 mt-2">Suggestions:</p>
                                <ul className="list-disc list-inside text-sm text-gray-600">
                                    {refinementSuggestions.map((suggestion, index) => (
                                        <li key={index}>{suggestion}</li>
                                    ))}
                                </ul>
                            </div>
                        </div>
                    );
                }
                return null;
            };

            const handleReset = () => {
                if (window.confirm('Are you sure you want to reset all segment data? This action cannot be undone.')) {
                    setAppState(prev => ({ ...prev, segmentData: {} }));
                }
            };

            // Generate part-specific structured data for consistent exports
            const generatePartSpecificData = () => {
                const formatFieldValue = (fieldValue) => {
                    // Handle arrays (future dynamic content)
                    if (Array.isArray(fieldValue)) {
                        return fieldValue.filter(item => item && item.toString().trim()).join('; ');
                    }
                    // Handle objects (future complex data)
                    if (typeof fieldValue === 'object' && fieldValue !== null) {
                        return Object.entries(fieldValue)
                            .filter(([k, v]) => v && v.toString().trim())
                            .map(([k, v]) => `${k}: ${v}`)
                            .join('; ');
                    }
                    // Handle strings (current implementation)
                    return fieldValue && fieldValue.toString().trim() || null;
                };

                // Build company object excluding null values
                const companyData = {};
                const companyName = formatFieldValue(appState.companyContext?.companyName);
                const companyWebsite = formatFieldValue(appState.companyContext?.companyWebsite);
                const industry = formatFieldValue(appState.companyContext?.industry);
                const productName = formatFieldValue(appState.companyContext?.productName);
                const targetMarket = formatFieldValue(appState.companyContext?.targetMarket);
                
                if (companyName) companyData.name = companyName;
                if (companyWebsite) companyData.website = companyWebsite;
                if (industry) companyData.industry = industry;
                if (productName) companyData.productName = productName;
                if (targetMarket) companyData.targetMarket = targetMarket;

                return {
                    metadata: {
                        exportDate: new Date().toISOString(),
                        partName: "Segment Foundation",
                        partNumber: 1,
                        company: companyData
                    },
                    content: {
                        jobsToBeDone: {
                            "Context": formatFieldValue(appState.segmentData?.['Context']),
                            "Struggling Moments": formatFieldValue(appState.segmentData?.['Struggling Moments']),
                            "Pushes & Pulls": formatFieldValue(appState.segmentData?.['Pushes & Pulls']),
                            "Anxieties & Habits": formatFieldValue(appState.segmentData?.['Anxieties & Habits']),
                            "Desired Outcomes": formatFieldValue(appState.segmentData?.['Desired Outcomes']),
                            "Basic Quality (Table Stakes)": formatFieldValue(appState.segmentData?.['Basic Quality (Table Stakes)']),
                            "Hiring Criteria": formatFieldValue(appState.segmentData?.['Hiring Criteria']),
                            "Firing Criteria": formatFieldValue(appState.segmentData?.['Firing Criteria']),
                            "Key Trade-offs": formatFieldValue(appState.segmentData?.['Key Trade-offs'])
                        },
                        customerValue: {
                            "Table Stakes": formatFieldValue(appState.segmentData?.['Table Stakes']),
                            "Functional Value": formatFieldValue(appState.segmentData?.['Functional Value']),
                            "Ease of Doing Business": formatFieldValue(appState.segmentData?.['Ease of Doing Business']),
                            "Individual Value": formatFieldValue(appState.segmentData?.['Individual Value']),
                            "Aspirational Value": formatFieldValue(appState.segmentData?.['Aspirational Value'])
                        },
                        willingnessToPay: {
                            "Ability to Pay": formatFieldValue(appState.segmentData?.['Ability to Pay']),
                            "Economic Justification": formatFieldValue(appState.segmentData?.['Economic Justification']),
                            "Relative Value vs. Alternatives": formatFieldValue(appState.segmentData?.['Relative Value vs. Alternatives']),
                            "Risk & Switching Costs": formatFieldValue(appState.segmentData?.['Risk & Switching Costs']),
                            "Market Reference Points": formatFieldValue(appState.segmentData?.['Market Reference Points'])
                        }
                    }
                };
            };

            // Generate markdown from structured data
            const generateMarkdownFromData = (data) => {
                const { metadata, content } = data;
                
                let markdown = `# Segment Foundation Summary\n\n`;
                
                // Add company context header
                if (metadata.company.name || metadata.company.website) {
                    markdown += `**Export Date:** ${new Date(metadata.exportDate).toLocaleDateString()}\n`;
                    if (metadata.company.name) {
                        markdown += `**Company:** ${metadata.company.name}`;
                        if (metadata.company.website) markdown += ` (${metadata.company.website})`;
                        markdown += `\n`;
                    }
                    if (metadata.company.industry || metadata.company.productName || metadata.company.targetMarket) {
                        const companyDetails = [];
                        if (metadata.company.industry) companyDetails.push(`**Industry:** ${metadata.company.industry}`);
                        if (metadata.company.productName) companyDetails.push(`**Product:** ${metadata.company.productName}`);
                        if (metadata.company.targetMarket) companyDetails.push(`**Market:** ${metadata.company.targetMarket}`);
                        markdown += `${companyDetails.join(' | ')}\n`;
                    }
                    markdown += `\n`;
                }

                // Jobs to be Done section
                markdown += `## Jobs to be Done\n`;
                Object.entries(content.jobsToBeDone).forEach(([key, value]) => {
                    markdown += `**${key}:** ${value || 'Not provided'}\n\n`;
                });

                // Customer Value section
                markdown += `## Customer Value\n`;
                Object.entries(content.customerValue).forEach(([key, value]) => {
                    markdown += `**${key}:** ${value || 'Not provided'}\n\n`;
                });

                // Willingness to Pay section
                markdown += `## Willingness to Pay\n`;
                Object.entries(content.willingnessToPay).forEach(([key, value]) => {
                    markdown += `**${key}:** ${value || 'Not provided'}\n\n`;
                });

                return markdown;
            };
            
            const handleExport = () => {
                const partData = generatePartSpecificData();
                const markdownContent = generateMarkdownFromData(partData);
                
                setExportData(partData);
                setExportContent(markdownContent);
                setExportModalOpen(true);
            };
            
            // AI Customer Value Generation Handler
            const handleGenerateCustomerValue = async () => {
                setAiDraftLoading(true);
                setAiDraftError(null);
                
                try {
                    const jtbdFields = ['Context', 'Struggling Moments', 'Pushes & Pulls', 'Anxieties & Habits', 'Desired Outcomes', 'Basic Quality (Table Stakes)', 'Hiring Criteria', 'Firing Criteria', 'Key Trade-offs'];
                    const filledFields = jtbdFields.filter(field => appState.segmentData[field] && typeof appState.segmentData[field] === 'string' && appState.segmentData[field].trim());
                    
                    if (filledFields.length < 3) {
                        setAiDraftError('Please complete at least 3 Jobs-to-be-Done fields before using the AI assistant.');
                        setAiDraftLoading(false);
                        return;
                    }
                    
                    const response = await fetch('/api/draft-customer-value', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            jtbdData: appState.segmentData
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API call failed: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success && data.drafts) {
                        // Update segmentData with AI-generated drafts
                        setAppState(prev => ({
                            ...prev,
                            segmentData: {
                                ...prev.segmentData,
                                'Table Stakes': data.drafts['Table Stakes'],
                                'Functional Value': data.drafts['Functional Value'],
                                'Ease of Doing Business': data.drafts['Ease of Doing Business'],
                                'Individual Value': data.drafts['Individual Value'],
                                'Aspirational Value': data.drafts['Aspirational Value']
                            }
                        }));
                        
                        setAiDraftsAvailable(true);
                    } else {
                        throw new Error(data.error || 'AI generation failed');
                    }
                } catch (error) {
                    console.error('AI Customer Value Generation Error:', error);
                    setAiDraftError(error.message || 'AI assistant is currently unavailable. Please try again later.');
                }
                
                setAiDraftLoading(false);
            };
            
            // AI WTP Generation Handler
            const handleGenerateWTP = async () => {
                setWtpDraftLoading(true);
                setWtpDraftError(null);
                
                try {
                    const customerValueFields = ['Table Stakes', 'Functional Value', 'Ease of Doing Business', 'Individual Value', 'Aspirational Value'];
                    const hasCustomerValue = customerValueFields.some(field => appState.segmentData[field] && typeof appState.segmentData[field] === 'string' && appState.segmentData[field].trim());
                    
                    if (!hasCustomerValue) {
                        setWtpDraftError('Please complete the Customer Value section first before generating WTP drivers.');
                        setWtpDraftLoading(false);
                        return;
                    }
                    
                    const response = await fetch('/api/draft-wtp-value', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            jtbdData: appState.segmentData,
                            customerValueData: {
                                'Table Stakes': appState.segmentData['Table Stakes'],
                                'Functional Value': appState.segmentData['Functional Value'],
                                'Ease of Doing Business': appState.segmentData['Ease of Doing Business'],
                                'Individual Value': appState.segmentData['Individual Value'],
                                'Aspirational Value': appState.segmentData['Aspirational Value']
                            }
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API call failed: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success && data.drafts) {
                        // Update segmentData with AI-generated WTP drafts
                        setAppState(prev => ({
                            ...prev,
                            segmentData: {
                                ...prev.segmentData,
                                'Ability to Pay': data.drafts['Ability to Pay'],
                                'Economic Justification': data.drafts['Economic Justification'],
                                'Relative Value vs. Alternatives': data.drafts['Relative Value vs. Alternatives'],
                                'Risk': data.drafts['Risk'],
                                'Market Reference Points': data.drafts['Market Reference Points']
                            }
                        }));
                        
                        setWtpDraftsAvailable(true);
                    } else {
                        throw new Error(data.error || 'AI generation failed');
                    }
                } catch (error) {
                    console.error('AI WTP Generation Error:', error);
                    setWtpDraftError(error.message || 'AI assistant is currently unavailable. Please try again later.');
                }
                
                setWtpDraftLoading(false);
            };

            // Schema validation function for import data
            const validateImportData = (data) => {
                const errors = [];
                const warnings = [];

                // Check if data is an object
                if (!data || typeof data !== 'object') {
                    errors.push('Invalid file format. Expected JSON object.');
                    return { isValid: false, errors, warnings };
                }

                // Check required top-level structure
                if (!data.metadata || typeof data.metadata !== 'object') {
                    errors.push('Missing or invalid metadata section.');
                }

                if (!data.content || typeof data.content !== 'object') {
                    errors.push('Missing or invalid content section.');
                }

                if (errors.length > 0) {
                    return { isValid: false, errors, warnings };
                }

                // Validate metadata structure
                const { metadata } = data;
                if (!metadata.partName || metadata.partName !== 'Segment Foundation') {
                    const detectedType = metadata?.partName || 'Unknown';
                    errors.push(`Wrong data type: Found "${detectedType}" data, but expected "Segment Foundation" data. Please select a Segment Foundation export file.`);
                }

                if (!metadata.company || typeof metadata.company !== 'object') {
                    warnings.push('Company information is missing or invalid.');
                }

                // Validate content structure
                const { content } = data;
                const requiredSections = ['jobsToBeDone', 'customerValue', 'willingnessToPay'];
                const missingSections = requiredSections.filter(section => !content[section]);
                
                if (missingSections.length > 0) {
                    errors.push(`Missing required sections: ${missingSections.join(', ')}`);
                }

                // Validate individual sections exist
                const jtbdFields = [
                    'Context', 'Struggling Moments', 'Pushes & Pulls', 
                    'Anxieties & Habits', 'Desired Outcomes', 'Basic Quality (Table Stakes)',
                    'Hiring Criteria', 'Firing Criteria', 'Key Trade-offs'
                ];

                const customerValueFields = [
                    'Table Stakes', 'Functional Value', 'Ease of Doing Business',
                    'Individual Value', 'Aspirational Value'
                ];

                const wtpFields = [
                    'Ability to Pay', 'Economic Justification', 'Relative Value vs. Alternatives',
                    'Risk & Switching Costs', 'Market Reference Points'
                ];

                // Count populated fields for quality assessment
                const populatedJtbd = jtbdFields.filter(field => 
                    content.jobsToBeDone?.[field] && content.jobsToBeDone[field].trim()
                ).length;

                const populatedCustomerValue = customerValueFields.filter(field => 
                    content.customerValue?.[field] && content.customerValue[field].trim()
                ).length;

                const populatedWtp = wtpFields.filter(field => 
                    content.willingnessToPay?.[field] && content.willingnessToPay[field].trim()
                ).length;

                if (populatedJtbd < 3) {
                    warnings.push(`Only ${populatedJtbd} of ${jtbdFields.length} Jobs-to-be-Done fields are populated.`);
                }

                if (populatedCustomerValue < 2) {
                    warnings.push(`Only ${populatedCustomerValue} of ${customerValueFields.length} Customer Value fields are populated.`);
                }

                if (populatedWtp < 2) {
                    warnings.push(`Only ${populatedWtp} of ${wtpFields.length} Willingness to Pay fields are populated.`);
                }

                return { 
                    isValid: errors.length === 0, 
                    errors, 
                    warnings,
                    stats: {
                        populatedJtbd,
                        populatedCustomerValue,
                        populatedWtp,
                        totalFields: jtbdFields.length + customerValueFields.length + wtpFields.length
                    }
                };
            };

            // Import handler function
            const handleImport = () => {
                // Create a hidden file input element
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.json';
                fileInput.style.display = 'none';
                
                fileInput.onchange = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    // Clear any previous messages
                    setImportMessage(null);
                    setImportMessageType('');
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            
                            // Validate the imported data
                            const validation = validateImportData(importedData);
                            
                            if (!validation.isValid) {
                                setImportMessage(`Import failed: ${validation.errors.join('; ')}`);
                                setImportMessageType('error');
                                return;
                            }
                            
                            // Process the import
                            const { content, metadata } = importedData;
                            const { jobsToBeDone, customerValue, willingnessToPay } = content;
                            
                            // Create new segment data by merging imported data
                            const newSegmentData = { ...appState.segmentData };
                            
                            // Import Jobs-to-be-Done fields
                            if (jobsToBeDone) {
                                Object.keys(jobsToBeDone).forEach(field => {
                                    if (jobsToBeDone[field] && jobsToBeDone[field].trim()) {
                                        newSegmentData[field] = jobsToBeDone[field];
                                    }
                                });
                            }
                            
                            // Import Customer Value fields
                            if (customerValue) {
                                Object.keys(customerValue).forEach(field => {
                                    if (customerValue[field] && customerValue[field].trim()) {
                                        newSegmentData[field] = customerValue[field];
                                    }
                                });
                            }
                            
                            // Import Willingness to Pay fields
                            if (willingnessToPay) {
                                Object.keys(willingnessToPay).forEach(field => {
                                    if (willingnessToPay[field] && willingnessToPay[field].trim()) {
                                        newSegmentData[field] = willingnessToPay[field];
                                    }
                                });
                            }
                            
                            // Update app state with imported data
                            setAppState(prev => ({
                                ...prev,
                                segmentData: newSegmentData
                            }));
                            
                            // Show success message with statistics
                            const { stats, warnings } = validation;
                            let message = `Successfully imported ${stats.populatedJtbd + stats.populatedCustomerValue + stats.populatedWtp} fields from ${stats.totalFields} total fields.`;
                            
                            if (warnings.length > 0) {
                                message += ` Warnings: ${warnings.join('; ')}`;
                                setImportMessageType('warning');
                            } else {
                                setImportMessageType('success');
                            }
                            
                            setImportMessage(message);
                            
                            // Auto-clear message after 10 seconds
                            setTimeout(() => {
                                setImportMessage(null);
                                setImportMessageType('');
                            }, 10000);
                            
                        } catch (error) {
                            setImportMessage(`Failed to parse JSON file: ${error.message}`);
                            setImportMessageType('error');
                        }
                    };
                    
                    reader.onerror = () => {
                        setImportMessage('Failed to read file. Please try again.');
                        setImportMessageType('error');
                    };
                    
                    reader.readAsText(file);
                };
                
                // Trigger file selection
                document.body.appendChild(fileInput);
                fileInput.click();
                document.body.removeChild(fileInput);
            };
            
            return (
                <div className="container mx-auto px-4 sm:px-6 lg:px-8 min-h-screen pb-16">
                    {/* AI-Generated Banner */}
                    {appState.aiGeneratedSegment && !appState.aiGeneratedBannerDismissed && (
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 flex items-center justify-between">
                            <div className="flex items-center space-x-3">
                                <div className="flex-shrink-0">
                                    <svg className="w-5 h-5 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd"></path>
                                    </svg>
                                </div>
                                <div className="flex-1">
                                    <p className="text-sm font-medium text-blue-800">
                                        AI-Generated Draft
                                    </p>
                                    <p className="text-sm text-blue-600">
                                        This form has been pre-populated with AI-generated insights based on your company analysis. Review and edit as needed.
                                    </p>
                                </div>
                            </div>
                            <button
                                onClick={() => setAppState(prev => ({ ...prev, aiGeneratedBannerDismissed: true }))}
                                className="flex-shrink-0 ml-4 text-blue-400 hover:text-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-blue-50 rounded-md p-1"
                                aria-label="Dismiss banner"
                            >
                                <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                    )}
                    
                    <header style={{
                        position: 'sticky',
                        top: '73px',
                        zIndex: 40,
                        backgroundColor: 'white',
                        borderBottom: '1px solid #e5e7eb',
                        padding: '1rem 0',
                        boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)'
                    }}>
                        <div className="flex justify-between items-center">
                            <h1 className="text-xl sm:text-2xl font-bold scale-green-text">Part 1: Segment Foundation</h1>
                            {React.createElement(PrimaryActions, {
                                currentPart: 'segment',
                                onReset: handleReset,
                                onImport: handleImport,
                                onExport: handleExport,
                                onContinue: () => { 
                                    markPartAsCompleted('segment'); 
                                    onNavigate('icp'); 
                                    window.scrollTo(0, 0); 
                                }
                            })}
                        </div>
                    </header>

                    {/* Import Status Message */}
                    {importMessage && (
                        <div className={`mt-4 p-4 rounded-lg border ${
                            importMessageType === 'success' ? 'bg-green-50 border-green-200 text-green-800' :
                            importMessageType === 'warning' ? 'bg-yellow-50 border-yellow-200 text-yellow-800' :
                            'bg-red-50 border-red-200 text-red-800'
                        }`}>
                            <div className="flex items-center">
                                <div className="flex-shrink-0">
                                    {importMessageType === 'success' && (
                                        <svg className="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                                        </svg>
                                    )}
                                    {importMessageType === 'warning' && (
                                        <svg className="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                                        </svg>
                                    )}
                                    {importMessageType === 'error' && (
                                        <svg className="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                                        </svg>
                                    )}
                                </div>
                                <div className="ml-3 flex-1">
                                    <p className="text-sm font-medium">
                                        {importMessage}
                                    </p>
                                </div>
                                <div className="ml-4 flex-shrink-0">
                                    <button
                                        onClick={() => {
                                            setImportMessage(null);
                                            setImportMessageType('');
                                        }}
                                        className="text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 rounded-md p-1"
                                    >
                                        <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="mt-8">
                        <div className="lg:flex lg:space-x-8">
                            {/* Sticky Navigation Sidebar */}
                            <nav className="hidden lg:block w-64 flex-shrink-0 sticky top-36 h-fit">
                                <div className="bg-white p-6 rounded-lg shadow-md">
                                    <h3 className="text-lg font-semibold text-gray-800 mb-4">Section Navigation</h3>
                                    <ul className="space-y-3">
                                        <li>
                                            <a 
                                                href="#jtbd-section" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('jtbd-section').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                Jobs to be Done
                                            </a>
                                        </li>
                                        <li>
                                            <a 
                                                href="#value-section" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('value-section').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                Customer Value
                                            </a>
                                        </li>
                                        <li>
                                            <a 
                                                href="#wtp-section" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('wtp-section').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                Willingness to Pay
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </nav>
                            
                            <main className="flex-1 min-w-0">
                                <div className="space-y-8">
                                    {/* Market Segment Definition Header */}
                                    <div id="segment-definition-section" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                                        <div className="text-center mb-8">
                                            <p className="text-lg text-gray-700 mb-8 max-w-4xl mx-auto">
                                                A true market segment is composed of customers who share a common Job to be Done, 
                                                perceive value similarly, and have a similar Willingness to Pay.
                                            </p>
                                            
                                            {/* Segment Foundation Summary */}
                                            <div className="bg-gray-50 rounded-lg p-6 mb-6 max-w-4xl mx-auto">
                                                <div className="text-center mb-4">
                                                    <h3 className="text-lg font-semibold text-gray-800 mb-3">Market Segmentation Process</h3>
                                                    <p className="text-gray-600 mb-4">
                                                        We filter the total market through three criteria: <strong>Jobs to be Done</strong> (shared context & struggling moments),
                                                        <strong>Customer Value</strong> (similar value priorities), and <strong>Willingness to Pay</strong> (investment threshold).
                                                    </p>
                                                    <button
                                                        onClick={() => openTourAtStep(1)}
                                                        className="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors duration-200"
                                                    >
                                                        <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                                        </svg>
                                                        View Interactive Diagram
                                                    </button>
                                                </div>
                                            </div>

                                            <p className="text-sm text-gray-600 mt-4 max-w-3xl mx-auto">
                                                The three input sections below help you define each filter criterion to identify your true market segment.
                                            </p>
                                        </div>
                                    </div>
                                    
                                    {/* Jobs To Be Done Section */}
                                    <div id="jtbd-section" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                                        <h2 className="text-2xl font-bold scale-green-text mb-6">Jobs To Be Done</h2>
                                        <div className="space-y-6">
                                            {[
                                                { name: 'Context', description: 'The business situation or operating environment.', placeholder: 'Quarterly close process across distributed finance teams.' },
                                                { name: 'Struggling Moments', description: 'Breakdowns, inefficiencies, or risks that trigger the search.', placeholder: 'Errors in revenue recognition delaying financial reporting.' },
                                                { name: 'Pushes & Pulls', description: 'Internal and external forces moving them toward or away from change.', placeholder: 'CFO pressure to modernize systems vs. IT reluctance to add new vendors.' },
                                                { name: 'Anxieties & Habits', description: 'Concerns about adopting something new, and inertia with current processes/tools.', placeholder: 'Fear of migration failure; comfort with spreadsheets.' },
                                                { name: 'Desired Outcomes', description: 'We will refine this outcome into specific types of value in the **Customer Value** section', placeholder: 'Reduce audit prep time by 50%; ensure SOX compliance.' },
                                                { name: 'Basic Quality (Table Stakes)', description: 'Minimum standards a solution must meet to even be considered.', placeholder: 'SOC2 compliance, API integrations with ERP, enterprise-grade security.' },
                                                { name: 'Hiring Criteria', description: 'Differentiators that make them select one vendor.', placeholder: 'Proven implementation playbook; reference customers in financial services.' },
                                                { name: 'Firing Criteria', description: 'Triggers that get a vendor rejected or replaced.', placeholder: 'System downtime; lack of role-based access control.' },
                                                { name: 'Key Trade-offs', description: 'Acceptable compromises or limits.', placeholder: 'May sacrifice customization for faster time to value.' }
                                            ].map(field => (
                                                <div key={field.name}>
                                                    <label className="block text-lg font-semibold text-gray-800 mb-2">{field.name}</label>
                                                    <p className="text-gray-600 text-sm mb-3">{field.description}</p>
                                                    <textarea
                                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                        rows="3"
                                                        value={appState.segmentData[field.name] || ''}
                                                        onChange={(e) => {
                                                            const newSegmentData = { ...appState.segmentData, [field.name]: e.target.value };
                                                            setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                        }}
                                                        placeholder={field.placeholder}
                                                    />
                                                    {/* Validate button removed for simplification */}
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Customer Value Section */}
                                    <div id="value-section" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                                        <h2 className="text-2xl font-bold scale-green-text mb-6">Customer Value</h2>
                                        
                                        <div className="space-y-6">
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Table Stakes</label>
                                                <p className="text-gray-600 text-sm mb-3">The non-negotiables for credibility and trust. Baseline requirements.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Table Stakes'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Table Stakes': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: SOC2 certification; ERP integration; 99.9% uptime SLAs."
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Functional Value</label>
                                                <p className="text-gray-600 text-sm mb-3">Tangible, measurable outcomes—ROI, efficiency, cost savings, growth, or risk mitigation.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Functional Value'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Functional Value': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: $500K OpEx savings from faster close cycles and fewer errors."
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Ease of Doing Business</label>
                                                <p className="text-gray-600 text-sm mb-3">How simple you make adoption and daily use. Less friction wins.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Ease of Doing Business'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Ease of Doing Business': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: Fast implementation playbook; role-based onboarding; 24/7 enterprise support."
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Individual Value</label>
                                                <p className="text-gray-600 text-sm mb-3">What matters to each buyer personally—status, workload relief, confidence, or career gains.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Individual Value'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Individual Value': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: CFO is seen as innovator; IT leader feels secure; end users save hours."
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Aspirational Value</label>
                                                <p className="text-gray-600 text-sm mb-3">Alignment with higher-order goals and purpose. Motivations beyond rational ROI.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Aspirational Value'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Aspirational Value': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: Supports ESG reporting; signals innovation to board and investors."
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    {/* Willingness to Pay Section */}
                                    <div id="wtp-section" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                                        <h2 className="text-2xl font-bold scale-green-text mb-6">Willingness to Pay</h2>
                                        
                                        <div className="space-y-6">
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Ability to Pay</label>
                                                <p className="text-gray-600 text-sm mb-3">Whether the customer has budget and capacity to spend. Even strong solutions fail without funding.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Ability to Pay'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Ability to Pay': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: Line item already approved in FY25 budget for compliance automation."
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Economic Justification</label>
                                                <p className="text-gray-600 text-sm mb-3">Whether the ROI and payback case makes financial sense. Customers want proof it pays for itself.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Economic Justification'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Economic Justification': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: Pays for itself in under 12 months through $1M annual cost avoidance."
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Relative Value vs. Alternatives</label>
                                                <p className="text-gray-600 text-sm mb-3">How your solution compares to competitors or the status quo. Clear differentiation increases willingness to pay.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Relative Value vs. Alternatives'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Relative Value vs. Alternatives': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: Automates 80% of manual work versus consultant-heavy models."
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Risk & Switching Costs</label>
                                                <p className="text-gray-600 text-sm mb-3">How much risk or friction they see in making the change. Higher risk lowers willingness; mitigation raises it.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Risk & Switching Costs'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Risk & Switching Costs': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: Migration takes days, not months; vendor assumes implementation risk."
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Market Reference Points</label>
                                                <p className="text-gray-600 text-sm mb-3">The pricing anchors customers bring from prior spend or competitors. Buyers benchmark against "similar" tools.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Market Reference Points'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Market Reference Points': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: Analytics platforms in this space usually run $100K–$150K annually."
                                                />
                                            </div>
                                        </div>
                                        
                                        {/* Clear All Fields Button */}
                                        <div className="mt-8 text-center">
                                            <button
                                                onClick={() => {
                                                    // Clear all JTBD and Customer Value fields
                                                    const clearedSegmentData = {};
                                                    setAppState(prev => ({ ...prev, segmentData: clearedSegmentData }));
                                                    alert('All fields cleared! Refresh the page to see placeholder text.');
                                                }}
                                                className="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600 transition-colors mr-4"
                                            >
                                                Clear All Fields
                                            </button>
                                            
                                            {/* Continue to Part 2 Button */}
                                            <button
                                                onClick={() => { 
                                                    markPartAsCompleted('segment');
                                                    onNavigate('icp'); 
                                                    window.scrollTo(0, 0); 
                                                }}
                                                className="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition-colors"
                                            >
                                                Continue to ICP Definition
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </main>
                        </div>
                    </div>

                    <ExportModal 
                        isOpen={exportModalOpen}
                        onClose={() => setExportModalOpen(false)}
                        title="Segment Foundation Summary"
                        content={exportContent}
                        appState={appState}
                        filename="segment-foundation-export"
                        partData={exportData}
                    />
                </div>
            );
        };

        // ICPFlowVisualization Component
        const ICPFlowVisualization = ({ appState, onNavigate, openTourAtStep }) => {
            const [hoveredSection, setHoveredSection] = useState(null);
            const [tooltipPosition, setTooltipPosition] = useState({ x: 0, y: 0 });
            
            // Check completion status for progressive states
            const isSegmentComplete = appState.segmentData && 
                Object.values(appState.segmentData).some(value => value && typeof value === 'string' && value.trim().length > 0);
            
            const isICPStarted = appState.positioningData && (
                appState.positioningData.icp_summary ||
                (appState.positioningData.values && appState.positioningData.values.some(v => v.val1))
            );
            
            const isICPComplete = appState.positioningData && 
                appState.positioningData.icp_summary && 
                appState.positioningData.values && 
                appState.positioningData.values.length > 0 &&
                appState.positioningData.values[0].val1;
            
            // Tooltip content for each section
            const tooltips = {
                segment: {
                    title: "Market Segment Foundation",
                    content: "Your foundational customer understanding from Part 1: Segment Foundation. This includes Jobs-to-be-Done, Customer Value propositions, and Willingness to Pay analysis.",
                    action: "Click to edit Segment Foundation"
                },
                bridge: {
                    title: "Strategic Bridge Analysis",
                    content: "The analytical work required to transform market segment insights into actionable ICP. This involves validating Product-Problem Fit and confirming your Scalable Business Model.",
                    action: "This represents your current analysis work"
                },
                strategic: {
                    title: "Strategic ICP - The 'Why'",
                    content: "The strategic reasoning behind your ICP focused on messaging and positioning. Includes the fundamental motivations, value drivers, and job-to-be-done insights.",
                    action: "Click to work on Strategic ICP elements"
                },
                operational: {
                    title: "Operational ICP - The 'Where'",
                    content: "The tactical targeting criteria for campaigns and sales. Includes firmographics, technographics, and behavioral signals for finding and reaching prospects.",
                    action: "Click to work on Operational ICP elements"
                }
            };
            
            // Handle mouse events for tooltips
            const handleMouseEnter = (section, event) => {
                setHoveredSection(section);
                const rect = event.currentTarget.getBoundingClientRect();
                setTooltipPosition({
                    x: rect.left + rect.width / 2,
                    y: rect.top - 10
                });
            };
            
            const handleMouseLeave = () => {
                setHoveredSection(null);
            };
            
            // Handle click navigation
            const handleSectionClick = (section) => {
                switch (section) {
                    case 'segment':
                        onNavigate('segment');
                        window.scrollTo(0, 0);
                        break;
                    case 'strategic':
                    case 'operational':
                        // Stay on current page but scroll to ICP definition
                        const icpSection = document.getElementById('section-1');
                        if (icpSection) {
                            icpSection.scrollIntoView({ behavior: 'smooth' });
                        }
                        break;
                    default:
                        break;
                }
            };
            
            return (
                <div className="mb-8 bg-white p-6 rounded-lg shadow-md">
                    <h3 className="text-lg font-bold text-gray-800 mb-4 text-center">Strategic Flow: From Market Segment to Actionable ICP</h3>

                    {/* ICP Development Summary */}
                    <div className="bg-gray-50 rounded-lg p-6 text-center">
                        <p className="text-gray-600 mb-4 max-w-3xl mx-auto">
                            Your <strong>Market Segment Foundation</strong> (JTBD, Value, WTP) combines with <strong>Product & Business Model Fit</strong>
                            to create an <strong>Actionable ICP</strong> with both <em>Strategic Why</em> (messaging & positioning) and <em>Operational Where</em> (targeting & campaigns).
                        </p>
                        <button
                            onClick={() => openTourAtStep(2)}
                            className="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors duration-200"
                        >
                            <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            View Interactive Flow
                        </button>
                    </div>
                </div>
            );
        };

        // ICPDefinitionTool Component - Updated with openTourAtStep
        const ICPDefinitionTool = ({ appState, setAppState, onNavigate, markPartAsCompleted, openTourAtStep }) => {
            const [exportModal, setExportModal] = useState({ isOpen: false, content: '', title: '' });
            const [gradingState, setGradingState] = useState({});
            const [analysisState, setAnalysisState] = useState({});
            const [uniquenessResults, setUniquenessResults] = useState({});
            const [trendAnalysisResults, setTrendAnalysisResults] = useState({});
            
            // F-8: Pillar Generation Modal State
            const [pillarGenModalOpen, setPillarGenModalOpen] = useState(false);
            const [pillarGenState, setPillarGenState] = useState({
                isGenerating: false,
                suggestedPillars: [],
                error: null,
                refinementInputs: {}
            });
            
            // Import state variables
            const [importMessage, setImportMessage] = useState(null);
            const [importMessageType, setImportMessageType] = useState(''); // 'success', 'error', 'warning'
            
            // Simulate AI grading for value propositions
            const simulateAIGrading = async (proposition, index) => {
                const { val1, val2, val3 } = proposition;
                
                // Set loading state
                setGradingState(prev => ({
                    ...prev,
                    [index]: { isGrading: true, score: null, feedback: null }
                }));
                
                // Simulate network delay
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Analyze proposition quality
                let score = 'C';
                let feedback = [];
                
                // Check attribute quality
                if (!val1 || val1.length < 10) {
                    feedback.push('Attribute needs more specificity and detail');
                } else if (val1.includes('AI') || val1.includes('intelligent') || val1.includes('automated')) {
                    score = score < 'B' ? 'B' : score;
                    feedback.push('Good use of compelling technology terms');
                }
                
                // Check benefit quality
                if (!val2 || val2.length < 15) {
                    feedback.push('Benefit statement should explain customer impact more clearly');
                } else if (val2.includes('reduces') || val2.includes('increases') || val2.includes('enables')) {
                    score = score < 'B+' ? 'B+' : score;
                    feedback.push('Strong benefit articulation with clear outcomes');
                }
                
                // Check value quality
                if (!val3 || val3.length < 10) {
                    feedback.push('Value statement needs quantifiable outcomes or proof points');
                } else if (val3.match(/\$|%|months?|weeks?|days?|hours?|\d+/)) {
                    score = 'A-';
                    feedback.push('Excellent quantifiable value with specific metrics');
                }
                
                // Assign final score
                if (val1 && val2 && val3 && val1.length > 10 && val2.length > 15 && val3.length > 15) {
                    if (score === 'C') score = 'B';
                }
                
                // Create final feedback
                const finalFeedback = feedback.length > 0 
                    ? feedback.join('. ') + '.'
                    : 'Complete all three fields with more specific details for better grading.';
                
                // Update grading state with results
                setGradingState(prev => ({
                    ...prev,
                    [index]: {
                        isGrading: false,
                        score,
                        feedback: finalFeedback,
                        timestamp: new Date().toISOString()
                    }
                }));
            };

            // Analyze uniqueness using web search API
            const analyzeUniqueness = async (attributeText, index) => {
                if (!attributeText || !attributeText.trim()) {
                    return;
                }

                setUniquenessResults(prev => ({
                    ...prev,
                    [index]: { isAnalyzing: true, results: null }
                }));

                try {
                    const response = await fetch('/api/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            query: `"${attributeText.trim()}" software features capabilities`
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const searchData = await response.json();
                    
                    // Extract relevant results for display
                    const results = searchData.web?.results?.slice(0, 3).map(result => ({
                        title: result.title,
                        description: result.description || result.snippet || 'No description available',
                        url: result.url
                    })) || [];

                    setUniquenessResults(prev => ({
                        ...prev,
                        [index]: {
                            isAnalyzing: false,
                            results,
                            timestamp: new Date().toISOString()
                        }
                    }));

                } catch (error) {
                    console.error('Uniqueness analysis error:', error);
                    setUniquenessResults(prev => ({
                        ...prev,
                        [index]: {
                            isAnalyzing: false,
                            error: 'Analysis unavailable - please try again later',
                            timestamp: new Date().toISOString()
                        }
                    }));
                }
            };
            
            // Analyze trend validation using web search
            const analyzeTrend = async (trendText, index) => {
                if (!trendText || !trendText.trim()) {
                    return;
                }

                setTrendAnalysisResults(prev => ({
                    ...prev,
                    [index]: { isAnalyzing: true, results: null }
                }));

                try {
                    const response = await fetch('/api/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            query: `"${trendText.trim()}" market trend industry analysis`
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const searchData = await response.json();
                    
                    // Extract relevant results for display
                    const results = searchData.web?.results?.slice(0, 3).map(result => ({
                        title: result.title,
                        description: result.description || result.snippet || 'No description available',
                        url: result.url
                    })) || [];

                    setTrendAnalysisResults(prev => ({
                        ...prev,
                        [index]: {
                            isAnalyzing: false,
                            results,
                            timestamp: new Date().toISOString()
                        }
                    }));

                } catch (error) {
                    console.error('Trend analysis error:', error);
                    setTrendAnalysisResults(prev => ({
                        ...prev,
                        [index]: {
                            isAnalyzing: false,
                            error: 'No strong evidence found for this trend. Consider rephrasing.',
                            timestamp: new Date().toISOString()
                        }
                    }));
                }
            };

            // --- START OF REPLACEMENT CODE for generatePart2SpecificData ---
            const generatePart2SpecificData = () => {
                const formatFieldValue = (fieldValue) => {
                    if (!fieldValue) return null;
                    return fieldValue.toString().trim() || null;
                };

                const segmentSummary = {
                    desiredOutcomes: formatFieldValue(appState.segmentData?.['Desired Outcomes']),
                    functionalValue: formatFieldValue(appState.segmentData?.['Functional Value']),
                    economicJustification: formatFieldValue(appState.segmentData?.['Economic Justification']),
                    tableStakes: formatFieldValue(appState.segmentData?.['Table Stakes']),
                    easeOfDoingBusiness: formatFieldValue(appState.segmentData?.['Ease of Doing Business']),
                    businessContext: `Context: ${formatFieldValue(appState.segmentData?.['Context']) || 'N/A'}\nStruggling Moments: ${formatFieldValue(appState.segmentData?.['Struggling Moments']) || 'N/A'}`
                };

                const icpData = {
                    quickDecisionMaking: formatFieldValue(appState.positioningData?.icp_quick_decision_making),
                    prioritizedRequirements: formatFieldValue(appState.positioningData?.icp_prioritized_requirements),
                    implementationReadiness: formatFieldValue(appState.positioningData?.icp_implementation_readiness),
                    firmographic: formatFieldValue(appState.positioningData?.icp_firmographic),
                    technographic: formatFieldValue(appState.positioningData?.icp_technographic),
                    behavioral: formatFieldValue(appState.positioningData?.icp_behavioral)
                };

                return {
                    metadata: {
                        exportDate: new Date().toISOString(),
                        partName: "ICP Definition",
                        company: {
                            name: appState.companyContext?.companyName || null,
                            url: appState.companyContext?.companyWebsite || null,
                            industry: appState.companyContext?.industry || null
                        }
                    },
                    content: {
                        segmentFoundationSummary: segmentSummary,
                        icpDefinition: icpData
                    }
                };
            };
            // --- END OF REPLACEMENT CODE ---

            // --- START OF REPLACEMENT CODE for generatePart2Markdown ---
            const generatePart2Markdown = (partData) => {
                let markdown = `# ICP Definition Summary\n\n`;

                // Company context
                if (partData.metadata.company.name) {
                    markdown += `**Company:** ${partData.metadata.company.name}\n`;
                    if (partData.metadata.company.url) {
                        markdown += `**URL:** ${partData.metadata.company.url}\n`;
                    }
                    markdown += `\n`;
                }

                markdown += `---\n\n`;

                // Segment Foundation Summary
                markdown += `## Segment Foundation Summary\n\n`;
                const summary = partData.content.segmentFoundationSummary;
                if (summary) {
                    markdown += `**Desired Outcomes:** ${summary.desiredOutcomes || 'Not provided'}\n\n`;
                    markdown += `**Functional Value:** ${summary.functionalValue || 'Not provided'}\n\n`;
                    markdown += `**Economic Justification:** ${summary.economicJustification || 'Not provided'}\n\n`;
                    markdown += `**Table Stakes:** ${summary.tableStakes || 'Not provided'}\n\n`;
                    markdown += `**Ease of Doing Business:** ${summary.easeOfDoingBusiness || 'Not provided'}\n\n`;
                    markdown += `**Business Context:**\n${summary.businessContext || 'Not provided'}\n\n`;
                }

                markdown += `---\n\n`;

                // ICP Definition fields
                markdown += `## ICP Definition\n\n`;
                const icp = partData.content.icpDefinition;
                if (icp) {
                    markdown += `**Quick Decision Making:** ${icp.quickDecisionMaking || 'Not provided'}\n\n`;
                    markdown += `**Prioritized Requirements:** ${icp.prioritizedRequirements || 'Not provided'}\n\n`;
                    markdown += `**Implementation Readiness:** ${icp.implementationReadiness || 'Not provided'}\n\n`;
                    markdown += `**Firmographic:** ${icp.firmographic || 'Not provided'}\n\n`;
                    markdown += `**Technographic:** ${icp.technographic || 'Not provided'}\n\n`;
                    markdown += `**Behavioral:** ${icp.behavioral || 'Not provided'}\n\n`;
                }

                markdown += `*Export generated on ${new Date(partData.metadata.exportDate).toLocaleString()}*`;
                return markdown;
            };
            // --- END OF REPLACEMENT CODE ---

            const handleExport = () => {
                // Generate structured data for both formats
                const partData = generatePart2SpecificData();
                
                // Generate markdown from structured data  
                const markdownContent = generatePart2Markdown(partData);
                
                // Open modal with both markdown and JSON data (fixed title)
                setExportModal({ 
                    isOpen: true, 
                    content: markdownContent, 
                    title: 'ICP Definition Summary',
                    partData: partData,
                    filename: 'icp-definition-export'
                });
            };

            // Schema validation function for ICP import data
            const validateICPImportData = (data) => {
                const errors = [];
                const warnings = [];

                // Check if data is an object
                if (!data || typeof data !== 'object') {
                    errors.push('Invalid file format. Expected JSON object.');
                    return { isValid: false, errors, warnings };
                }

                // Check required top-level structure
                if (!data.metadata || typeof data.metadata !== 'object') {
                    errors.push('Missing or invalid metadata section.');
                }

                if (!data.content || typeof data.content !== 'object') {
                    errors.push('Missing or invalid content section.');
                }

                if (errors.length > 0) {
                    return { isValid: false, errors, warnings };
                }

                // Validate metadata structure
                const { metadata } = data;
                if (!metadata.partName || metadata.partName !== 'ICP Definition') {
                    const detectedType = metadata?.partName || 'Unknown';
                    errors.push(`Wrong data type: Found "${detectedType}" data, but expected "ICP Definition" data. Please select an ICP Definition export file.`);
                }

                if (!metadata.company || typeof metadata.company !== 'object') {
                    warnings.push('Company information is missing or invalid.');
                }

                // Validate content structure
                const { content } = data;
                if (!content.icpDefinition || typeof content.icpDefinition !== 'object') {
                    errors.push('Missing or invalid icpDefinition section.');
                    return { isValid: false, errors, warnings };
                }

                // Validate ICP fields
                const icpFields = [
                    'quickDecisionMaking', 'prioritizedRequirements', 'implementationReadiness',
                    'firmographic', 'technographic', 'behavioral'
                ];

                // Count populated fields for quality assessment
                const populatedFields = icpFields.filter(field => 
                    content.icpDefinition[field] && content.icpDefinition[field].trim()
                ).length;

                if (populatedFields < 3) {
                    warnings.push(`Only ${populatedFields} of ${icpFields.length} ICP fields are populated.`);
                }

                return { 
                    isValid: errors.length === 0, 
                    errors, 
                    warnings,
                    stats: {
                        populatedFields,
                        totalFields: icpFields.length
                    }
                };
            };

            // Import handler function for ICP
            const handleImportICP = () => {
                // Create a hidden file input element
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.json';
                fileInput.style.display = 'none';
                
                fileInput.onchange = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    // Clear any previous messages
                    setImportMessage(null);
                    setImportMessageType('');
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            
                            // Validate the imported data
                            const validation = validateICPImportData(importedData);
                            
                            if (!validation.isValid) {
                                setImportMessage(`Import failed: ${validation.errors.join('; ')}`);
                                setImportMessageType('error');
                                return;
                            }
                            
                            // Process the import
                            const { content } = importedData;
                            const { icpDefinition } = content;
                            
                            // Map imported fields to the state
                            const fieldMapping = {
                                quickDecisionMaking: 'icp_quick_decision_making',
                                prioritizedRequirements: 'icp_prioritized_requirements',
                                implementationReadiness: 'icp_implementation_readiness',
                                firmographic: 'icp_firmographic',
                                technographic: 'icp_technographic',
                                behavioral: 'icp_behavioral'
                            };

                            const updates = {};
                            Object.keys(fieldMapping).forEach(importField => {
                                if (icpDefinition[importField] && icpDefinition[importField].trim()) {
                                    const stateField = fieldMapping[importField];
                                    updates[stateField] = icpDefinition[importField];
                                }
                            });

                            // Explicitly update the state to ensure re-render
                            setAppState(prev => ({
                                ...prev,
                                positioningData: {
                                    ...prev.positioningData,
                                    ...updates
                                }
                            }));
                            
                            // Show success message with statistics
                            const { stats, warnings } = validation;
                            let message = `Successfully imported ${stats.populatedFields} fields from ${stats.totalFields} total ICP fields.`;
                            
                            if (warnings.length > 0) {
                                message += ` Warnings: ${warnings.join('; ')}`;
                                setImportMessageType('warning');
                            } else {
                                setImportMessageType('success');
                            }
                            
                            setImportMessage(message);
                            
                            // Auto-clear message after 10 seconds
                            setTimeout(() => {
                                setImportMessage(null);
                                setImportMessageType('');
                            }, 10000);
                            
                        } catch (error) {
                            setImportMessage(`Failed to parse JSON file: ${error.message}`);
                            setImportMessageType('error');
                        }
                    };
                    
                    reader.onerror = () => {
                        setImportMessage('Failed to read file. Please try again.');
                        setImportMessageType('error');
                    };
                    
                    reader.readAsText(file);
                };
                
                // Trigger file selection
                document.body.appendChild(fileInput);
                fileInput.click();
                document.body.removeChild(fileInput);
            };

            return (
                <div className="container mx-auto px-4 sm:px-6 lg:px-8 min-h-screen pb-16">
                    <header style={{
                        position: 'sticky',
                        top: '73px',
                        zIndex: 40,
                        backgroundColor: 'white',
                        borderBottom: '1px solid #e5e7eb',
                        padding: '1rem 0',
                        boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)'
                    }}>
                        <div className="flex justify-between items-center">
                            <h1 className="text-xl sm:text-2xl font-bold scale-green-text">Part 2: ICP Definition</h1>
                            {React.createElement(PrimaryActions, {
                                currentPart: 'icp',
                                onReset: () => {
                                    if (window.confirm("Are you sure you want to reset all data for Part 2? This will clear all ICP and Positioning fields.")) {
                                        setAppState(prev => ({
                                            ...prev,
                                            positioningData: getInitialState().positioningData
                                        }));
                                    }
                                },
                                onImport: handleImportICP,
                                onExport: handleExport,
                                onContinue: () => { 
                                    markPartAsCompleted('icp'); 
                                    onNavigate('positioning'); 
                                    window.scrollTo(0, 0); 
                                }
                            })}
                        </div>
                    </header>

                    {/* Import Status Message */}
                    {importMessage && (
                        <div className={`mt-4 p-4 rounded-lg border ${
                            importMessageType === 'success' ? 'bg-green-50 border-green-200 text-green-800' :
                            importMessageType === 'warning' ? 'bg-yellow-50 border-yellow-200 text-yellow-800' :
                            'bg-red-50 border-red-200 text-red-800'
                        }`}>
                            <div className="flex items-center">
                                <div className="flex-shrink-0">
                                    {importMessageType === 'success' && (
                                        <svg className="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                                        </svg>
                                    )}
                                    {importMessageType === 'warning' && (
                                        <svg className="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                                        </svg>
                                    )}
                                    {importMessageType === 'error' && (
                                        <svg className="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                                        </svg>
                                    )}
                                </div>
                                <div className="ml-3 flex-1">
                                    <p className="text-sm font-medium">
                                        {importMessage}
                                    </p>
                                </div>
                                <div className="ml-4 flex-shrink-0">
                                    <button
                                        onClick={() => {
                                            setImportMessage(null);
                                            setImportMessageType('');
                                        }}
                                        className="text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 rounded-md p-1"
                                    >
                                        <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="mt-8">
                        <div className="lg:flex lg:space-x-8">
                            <main className="w-full">
                                <div className="space-y-8">
                        
                        {/* ICP Flow Visualization */}
                        <ICPFlowVisualization appState={appState} onNavigate={onNavigate} openTourAtStep={openTourAtStep} />
                        
                        <div id="section-1" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                            <h2 className="text-2xl font-bold scale-green-text mb-2">Define Your Ideal Customer Profile (ICP)</h2>
                            <p className="text-gray-600 mb-6">This is the foundation. A precise ICP provides the lens through which all other positioning elements are viewed. Be specific and use data where possible.</p>
                            
                            {/* Segment Foundation Summary */}
                            <div className="mb-8 p-6 bg-green-50 border border-green-200 rounded-lg">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold scale-green-text">Segment Foundation Summary</h3>
                                    <button 
                                        onClick={() => onNavigate('segment')}
                                        className="text-sm text-green-600 hover:text-green-800 font-semibold flex items-center gap-1"
                                    >
                                        ← Edit Segment Foundation
                                    </button>
                                </div>
                                
                                {/* Check if segment data exists */}
                                {appState.segmentData && Object.keys(appState.segmentData).some(key => appState.segmentData[key] && typeof appState.segmentData[key] === 'string' && appState.segmentData[key].trim()) ? (
                                    <div className="space-y-4">
                                        {/* Jobs to be Done Summary */}
                                        {appState.segmentData['Desired Outcomes'] && (
                                            <div>
                                                <h4 className="font-semibold text-gray-700 mb-1">Desired Outcomes</h4>
                                                <p className="text-sm text-gray-600 bg-white p-3 rounded border">
                                                    {appState.segmentData['Desired Outcomes']}
                                                </p>
                                            </div>
                                        )}
                                        
                                        {/* Customer Value Summary */}
                                        <div className="grid md:grid-cols-2 gap-4">
                                            {appState.segmentData['Functional Value'] && (
                                                <div>
                                                    <h4 className="font-semibold text-gray-700 mb-1">Functional Value</h4>
                                                    <p className="text-sm text-gray-600 bg-white p-3 rounded border">
                                                        {appState.segmentData['Functional Value']}
                                                    </p>
                                                </div>
                                            )}
                                            
                                            {appState.segmentData['Economic Justification'] && (
                                                <div>
                                                    <h4 className="font-semibold text-gray-700 mb-1">Economic Justification</h4>
                                                    <p className="text-sm text-gray-600 bg-white p-3 rounded border">
                                                        {appState.segmentData['Economic Justification']}
                                                    </p>
                                                </div>
                                            )}
                                            
                                            {appState.segmentData['Table Stakes'] && (
                                                <div>
                                                    <h4 className="font-semibold text-gray-700 mb-1">Table Stakes</h4>
                                                    <p className="text-sm text-gray-600 bg-white p-3 rounded border">
                                                        {appState.segmentData['Table Stakes']}
                                                    </p>
                                                </div>
                                            )}
                                            
                                            {appState.segmentData['Ease of Doing Business'] && (
                                                <div>
                                                    <h4 className="font-semibold text-gray-700 mb-1">Ease of Doing Business</h4>
                                                    <p className="text-sm text-gray-600 bg-white p-3 rounded border">
                                                        {appState.segmentData['Ease of Doing Business']}
                                                    </p>
                                                </div>
                                            )}
                                        </div>
                                        
                                        {/* Additional context fields if available */}
                                        {(appState.segmentData['Context'] || appState.segmentData['Struggling Moments']) && (
                                            <div className="pt-4 border-t border-green-200">
                                                <h4 className="font-semibold text-gray-700 mb-2">Business Context</h4>
                                                <div className="space-y-2">
                                                    {appState.segmentData['Context'] && (
                                                        <p className="text-sm text-gray-600">
                                                            <span className="font-medium">Context:</span> {appState.segmentData['Context']}
                                                        </p>
                                                    )}
                                                    {appState.segmentData['Struggling Moments'] && (
                                                        <p className="text-sm text-gray-600">
                                                            <span className="font-medium">Struggling Moments:</span> {appState.segmentData['Struggling Moments']}
                                                        </p>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <div className="text-center py-8">
                                        <div className="text-gray-500 mb-3">
                                            <span className="text-2xl">📝</span>
                                        </div>
                                        <h4 className="font-semibold text-gray-700 mb-2">No Segment Data Yet</h4>
                                        <p className="text-sm text-gray-600 mb-4">
                                            Complete Part 1 (Segment Foundation) to see your market segment data here.
                                        </p>
                                        <button 
                                            onClick={() => onNavigate('segment')}
                                            className="scale-green-bg text-white font-semibold py-2 px-4 rounded-lg hover:bg-opacity-90"
                                        >
                                            Go to Part 1: Segment Foundation
                                        </button>
                                    </div>
                                )}
                            </div>
                            
                            <div className="space-y-6">
                                <div>
                                    <label className="block font-bold text-gray-700">Quick Decision Making</label>
                                    <p className="text-sm text-gray-500 mb-2">Who is the economic buyer and can they approve the purchase efficiently?</p>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="3" 
                                        placeholder="Example: The VP of Finance is the economic buyer. They have budget authority up to $250k for transformation projects and can sign off without a lengthy committee review."
                                        value={appState.positioningData.icp_quick_decision_making || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, icp_quick_decision_making: e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Prioritized Requirements</label>
                                    <p className="text-sm text-gray-500 mb-2">What do they value most in a solution for this problem?</p>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="3" 
                                        placeholder="Example: Speed-to-insight is #1. We cannot wait 6 months for consultants. #2 is accuracy; the data must be audit-grade. #3 is ease of use for our internal team."
                                        value={appState.positioningData.icp_prioritized_requirements || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, icp_prioritized_requirements: e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Implementation Readiness</label>
                                    <p className="text-sm text-gray-500 mb-2">Can they adopt and get value from the product today?</p>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="3" 
                                        placeholder="Example: They have a dedicated transformation team ready to start. All relevant contracts and process documents are digitized and accessible."
                                        value={appState.positioningData.icp_implementation_readiness || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, icp_implementation_readiness: e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Firmographic</label>
                                    <p className="text-sm text-gray-500 mb-2">What are the key company attributes (size, industry, revenue)?</p>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="3" 
                                        placeholder="Example: Publicly traded B2B SaaS company, >$1B in annual revenue, 2000+ employees. Headquartered in North America."
                                        value={appState.positioningData.icp_firmographic || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, icp_firmographic: e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Technographic</label>
                                    <p className="text-sm text-gray-500 mb-2">What is their current technology stack?</p>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="3" 
                                        placeholder="Example: Currently using NetSuite, Salesforce, and Coupa. Moving to Oracle Fusion. Internal BI uses Tableau."
                                        value={appState.positioningData.icp_technographic || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, icp_technographic: e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Behavioral</label>
                                    <p className="text-sm text-gray-500 mb-2">How do they act, buy, and use technology?</p>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="3" 
                                        placeholder="Example: They are early adopters of AI technology in their finance stack. They prefer to buy best-of-breed solutions over suite extensions. They have a history of successful, large-scale software implementations."
                                        value={appState.positioningData.icp_behavioral || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, icp_behavioral: e.target.value } }))}
                                    />
                                </div>
                            </div>
                        </div>


                        {/* Navigation Buttons */}
                        <div className="mt-8 text-center">
                            <button
                                onClick={() => {
                                    // Clear all ICP and Positioning fields
                                    setAppState(prev => ({
                                        ...prev,
                                        positioningData: getInitialState().positioningData
                                    }));
                                    alert('All fields cleared! Refresh the page to see placeholder text.');
                                }}
                                className="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600 transition-colors mr-4"
                            >
                                Clear All Fields
                            </button>
                            
                            {/* Continue to Part 3 Button */}
                            <button
                                onClick={() => { 
                                    markPartAsCompleted('icp');
                                    onNavigate('positioning'); 
                                    window.scrollTo(0, 0); 
                                }}
                                className="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition-colors"
                            >
                                Continue to Positioning
                            </button>
                        </div>
                                </div>
                            </main>
                        </div>
                    </div>

                    <ExportModal 
                        isOpen={exportModal.isOpen}
                        onClose={() => setExportModal(prev => ({ ...prev, isOpen: false }))}
                        title={exportModal.title}
                        content={exportModal.content}
                        appState={appState}
                        filename={exportModal.filename || "icp-definition-export"}
                        partData={exportModal.partData}
                    />
                    
                </div>
            );
        };

        // Dynamic Field Components for PositioningTool
        const RemovableRow = ({ index, item, onUpdate, onRemove, placeholder1, placeholder2 }) => (
            <div className="space-y-3">
                <div className="flex items-center space-x-2">
                    <input 
                        type="text" 
                        className="w-1/2 p-2 border border-gray-300 rounded-md focus-ring-gold"
                        placeholder={placeholder1}
                        value={item.val1}
                        onChange={(e) => onUpdate(index, 'val1', e.target.value)}
                    />
                    <textarea 
                        className="w-1/2 p-2 border border-gray-300 rounded-md focus-ring-gold"
                        rows="3" 
                        placeholder={placeholder2}
                        value={item.val2}
                        onChange={(e) => onUpdate(index, 'val2', e.target.value)}
                    ></textarea>
                    <div className="flex flex-col space-y-2">
                        <button 
                            onClick={() => onRemove(index)}
                            className="text-gray-400 hover:text-red-600 font-bold text-2xl transition-colors"
                        >
                            ×
                        </button>
                    </div>
                </div>
                
            </div>
        );

        const RemovableAlternative = ({ index, item, onUpdate, onRemove }) => (
            <div className="space-y-3 p-4 border border-gray-200 rounded-lg bg-gray-50">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Alternative Name</label>
                        <input
                            type="text"
                            className="w-full p-2 border border-gray-300 rounded-md focus-ring-gold"
                            placeholder="e.g., Excel spreadsheets, Tableau, PowerBI"
                            value={item.val1}
                            onChange={(e) => onUpdate(index, 'val1', e.target.value)}
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea
                            className="w-full p-2 border border-gray-300 rounded-md focus-ring-gold"
                            rows="2"
                            placeholder="Brief explanation of what it is and how it works"
                            value={item.val2}
                            onChange={(e) => onUpdate(index, 'val2', e.target.value)}
                        ></textarea>
                    </div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Why Customers Choose This</label>
                        <textarea
                            className="w-full p-2 border border-gray-300 rounded-md focus-ring-gold"
                            rows="2"
                            placeholder="e.g., Low cost, simplicity, familiarity, incumbent status"
                            value={item.val3}
                            onChange={(e) => onUpdate(index, 'val3', e.target.value)}
                        ></textarea>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Weaknesses/Gaps</label>
                        <textarea
                            className="w-full p-2 border border-gray-300 rounded-md focus-ring-gold"
                            rows="2"
                            placeholder="e.g., Time-consuming, prone to errors, lacks scalability"
                            value={item.val4}
                            onChange={(e) => onUpdate(index, 'val4', e.target.value)}
                        ></textarea>
                    </div>
                </div>
                <div className="flex items-start space-x-2">
                    <div className="flex-1">
                        <label className="block text-sm font-medium text-gray-700 mb-1">Customer Proof</label>
                        <textarea
                            className="w-full p-2 border border-gray-300 rounded-md focus-ring-gold"
                            rows="2"
                            placeholder="Evidence: company names, quotes from reviews, survey data, case studies"
                            value={item.val5}
                            onChange={(e) => onUpdate(index, 'val5', e.target.value)}
                        ></textarea>
                    </div>
                    <div className="flex flex-col justify-end">
                        <button
                            onClick={() => onRemove(index)}
                            className="text-gray-400 hover:text-red-600 font-bold text-2xl transition-colors mt-6"
                            title="Remove this alternative"
                        >
                            ×
                        </button>
                    </div>
                </div>
            </div>
        );

        const RemovableInput = ({ index, item, onUpdate, onRemove, placeholder }) => (
            <div className="flex items-center space-x-2">
                <input 
                    type="text" 
                    className="w-full p-2 border border-gray-300 rounded-md focus-ring-gold"
                    placeholder={placeholder}
                    value={item.value}
                    onChange={(e) => onUpdate(index, 'value', e.target.value)}
                />
                <button 
                    onClick={() => onRemove(index)}
                    className="text-gray-400 hover:text-red-600 font-bold text-2xl transition-colors"
                >
                    ×
                </button>
            </div>
        );

        const RemovableTriple = ({ index, item, onUpdate, onRemove }) => (
            <div className="p-4 border border-gray-200 rounded-lg space-y-3 bg-gray-50">
                <div className="flex items-start space-x-2">
                    <div className="flex-grow">
                        <label className="block text-sm font-semibold text-gray-700 mb-1">
                            Truly Unique Attribute Name (&lt; 5 word name for the Feature or Capability):
                        </label>
                        <input 
                            type="text" 
                            className="w-full p-2 border border-gray-300 rounded-md focus-ring-gold"
                            placeholder="Example: Real-time collaborative analytics"
                            value={item.val1}
                            onChange={(e) => onUpdate(index, 'val1', e.target.value)}
                        />
                    </div>
                    <button 
                        onClick={() => onRemove(index)}
                        className="mt-6 text-gray-400 hover:text-red-600 font-bold text-2xl transition-colors"
                    >
                        ×
                    </button>
                </div>
                <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-1">
                        Attribute Description: (10+ word description highlighting the differentiation)
                    </label>
                    <textarea 
                        className="w-full p-2 border border-gray-300 rounded-md focus-ring-gold"
                        rows="3" 
                        placeholder="Example: Industry's only platform enabling simultaneous multi-user data exploration with instant synchronization across all dashboards"
                        value={item.val2}
                        onChange={(e) => onUpdate(index, 'val2', e.target.value)}
                    ></textarea>
                </div>
                <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-1">
                        Benefit: What the attribute enables for a customer
                    </label>
                    <textarea 
                        className="w-full p-2 border border-gray-300 rounded-md focus-ring-gold"
                        rows="2" 
                        placeholder="Example: Enables teams to make data-driven decisions together in real-time, eliminating version control issues and reducing meeting cycles"
                        value={item.val3}
                        onChange={(e) => onUpdate(index, 'val3', e.target.value)}
                    ></textarea>
                </div>
                <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-1">
                        Value: The metrics and KPIs the customer use to measure value created by this attribute
                    </label>
                    <textarea 
                        className="w-full p-2 border border-gray-300 rounded-md focus-ring-gold"
                        rows="2" 
                        placeholder="Example: 50% reduction in decision-making time, 3x faster insight discovery, $2M annual savings from eliminated redundant analysis"
                        value={item.val4}
                        onChange={(e) => onUpdate(index, 'val4', e.target.value)}
                    ></textarea>
                </div>
            </div>
        );

        // PositioningTool Component
        const PositioningTool = ({ appState, setAppState, onNavigate, markPartAsCompleted }) => {
            const [exportModal, setExportModal] = useState({ isOpen: false, content: '', title: '' });
            const [trendAnalysisResults, setTrendAnalysisResults] = useState({});
            const [pillarGenState, setPillarGenState] = useState({
                isGenerating: false,
                suggestedPillars: [],
                error: null,
                refinementInputs: {}
            });
            const [pillarGenModalOpen, setPillarGenModalOpen] = useState(false);
            const [importMessage, setImportMessage] = useState(null);
            const [importMessageType, setImportMessageType] = useState('');

            // Helper functions for nested data management
            const updateNestedValue = (section, index, key, value) => {
                const newData = { ...appState.positioningData };
                if (!newData[section]) newData[section] = [];
                if (!newData[section][index]) newData[section][index] = {};
                newData[section][index][key] = value;
                setAppState(prev => ({ ...prev, positioningData: newData }));
            };

            const addItem = (section, template) => {
                const newData = { ...appState.positioningData };
                if (!newData[section]) newData[section] = [];
                newData[section].push(template);
                setAppState(prev => ({ ...prev, positioningData: newData }));
            };

            const removeItem = (section, index) => {
                const newData = { ...appState.positioningData };
                if (newData[section]) {
                    newData[section].splice(index, 1);
                    setAppState(prev => ({ ...prev, positioningData: newData }));
                    // Clear grading state for removed item
                    setGradingState(prev => {
                        const newState = { ...prev };
                        delete newState[index];
                        return newState;
                    });
                }
            };

            // Simulate AI grading for value propositions
            const simulateAIGrading = async (proposition, index) => {
                const { val1, val2, val3 } = proposition;
                
                // Set loading state
                setGradingState(prev => ({
                    ...prev,
                    [index]: { isGrading: true, score: null, feedback: null }
                }));
                
                // Simulate network delay
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Analyze proposition quality
                let score = 'C';
                let feedback = [];
                
                // Check attribute quality
                if (!val1 || val1.length < 10) {
                    feedback.push('Attribute needs more specificity and detail');
                } else if (val1.includes('AI') || val1.includes('intelligent') || val1.includes('automated')) {
                    score = score < 'B' ? 'B' : score;
                    feedback.push('Good use of compelling technology terms');
                }
                
                // Check benefit quality
                if (!val2 || val2.length < 15) {
                    feedback.push('Benefit statement should explain customer impact more clearly');
                } else if (val2.includes('reduces') || val2.includes('increases') || val2.includes('enables')) {
                    score = score < 'B+' ? 'B+' : score;
                    feedback.push('Strong benefit articulation with clear outcomes');
                }
                
                // Check value quality
                if (!val3 || val3.length < 10) {
                    feedback.push('Value statement needs quantifiable outcomes or proof points');
                } else if (val3.match(/\$|%|months?|weeks?|days?|hours?|\d+/)) {
                    score = 'A-';
                    feedback.push('Excellent quantifiable value with specific metrics');
                }
                
                // Assign final score
                if (val1 && val2 && val3 && val1.length > 10 && val2.length > 15 && val3.length > 15) {
                    if (score === 'C') score = 'B';
                }
                
                // Create final feedback
                const finalFeedback = feedback.length > 0 
                    ? feedback.join('. ') + '.'
                    : 'Complete all three fields with more specific details for better grading.';
                
                // Update grading state with results
                setGradingState(prev => ({
                    ...prev,
                    [index]: {
                        isGrading: false,
                        score,
                        feedback: finalFeedback,
                        timestamp: new Date().toISOString()
                    }
                }));
            };

            // Analyze uniqueness using web search API
            const analyzeUniqueness = async (attributeText, index) => {
                if (!attributeText || !attributeText.trim()) {
                    return;
                }

                setUniquenessResults(prev => ({
                    ...prev,
                    [index]: { isAnalyzing: true, results: null }
                }));

                try {
                    const response = await fetch('/api/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            query: `"${attributeText.trim()}" software features capabilities`
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const searchData = await response.json();
                    
                    // Extract relevant results for display
                    const results = searchData.web?.results?.slice(0, 3).map(result => ({
                        title: result.title,
                        description: result.description || result.snippet || 'No description available',
                        url: result.url
                    })) || [];

                    setUniquenessResults(prev => ({
                        ...prev,
                        [index]: {
                            isAnalyzing: false,
                            results,
                            timestamp: new Date().toISOString()
                        }
                    }));

                } catch (error) {
                    console.error('Uniqueness analysis error:', error);
                    setUniquenessResults(prev => ({
                        ...prev,
                        [index]: {
                            isAnalyzing: false,
                            error: 'Analysis unavailable - please try again later',
                            timestamp: new Date().toISOString()
                        }
                    }));
                }
            };

            // Validate imported Part 3 positioning data
            const validatePositioningImportData = (data) => {
                const errors = [];

                // Validate basic structure
                if (!data || typeof data !== 'object') {
                    errors.push('Invalid file structure - expected JSON object');
                    return { isValid: false, errors };
                }

                // Validate metadata
                if (!data.metadata || typeof data.metadata !== 'object') {
                    errors.push('Missing or invalid metadata section');
                } else {
                    if (!data.metadata.partName || data.metadata.partName !== 'Positioning') {
                        const detectedType = data.metadata?.partName || 'Unknown';
                        errors.push(`Wrong data type: Found "${detectedType}" data, but expected "Positioning" data. Please select a Positioning export file.`);
                    }
                    if (!data.metadata.exportDate) {
                        errors.push('Missing export date in metadata');
                    }
                }

                // Validate content structure
                if (!data.content || typeof data.content !== 'object') {
                    errors.push('Missing or invalid content section');
                    return { isValid: false, errors };
                }

                const { content } = data;

                // Validate competitiveAlternatives
                if (content.competitiveAlternatives !== undefined) {
                    if (!Array.isArray(content.competitiveAlternatives)) {
                        errors.push('competitiveAlternatives must be an array');
                    } else {
                        content.competitiveAlternatives.forEach((alt, index) => {
                            if (typeof alt !== 'object' || alt === null) {
                                errors.push(`competitiveAlternatives[${index}] must be an object`);
                            } else {
                                if (!alt.hasOwnProperty('alternative') || !alt.hasOwnProperty('description')) {
                                    errors.push(`competitiveAlternatives[${index}] must have 'alternative' and 'description' fields`);
                                }
                            }
                        });
                    }
                }

                // Validate uniqueValueAndProof
                if (content.uniqueValueAndProof !== undefined) {
                    if (!Array.isArray(content.uniqueValueAndProof)) {
                        errors.push('uniqueValueAndProof must be an array');
                    } else {
                        content.uniqueValueAndProof.forEach((val, index) => {
                            if (typeof val !== 'object' || val === null) {
                                errors.push(`uniqueValueAndProof[${index}] must be an object`);
                            } else {
                                // --- START of replacement for the 'if' condition in the uniqueValueAndProof validation loop ---
                                if (!val.hasOwnProperty('attributeName') || !val.hasOwnProperty('attributeDescription') || !val.hasOwnProperty('benefit') || !val.hasOwnProperty('value')) {
                                    errors.push(`uniqueValueAndProof[${index}] must have 'attributeName', 'attributeDescription', 'benefit', and 'value' fields`);
                                }
                                // --- END of replacement ---
                            }
                        });
                    }
                }

                // Validate marketCategory (optional string)
                if (content.marketCategory !== undefined && typeof content.marketCategory !== 'string') {
                    errors.push('marketCategory must be a string');
                }

                // Validate categoryName (optional string)
                if (content.categoryName !== undefined && typeof content.categoryName !== 'string') {
                    errors.push('categoryName must be a string');
                }

                // Validate relevantTrends
                if (content.relevantTrends !== undefined) {
                    if (typeof content.relevantTrends !== 'object' || content.relevantTrends === null || Array.isArray(content.relevantTrends)) {
                        errors.push('relevantTrends must be an object');
                    } else {
                        // Validate trend fields
                        const validTrendKeys = ['trend1', 'trend2', 'trend3', 'trend4'];
                        Object.keys(content.relevantTrends).forEach(key => {
                            if (!validTrendKeys.includes(key)) {
                                errors.push(`Invalid trend key: ${key}. Valid keys are: ${validTrendKeys.join(', ')}`);
                            }
                            if (typeof content.relevantTrends[key] !== 'string') {
                                errors.push(`${key} must be a string`);
                            }
                        });
                    }
                }

                return {
                    isValid: errors.length === 0,
                    errors
                };
            };

            // Handle import of Part 3 positioning data
            const handleImportPositioning = () => {
                // Create a hidden file input element
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.json';
                fileInput.style.display = 'none';
                
                fileInput.onchange = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    // Clear any previous messages
                    setImportMessage(null);
                    setImportMessageType('');
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            
                            // Validate the imported data
                            const validation = validatePositioningImportData(importedData);
                            
                            if (!validation.isValid) {
                                setImportMessage(`Import failed: ${validation.errors.join('; ')}`);
                                setImportMessageType('error');
                                return;
                            }
                            
                            // Process the import - perform reverse transformation
                            const { content } = importedData;
                            const updates = {};
                            
                            // Transform competitive alternatives: enhanced 5-field structure → {val1, val2, val3, val4, val5}
                            if (content.competitiveAlternatives && Array.isArray(content.competitiveAlternatives)) {
                                updates.alternatives = content.competitiveAlternatives.map(alt => ({
                                    val1: alt.alternative || '',
                                    val2: alt.description || '',
                                    val3: alt.whyCustomersChoose || '',
                                    val4: alt.weaknessesOrGaps || '',
                                    val5: alt.customerProof || ''
                                }));
                            }
                            
                            // --- START of replacement for the uniqueValueAndProof transformation ---
                            if (content.uniqueValueAndProof && Array.isArray(content.uniqueValueAndProof)) {
                                updates.values = content.uniqueValueAndProof.map(val => ({
                                    val1: val.attributeName || '',
                                    val2: val.attributeDescription || '',
                                    val3: val.benefit || '',
                                    val4: val.value || ''
                                }));
                            }
                            // --- END of replacement ---
                            
                            // Map market category
                            if (content.marketCategory && content.marketCategory.trim()) {
                                updates['market-context'] = content.marketCategory;
                            }
                            
                            // Map category name
                            if (content.categoryName && content.categoryName.trim()) {
                                updates['category-name'] = content.categoryName;
                            }
                            
                            // Transform trends: {trend1, trend2, ...} → trend1_desc, trend2_desc, ...
                            if (content.relevantTrends && typeof content.relevantTrends === 'object') {
                                Object.entries(content.relevantTrends).forEach(([key, value]) => {
                                    if (value && value.trim()) {
                                        updates[`${key}_desc`] = value;
                                    }
                                });
                            }
                            
                            // Apply updates using immutable pattern, preserving existing ICP fields
                            setAppState(prev => ({
                                ...prev,
                                positioningData: {
                                    ...prev.positioningData,
                                    ...updates
                                }
                            }));
                            
                            setImportMessage('Part 3 positioning data imported successfully!');
                            setImportMessageType('success');
                            
                        } catch (error) {
                            setImportMessage(`Import failed: Invalid JSON file format - ${error.message}`);
                            setImportMessageType('error');
                        }
                    };
                    
                    reader.readAsText(file);
                };
                
                // Trigger file selection
                document.body.appendChild(fileInput);
                fileInput.click();
                document.body.removeChild(fileInput);
            };

            // Generate Part 3 specific data for dual-format export
            const generatePart3SpecificData = () => {
                const exportDate = new Date().toISOString();
                
                // Utility to format field values with future-proofing
                const formatFieldValue = (fieldValue) => {
                    if (Array.isArray(fieldValue)) {
                        return fieldValue.filter(item => item && item.toString().trim()).join('; ');
                    }
                    return fieldValue && fieldValue.toString().trim() || null;
                };

                // Generate focused ICP summary for Target Market Characteristics
                const generateTargetMarketIcpSummary = () => {
                    if (!appState.segmentData?.icpDefinition) return null;
                    
                    const icp = appState.segmentData.icpDefinition;
                    const characteristics = {};
                    
                    if (icp.firmographic) {
                        characteristics.firmographic = formatFieldValue(icp.firmographic);
                    }
                    if (icp.technographic) {
                        characteristics.technographic = formatFieldValue(icp.technographic);
                    }
                    if (icp.behavioral) {
                        characteristics.behavioral = formatFieldValue(icp.behavioral);
                    }
                    if (icp.quickDecisionMaking) {
                        characteristics.decisionMaking = formatFieldValue(icp.quickDecisionMaking);
                    }
                    if (icp.prioritizedRequirements) {
                        characteristics.keyRequirements = formatFieldValue(icp.prioritizedRequirements);
                    }
                    
                    return Object.keys(characteristics).length > 0 ? characteristics : null;
                };

                // Format competitive alternatives
                const formatCompetitiveAlternatives = () => {
                    if (!appState.positioningData.alternatives || !Array.isArray(appState.positioningData.alternatives)) {
                        return [{ alternative: null, description: null, whyCustomersChoose: null, weaknessesOrGaps: null, customerProof: null }];
                    }
                    
                    return appState.positioningData.alternatives.map(alt => ({
                        alternative: formatFieldValue(alt.val1),
                        description: formatFieldValue(alt.val2),
                        whyCustomersChoose: formatFieldValue(alt.val3),
                        weaknessesOrGaps: formatFieldValue(alt.val4),
                        customerProof: formatFieldValue(alt.val5)
                    }));
                };

                // Format unique value and proof
                const formatUniqueValueAndProof = () => {
                    if (!appState.positioningData.values || !Array.isArray(appState.positioningData.values)) {
                        return [{ attribute: null, benefit: null, value: null }];
                    }
                    
                    // --- START of replacement for formatUniqueValueAndProof return statement ---
                    return appState.positioningData.values.map(val => ({
                        attribute: formatFieldValue(val.val1),
                        attributeDescription: formatFieldValue(val.val2),
                        benefit: formatFieldValue(val.val3),
                        value: formatFieldValue(val.val4)
                    }));
                    // --- END of replacement ---
                };

                // Get market category
                const getMarketCategory = () => {
                    if (appState.positioningData['market-context'] === 'Other') {
                        return formatFieldValue(appState.positioningData['market-context-other']);
                    }
                    return formatFieldValue(appState.positioningData['market-context']);
                };

                // Format relevant trends
                const formatRelevantTrends = () => {
                    return {
                        trend1: formatFieldValue(appState.positioningData.trend1_desc),
                        trend2: formatFieldValue(appState.positioningData.trend2_desc),
                        trend3: formatFieldValue(appState.positioningData.trend3_desc),
                        trend4: formatFieldValue(appState.positioningData.trend4_desc)
                    };
                };

                return {
                    metadata: {
                        exportDate: exportDate,
                        partName: "Positioning",
                        company: {
                            name: formatFieldValue(appState.companyData?.name),
                            url: formatFieldValue(appState.companyData?.url),
                            productName: formatFieldValue(appState.companyData?.productName),
                            industry: formatFieldValue(appState.companyData?.industry)
                        }
                    },
                    content: {
                        competitiveAlternatives: formatCompetitiveAlternatives(),
                        uniqueValueAndProof: formatUniqueValueAndProof(),
                        marketCategory: getMarketCategory(),
                        categoryName: formatFieldValue(appState.positioningData?.['category-name']),
                        targetMarketCharacteristics: generateTargetMarketIcpSummary(),
                        relevantTrends: formatRelevantTrends()
                    }
                };
            };

            // Generate Part 3 markdown content
            const generatePart3Markdown = (data) => {
                let markdown = `# Positioning\n\n`;
                
                // Add metadata
                if (data.metadata.company.name) {
                    markdown += `**Company:** ${data.metadata.company.name}\n`;
                }
                if (data.metadata.company.url) {
                    markdown += `**Website:** ${data.metadata.company.url}\n`;
                }
                if (data.metadata.company.productName) {
                    markdown += `**Product:** ${data.metadata.company.productName}\n`;
                }
                if (data.metadata.company.industry) {
                    markdown += `**Industry:** ${data.metadata.company.industry}\n`;
                }
                markdown += `**Export Date:** ${new Date(data.metadata.exportDate).toLocaleString()}\n\n`;
                
                markdown += `---\n\n`;

                // Competitive Alternatives
                markdown += `## Competitive Alternatives\n\n`;
                if (data.content.competitiveAlternatives.length > 0 && data.content.competitiveAlternatives[0].alternative) {
                    data.content.competitiveAlternatives.forEach((alt, index) => {
                        if (alt.alternative) {
                            markdown += `**${index + 1}. ${alt.alternative}**\n`;
                            if (alt.description) {
                                markdown += `   ${alt.description}\n\n`;
                            } else {
                                markdown += `\n`;
                            }
                        }
                    });
                } else {
                    markdown += `*No competitive alternatives defined*\n\n`;
                }

                // Unique Value and Proof
                markdown += `## Unique Value and Proof\n\n`;
                if (data.content.uniqueValueAndProof.length > 0 && data.content.uniqueValueAndProof[0].attribute) {
                    data.content.uniqueValueAndProof.forEach((item, index) => {
                        if (item.attribute) {
                            markdown += `**${index + 1}. ${item.attribute}**\n`;
                            if (item.benefit) {
                                markdown += `   **Benefit:** ${item.benefit}\n`;
                            }
                            if (item.value) {
                                markdown += `   **Value:** ${item.value}\n`;
                            }
                            markdown += `\n`;
                        }
                    });
                } else {
                    markdown += `*No unique value and proof defined*\n\n`;
                }

                // Market Category
                markdown += `## Market Category\n\n`;
                if (data.content.marketCategory) {
                    markdown += `**Market Context:** ${data.content.marketCategory}\n\n`;
                } else {
                    markdown += `**Market Context:** *No market category defined*\n\n`;
                }
                
                // Category Name
                if (data.content.categoryName) {
                    markdown += `**Category Name:** ${data.content.categoryName}\n\n`;
                } else {
                    markdown += `**Category Name:** *No category name specified*\n\n`;
                }

                // Target Market Characteristics
                markdown += `## Target Market Characteristics\n\n`;
                if (data.content.targetMarketCharacteristics) {
                    const characteristics = data.content.targetMarketCharacteristics;
                    if (characteristics.firmographic) {
                        markdown += `    **Firmographic**: ${characteristics.firmographic}\n`;
                    }
                    if (characteristics.technographic) {
                        markdown += `    **Technographic**: ${characteristics.technographic}\n`;
                    }
                    if (characteristics.behavioral) {
                        markdown += `    **Behavioral**: ${characteristics.behavioral}\n`;
                    }
                    if (characteristics.decisionMaking) {
                        markdown += `    **Decision Making**: ${characteristics.decisionMaking}\n`;
                    }
                    if (characteristics.keyRequirements) {
                        markdown += `    **Key Requirements**: ${characteristics.keyRequirements}\n`;
                    }
                    markdown += `\n`;
                } else {
                    markdown += `*No target market characteristics defined*\n\n`;
                }

                // Relevant Trends
                markdown += `## Relevant Trends\n\n`;
                const trends = data.content.relevantTrends;
                let hasTrends = false;
                
                ['trend1', 'trend2', 'trend3', 'trend4'].forEach((trendKey, index) => {
                    if (trends[trendKey]) {
                        markdown += `    **Trend ${index + 1}:** ${trends[trendKey]}\n`;
                        hasTrends = true;
                    }
                });
                
                if (hasTrends) {
                    markdown += `\n`;
                } else {
                    markdown += `*No relevant trends defined*\n\n`;
                }

                return markdown;
            };

            // Export functionality for positioning data (dual-format)
            const exportData = () => {
                const data = generatePart3SpecificData();
                const markdownContent = generatePart3Markdown(data);
                
                setExportModal({
                    isOpen: true,
                    content: markdownContent,
                    title: 'Positioning Export',
                    filename: 'positioning-export',
                    partData: data
                });
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    <ExportModal 
                        isOpen={exportModal.isOpen}
                        onClose={() => setExportModal({ isOpen: false, content: '', title: '' })}
                        title={exportModal.title}
                        content={exportModal.content}
                        appState={appState}
                        filename={exportModal.filename || "positioning-export"}
                        partData={exportModal.partData}
                    />
                    
                    {/* Header */}
                    <header style={{
                        position: 'sticky',
                        top: '73px',
                        zIndex: 40,
                        backgroundColor: 'white',
                        borderBottom: '1px solid #e5e7eb',
                        padding: '1rem 0',
                        boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)'
                    }}>
                        <div className="container mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center">
                                <h1 className="text-xl sm:text-2xl font-bold scale-green-text">Part 3: Positioning</h1>
                            {React.createElement(PrimaryActions, {
                                currentPart: 'positioning',
                                onReset: () => {
                                    if (window.confirm("Are you sure you want to reset all data for Part 3? This will clear all Positioning fields.")) {
                                        setAppState(prev => ({
                                            ...prev,
                                            positioningData: getInitialState().positioningData
                                        }));
                                    }
                                },
                                onExport: exportData,
                                onImport: handleImportPositioning,
                                onContinue: () => { 
                                    markPartAsCompleted('positioning'); 
                                    onNavigate('category'); 
                                    window.scrollTo(0, 0); 
                                }
                            })}
                            </div>
                        </div>
                    </header>

                    {/* Import Message */}
                    {importMessage && (
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-4">
                            <div className={`p-4 rounded-md ${importMessageType === 'error' ? 'bg-red-50 border border-red-200' : 'bg-green-50 border border-green-200'}`}>
                                <div className="flex">
                                    <div className={`${importMessageType === 'error' ? 'text-red-800' : 'text-green-800'}`}>
                                        <p className="text-sm font-medium">{importMessage}</p>
                                    </div>
                                    <div className="ml-auto pl-3">
                                        <button
                                            onClick={() => setImportMessage(null)}
                                            className={`${importMessageType === 'error' ? 'text-red-400 hover:text-red-600' : 'text-green-400 hover:text-green-600'} transition-colors`}
                                        >
                                            <span className="sr-only">Dismiss</span>
                                            <svg className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Layout with Sidebar Navigation */}
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        <div className="lg:flex lg:space-x-8">
                            {/* Sticky Navigation Sidebar */}
                            <nav className="hidden lg:block w-64 flex-shrink-0 sticky top-36 h-fit">
                                <div className="bg-white p-6 rounded-lg shadow-md">
                                    <h3 className="text-lg font-semibold text-gray-800 mb-4">Section Navigation</h3>
                                    <ul className="space-y-3">
                                        <li>
                                            <a 
                                                href="#section-1" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('section-1').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                Competitive Alternatives
                                            </a>
                                        </li>
                                        <li>
                                            <a 
                                                href="#section-2" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('section-2').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                Unique Value and Proof
                                            </a>
                                        </li>
                                        <li>
                                            <a 
                                                href="#section-3" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('section-3').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                Market Category
                                            </a>
                                        </li>
                                        <li>
                                            <a 
                                                href="#section-4" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('section-4').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                Target Market Characteristics
                                            </a>
                                        </li>
                                        <li>
                                            <a 
                                                href="#section-5" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('section-5').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                Relevant Trends
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </nav>
                            
                            <main className="flex-1 min-w-0">
                                <div className="space-y-8">
                            
                            {/* Section 1: Competitive Alternatives */}
                            <div id="section-1" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                                <h2 className="text-2xl font-bold scale-green-text mb-2">Competitive Alternatives</h2>
                                <p className="text-gray-600 mb-6">What are your target customers currently using to solve this problem?</p>
                                <div className="space-y-4">
                                    {(appState.positioningData?.alternatives || []).map((item, index) =>
                                        React.createElement(RemovableAlternative, {
                                            key: index,
                                            index: index,
                                            item: item,
                                            onUpdate: (idx, key, value) => updateNestedValue('alternatives', idx, key, value),
                                            onRemove: (idx) => removeItem('alternatives', idx)
                                        })
                                    )}
                                    <button
                                        onClick={() => addItem('alternatives', { val1: '', val2: '', val3: '', val4: '', val5: '' })}
                                        className="bg-blue-600 text-white font-bold py-2 px-4 rounded hover:bg-blue-700"
                                    >
                                        + Add Alternative
                                    </button>
                                </div>
                            </div>
                            
                            {/* Section 2: Unique Value & Proof */}
                            <div id="section-2" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                                <h2 className="text-2xl font-bold scale-green-text mb-2">Unique Value & Proof</h2>
                                <p className="text-gray-600 mb-6">What unique attributes deliver measurable value to your customers?</p>
                                <div className="space-y-4">
                                    {(appState.positioningData?.values || []).map((item, index) => 
                                        React.createElement(RemovableTriple, {
                                            key: index,
                                            index: index,
                                            item: item,
                                            onUpdate: (idx, key, value) => updateNestedValue('values', idx, key, value),
                                            onRemove: (idx) => removeItem('values', idx)
                                        })
                                    )}
                                    <button
                                        onClick={() => addItem('values', { val1: '', val2: '', val3: '', val4: '' })}
                                        className="bg-blue-600 text-white font-bold py-2 px-4 rounded hover:bg-blue-700"
                                    >
                                        + Add Value Proposition
                                    </button>
                                </div>
                            </div>
                            
                            {/* Section 3: Market Category */}
                            <div id="section-3" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                                <h2 className="text-2xl font-bold scale-green-text mb-2">Market Category</h2>
                                <p className="text-gray-600 mb-6">Define how customers and analysts will categorize your solution.</p>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block font-bold text-gray-700 mb-2">Market Context</label>
                                        <select
                                            className="w-full p-2 border border-gray-300 rounded-md"
                                            value={appState.positioningData?.['market-context'] || ''}
                                            onChange={(e) => setAppState(prev => ({ 
                                                ...prev, 
                                                positioningData: { ...prev.positioningData, 'market-context': e.target.value } 
                                            }))}
                                        >
                                            <option value="">Select market category...</option>
                                            <option value="New Category">New Category</option>
                                            <option value="Existing Category">Existing Category</option>
                                            <option value="Sub-category">Sub-category</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    {/* Show additional input if "Other" is selected */}
                                    {appState.positioningData?.['market-context'] === 'Other' && (
                                        <div>
                                            <label className="block font-bold text-gray-700 mb-2">Specify Market Context</label>
                                            <input
                                                type="text"
                                                className="w-full p-2 border border-gray-300 rounded-md"
                                                placeholder="Enter your specific market context..."
                                                value={appState.positioningData?.['market-context-other'] || ''}
                                                onChange={(e) => setAppState(prev => ({ 
                                                    ...prev, 
                                                    positioningData: { ...prev.positioningData, 'market-context-other': e.target.value } 
                                                }))}
                                            />
                                        </div>
                                    )}
                                    
                                    {/* Category Name Field */}
                                    <div>
                                        <label className="block font-bold text-gray-700 mb-2">Category Name</label>
                                        <input
                                            type="text"
                                            className="w-full p-2 border border-gray-300 rounded-md"
                                            placeholder="Enter the name of your chosen category..."
                                            value={appState.positioningData?.['category-name'] || ''}
                                            onChange={(e) => setAppState(prev => ({ 
                                                ...prev, 
                                                positioningData: { ...prev.positioningData, 'category-name': e.target.value } 
                                            }))}
                                        />
                                    </div>
                                </div>
                            </div>
                            
                            {/* Section 4: Target Market Characteristics */}
                            <div id="section-4" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                                <h2 className="text-2xl font-bold scale-green-text mb-2">Target Market Characteristics</h2>
                                <p className="text-gray-600 mb-6">Who will care most about your unique value?</p>
                                <div className="space-y-4">
                                    {/* Display ICP data from Part 2 */}
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                        <h3 className="text-lg font-bold text-blue-800 mb-2">ICP Summary from Part 2</h3>
                                        <div className="space-y-2">
                                            {appState.positioningData?.icp_summary ? 
                                                <p className="text-blue-700">{appState.positioningData.icp_summary}</p> :
                                                <p className="text-blue-600 italic">Complete Part 2: ICP Definition to see your target market characteristics here</p>
                                            }
                                        </div>
                                    </div>
                                    {/* Additional ICP details */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {/* Firmographic */}
                                        {appState.positioningData?.icp_firmographic && (
                                            <div className="p-3 bg-gray-50 rounded-lg">
                                                <h4 className="font-bold text-gray-800 mb-1">Firmographic</h4>
                                                <p className="text-sm text-gray-700">{appState.positioningData.icp_firmographic}</p>
                                            </div>
                                        )}
                                        {/* Technographic */}
                                        {appState.positioningData?.icp_technographic && (
                                            <div className="p-3 bg-gray-50 rounded-lg">
                                                <h4 className="font-bold text-gray-800 mb-1">Technographic</h4>
                                                <p className="text-sm text-gray-700">{appState.positioningData.icp_technographic}</p>
                                            </div>
                                        )}
                                        {/* Behavioral */}
                                        {appState.positioningData?.icp_behavioral && (
                                            <div className="p-3 bg-gray-50 rounded-lg">
                                                <h4 className="font-bold text-gray-800 mb-1">Behavioral</h4>
                                                <p className="text-sm text-gray-700">{appState.positioningData.icp_behavioral}</p>
                                            </div>
                                        )}
                                        {/* Implementation Readiness */}
                                        {appState.positioningData?.icp_implementation_readiness && (
                                            <div className="p-3 bg-gray-50 rounded-lg">
                                                <h4 className="font-bold text-gray-800 mb-1">Implementation Readiness</h4>
                                                <p className="text-sm text-gray-700">{appState.positioningData.icp_implementation_readiness}</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                            
                            {/* Section 5: Relevant Trends */}
                            <div id="section-5" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                                <h2 className="text-2xl font-bold scale-green-text mb-2">Relevant Trends</h2>
                                <p className="text-gray-600 mb-6">What market trends create urgency for your solution?</p>
                                <div className="space-y-6">
                                    {/* Trend 1 */}
                                    <div>
                                        <label className="block font-bold text-gray-700 mb-2">Industry Trend 1</label>
                                        <textarea
                                            className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                            rows="2"
                                            placeholder="Example: AI automation is becoming table stakes in enterprise software"
                                            value={appState.positioningData?.trend1_desc || ''}
                                            onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, trend1_desc: e.target.value } }))}
                                        />
                                    </div>
                                    {/* Trend 2 */}
                                    <div>
                                        <label className="block font-bold text-gray-700 mb-2">Industry Trend 2</label>
                                        <textarea
                                            className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                            rows="2"
                                            placeholder="Example: Remote work is driving demand for cloud-based collaboration"
                                            value={appState.positioningData?.trend2_desc || ''}
                                            onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, trend2_desc: e.target.value } }))}
                                        />
                                    </div>
                                    {/* Trend 3 */}
                                    <div>
                                        <label className="block font-bold text-gray-700 mb-2">Industry Trend 3</label>
                                        <textarea
                                            className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                            rows="2"
                                            placeholder="Example: Regulatory compliance requirements are becoming more stringent"
                                            value={appState.positioningData?.trend3_desc || ''}
                                            onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, trend3_desc: e.target.value } }))}
                                        />
                                    </div>
                                    {/* Trend 4 */}
                                    <div>
                                        <label className="block font-bold text-gray-700 mb-2">Industry Trend 4</label>
                                        <textarea
                                            className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                            rows="2"
                                            placeholder="Example: Customer expectations for real-time data insights"
                                            value={appState.positioningData?.trend4_desc || ''}
                                            onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, trend4_desc: e.target.value } }))}
                                        />
                                    </div>
                                </div>
                            </div>
                            
                            {/* Clear All Fields Button */}
                            <div className="mt-8 text-center">
                                <button
                                    onClick={() => {
                                        // Clear all Positioning fields
                                        const clearedPositioningData = {};
                                        setAppState(prev => ({ ...prev, positioningData: clearedPositioningData }));
                                        alert('All fields cleared! Refresh the page to see placeholder text.');
                                    }}
                                    className="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600 transition-colors mr-4"
                                >
                                    Clear All Fields
                                </button>
                                
                                {/* Continue to Part 4 Button */}
                                <button
                                    onClick={() => { 
                                        markPartAsCompleted('positioning');
                                        onNavigate('category'); 
                                        window.scrollTo(0, 0); 
                                    }}
                                    className="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition-colors"
                                >
                                    Continue to Category Design
                                </button>
                            </div>
                                </div>
                            </main>
                        </div>
                    </div>
                </div>
            );
        };

        // CategoryDesignTool Component
        const CategoryDesignTool = ({ appState, setAppState, onNavigate, markPartAsCompleted }) => {
            const [exportModal, setExportModal] = useState({ isOpen: false, content: '', title: '' });
            const [importMessage, setImportMessage] = useState(null);
            const [importMessageType, setImportMessageType] = useState('');

            // Validation function for category import data
            const validateCategoryImportData = (data) => {
                const errors = [];
                
                if (!data || typeof data !== 'object') {
                    errors.push('Invalid JSON format');
                    return { isValid: false, errors };
                }
                
                if (!data.metadata || data.metadata.partName !== 'Category Design') {
                    const detectedType = data.metadata?.partName || 'Unknown';
                    errors.push(`Wrong data type: Found "${detectedType}" data, but expected "Category Design" data. Please select a Category Design export file.`);
                }
                
                if (!data.content || typeof data.content !== 'object') {
                    errors.push('Missing or invalid content section');
                }
                
                return { isValid: errors.length === 0, errors };
            };

            // Handle import for Category Design
            const handleImportCategory = () => {
                // Create a hidden file input element
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.json';
                fileInput.style.display = 'none';
                
                fileInput.onchange = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    // Clear any previous messages
                    setImportMessage(null);
                    setImportMessageType('');
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            
                            // Validate the imported data
                            const validation = validateCategoryImportData(importedData);
                            
                            if (!validation.isValid) {
                                setImportMessage(`Import failed: ${validation.errors.join('; ')}`);
                                setImportMessageType('error');
                                return;
                            }
                            
                            // Process the import
                            const { content } = importedData;
                            const updates = {};
                            
                            // Map Point of View fields from export format to internal state
                            if (content.pointOfView) {
                                if (content.pointOfView.fromStatement) updates['from-statement'] = content.pointOfView.fromStatement;
                                if (content.pointOfView.toStatement) updates['to-statement'] = content.pointOfView.toStatement;
                            }
                            if (content.newOpportunity) updates['new-opportunity'] = content.newOpportunity;
                            if (content.categoryName && content.categoryName.name) updates['category-name'] = content.categoryName.name;
                            if (content.categoryName && content.categoryName.definition) updates['category-definition'] = content.categoryName.definition;
                            if (content.manifesto) updates['manifesto'] = content.manifesto;
                            if (content.marketCategory) updates['market-category'] = content.marketCategory;
                            
                            // Target market characteristics
                            if (content.targetMarketCharacteristics) {
                                const tm = content.targetMarketCharacteristics;
                                if (tm.summary) updates['target-market-summary'] = tm.summary;
                                if (tm.firmographic) updates['target-market-firmographic'] = tm.firmographic;
                                if (tm.technographic) updates['target-market-technographic'] = tm.technographic;
                                if (tm.behavioral) updates['target-market-behavioral'] = tm.behavioral;
                                if (tm.implementationReadiness) updates['target-market-readiness'] = tm.implementationReadiness;
                            }
                            
                            // Update the state
                            setAppState(prev => ({
                                ...prev,
                                categoryData: {
                                    ...prev.categoryData,
                                    ...updates
                                }
                            }));
                            
                            setImportMessage(`Successfully imported ${Object.keys(updates).length} fields from Category Design data`);
                            setImportMessageType('success');
                            
                        } catch (error) {
                            console.error('Import error:', error);
                            setImportMessage(`Import failed: ${error.message}`);
                            setImportMessageType('error');
                        }
                    };
                    
                    reader.readAsText(file);
                };
                
                // Trigger file dialog
                document.body.appendChild(fileInput);
                fileInput.click();
                document.body.removeChild(fileInput);
            };
            

            // Generate Part 4 specific data for dual-format export
            const generatePart4SpecificData = () => {
                const exportDate = new Date().toISOString();
                
                // Utility to format field values with future-proofing
                const formatFieldValue = (fieldValue) => {
                    if (Array.isArray(fieldValue)) {
                        return fieldValue.filter(item => item && item.toString().trim()).join('; ');
                    }
                    return fieldValue && fieldValue.toString().trim() || null;
                };

                // Generate comprehensive positioning foundation summary from Part 3 data
                const generatePositioningFoundationSummary = () => {
                    if (!appState.positioningData) return null;
                    
                    const foundation = {};
                    
                    // 1. Competitive Alternatives
                    if (appState.positioningData.alternatives && Array.isArray(appState.positioningData.alternatives)) {
                        const alternatives = appState.positioningData.alternatives
                            .filter(alt => alt && alt.val1)
                            .map(alt => ({
                                alternative: formatFieldValue(alt.val1),
                                description: formatFieldValue(alt.val2),
                                whyCustomersChoose: formatFieldValue(alt.val3),
                                weaknessesOrGaps: formatFieldValue(alt.val4),
                                customerProof: formatFieldValue(alt.val5)
                            }));
                        if (alternatives.length > 0) {
                            foundation.competitiveAlternatives = alternatives;
                        }
                    }
                    
                    // 2. Unique Value & Proof
                    if (appState.positioningData.values && Array.isArray(appState.positioningData.values)) {
                        const values = appState.positioningData.values
                            .filter(v => v && v.val1)
                            .map(v => ({
                                attribute: formatFieldValue(v.val1),
                                attributeDescription: formatFieldValue(v.val2),
                                benefit: formatFieldValue(v.val3),
                                value: formatFieldValue(v.val4)
                            }));
                        if (values.length > 0) {
                            foundation.uniqueValueAndProof = values;
                        }
                    }
                    
                    // 3. Market Category
                    if (appState.positioningData['market-context']) {
                        foundation.marketCategory = appState.positioningData['market-context'] === 'Other' 
                            ? formatFieldValue(appState.positioningData['market-context-other'])
                            : formatFieldValue(appState.positioningData['market-context']);
                    }
                    
                    // 4. Target Market Characteristics
                    const targetMarket = {};
                    if (appState.positioningData.icp_summary) {
                        targetMarket.summary = formatFieldValue(appState.positioningData.icp_summary);
                    }
                    if (appState.positioningData.icp_firmographic) {
                        targetMarket.firmographic = formatFieldValue(appState.positioningData.icp_firmographic);
                    }
                    if (appState.positioningData.icp_technographic) {
                        targetMarket.technographic = formatFieldValue(appState.positioningData.icp_technographic);
                    }
                    if (appState.positioningData.icp_behavioral) {
                        targetMarket.behavioral = formatFieldValue(appState.positioningData.icp_behavioral);
                    }
                    if (appState.positioningData.icp_implementation_readiness) {
                        targetMarket.implementationReadiness = formatFieldValue(appState.positioningData.icp_implementation_readiness);
                    }
                    if (Object.keys(targetMarket).length > 0) {
                        foundation.targetMarketCharacteristics = targetMarket;
                    }
                    
                    // 5. Relevant Trends
                    const trends = [];
                    if (appState.positioningData.trend1_desc) trends.push(formatFieldValue(appState.positioningData.trend1_desc));
                    if (appState.positioningData.trend2_desc) trends.push(formatFieldValue(appState.positioningData.trend2_desc));
                    if (appState.positioningData.trend3_desc) trends.push(formatFieldValue(appState.positioningData.trend3_desc));
                    if (appState.positioningData.trend4_desc) trends.push(formatFieldValue(appState.positioningData.trend4_desc));
                    if (trends.length > 0) {
                        foundation.relevantTrends = trends;
                    }
                    
                    return Object.keys(foundation).length > 0 ? foundation : null;
                };

                return {
                    metadata: {
                        exportDate: exportDate,
                        partName: "Category Design",
                        company: {
                            name: formatFieldValue(appState.companyData?.name),
                            url: formatFieldValue(appState.companyData?.url),
                            productName: formatFieldValue(appState.companyData?.productName),
                            industry: formatFieldValue(appState.companyData?.industry)
                        }
                    },
                    content: {
                        positioningFoundation: generatePositioningFoundationSummary(),
                        pointOfView: {
                            fromStatement: formatFieldValue(appState.categoryData?.['from-statement']),
                            toStatement: formatFieldValue(appState.categoryData?.['to-statement'])
                        },
                        newOpportunity: formatFieldValue(appState.categoryData?.['new-opportunity']),
                        categoryNameAndDefinition: {
                            name: formatFieldValue(appState.categoryData?.['category-name']),
                            definition: formatFieldValue(appState.categoryData?.['category-definition'])
                        },
                        manifesto: formatFieldValue(appState.categoryData?.['manifesto']),
                        marketCategory: formatFieldValue(appState.categoryData?.['market-category']),
                        targetMarketCharacteristics: {
                            summary: formatFieldValue(appState.categoryData?.['target-market-summary']),
                            firmographic: formatFieldValue(appState.categoryData?.['target-market-firmographic']),
                            technographic: formatFieldValue(appState.categoryData?.['target-market-technographic']),
                            behavioral: formatFieldValue(appState.categoryData?.['target-market-behavioral']),
                            implementationReadiness: formatFieldValue(appState.categoryData?.['target-market-readiness'])
                        }
                    }
                };
            };

            // Generate Part 4 markdown content
            const generatePart4Markdown = (data) => {
                let markdown = `# Category Design\n\n`;
                
                // Add metadata
                if (data.metadata.company.name) {
                    markdown += `**Company:** ${data.metadata.company.name}\n`;
                }
                if (data.metadata.company.url) {
                    markdown += `**Website:** ${data.metadata.company.url}\n`;
                }
                if (data.metadata.company.productName) {
                    markdown += `**Product:** ${data.metadata.company.productName}\n`;
                }
                if (data.metadata.company.industry) {
                    markdown += `**Industry:** ${data.metadata.company.industry}\n`;
                }
                markdown += `**Export Date:** ${new Date(data.metadata.exportDate).toLocaleString()}\n\n`;
                
                markdown += `---\n\n`;

                // Positioning Foundation
                markdown += `## Positioning Foundation\n\n`;
                if (data.content.positioningFoundation) {
                    const foundation = data.content.positioningFoundation;
                    
                    // 1. Competitive Alternatives
                    if (foundation.competitiveAlternatives && foundation.competitiveAlternatives.length > 0) {
                        markdown += `### 1. Competitive Alternatives\n`;
                        foundation.competitiveAlternatives.forEach(alt => {
                            markdown += `- **${alt.alternative}**${alt.description ? `: ${alt.description}` : ''}\n`;
                        });
                        markdown += `\n`;
                    }
                    
                    // 2. Unique Value & Proof
                    if (foundation.uniqueValueAndProof && foundation.uniqueValueAndProof.length > 0) {
                        markdown += `### 2. Unique Value & Proof\n`;
                        foundation.uniqueValueAndProof.forEach(value => {
                            markdown += `- **${value.attribute}**\n`;
                            if (value.attributeDescription) {
                                markdown += `  - *Description:* ${value.attributeDescription}\n`;
                            }
                            if (value.benefit) {
                                markdown += `  - *Benefit:* ${value.benefit}\n`;
                            }
                            if (value.value) {
                                markdown += `  - *Value & Proof:* ${value.value}\n`;
                            }
                            markdown += `\n`;
                        });
                    }
                    
                    // 3. Market Category
                    if (foundation.marketCategory) {
                        markdown += `### 3. Market Category\n`;
                        markdown += `${foundation.marketCategory}\n\n`;
                    }
                    
                    // 4. Target Market Characteristics
                    if (foundation.targetMarketCharacteristics) {
                        markdown += `### 4. Target Market Characteristics\n`;
                        const tm = foundation.targetMarketCharacteristics;
                        if (tm.summary) {
                            markdown += `**Summary:** ${tm.summary}\n\n`;
                        }
                        if (tm.firmographic) {
                            markdown += `**Firmographic:** ${tm.firmographic}\n\n`;
                        }
                        if (tm.technographic) {
                            markdown += `**Technographic:** ${tm.technographic}\n\n`;
                        }
                        if (tm.behavioral) {
                            markdown += `**Behavioral:** ${tm.behavioral}\n\n`;
                        }
                        if (tm.implementationReadiness) {
                            markdown += `**Implementation Readiness:** ${tm.implementationReadiness}\n\n`;
                        }
                    }
                    
                    // 5. Relevant Trends
                    if (foundation.relevantTrends && foundation.relevantTrends.length > 0) {
                        markdown += `### 5. Relevant Trends\n`;
                        foundation.relevantTrends.forEach((trend, index) => {
                            markdown += `${index + 1}. ${trend}\n`;
                        });
                        markdown += `\n`;
                    }
                } else {
                    markdown += `*No positioning foundation data available*\n\n`;
                }

                // Point of View (The "From/To" Shift)
                markdown += `## The Point of View (The "From/To" Shift)\n\n`;
                if (data.content.pointOfView.fromStatement || data.content.pointOfView.toStatement) {
                    if (data.content.pointOfView.fromStatement) {
                        markdown += `    **From:** ${data.content.pointOfView.fromStatement}\n`;
                    }
                    if (data.content.pointOfView.toStatement) {
                        markdown += `    **To:** ${data.content.pointOfView.toStatement}\n`;
                    }
                    markdown += `\n`;
                } else {
                    markdown += `*No point of view defined*\n\n`;
                }

                // The New Opportunity
                markdown += `## The New Opportunity\n\n`;
                if (data.content.newOpportunity) {
                    markdown += `${data.content.newOpportunity}\n\n`;
                } else {
                    markdown += `*No new opportunity defined*\n\n`;
                }

                // Category Name & Definition
                markdown += `## Category Name & Definition\n\n`;
                if (data.content.categoryNameAndDefinition.name || data.content.categoryNameAndDefinition.definition) {
                    if (data.content.categoryNameAndDefinition.name) {
                        markdown += `    **Name:** ${data.content.categoryNameAndDefinition.name}\n`;
                    }
                    if (data.content.categoryNameAndDefinition.definition) {
                        markdown += `    **Definition:** ${data.content.categoryNameAndDefinition.definition}\n`;
                    }
                    markdown += `\n`;
                } else {
                    markdown += `*No category name and definition specified*\n\n`;
                }

                // The Manifesto
                markdown += `## The Manifesto\n\n`;
                if (data.content.manifesto) {
                    markdown += `${data.content.manifesto}\n\n`;
                } else {
                    markdown += `*No manifesto defined*\n\n`;
                }

                // Market Category (Part 4 specific)
                markdown += `## Market Category\n\n`;
                if (data.content.marketCategory) {
                    markdown += `${data.content.marketCategory}\n\n`;
                } else {
                    markdown += `*No market category defined*\n\n`;
                }

                // Target Market Characteristics (Part 4 specific)
                markdown += `## Target Market Characteristics\n\n`;
                if (data.content.targetMarketCharacteristics && 
                    (data.content.targetMarketCharacteristics.summary ||
                     data.content.targetMarketCharacteristics.firmographic ||
                     data.content.targetMarketCharacteristics.technographic ||
                     data.content.targetMarketCharacteristics.behavioral ||
                     data.content.targetMarketCharacteristics.implementationReadiness)) {
                    const tm = data.content.targetMarketCharacteristics;
                    if (tm.summary) {
                        markdown += `**Summary:** ${tm.summary}\n\n`;
                    }
                    if (tm.firmographic) {
                        markdown += `**Firmographic:** ${tm.firmographic}\n\n`;
                    }
                    if (tm.technographic) {
                        markdown += `**Technographic:** ${tm.technographic}\n\n`;
                    }
                    if (tm.behavioral) {
                        markdown += `**Behavioral:** ${tm.behavioral}\n\n`;
                    }
                    if (tm.implementationReadiness) {
                        markdown += `**Implementation Readiness:** ${tm.implementationReadiness}\n\n`;
                    }
                } else {
                    markdown += `*No target market characteristics defined*\n\n`;
                }

                return markdown;
            };

            const handleExport = () => {
                try {
                    const data = generatePart4SpecificData();
                    const markdown = generatePart4Markdown(data);
                    
                    setExportModal({
                        isOpen: true,
                        content: markdown,
                        title: 'Category Design Export',
                        filename: 'category-design-export',
                        partData: data
                    });
                } catch (error) {
                    console.error("Error during Part 4 export:", error);
                    setExportModal({
                        isOpen: true,
                        content: "Error generating export. Please try again.",
                        title: 'Export Error'
                    });
                }
            };

            return (
                <div className="container mx-auto px-4 sm:px-6 lg:px-8 pb-32">
                    <header style={{
                        position: 'sticky',
                        top: '73px',
                        zIndex: 40,
                        backgroundColor: 'white',
                        borderBottom: '1px solid #e5e7eb',
                        padding: '1rem 0',
                        boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)'
                    }}>
                        <div className="flex justify-between items-center">
                            <h1 className="text-xl sm:text-2xl font-bold scale-green-text">Part 4: Category Design</h1>
                            {React.createElement(PrimaryActions, {
                                currentPart: 'category',
                                onImport: handleImportCategory,
                                onReset: () => {
                                    if (window.confirm("Are you sure you want to reset all data for Part 4? This will clear all Category Design fields.")) {
                                        setAppState(prev => ({
                                            ...prev,
                                            categoryData: getInitialState().categoryData
                                        }));
                                    }
                                },
                                onExport: handleExport,
                                onContinue: () => {
                                    // Complete Blueprint - could navigate to completion page or show success message
                                    alert('Blueprint Complete! All parts have been finished.');
                                    window.scrollTo(0, 0);
                                }
                            })}
                        </div>
                    </header>

                    {/* Import Message Display */}
                    {importMessage && (
                        <div className={`mt-4 p-4 rounded-md ${
                            importMessageType === 'success' 
                                ? 'bg-green-50 border border-green-200 text-green-800' 
                                : 'bg-red-50 border border-red-200 text-red-800'
                        }`}>
                            <div className="flex items-center">
                                <span className="font-medium">
                                    {importMessageType === 'success' ? '✅ ' : '❌ '}
                                    {importMessage}
                                </span>
                                <button 
                                    onClick={() => setImportMessage(null)}
                                    className="ml-auto text-sm opacity-70 hover:opacity-100"
                                >
                                    ✕
                                </button>
                            </div>
                        </div>
                    )}

                    <div className="mt-8">
                        <div className="lg:flex lg:space-x-8">
                            {/* Sticky Navigation Sidebar */}
                            <nav className="hidden lg:block w-64 flex-shrink-0 sticky top-36 h-fit">
                                <div className="bg-white p-6 rounded-lg shadow-md">
                                    <h3 className="text-lg font-semibold text-gray-800 mb-4">Section Navigation</h3>
                                    <ul className="space-y-3">
                                        <li>
                                            <a 
                                                href="#positioning-foundation" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('positioning-foundation').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                Positioning Foundation
                                            </a>
                                        </li>
                                        <li>
                                            <a 
                                                href="#section-1" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('section-1').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                The Point of View
                                            </a>
                                        </li>
                                        <li>
                                            <a 
                                                href="#section-2" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('section-2').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                The New Opportunity
                                            </a>
                                        </li>
                                        <li>
                                            <a 
                                                href="#section-3" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('section-3').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                Category Name & Definition
                                            </a>
                                        </li>
                                        <li>
                                            <a 
                                                href="#section-4" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('section-4').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                The Manifesto
                                            </a>
                                        </li>
                                        <li>
                                            <a 
                                                href="#section-5" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('section-5').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                Market Category
                                            </a>
                                        </li>
                                        <li>
                                            <a 
                                                href="#section-6" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('section-6').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                Target Market Characteristics
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </nav>

                            <main className="w-full">
                                <div className="space-y-8">
                        <div id="positioning-foundation" className="bg-green-50 border-l-4 border-green-600 p-6 rounded-r-lg shadow-sm scroll-mt-32">
                            <h3 className="text-xl font-bold text-green-800 mb-3">Positioning Foundation</h3>
                            <p className="text-green-700 mb-4">This category design exercise builds upon the positioning work from Part 3. Here is a comprehensive summary of your positioning inputs:</p>
                            <div className="bg-white p-4 rounded-md border border-green-200 space-y-4">
                                
                                {/* 1. Competitive Alternatives */}
                                <div>
                                    <h4 className="font-bold text-gray-800 mb-2">1. Competitive Alternatives</h4>
                                    <div className="text-sm text-gray-600">
                                        {(appState.positioningData.alternatives && appState.positioningData.alternatives.some(alt => alt.val1)) ? (
                                            <ul className="list-disc pl-5 space-y-1">
                                                {appState.positioningData.alternatives.map((alt, index) => (
                                                    alt.val1 && <li key={index}>
                                                        <strong>{alt.val1}:</strong> {alt.val2 && <span className="italic">{alt.val2}</span>}
                                                    </li>
                                                ))}
                                            </ul>
                                        ) : (
                                            <span className="italic">Complete Part 3 first</span>
                                        )}
                                    </div>
                                </div>

                                {/* 2. Unique Value & Proof */}
                                <div>
                                    <h4 className="font-bold text-gray-800 mb-2">2. Unique Value & Proof</h4>
                                    <div className="text-sm text-gray-600">
                                        {(appState.positioningData.values && appState.positioningData.values.some(v => v.val1)) ? (
                                            <ul className="list-disc pl-5 space-y-1">
                                                {appState.positioningData.values.map((item, index) => (
                                                    item.val1 && <li key={index}>
                                                        <strong>{item.val1}:</strong> {item.val2 && <span>{item.val2}</span>}
                                                        {item.val3 && <span className="italic"> - {item.val3}</span>}
                                                    </li>
                                                ))}
                                            </ul>
                                        ) : (
                                            <span className="italic">Complete Part 3 first</span>
                                        )}
                                    </div>
                                </div>

                                {/* --- START of Market Category replacement --- */}
                                <div>
                                    <h4 className="font-bold text-gray-800 mb-2">3. Market Category</h4>
                                    <div className="text-sm text-gray-600">
                                        {appState.positioningData['market-context'] ? (
                                            <p>
                                                <strong>Context:</strong> {appState.positioningData['market-context'] === 'Other'
                                                    ? appState.positioningData['market-context-other']
                                                    : appState.positioningData['market-context']}
                                                <br />
                                                <strong>Name:</strong> {appState.positioningData['category-name'] || <span className="italic">Not provided</span>}
                                            </p>
                                        ) : (
                                            <span className="italic">Complete Part 3 first</span>
                                        )}
                                    </div>
                                </div>
                                {/* --- END of Market Category replacement --- */}

                                {/* --- START of Target Market Characteristics replacement --- */}
                                <div>
                                    <h4 className="font-bold text-gray-800 mb-2">4. Target Market Characteristics</h4>
                                    <div className="text-sm text-gray-600">
                                        {(appState.positioningData.icp_firmographic || appState.positioningData.icp_technographic || appState.positioningData.icp_behavioral) ? (
                                            <div className="space-y-2 ml-4">
                                                {appState.positioningData.icp_firmographic && (
                                                    <div><strong>Firmographic:</strong> {appState.positioningData.icp_firmographic}</div>
                                                )}
                                                {appState.positioningData.icp_technographic && (
                                                    <div><strong>Technographic:</strong> {appState.positioningData.icp_technographic}</div>
                                                )}
                                                {appState.positioningData.icp_behavioral && (
                                                    <div><strong>Behavioral:</strong> {appState.positioningData.icp_behavioral}</div>
                                                )}
                                                {appState.positioningData.icp_implementation_readiness && (
                                                    <div><strong>Implementation Readiness:</strong> {appState.positioningData.icp_implementation_readiness}</div>
                                                )}
                                            </div>
                                        ) : (
                                            <span className="italic">Complete Part 3 first</span>
                                        )}
                                    </div>
                                </div>
                                {/* --- END of Target Market Characteristics replacement --- */}

                                {/* 5. Relevant Trends */}
                                <div>
                                    <h4 className="font-bold text-gray-800 mb-2">5. Relevant Trends</h4>
                                    <div className="text-sm text-gray-600">
                                        {(appState.positioningData.trend1_desc || 
                                          appState.positioningData.trend2_desc || 
                                          appState.positioningData.trend3_desc || 
                                          appState.positioningData.trend4_desc) ? (
                                            <ul className="list-disc pl-5 space-y-1">
                                                {appState.positioningData.trend1_desc && (
                                                    <li>{appState.positioningData.trend1_desc}</li>
                                                )}
                                                {appState.positioningData.trend2_desc && (
                                                    <li>{appState.positioningData.trend2_desc}</li>
                                                )}
                                                {appState.positioningData.trend3_desc && (
                                                    <li>{appState.positioningData.trend3_desc}</li>
                                                )}
                                                {appState.positioningData.trend4_desc && (
                                                    <li>{appState.positioningData.trend4_desc}</li>
                                                )}
                                            </ul>
                                        ) : (
                                            <span className="italic">Complete Part 3 first</span>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="section-1" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                            <h2 className="text-2xl font-bold scale-green-text mb-2">The Point of View (The "From/To" Shift)</h2>
                            <p className="font-semibold text-gray-600 mb-2">Question: What is the old, broken way of thinking, and what is our new, better way?</p>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label className="block font-bold text-gray-700">From (The Old, Broken Way)</label>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="4" 
                                        placeholder="Example: Business transformation is a series of slow, high-risk, episodic projects."
                                        value={appState.categoryData['from-statement'] || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'from-statement': e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">To (Our New, Better Way)</label>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="4" 
                                        placeholder="Example: Operational excellence is a continuous, automated, data-driven business function."
                                        value={appState.categoryData['to-statement'] || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'to-statement': e.target.value } }))}
                                    />
                                </div>
                            </div>
                        </div>

                        <div id="section-2" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                            <h2 className="text-2xl font-bold scale-green-text mb-2">The New Opportunity</h2>
                            <p className="font-semibold text-gray-600 mb-2">Question: What becomes possible for businesses that adopt our point of view?</p>
                            <textarea 
                                className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                rows="4" 
                                placeholder="Example: Businesses can now move beyond reactive, crisis-driven change and achieve continuous transformation..."
                                value={appState.categoryData['new-opportunity'] || ''}
                                onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'new-opportunity': e.target.value } }))}
                            />
                        </div>

                        <div id="section-3" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                            <h2 className="text-2xl font-bold scale-green-text mb-2">Category Name & Definition</h2>
                            <div className="space-y-4">
                                <div>
                                    <label className="block font-bold text-gray-700">Category Name</label>
                                    <div className="flex gap-2 mt-1">
                                        <input 
                                            type="text" 
                                            className="flex-1 p-2 border border-gray-300 rounded-md"
                                            placeholder="Example: Continuous Transformation"
                                            value={appState.categoryData['category-name'] || ''}
                                            onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'category-name': e.target.value } }))}
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">One-Sentence Definition</label>
                                    <input 
                                        type="text" 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        placeholder="Example: The practice of using AI to continuously analyze and optimize business processes in real-time."
                                        value={appState.categoryData['category-definition'] || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'category-definition': e.target.value } }))}
                                    />
                                </div>
                            </div>
                        </div>

                        <div id="section-4" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                            <h2 className="text-2xl font-bold scale-green-text mb-2">The Manifesto</h2>
                            <p className="font-semibold text-gray-600 mb-2">Question: What is our story?</p>
                            <textarea 
                                className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                rows="8" 
                                placeholder="Enter your manifesto here..."
                                value={appState.categoryData['manifesto'] || ''}
                                onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'manifesto': e.target.value } }))}
                            />
                        </div>

                        <div id="section-5" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                            <h2 className="text-2xl font-bold scale-green-text mb-2">Market Category</h2>
                            <p className="font-semibold text-gray-600 mb-2">Question: What market category does your solution belong to?</p>
                            <textarea 
                                className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                rows="3" 
                                placeholder="Example: Customer Success Platform, Marketing Automation, etc."
                                value={appState.categoryData['market-category'] || ''}
                                onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'market-category': e.target.value } }))}
                            />
                        </div>

                        <div id="section-6" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                            <h2 className="text-2xl font-bold scale-green-text mb-2">Target Market Characteristics</h2>
                            <p className="font-semibold text-gray-600 mb-2">Question: Who is the ideal customer for this category?</p>
                            <div className="space-y-4">
                                <div>
                                    <label className="block font-bold text-gray-700">Summary</label>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="3" 
                                        placeholder="Brief overview of your target market..."
                                        value={appState.categoryData['target-market-summary'] || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'target-market-summary': e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Firmographic</label>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="2" 
                                        placeholder="Company size, industry, revenue..."
                                        value={appState.categoryData['target-market-firmographic'] || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'target-market-firmographic': e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Technographic</label>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="2" 
                                        placeholder="Technology stack, tools used..."
                                        value={appState.categoryData['target-market-technographic'] || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'target-market-technographic': e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Behavioral</label>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="2" 
                                        placeholder="Buying patterns, preferences..."
                                        value={appState.categoryData['target-market-behavioral'] || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'target-market-behavioral': e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Implementation Readiness</label>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="2" 
                                        placeholder="Readiness to adopt new solutions..."
                                        value={appState.categoryData['target-market-readiness'] || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'target-market-readiness': e.target.value } }))}
                                    />
                                </div>
                            </div>
                        </div>
                        
                        {/* Clear All Fields Button */}
                        <div className="mt-8 mb-32 text-center">
                            <button
                                onClick={() => {
                                    // Clear all Category Design fields
                                    const clearedCategoryData = {};
                                    setAppState(prev => ({ ...prev, categoryData: clearedCategoryData }));
                                    alert('All fields cleared! Refresh the page to see placeholder text.');
                                }}
                                className="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600 transition-colors mr-4"
                            >
                                Clear All Fields
                            </button>
                            
                            {/* Complete Blueprint Button */}
                            <button
                                onClick={() => {
                                    // Complete Blueprint - could navigate to completion page or show success message
                                    alert('Blueprint Complete! All parts have been finished.');
                                    window.scrollTo(0, 0);
                                }}
                                className="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition-colors"
                            >
                                Complete Blueprint
                            </button>
                        </div>
                                </div>
                            </main>
                        </div>
                    </div>

                    <ExportModal 
                        isOpen={exportModal.isOpen}
                        onClose={() => setExportModal(prev => ({ ...prev, isOpen: false }))}
                        title={exportModal.title}
                        content={exportModal.content}
                        appState={appState}
                        filename="category-design-blueprint"
                    />
                </div>
            );
        };

        // Home Component
        const Home = ({ appState, setAppState, onNavigate, setShowAIResearchModal, openTourAtStep, onImport, onExport, disabled }) => {
            console.log('HomeView props:', { appState, setAppState, onNavigate });
            
            const [showCompanySetupModal, setShowCompanySetupModal] = useState(() => {
                // Initialize modal state based on setup completion
                return !appState.companyContext?.isSetupComplete;
            });

            // State for the user guide accordion
            const [showUserGuide, setShowUserGuide] = useState(false);

            // State for the prompt display modal
            const [promptModalData, setPromptModalData] = useState({
                isOpen: false,
                title: '',
                promptText: ''
            });
            

            // Separate useEffect for debugging
            useEffect(() => {
                console.log('CompanyContext:', appState.companyContext);
                console.log('Should show modal:', !appState.companyContext?.isSetupComplete);
                console.log('Modal state:', showCompanySetupModal);
            });

            // useEffect to sync modal state with company context changes
            useEffect(() => {
                const shouldShowModal = !appState.companyContext?.isSetupComplete;
                if (shouldShowModal !== showCompanySetupModal) {
                    setShowCompanySetupModal(shouldShowModal);
                }
            }, [appState.companyContext?.isSetupComplete]);

            return (
                <div className="min-h-screen bg-gray-50 py-12 px-4">
                    <div className="max-w-3xl mx-auto">
                        {/* Existing welcome content */}
                        <h1 className="text-4xl font-bold text-center mb-8 scale-green-text">Welcome to Positioning Blueprint</h1>

                        {/* Company Context Display */}
                        {appState.companyContext?.isSetupComplete && (
                            <div className="bg-white rounded-lg shadow-md p-6 mb-8">
                                <h3 className="text-lg font-semibold mb-3">Current Company Context</h3>
                                <div className="flex flex-wrap gap-6 text-sm">
                                    <div>
                                        <span className="font-medium">Company:</span> {appState.companyContext.companyName || 'Not specified'}
                                    </div>
                                    <div>
                                        <span className="font-medium">Product:</span> {appState.companyContext.productName || 'Not specified'}
                                    </div>
                                </div>
                                
                                {/* Reset Company Setup Button */}
                                <div className="mt-4 flex flex-col sm:flex-row gap-2 items-start">
                                    <button
                                        onClick={() => {
                                            // Reset company context to trigger modal
                                            setAppState(prev => ({
                                                ...prev,
                                                companyContext: {
                                                    ...prev.companyContext,
                                                    isSetupComplete: false
                                                }
                                            }));
                                            // This will trigger the CompanySetupModal to show again
                                        }}
                                        className="text-sm text-gray-600 hover:text-blue-600 underline"
                                    >
                                        Change Company Setup
                                    </button>


                                </div>
                            </div>
                        )}
                        
                        {/* Action Buttons Grid - Enhanced UX Layout */}
                        {/* 2x2 responsive grid with left-to-right, top-to-bottom flow */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto mb-8">
                            {/* Top-Left: Generate Research Prompt */}
                            <button
                                onClick={() => {
                                    try {
                                        const promptText = generateDeepResearchPrompt(appState.companyContext);

                                        if (promptText && promptText.startsWith('Error generating prompt')) {
                                            alert(promptText);
                                            return;
                                        }

                                        setPromptModalData({
                                            isOpen: true,
                                            title: `Deep Research Prompt for ${appState.companyContext?.companyName || 'Your Company'}`,
                                            promptText: promptText
                                        });
                                    } catch (error) {
                                        console.error('Failed to generate prompt:', error);
                                        alert('Failed to generate research prompt. Please try again.');
                                    }
                                }}
                                className="p-6 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-semibold text-lg shadow-lg transition-all duration-200 hover:shadow-xl order-1"
                            >
                                Generate Research Prompt
                            </button>

                            {/* Top-Right: Primary Action Button - Conditional Green Button */}
                            {appState.navigationProgress.completedParts.length > 0 ? (
                                <button
                                    onClick={() => {
                                        // Find the last incomplete part
                                        const parts = ['segment', 'icp', 'positioning', 'category'];
                                        const nextPart = parts.find(p => !appState.navigationProgress.completedParts.includes(p));
                                        onNavigate(nextPart || 'segment');
                                    }}
                                    className="p-6 bg-green-600 text-white rounded-xl hover:bg-green-700 font-semibold text-lg shadow-lg transition-all duration-200 hover:shadow-xl order-2"
                                >
                                    Continue Where You Left Off
                                </button>
                            ) : (
                                <button
                                    onClick={() => onNavigate('segment')}
                                    className="p-6 bg-green-600 text-white rounded-xl hover:bg-green-700 font-semibold text-lg shadow-lg transition-all duration-200 hover:shadow-xl order-2"
                                >
                                    Start Blueprint Process
                                </button>
                            )}

                            {/* Bottom-Left: AI Research Assistant */}
                            <button
                                onClick={() => setShowAIResearchModal(true)}
                                className="p-6 bg-purple-600 text-white rounded-xl hover:bg-purple-700 font-semibold text-lg shadow-lg transition-all duration-200 hover:shadow-xl flex items-center justify-center gap-2 order-3"
                                title="Upload and analyze research reports to automatically populate form fields across the Positioning Blueprint"
                            >
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Process a Deep Research Report
                            </button>

                            {/* Bottom-Right: Start Fresh Button - Show conditionally */}
                            {(appState.navigationProgress.completedParts.length > 0 ||
                              Object.keys(appState.segmentData || {}).length > 0 ||
                              Object.keys(appState.positioningData || {}).length > 0 ||
                              Object.keys(appState.categoryData || {}).length > 0) && (
                                <button
                                    onClick={() => {
                                        if (window.confirm('This will clear all your progress and form data. Are you sure?')) {
                                            // Clear all progress
                                            localStorage.removeItem('categoryBlueprintState');
                                            window.location.reload();
                                        }
                                    }}
                                    className="p-4 bg-gray-500 text-white rounded-xl hover:bg-gray-600 font-semibold text-lg shadow-md transition-all duration-200 hover:shadow-lg order-4"
                                >
                                    Start Fresh
                                </button>
                            )}
                        </div>

                        {/* User Guide and Visual Tour Buttons */}
                        <div className="text-center mb-8 mt-12">
                            <div className="inline-flex gap-4">
                                <button
                                    onClick={() => setShowUserGuide(!showUserGuide)}
                                    className="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition-colors duration-200 inline-flex items-center gap-2"
                                >
                                    <span>📚</span>
                                    User Guide
                                    <span className={`transform transition-transform duration-200 ${showUserGuide ? 'rotate-180' : ''}`}>▼</span>
                                </button>

                                <button
                                    onClick={() => openTourAtStep(1)}
                                    className="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition-colors duration-200 inline-flex items-center gap-2"
                                >
                                    <span>🎯</span>
                                    Visual Tour
                                </button>

                                {React.createElement(SessionMenu, {
                                    onImport: onImport,
                                    onExport: onExport,
                                    disabled: disabled
                                })}
                            </div>
                        </div>

                        {/* User Guide Accordion */}
                        {showUserGuide && (
                            <div className="bg-white rounded-lg shadow-md p-6 mb-8 border-l-4 border-blue-600">
                                <div className="prose max-w-none">
                                    <h2 className="text-2xl font-bold text-gray-800 mb-6">Getting Started</h2>

                                    <div className="space-y-6">
                                        {/* Step 1: Company Setup */}
                                        <div>
                                            <h3 className="text-lg font-semibold text-gray-800 mb-3">Step 1: Company Setup</h3>
                                            <div className="ml-4 space-y-2">
                                                <p className="text-gray-700">1. Enter your company information in the welcome screen:</p>
                                                <ul className="ml-6 list-disc space-y-1 text-gray-600">
                                                    <li>Company name</li>
                                                    <li>Website URL</li>
                                                    <li>Product/service name</li>
                                                    <li>Competitors or Alternatives</li>
                                                </ul>
                                                <p className="text-gray-700">2. Click "Continue" to proceed to the main application</p>
                                            </div>
                                        </div>

                                        {/* Step 2: AI-Powered Research Features */}
                                        <div>
                                            <h3 className="text-lg font-semibold text-gray-800 mb-3">Step 2: AI-Powered Research Features</h3>
                                            <div className="ml-4 space-y-2">
                                                <p className="text-gray-700">Positioning Blueprint offers several AI-powered tools to accelerate your research and analysis:</p>

                                                <div className="bg-blue-50 p-3 rounded-lg mt-3">
                                                    <h4 className="font-semibold text-blue-800 mb-2">📝 Generate Research Prompt</h4>
                                                    <p className="text-blue-700 text-sm mb-2">Creates a customized AI research prompt based on your company information.</p>
                                                    <ul className="ml-4 list-disc space-y-1 text-blue-700 text-sm">
                                                        <li>Available on the home screen after company setup</li>
                                                        <li>Generates prompts tailored to your company, product, and competitors</li>
                                                        <li>Copy to use with external AI assistants like ChatGPT or Claude</li>
                                                        <li>Download as text file for future reference</li>
                                                    </ul>
                                                </div>

                                                <div className="bg-purple-50 p-3 rounded-lg">
                                                    <h4 className="font-semibold text-purple-800 mb-2">🔬 Process a Deep Research Report</h4>
                                                    <p className="text-purple-700 text-sm mb-2">Upload research reports and let AI extract insights for your Positioning Blueprint.</p>
                                                    <ul className="ml-4 list-disc space-y-1 text-purple-700 text-sm">
                                                        <li>Available via the purple button on home screen</li>
                                                        <li>Supports markdown (.md) and text (.txt) files</li>
                                                        <li>AI analyzes content and suggests form field inputs</li>
                                                        <li>Apply suggestions directly to your blueprint sections</li>
                                                        <li>Process multiple reports to build comprehensive data</li>
                                                    </ul>
                                                </div>

                                                <div className="bg-gray-50 p-3 rounded-lg">
                                                    <h4 className="font-semibold text-gray-800 mb-2">✨ AI Research Assistant</h4>
                                                    <p className="text-gray-700 text-sm mb-2">Available during blueprint process via navigation bar.</p>
                                                    <ul className="ml-4 list-disc space-y-1 text-gray-700 text-sm">
                                                        <li>Sparkle icon in top navigation while working on sections</li>
                                                        <li>Upload research documents for context-aware suggestions</li>
                                                        <li>Get AI recommendations for current section you're working on</li>
                                                        <li>Tooltip guidance: "Upload a research report to get AI suggestions"</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Step 3: Import/Export Features */}
                                        <div>
                                            <h3 className="text-lg font-semibold text-gray-800 mb-3">Step 3: Import/Export Features</h3>
                                            <div className="ml-4 space-y-2">
                                                <p className="text-gray-700">Save and restore your work using the built-in import/export functionality:</p>

                                                <div className="bg-indigo-50 p-3 rounded-lg mt-3">
                                                    <h4 className="font-semibold text-indigo-800 mb-2">📤 Export Your Work</h4>
                                                    <p className="text-indigo-700 text-sm mb-2">Save your progress as downloadable files:</p>
                                                    <ul className="ml-4 list-disc space-y-1 text-indigo-700 text-sm">
                                                        <li>Each section has an "Export" button in the top-right</li>
                                                        <li>Download as JSON files for easy backup and sharing</li>
                                                        <li>Export individual sections or entire completed parts</li>
                                                        <li>Files include metadata with company info and export date</li>
                                                    </ul>
                                                </div>

                                                <div className="bg-orange-50 p-3 rounded-lg">
                                                    <h4 className="font-semibold text-orange-800 mb-2">📥 Import Previous Work</h4>
                                                    <p className="text-orange-700 text-sm mb-2">Restore data from previous sessions or template files:</p>
                                                    <ul className="ml-4 list-disc space-y-1 text-orange-700 text-sm">
                                                        <li>Use "Import Data" button in each section header</li>
                                                        <li>Supports JSON files exported from previous sessions</li>
                                                        <li>Template files from consultants or previous projects</li>
                                                        <li>Each part has its own specific import file format</li>
                                                        <li>Data validation ensures compatibility and accuracy</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Step 4: Navigation & Workflow Management */}
                                        <div>
                                            <h3 className="text-lg font-semibold text-gray-800 mb-3">Step 4: Navigation & Workflow Management</h3>
                                            <div className="ml-4 space-y-2">
                                                <p className="text-gray-700">Understanding how to navigate and manage your progress in the Positioning Blueprint:</p>

                                                <div className="bg-green-50 p-3 rounded-lg mt-3">
                                                    <h4 className="font-semibold text-green-800 mb-2">📋 Four-Part Blueprint Process</h4>
                                                    <p className="text-green-700 text-sm mb-2">Complete your category positioning through these sequential parts:</p>
                                                    <ol className="ml-4 list-decimal space-y-1 text-green-700 text-sm">
                                                        <li><strong>Part 1: Segment Foundation</strong> - Define market segments and target characteristics</li>
                                                        <li><strong>Part 2: ICP Definition</strong> - Create your Ideal Customer Profile</li>
                                                        <li><strong>Part 3: Positioning</strong> - Develop your positioning strategy and competitive alternatives</li>
                                                        <li><strong>Part 4: Category Design</strong> - Design your category narrative and market opportunity</li>
                                                    </ol>
                                                </div>

                                                <div className="bg-blue-50 p-3 rounded-lg">
                                                    <h4 className="font-semibold text-blue-800 mb-2">🧭 Navigation Options</h4>
                                                    <p className="text-blue-700 text-sm mb-2">Control your workflow with these navigation features:</p>
                                                    <ul className="ml-4 list-disc space-y-1 text-blue-700 text-sm">
                                                        <li><strong>Continue Where You Left Off:</strong> Resume from your last incomplete section</li>
                                                        <li><strong>Start Fresh:</strong> Clear all progress and form data to begin anew</li>
                                                        <li><strong>Change Company Setup:</strong> Reset company context while preserving section progress</li>
                                                        <li><strong>Progress Tracking:</strong> App automatically tracks completed parts and saves progress</li>
                                                    </ul>
                                                </div>

                                                <div className="bg-yellow-50 p-3 rounded-lg">
                                                    <h4 className="font-semibold text-yellow-800 mb-2">💾 Auto-Save & Data Management</h4>
                                                    <p className="text-yellow-700 text-sm mb-2">Your work is automatically preserved:</p>
                                                    <ul className="ml-4 list-disc space-y-1 text-yellow-700 text-sm">
                                                        <li><strong>Auto-Save:</strong> Progress automatically saved in your browser as you type</li>
                                                        <li><strong>Local Storage:</strong> All data stays on your device - nothing sent to servers</li>
                                                        <li><strong>Session Persistence:</strong> Return to your work anytime in the same browser</li>
                                                        <li><strong>Export/Import:</strong> Save your work as files for backup or sharing</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Step 5: Quick Import Process */}
                                        <div>
                                            <h3 className="text-lg font-semibold text-gray-800 mb-3">Step 5: Quick Import Process</h3>
                                            <div className="ml-4 space-y-2">
                                                <p className="text-gray-700">Fast-track your work by importing existing data:</p>
                                                <ol className="ml-6 list-decimal space-y-1 text-gray-600">
                                                    <li>Navigate to the section where you want to import data</li>
                                                    <li>Click the "Import Data" button in the section header</li>
                                                    <li>Select your JSON file (from exports or templates)</li>
                                                    <li>Verify the imported data and customize as needed</li>
                                                    <li>Continue with your blueprint process</li>
                                                </ol>
                                                <p className="text-gray-700 text-sm mt-2 italic">💡 Each section supports its own import format - exported files from the same section will work perfectly.</p>
                                            </div>
                                        </div>

                                        {/* Step 6: Manual Entry */}
                                        <div>
                                            <h3 className="text-lg font-semibold text-gray-800 mb-3">Step 6: Manual Entry (Alternative)</h3>
                                            <div className="ml-4 space-y-2">
                                                <p className="text-gray-700">If you prefer to fill out the forms manually or want to customize beyond the imported templates:</p>
                                                <ul className="ml-6 list-disc space-y-1 text-gray-600">
                                                    <li><strong>Part 1:</strong> Define your market segments and target characteristics</li>
                                                    <li><strong>Part 2:</strong> Create your Ideal Customer Profile (ICP)</li>
                                                    <li><strong>Part 3:</strong> Develop your positioning strategy</li>
                                                </ul>
                                            </div>
                                        </div>

                                        {/* Step 7: Tips, Privacy & Best Practices */}
                                        <div>
                                            <h3 className="text-lg font-semibold text-gray-800 mb-3">Step 7: Tips, Privacy & Best Practices</h3>
                                            <div className="ml-4 space-y-3">

                                                <div className="bg-green-50 p-3 rounded-lg">
                                                    <h4 className="font-semibold text-green-800 mb-2">💡 Pro Tips</h4>
                                                    <ul className="list-disc ml-4 space-y-1 text-green-700 text-sm">
                                                        <li>Use AI features early - generate research prompts before starting manual work</li>
                                                        <li>Export your work frequently as backup files</li>
                                                        <li>Complete sections in order for best results - each part builds on the previous</li>
                                                        <li>Use "Change Company Setup" instead of "Start Fresh" to preserve section progress</li>
                                                        <li>Process multiple research reports to get comprehensive AI suggestions</li>
                                                    </ul>
                                                </div>

                                                <div className="bg-blue-50 p-3 rounded-lg">
                                                    <h4 className="font-semibold text-blue-800 mb-2">🔐 Privacy & Data Security</h4>
                                                    <ul className="list-disc ml-4 space-y-1 text-blue-700 text-sm">
                                                        <li><strong>Local Storage Only:</strong> All your data stays on your device</li>
                                                        <li><strong>No Server Uploads:</strong> Nothing is sent to external servers</li>
                                                        <li><strong>Browser-Based:</strong> Data persists in your browser's local storage</li>
                                                        <li><strong>AI Processing:</strong> Research analysis happens through secure API calls</li>
                                                        <li><strong>File Control:</strong> You control all exports and imports manually</li>
                                                    </ul>
                                                </div>

                                                <div className="bg-yellow-50 p-3 rounded-lg">
                                                    <h4 className="font-semibold text-yellow-800 mb-2">🎯 Best Practices</h4>
                                                    <ul className="list-disc ml-4 space-y-1 text-yellow-700 text-sm">
                                                        <li>Start with comprehensive company setup - quality inputs lead to better AI suggestions</li>
                                                        <li>Use research prompts to gather external data before filling forms manually</li>
                                                        <li>Take advantage of auto-save - your progress is preserved as you work</li>
                                                        <li>Export completed sections immediately for backup and sharing</li>
                                                        <li>Review and customize AI suggestions - they're starting points, not final answers</li>
                                                        <li>Keep the same browser/device for consistent access to your saved work</li>
                                                    </ul>
                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        <p className="text-sm text-gray-500 mt-8 text-center max-w-2xl mx-auto">
                            Your progress is saved automatically in your browser. This data is private and is not sent to any server.
                        </p>

                        <footer className="text-center text-sm text-gray-500 py-8 mt-12">
                            Scale Venture Partners
                        </footer>
                    </div>

                    <CompanySetupModal
                        isOpen={showCompanySetupModal}
                        onComplete={() => {
                            console.log('Modal onComplete called');
                            setShowCompanySetupModal(false);
                            saveAppState(appState);
                        }}
                        companyData={appState.companyContext || {}}
                        setCompanyData={(updater) => {
                            console.log('setCompanyData called with:', updater);
                            setAppState(prev => {
                                console.log('Previous state:', prev);
                                const updatedContext = typeof updater === 'function' 
                                    ? updater(prev.companyContext || {})
                                    : updater;
                                const newState = { ...prev, companyContext: updatedContext };
                                console.log('New state:', newState);
                                return newState;
                            });
                        }}
                    />
                    
                    <PromptDisplayModal
                        isOpen={promptModalData.isOpen}
                        onClose={() => setPromptModalData(prev => ({ ...prev, isOpen: false }))}
                        promptText={promptModalData.promptText}
                        title={promptModalData.title}
                    />
                </div>
            );
        };

        // SegmentFunnelDiagram Component
        const SegmentFunnelDiagram = ({ highlightedSection = null, subStep = 0 }) => {
            const getSectionOpacity = (sectionName) => {
                if (!highlightedSection) return 1;
                return highlightedSection === sectionName ? 1 : 0.3;
            };

            const getSectionFilter = (sectionName) => {
                if (!highlightedSection) return '';
                return highlightedSection === sectionName ? 'drop-shadow(0 0 8px currentColor)' : '';
            };

            return (
                <svg width="850" height="450" viewBox="0 0 850 450" className="max-w-full h-auto transition-all duration-500">
                    <defs>
                        <marker id="tour-arrowhead" markerWidth="10" markerHeight="7"
                                refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#224f41"/>
                        </marker>
                    </defs>

                    {/* Total Market */}
                    <g style={{ opacity: getSectionOpacity('total-market'), filter: getSectionFilter('total-market'), transition: 'all 0.3s ease' }}>
                        <rect x="50" y="20" width="300" height="60" fill="#e5ecea" stroke="#224f41" strokeWidth="2" rx="4"/>
                        <text x="200" y="55" textAnchor="middle" fill="#224f41" fontSize="16" fontWeight="600">
                            Total Market of Buyers
                        </text>
                    </g>

                    {/* Arrow 1 */}
                    <line x1="200" y1="80" x2="200" y2="110" stroke="#224f41" strokeWidth="2" markerEnd="url(#tour-arrowhead)"
                          style={{ opacity: getSectionOpacity('arrow1'), transition: 'all 0.3s ease' }}/>

                    {/* JTBD Filter */}
                    <g style={{ opacity: getSectionOpacity('jtbd-filter'), filter: getSectionFilter('jtbd-filter'), transition: 'all 0.3s ease' }}>
                        <rect x="80" y="115" width="240" height="50" fill="#7da399" stroke="#224f41" strokeWidth="2" rx="4"/>
                        <text x="200" y="135" textAnchor="middle" fill="white" fontSize="14" fontWeight="500">
                            Shared Job to be Done
                        </text>
                        <text x="200" y="150" textAnchor="middle" fill="white" fontSize="12">
                            (Common Context & Struggling Moments)
                        </text>
                    </g>

                    {/* Arrow 2 */}
                    <line x1="200" y1="165" x2="200" y2="195" stroke="#224f41" strokeWidth="2" markerEnd="url(#tour-arrowhead)"
                          style={{ opacity: getSectionOpacity('arrow2'), transition: 'all 0.3s ease' }}/>

                    {/* Value Filter */}
                    <g style={{ opacity: getSectionOpacity('value-filter'), filter: getSectionFilter('value-filter'), transition: 'all 0.3s ease' }}>
                        <rect x="110" y="200" width="180" height="50" fill="#528577" stroke="#224f41" strokeWidth="2" rx="4"/>
                        <text x="200" y="220" textAnchor="middle" fill="white" fontSize="14" fontWeight="500">
                            Commonly Perceived Value
                        </text>
                        <text x="200" y="235" textAnchor="middle" fill="white" fontSize="12">
                            (Similar Value Priorities)
                        </text>
                    </g>

                    {/* Arrow 3 */}
                    <line x1="200" y1="250" x2="200" y2="280" stroke="#224f41" strokeWidth="2" markerEnd="url(#tour-arrowhead)"
                          style={{ opacity: getSectionOpacity('arrow3'), transition: 'all 0.3s ease' }}/>

                    {/* WTP Filter */}
                    <g style={{ opacity: getSectionOpacity('wtp-filter'), filter: getSectionFilter('wtp-filter'), transition: 'all 0.3s ease' }}>
                        <rect x="140" y="285" width="120" height="50" fill="#224f41" stroke="#224f41" strokeWidth="2" rx="4"/>
                        <text x="200" y="305" textAnchor="middle" fill="white" fontSize="14" fontWeight="500">
                            Similar Willingness
                        </text>
                        <text x="200" y="320" textAnchor="middle" fill="white" fontSize="14" fontWeight="500">
                            to Pay
                        </text>
                    </g>

                    {/* Arrow 4 */}
                    <line x1="200" y1="335" x2="200" y2="365" stroke="#224f41" strokeWidth="2" markerEnd="url(#tour-arrowhead)"
                          style={{ opacity: getSectionOpacity('arrow4'), transition: 'all 0.3s ease' }}/>

                    {/* Market Segment Result */}
                    <g style={{ opacity: getSectionOpacity('segment-result'), filter: getSectionFilter('segment-result'), transition: 'all 0.3s ease' }}>
                        <rect x="160" y="370" width="80" height="60" fill="#e5a819" stroke="#224f41" strokeWidth="2" rx="4"/>
                        <text x="200" y="390" textAnchor="middle" fill="#224f41" fontSize="14" fontWeight="600">
                            A True
                        </text>
                        <text x="200" y="405" textAnchor="middle" fill="#224f41" fontSize="14" fontWeight="600">
                            Market
                        </text>
                        <text x="200" y="420" textAnchor="middle" fill="#224f41" fontSize="14" fontWeight="600">
                            Segment
                        </text>
                    </g>

                    {/* Side Labels */}
                    <text x="30" y="225" textAnchor="middle" fill="#224f41" fontSize="12" transform="rotate(-90, 30, 225)"
                          style={{ opacity: getSectionOpacity('labels'), transition: 'all 0.3s ease' }}>
                        Filtering Process
                    </text>
                    <text x="370" y="225" textAnchor="middle" fill="#224f41" fontSize="12" transform="rotate(90, 370, 225)"
                          style={{ opacity: getSectionOpacity('labels'), transition: 'all 0.3s ease' }}>
                        Strategic Focus
                    </text>

                    {/* Relationship Flow - Right Side */}
                    <g style={{ opacity: getSectionOpacity('relationship-flow'), transition: 'all 0.3s ease' }}>
                        <line x1="425" y1="50" x2="425" y2="400" stroke="#e5e7eb" strokeWidth="2" strokeDasharray="5,5"/>

                        <text x="625" y="40" textAnchor="middle" fill="#224f41" fontSize="18" fontWeight="600">
                            How the Components Relate
                        </text>

                        {/* JTBD Box */}
                        <rect x="450" y="120" width="110" height="120" fill="#7da399" stroke="#224f41" strokeWidth="2" rx="4"/>
                        <text x="505" y="145" textAnchor="middle" fill="white" fontSize="16" fontWeight="600">(1)</text>
                        <text x="505" y="170" textAnchor="middle" fill="white" fontSize="12" fontWeight="500">Why the</text>
                        <text x="505" y="185" textAnchor="middle" fill="white" fontSize="12" fontWeight="500">customer is</text>
                        <text x="505" y="200" textAnchor="middle" fill="white" fontSize="12" fontWeight="500">motivated</text>
                        <text x="505" y="220" textAnchor="middle" fill="white" fontSize="11" fontStyle="italic">(Jobs to be Done)</text>

                        <line x1="560" y1="180" x2="590" y2="180" stroke="#224f41" strokeWidth="3" markerEnd="url(#tour-arrowhead)"/>

                        {/* Customer Value Box */}
                        <rect x="590" y="120" width="110" height="120" fill="#528577" stroke="#224f41" strokeWidth="2" rx="4"/>
                        <text x="645" y="145" textAnchor="middle" fill="white" fontSize="16" fontWeight="600">(2)</text>
                        <text x="645" y="170" textAnchor="middle" fill="white" fontSize="12" fontWeight="500">How they</text>
                        <text x="645" y="185" textAnchor="middle" fill="white" fontSize="12" fontWeight="500">define</text>
                        <text x="645" y="200" textAnchor="middle" fill="white" fontSize="12" fontWeight="500">success</text>
                        <text x="645" y="220" textAnchor="middle" fill="white" fontSize="11" fontStyle="italic">(Customer Value)</text>

                        <line x1="700" y1="180" x2="730" y2="180" stroke="#224f41" strokeWidth="3" markerEnd="url(#tour-arrowhead)"/>

                        {/* WTP Box */}
                        <rect x="730" y="120" width="110" height="120" fill="#224f41" stroke="#224f41" strokeWidth="2" rx="4"/>
                        <text x="785" y="145" textAnchor="middle" fill="white" fontSize="16" fontWeight="600">(3)</text>
                        <text x="785" y="165" textAnchor="middle" fill="white" fontSize="12" fontWeight="500">How much</text>
                        <text x="785" y="180" textAnchor="middle" fill="white" fontSize="12" fontWeight="500">they will</text>
                        <text x="785" y="195" textAnchor="middle" fill="white" fontSize="12" fontWeight="500">invest & why</text>
                        <text x="785" y="215" textAnchor="middle" fill="white" fontSize="11" fontStyle="italic">(Willingness</text>
                        <text x="785" y="228" textAnchor="middle" fill="white" fontSize="11" fontStyle="italic">to Pay)</text>

                        <text x="645" y="290" textAnchor="middle" fill="#224f41" fontSize="14" fontWeight="500">Understanding Progression</text>
                        <text x="645" y="310" textAnchor="middle" fill="#6b7280" fontSize="12">Customer motivation drives what they value,</text>
                        <text x="645" y="325" textAnchor="middle" fill="#6b7280" fontSize="12">which determines their investment threshold</text>
                    </g>
                </svg>
            );
        };

        // ICPFlowDiagram Component
        const ICPFlowDiagram = ({ highlightedSection = null, subStep = 0 }) => {
            const getSectionOpacity = (sectionName) => {
                if (!highlightedSection) return 1;
                return highlightedSection === sectionName ? 1 : 0.3;
            };

            const getSectionFilter = (sectionName) => {
                if (!highlightedSection) return '';
                return highlightedSection === sectionName ? 'drop-shadow(0 0 8px currentColor)' : '';
            };

            return (
                <svg viewBox="0 0 800 300" className="w-full h-auto max-w-4xl mx-auto transition-all duration-500">
                    <defs>
                        <marker id="icp-arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#6B7280" />
                        </marker>
                    </defs>

                    {/* Market Segment Box */}
                    <g style={{ opacity: getSectionOpacity('market-segment'), filter: getSectionFilter('market-segment'), transition: 'all 0.3s ease' }}>
                        <rect x="30" y="100" width="150" height="100" rx="8" fill="#059669" />
                        <text x="105" y="125" textAnchor="middle" fill="white" fontSize="14" fontWeight="bold">Market Segment</text>
                        <text x="105" y="145" textAnchor="middle" fill="white" fontSize="12">JTBD • Value • WTP</text>
                        <text x="105" y="165" textAnchor="middle" fill="white" fontSize="10">Foundation Complete</text>
                        <text x="105" y="180" textAnchor="middle" fill="white" fontSize="10">✓</text>
                    </g>

                    {/* Bridge Arrow */}
                    <line x1="180" y1="150" x2="380" y2="150" stroke="#6B7280" strokeWidth="3" markerEnd="url(#icp-arrowhead)"
                          style={{ opacity: getSectionOpacity('bridge-arrow'), transition: 'all 0.3s ease' }} />

                    {/* Bridge Content Box */}
                    <g style={{ opacity: getSectionOpacity('bridge'), filter: getSectionFilter('bridge'), transition: 'all 0.3s ease' }}>
                        <rect x="220" y="60" width="180" height="80" rx="6" fill="#F3F4F6" stroke="#6B7280" strokeWidth="1" />
                        <text x="310" y="80" textAnchor="middle" fill="#374151" fontSize="12" fontWeight="bold">Add Product & Business</text>
                        <text x="310" y="95" textAnchor="middle" fill="#374151" fontSize="12" fontWeight="bold">Model Fit</text>
                        <text x="310" y="115" textAnchor="middle" fill="#6B7280" fontSize="10">Product-Problem Fit</text>
                        <text x="310" y="128" textAnchor="middle" fill="#6B7280" fontSize="10">Scalable Business Model</text>
                    </g>

                    {/* Actionable ICP Container */}
                    <rect x="420" y="50" width="350" height="200" rx="8" fill="#F9FAFB" stroke="#D1D5DB" strokeWidth="1"
                          style={{ opacity: getSectionOpacity('actionable-icp'), filter: getSectionFilter('actionable-icp'), transition: 'all 0.3s ease' }} />

                    <text x="595" y="75" textAnchor="middle" fill="#111827" fontSize="16" fontWeight="bold">Actionable ICP</text>

                    {/* Strategic Why Section */}
                    <g style={{ opacity: getSectionOpacity('strategic-why'), filter: getSectionFilter('strategic-why'), transition: 'all 0.3s ease' }}>
                        <rect x="440" y="90" width="155" height="140" rx="6" fill="#DCFCE7" stroke="#16A34A" strokeWidth="1" />
                        <text x="517.5" y="110" textAnchor="middle" fill="#166534" fontSize="12" fontWeight="bold">Strategic Why</text>
                        <text x="455" y="130" fill="#15803D" fontSize="10">• Jobs to be Done</text>
                        <text x="455" y="145" fill="#15803D" fontSize="10">• Value Drivers</text>
                        <text x="455" y="160" fill="#15803D" fontSize="10">• Buyer Motivations</text>
                        <text x="517.5" y="185" textAnchor="middle" fill="#059669" fontSize="9" fontStyle="italic">For messaging</text>
                        <text x="517.5" y="200" textAnchor="middle" fill="#059669" fontSize="9" fontStyle="italic">& positioning</text>
                    </g>

                    {/* Operational Where Section */}
                    <g style={{ opacity: getSectionOpacity('operational-where'), filter: getSectionFilter('operational-where'), transition: 'all 0.3s ease' }}>
                        <rect x="610" y="90" width="155" height="140" rx="6" fill="#FEF3C7" stroke="#F59E0B" strokeWidth="1" />
                        <text x="687.5" y="110" textAnchor="middle" fill="#92400E" fontSize="12" fontWeight="bold">Operational Where</text>
                        <text x="625" y="130" fill="#A16207" fontSize="10">• Firmographics</text>
                        <text x="625" y="145" fill="#A16207" fontSize="10">• Technographics</text>
                        <text x="625" y="160" fill="#A16207" fontSize="10">• Behavioral Signals</text>
                        <text x="687.5" y="185" textAnchor="middle" fill="#D97706" fontSize="9" fontStyle="italic">For targeting</text>
                        <text x="687.5" y="200" textAnchor="middle" fill="#D97706" fontSize="9" fontStyle="italic">& campaigns</text>
                    </g>
                </svg>
            );
        };

        // OnboardingTour Component - Enhanced Version with Visual Improvements
        const OnboardingTour = ({ isOpen, onClose, startStep = 1 }) => {
            const [currentStep, setCurrentStep] = useState(startStep);
            const [dontShowAgain, setDontShowAgain] = useState(false);
            const [subStep, setSubStep] = useState(0);
            const [visualMode, setVisualMode] = useState(true);

            const tourSteps = [
                {
                    title: "Part 1: Segment Foundation",
                    icon: "🏗️",
                    hasInteractive: true,
                    subSteps: [
                        { highlight: null, title: "The Filtering Funnel", description: "See how we narrow down from Total Market to Market Segment through strategic filtering." },
                        { highlight: "total-market", title: "Total Market", description: "Start with everyone who could potentially buy any solution." },
                        { highlight: "jtbd-filter", title: "Jobs-to-be-Done", description: "Filter to those with specific jobs they need to get done." },
                        { highlight: "value-filter", title: "Value Recognition", description: "Narrow to those who recognize the value of solving the problem." },
                        { highlight: "wtp-filter", title: "Willingness to Pay", description: "Focus on those willing to pay for a solution." },
                        { highlight: "segment-result", title: "Market Segment", description: "Your refined, actionable market segment." }
                    ],
                    content: "Welcome to the Positioning Blueprint! Everything starts with the Foundation. Here, you will define the core market problems and customer motivations using the Jobs-to-be-Done framework."
                },
                {
                    title: "Part 2: ICP Definition",
                    icon: "🎯",
                    hasInteractive: true,
                    subSteps: [
                        { highlight: null, title: "ICP Development Flow", description: "Transform your Market Segment into an Actionable ICP with strategic insights." },
                        { highlight: "market-segment", title: "Market Segment", description: "Start with your refined market segment from Part 1." },
                        { highlight: "bridge", title: "Product/Business Model Fit", description: "Align your offering with customer needs and business model." },
                        { highlight: "strategic-why", title: "Strategic Why", description: "Understand the deeper motivations and strategic value." },
                        { highlight: "operational-where", title: "Operational Where", description: "Define the tactical attributes and characteristics." },
                        { highlight: "actionable-icp", title: "Actionable ICP", description: "Your complete, actionable Ideal Customer Profile." }
                    ],
                    content: "Next, you'll use the foundation to build a clear picture of your Ideal Customer Profile (ICP). This step focuses on the firmographic, technographic, and behavioral attributes of your best customers."
                },
                {
                    title: "Part 3: Positioning",
                    icon: "🧩",
                    hasInteractive: false,
                    content: "With a clear customer in mind, you can now define your product's unique positioning. This involves identifying competitive alternatives, unique attributes, and the value you deliver that no one else can."
                },
                {
                    title: "Part 4: Category Design",
                    icon: "📖",
                    hasInteractive: false,
                    content: "Finally, you will craft the narrative. This is where you design a new market category or reframe an existing one, creating a powerful story that communicates your unique value and vision to the world."
                }
            ];

            const handleNext = () => {
                const currentStepData = tourSteps[currentStep - 1];
                if (currentStepData.hasInteractive && subStep < currentStepData.subSteps.length - 1) {
                    setSubStep(subStep + 1);
                } else if (currentStep < tourSteps.length) {
                    setCurrentStep(currentStep + 1);
                    setSubStep(0);
                }
            };

            const handleBack = () => {
                const currentStepData = tourSteps[currentStep - 1];
                if (currentStepData.hasInteractive && subStep > 0) {
                    setSubStep(subStep - 1);
                } else if (currentStep > 1) {
                    setCurrentStep(currentStep - 1);
                    const prevStepData = tourSteps[currentStep - 2];
                    setSubStep(prevStepData.hasInteractive ? prevStepData.subSteps.length - 1 : 0);
                }
            };

            const handleStepClick = (stepIndex) => {
                setCurrentStep(stepIndex + 1);
                setSubStep(0);
            };

            const handleClose = () => {
                if (dontShowAgain) {
                    localStorage.setItem('hasCompletedTour', 'true');
                }
                onClose();
            };

            const handleEscapeKey = (e) => {
                if (e.key === 'Escape') {
                    handleClose();
                }
                if (e.key === 'ArrowLeft') {
                    handleBack();
                }
                if (e.key === 'ArrowRight') {
                    handleNext();
                }
            };

            useEffect(() => {
                if (isOpen) {
                    setCurrentStep(startStep);
                    setSubStep(0);
                    document.addEventListener('keydown', handleEscapeKey);
                    return () => document.removeEventListener('keydown', handleEscapeKey);
                }
            }, [isOpen, startStep]);

            if (!isOpen) return null;

            const currentStepData = tourSteps[currentStep - 1];
            const currentSubStepData = currentStepData.hasInteractive ? currentStepData.subSteps[subStep] : null;

            // Calculate progress for progress bar
            let totalSteps = 0;
            let completedSteps = 0;

            tourSteps.forEach((step, index) => {
                if (step.hasInteractive) {
                    totalSteps += step.subSteps.length;
                    if (index + 1 < currentStep) {
                        completedSteps += step.subSteps.length;
                    } else if (index + 1 === currentStep) {
                        completedSteps += subStep;
                    }
                } else {
                    totalSteps += 1;
                    if (index + 1 < currentStep) {
                        completedSteps += 1;
                    }
                }
            });

            const progress = Math.round((completedSteps / totalSteps) * 100);

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] overflow-hidden">
                        {/* Enhanced Header with Gradient */}
                        <div className="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-4">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h2 className="text-xl font-bold">Visual Tour</h2>
                                    <p className="text-blue-100 text-sm mt-1">
                                        Discover the power of strategic positioning
                                    </p>
                                </div>
                                <button
                                    onClick={handleClose}
                                    className="text-white hover:text-blue-200 transition-colors p-1"
                                >
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>

                            {/* Progress Bar */}
                            <div className="mt-4">
                                <div className="flex justify-between items-center mb-2">
                                    <span className="text-sm text-blue-100">Progress</span>
                                    <span className="text-sm text-blue-100">{progress}%</span>
                                </div>
                                <div className="bg-white bg-opacity-20 h-2 rounded-full overflow-hidden">
                                    <div
                                        className="bg-white h-2 transition-all duration-300 ease-out"
                                        style={{ width: `${progress}%` }}
                                    ></div>
                                </div>
                            </div>
                        </div>

                        {/* Main Content */}
                        <div className="p-6 flex flex-col lg:flex-row">
                            {/* Visualization Panel */}
                            <div className="flex-1 lg:pr-6 mb-6 lg:mb-0">
                                {/* Interactive Content for Parts 1 and 2 */}
                                {currentStepData.hasInteractive ? (
                                    <div>
                                        {/* Visual Mode Toggle */}
                                        <div className="flex justify-center mb-4">
                                            <button
                                                onClick={() => setVisualMode(!visualMode)}
                                                className="flex items-center space-x-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"
                                            >
                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                                </svg>
                                                <span className="text-sm">{visualMode ? 'Hide' : 'Show'} Visualization</span>
                                            </button>
                                        </div>

                                        {/* Interactive SVG Diagrams */}
                                        {visualMode && (
                                            <div className="flex justify-center mb-6">
                                                {currentStep === 1 && (
                                                    <SegmentFunnelDiagram
                                                        highlightedSection={currentSubStepData?.highlight}
                                                        subStep={subStep}
                                                    />
                                                )}
                                                {currentStep === 2 && (
                                                    <ICPFlowDiagram
                                                        highlightedSection={currentSubStepData?.highlight}
                                                        subStep={subStep}
                                                    />
                                                )}
                                            </div>
                                        )}

                                        {/* Interactive Step Progress */}
                                        <div className="flex justify-center">
                                            <div className="flex items-center space-x-2">
                                                {currentStepData.subSteps.map((_, index) => (
                                                    <div
                                                        key={index}
                                                        className={`w-3 h-3 rounded-full transition-all duration-300 ${
                                                            index <= subStep ? 'bg-blue-600 scale-110' : 'bg-gray-300'
                                                        }`}
                                                    />
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    /* Static Content for Parts 3 and 4 */
                                    <div className="text-center">
                                        <div className="text-6xl mb-6">{currentStepData.icon}</div>
                                        <div className="max-w-md mx-auto">
                                            <h3 className="text-xl font-semibold text-gray-800 mb-4">{currentStepData.title}</h3>
                                            <p className="text-gray-600 leading-relaxed">{currentStepData.content}</p>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Explanation Panel */}
                            <div className="w-full lg:w-80 flex flex-col">
                                <div className="bg-gray-50 rounded-lg p-6 flex-1">
                                    {/* Step Header */}
                                    <div className="flex items-center mb-4">
                                        <div className="text-2xl mr-3">{currentStepData.icon}</div>
                                        <div>
                                            <h3 className="font-semibold text-gray-800">{currentStepData.title}</h3>
                                            <div className="text-sm text-gray-500">
                                                Part {currentStep} of {tourSteps.length}
                                            </div>
                                        </div>
                                    </div>

                                    {/* Current SubStep Info */}
                                    {currentStepData.hasInteractive && currentSubStepData ? (
                                        <div className="bg-white rounded-lg p-4 mb-4 border-l-4 border-blue-500">
                                            <h4 className="font-medium text-gray-900 mb-2">{currentSubStepData.title}</h4>
                                            <p className="text-gray-700 text-sm leading-relaxed">{currentSubStepData.description}</p>
                                            <div className="mt-3 text-xs text-gray-500">
                                                Step {subStep + 1} of {currentStepData.subSteps.length}
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="bg-white rounded-lg p-4 mb-4">
                                            <p className="text-gray-700 leading-relaxed">{currentStepData.content}</p>
                                        </div>
                                    )}

                                    {/* Navigation Info */}
                                    <div className="text-xs text-gray-500 bg-white rounded p-3">
                                        <div className="font-medium mb-1">Navigation:</div>
                                        <div>• Arrow keys: Navigate steps</div>
                                        <div>• Escape: Close tour</div>
                                        <div>• Click dots: Jump to step</div>
                                    </div>
                                </div>

                                {/* Main Step Indicators */}
                                <div className="flex justify-center space-x-2 mt-4">
                                    {tourSteps.map((_, index) => (
                                        <button
                                            key={index}
                                            onClick={() => handleStepClick(index)}
                                            className={`w-4 h-4 rounded-full transition-all duration-200 hover:scale-110 ${
                                                index + 1 === currentStep
                                                    ? 'bg-blue-600 shadow-lg'
                                                    : 'bg-gray-300 hover:bg-gray-400'
                                            }`}
                                        />
                                    ))}
                                </div>

                                {/* Don't show again checkbox - only on last step */}
                                {currentStep === tourSteps.length && (
                                    <div className="flex items-center justify-center mt-4">
                                        <label className="flex items-center text-sm text-gray-600 cursor-pointer">
                                            <input
                                                type="checkbox"
                                                checked={dontShowAgain}
                                                onChange={(e) => setDontShowAgain(e.target.checked)}
                                                className="mr-2 rounded"
                                            />
                                            Don't show this tour again
                                        </label>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Enhanced Footer */}
                        <div className="flex justify-between items-center px-6 py-4 border-t bg-gradient-to-r from-gray-50 to-gray-100">
                            <div className="text-sm text-gray-600">
                                {currentStepData.hasInteractive ? (
                                    <span>Part {currentStep} • Step {subStep + 1} of {currentStepData.subSteps.length}</span>
                                ) : (
                                    <span>Part {currentStep} of {tourSteps.length}</span>
                                )}
                            </div>
                            <div className="flex gap-3">
                                {(currentStep > 1 || subStep > 0) && (
                                    <button
                                        onClick={handleBack}
                                        className="px-6 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-100 transition-all duration-200 font-medium"
                                    >
                                        ← Back
                                    </button>
                                )}
                                {(() => {
                                    const isLastStep = currentStep === tourSteps.length;
                                    const isLastSubStep = currentStepData.hasInteractive ? (subStep === currentStepData.subSteps.length - 1) : true;
                                    const canContinue = !isLastStep || !isLastSubStep;

                                    if (canContinue) {
                                        return (
                                            <button
                                                onClick={handleNext}
                                                className="px-6 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all duration-200 font-medium shadow-lg"
                                            >
                                                {currentStepData.hasInteractive && subStep < currentStepData.subSteps.length - 1 ? 'Continue →' : 'Next Part →'}
                                            </button>
                                        );
                                    } else {
                                        return (
                                            <button
                                                onClick={handleClose}
                                                className="px-6 py-2 bg-gradient-to-r from-green-600 to-blue-600 text-white rounded-lg hover:from-green-700 hover:to-blue-700 transition-all duration-200 font-medium shadow-lg"
                                            >
                                                Get Started! 🚀
                                            </button>
                                        );
                                    }
                                })()}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const [appState, setAppState] = useState(() => {
                const savedState = loadAppState();
                const state = savedState || getInitialState();
                return state;
            });

            // New state for AI Research Modal
            const [showAIResearchModal, setShowAIResearchModal] = useState(false);
            const [sessionNotice, setSessionNotice] = useState(null);
            const [pendingImport, setPendingImport] = useState(null);
            const [isProcessingImport, setIsProcessingImport] = useState(false);
            const [showOnboardingTour, setShowOnboardingTour] = useState(false);
            const [tourStartStep, setTourStartStep] = useState(1);

            useEffect(() => {
                saveAppState(appState);
            }, [appState]);

            const dismissNotice = () => setSessionNotice(null);

            const showNotice = (message, type = 'success') => {
                setSessionNotice({ message, type, createdAt: Date.now() });
            };

            const openTourAtStep = (step) => {
                setTourStartStep(step);
                setShowOnboardingTour(true);
            };

            const handleExportSession = () => {
                try {
                    if (!window.SessionFileIO) {
                        throw new Error('SessionFileIO not loaded. Please refresh the page and try again.');
                    }
                    const envelope = SessionManager.serializeSession({
                        getState: () => appState,
                        appVersion: APP_VERSION
                    });
                    const filename = `positioning-session-${new Date().toISOString().slice(0, 10)}.json`;
                    window.SessionFileIO.triggerDownload(filename, JSON.stringify(envelope, null, 2));
                    showNotice('Session exported successfully.');
                } catch (error) {
                    console.error('Failed to export session', error);
                    showNotice(error.message || 'Failed to export session.', 'error');
                }
            };

            const handleStartImport = async () => {
                try {
                    if (!window.SessionFileIO) {
                        throw new Error('SessionFileIO not loaded. Please refresh the page and try again.');
                    }
                    const { json, fileName } = await window.SessionFileIO.pickJsonFile();
                    setPendingImport({ json, fileName });
                } catch (error) {
                    if (error && error.message === 'NO_FILE_SELECTED') {
                        return;
                    }
                    console.error('Failed to load session file', error);
                    showNotice(error.message || 'Failed to load session file.', 'error');
                }
            };

            const handleConfirmImport = async () => {
                if (!pendingImport) {
                    return;
                }
                setIsProcessingImport(true);
                try {
                    SessionManager.backupSession({
                        getState: () => appState,
                        appVersion: APP_VERSION
                    });
                } catch (error) {
                    console.error('Failed to create session backup', error);
                    showNotice('Could not create a backup. Import cancelled.', 'error');
                    setIsProcessingImport(false);
                    setPendingImport(null);
                    return;
                }

                try {
                    const mergedState = SessionManager.hydrateSession({
                        json: pendingImport.json,
                        replaceState: (nextState) => {
                            setAppState(() => nextState);
                        },
                        getInitialState
                    });
                    saveAppState(mergedState);
                    showNotice(`Imported session from ${pendingImport.fileName || 'file'} successfully.`);
                } catch (error) {
                    console.error('Failed to import session', error);
                    showNotice(error.message || 'Failed to import session.', 'error');
                } finally {
                    setPendingImport(null);
                    setIsProcessingImport(false);
                }
            };

            const handleCancelImport = () => {
                setPendingImport(null);
            };

            // Generate complete application data for home page export
            const generateFullApplicationData = () => {
                const formatFieldValue = (fieldValue) => {
                    if (Array.isArray(fieldValue)) {
                        return fieldValue.filter(item => item && item.toString().trim()).join('; ');
                    }
                    if (typeof fieldValue === 'object' && fieldValue !== null) {
                        return Object.entries(fieldValue)
                            .filter(([k, v]) => v && v.toString().trim())
                            .map(([k, v]) => `${k}: ${v}`)
                            .join('; ');
                    }
                    return fieldValue && fieldValue.toString().trim() || null;
                };

                // Build company object excluding null values
                const companyData = {};
                const companyName = formatFieldValue(appState.companyContext?.companyName);
                const companyWebsite = formatFieldValue(appState.companyContext?.companyWebsite);
                const industry = formatFieldValue(appState.companyContext?.industry);
                const productName = formatFieldValue(appState.companyContext?.productName);
                
                if (companyName) companyData.name = companyName;
                if (companyWebsite) companyData.website = companyWebsite;
                if (industry) companyData.industry = industry;
                if (productName) companyData.productName = productName;

                return {
                    metadata: {
                        exportDate: new Date().toISOString(),
                        exportType: "Complete Application Data",
                        company: companyData
                    },
                    parts: {
                        segmentFoundation: {
                            partName: "Segment Foundation",
                            partNumber: 1,
                            jobsToBeDone: {
                                "Context": formatFieldValue(appState.segmentData?.['Context']),
                                "Struggling Moments": formatFieldValue(appState.segmentData?.['Struggling Moments']),
                                "Pushes & Pulls": formatFieldValue(appState.segmentData?.['Pushes & Pulls']),
                                "Anxieties & Habits": formatFieldValue(appState.segmentData?.['Anxieties & Habits']),
                                "Desired Outcomes": formatFieldValue(appState.segmentData?.['Desired Outcomes']),
                                "Basic Quality (Table Stakes)": formatFieldValue(appState.segmentData?.['Basic Quality (Table Stakes)']),
                                "Hiring Criteria": formatFieldValue(appState.segmentData?.['Hiring Criteria']),
                                "Firing Criteria": formatFieldValue(appState.segmentData?.['Firing Criteria']),
                                "Key Trade-offs": formatFieldValue(appState.segmentData?.['Key Trade-offs'])
                            },
                            customerValue: {
                                "Table Stakes": formatFieldValue(appState.segmentData?.['Table Stakes']),
                                "Functional Value": formatFieldValue(appState.segmentData?.['Functional Value']),
                                "Ease of Doing Business": formatFieldValue(appState.segmentData?.['Ease of Doing Business']),
                                "Individual Value": formatFieldValue(appState.segmentData?.['Individual Value']),
                                "Aspirational Value": formatFieldValue(appState.segmentData?.['Aspirational Value'])
                            },
                            willingnessToPay: {
                                "Ability to Pay": formatFieldValue(appState.segmentData?.['Ability to Pay']),
                                "Economic Justification": formatFieldValue(appState.segmentData?.['Economic Justification']),
                                "Relative Value vs. Alternatives": formatFieldValue(appState.segmentData?.['Relative Value vs. Alternatives']),
                                "Risk & Switching Costs": formatFieldValue(appState.segmentData?.['Risk & Switching Costs']),
                                "Market Reference Points": formatFieldValue(appState.segmentData?.['Market Reference Points'])
                            }
                        },
                        icpDefinition: {
                            partName: "ICP Definition",
                            partNumber: 2,
                            data: appState.positioningData ? Object.keys(appState.positioningData)
                                .filter(key => key.startsWith('icp_'))
                                .reduce((obj, key) => {
                                    const formattedValue = formatFieldValue(appState.positioningData[key]);
                                    if (formattedValue) obj[key] = formattedValue;
                                    return obj;
                                }, {}) : {}
                        },
                        positioning: {
                            partName: "Positioning",
                            partNumber: 3,
                            data: appState.positioningData ? Object.keys(appState.positioningData)
                                .filter(key => !key.startsWith('icp_'))
                                .reduce((obj, key) => {
                                    const formattedValue = formatFieldValue(appState.positioningData[key]);
                                    if (formattedValue) obj[key] = formattedValue;
                                    return obj;
                                }, {}) : {}
                        },
                        categoryDesign: {
                            partName: "Category Design",
                            partNumber: 4,
                            data: appState.categoryData ? Object.keys(appState.categoryData)
                                .reduce((obj, key) => {
                                    const formattedValue = formatFieldValue(appState.categoryData[key]);
                                    if (formattedValue) obj[key] = formattedValue;
                                    return obj;
                                }, {}) : {}
                        }
                    }
                };
            };


            // Helper function to mark a part as completed
            const markPartAsCompleted = (partId) => {
                setAppState(prev => {
                    const updatedCompletedParts = prev.navigationProgress.completedParts.includes(partId)
                        ? prev.navigationProgress.completedParts
                        : [...prev.navigationProgress.completedParts, partId];
                    
                    return {
                        ...prev,
                        navigationProgress: {
                            ...prev.navigationProgress,
                            completedParts: updatedCompletedParts,
                            partCompletionData: {
                                ...prev.navigationProgress.partCompletionData,
                                [partId]: {
                                    completed: true,
                                    completedAt: new Date().toISOString()
                                }
                            }
                        }
                    };
                });
            };

            const navigate = (view) => {
                setAppState(prev => {
                    const newState = { ...prev, currentView: view };
                    
                    // Update navigationProgress for workflow pages
                    if (['segment', 'icp', 'positioning', 'category'].includes(view)) {
                        newState.navigationProgress = {
                            ...prev.navigationProgress,
                            currentPart: view
                        };
                    }
                    
                    return newState;
                });
            };

            const renderCurrentView = () => {
                switch (appState.currentView) {
                    // case 'analysis': - REMOVED for simplification
                    case 'segment':
                        return <SegmentFoundationTool appState={appState} setAppState={setAppState} onNavigate={navigate} markPartAsCompleted={markPartAsCompleted} openTourAtStep={openTourAtStep} />;
                    case 'icp':
                        return <ICPDefinitionTool appState={appState} setAppState={setAppState} onNavigate={navigate} markPartAsCompleted={markPartAsCompleted} openTourAtStep={openTourAtStep} />;
                    case 'positioning':
                        return <PositioningTool appState={appState} setAppState={setAppState} onNavigate={navigate} markPartAsCompleted={markPartAsCompleted} />;
                    case 'category':
                        return <CategoryDesignTool appState={appState} setAppState={setAppState} onNavigate={navigate} markPartAsCompleted={markPartAsCompleted} />;
                    case 'home':
                    default:
                        return <Home appState={appState} setAppState={setAppState} onNavigate={navigate} setShowAIResearchModal={setShowAIResearchModal} openTourAtStep={openTourAtStep} onImport={handleStartImport} onExport={handleExportSession} disabled={isProcessingImport} />;
                }
            };

            // Show progress stepper only on workflow pages
            const showProgressStepper = ['segment', 'icp', 'positioning', 'category'].includes(appState.currentView);

            

            return (
                <div>
                    {showProgressStepper && (
                        <ProgressStepper
                            currentPart={appState.currentView}
                            completedParts={appState.navigationProgress.completedParts}
                            onNavigate={navigate}
                            appState={appState}
                            saveAppState={saveAppState}
                            onImport={handleStartImport}
                            onExport={handleExportSession}
                            disabled={isProcessingImport}
                        />
                    )}
                    {renderCurrentView()}
                    {/* AI Research Modal will be rendered here */}
                    {showAIResearchModal && (
                        <AIResearchModal
                            isOpen={showAIResearchModal}
                            onClose={() => setShowAIResearchModal(false)}
                            appState={appState}
                            setAppState={setAppState}
                        />
                    )}
                    <SessionNotice notice={sessionNotice} onDismiss={dismissNotice} />
                    <SessionImportModal
                        isOpen={Boolean(pendingImport)}
                        fileName={pendingImport?.fileName}
                        onCancel={handleCancelImport}
                        onConfirm={handleConfirmImport}
                        isProcessing={isProcessingImport}
                    />
                    <OnboardingTour
                        isOpen={showOnboardingTour}
                        onClose={() => setShowOnboardingTour(false)}
                        startStep={tourStartStep}
                    />
                </div>
            );
        };

        
        const container = document.getElementById('root');
        if (container) {
            try {
                const root = ReactDOM.createRoot(container);
                
                root.render(<App />);
            } catch (error) {
                serverLog('error', 'Failed to create or render React root', error);
            }
        } else {
            serverLog('error', 'Root container not found!');
        }
    </script>
</body>
</html>