<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive GTM Blueprint Series</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700&family=Work+Sans:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f6f6f6;
        }
        
        .scale-green-bg {
            background-color: #10b981;
        }
        
        .scale-green-text {
            color: #10b981;
        }
        
        .scale-gold-text {
            color: #d97706;
        }
    </style>
</head>
<body class="text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        // Get all React hooks we need
        const { useState, useEffect, useRef } = React;

        // Enhanced logging that sends to server
        const serverLog = async (level, message, error = null) => {
            // Temporarily disabled to prevent infinite loops
            return;
        };

        // Console overrides temporarily disabled to prevent infinite loops
        // const originalConsoleError = console.error;
        // const originalConsoleLog = console.log;
        // const originalConsoleWarn = console.warn;

        // Error listeners temporarily disabled to prevent infinite loops
        // window.addEventListener('error', (event) => {
        //     serverLog('error', `Unhandled error: ${event.message}`, event.error);
        // });

        // window.addEventListener('unhandledrejection', (event) => {
        //     serverLog('error', `Unhandled promise rejection: ${event.reason}`);
        // });


        // localStorage helper functions
        const saveAppState = (state) => {
          try {
            const stateWithTimestamp = {
              ...state,
              lastSaved: new Date().toISOString()
            };
            localStorage.setItem('klarityGTMBlueprintState', JSON.stringify(stateWithTimestamp));
          } catch (error) {
            console.error('Could not save state to localStorage', error);
          }
        };

        const loadAppState = () => {
          try {
            const savedState = localStorage.getItem('klarityGTMBlueprintState');
            if (!savedState) {
              return null;
            }
            
            const parsedState = JSON.parse(savedState);
            
            // Merge with initial state to ensure all new properties exist
            const initialState = getInitialState();
            const mergedState = {
              ...initialState,
              ...parsedState,
              // Ensure nested objects are properly merged
              positioningData: { ...initialState.positioningData, ...(parsedState.positioningData || {}) },
              categoryData: { ...initialState.categoryData, ...(parsedState.categoryData || {}) },
              segmentData: { ...initialState.segmentData, ...(parsedState.segmentData || {}) },
              companyContext: { ...initialState.companyContext, ...(parsedState.companyContext || {}) },
              navigationProgress: { 
                ...initialState.navigationProgress, 
                ...(parsedState.navigationProgress || {}),
                partCompletionData: {
                  ...initialState.navigationProgress.partCompletionData,
                  ...(parsedState.navigationProgress?.partCompletionData || {})
                }
              }
            };
            return mergedState;
          } catch (error) {
            console.error('Could not load state from localStorage', error);
            return null;
          }
        };

        const getInitialState = () => {
          return {
            positioningData: {
              icp_common_needs: '',
              icp_desired_business_value: '',
              icp_problem_urgency: '',
              icp_quick_decision_making: '',
              icp_prioritized_requirements: '',
              icp_willingness_to_pay: '',
              icp_implementation_readiness: '',
              icp_firmographic: '',
              icp_technographic: '',
              icp_behavioral: '',
              icp_summary: '',
              'market-context': '',
              'market-context-other': '',
              alternatives: [{ val1: '', val2: '' }],
              pillars: [{ id: 1, name: '', benefit: '' }],
              values: [{ val1: '', val2: '', val3: '', pillarId: null }],
              trend1_desc: '',
              trend2_desc: '',
              trend3_desc: '',
              trend4_desc: ''
            },
            categoryData: {
              'from-statement': '',
              'to-statement': '',
              'new-opportunity': '',
              'category-name': '',
              'category-definition': '',
              'manifesto': ''
            },
            segmentData: {},
            companyContext: {
              isSetupComplete: false,
              companyName: '',
              companyWebsite: '',
              industry: '',
              productName: '',
              targetMarket: 'B2B',
              caseStudyUrls: [],
              documentationUrls: [],
              competitorNames: ['', '', '']
            },
            navigationProgress: {
              completedParts: [],
              currentPart: 'segment',
              partCompletionData: {
                segment: { completed: false, completedAt: null },
                icp: { completed: false, completedAt: null },
                positioning: { completed: false, completedAt: null },
                category: { completed: false, completedAt: null }
              }
            },
            currentView: 'home'
          };
        };

        // Progress Stepper Component
        const ProgressStepper = ({ currentPart, completedParts, onNavigate }) => {
            
            const parts = [
                { id: 'segment', name: 'Foundation', number: 1 },
                { id: 'icp', name: 'ICP Definition', number: 2 },
                { id: 'positioning', name: 'Positioning', number: 3 },
                { id: 'category', name: 'Category Design', number: 4 }
            ];

            const getStepState = (partId, current, completed) => {
                if (partId === current) return 'active';
                if (completed.includes(partId)) return 'completed';
                return 'upcoming';
            };

            return (
                <div style={{ 
                    display: 'flex', 
                    justifyContent: 'center', 
                    alignItems: 'center',
                    padding: '1rem',
                    backgroundColor: 'white',
                    borderBottom: '1px solid #e5e7eb',
                    position: 'sticky',
                    top: 0,
                    zIndex: 50
                }}>
                    {parts.map((part, index) => (
                        <React.Fragment key={part.id}>
                            <div 
                                onClick={() => {
                                    if (completedParts.includes(part.id) || part.id === currentPart) {
                                        onNavigate(part.id);
                                    }
                                }}
                                style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '0.5rem',
                                    padding: '0.75rem 1rem',
                                    borderRadius: '0.5rem',
                                    cursor: completedParts.includes(part.id) || part.id === currentPart ? 'pointer' : 'not-allowed',
                                    backgroundColor: 
                                        part.id === currentPart ? '#3b82f6' :
                                        completedParts.includes(part.id) ? '#10b981' :
                                        '#f3f4f6',
                                    color: 
                                        part.id === currentPart || completedParts.includes(part.id) ? 'white' :
                                        '#6b7280'
                                }}
                            >
                                {completedParts.includes(part.id) ? (
                                    <span>‚úì</span>
                                ) : (
                                    <span>{part.number}</span>
                                )}
                                <span>Part {part.number}: {part.name}</span>
                            </div>
                            {index < parts.length - 1 && (
                                <div style={{ margin: '0 0.5rem', color: '#9ca3af', fontWeight: 'bold' }}>
                                    ‚Üí
                                </div>
                            )}
                        </React.Fragment>
                    ))}
                </div>
            );
        };

        // Primary Action Buttons Component
        const PrimaryActions = ({ currentPart, onExport, onContinue, onReset }) => {
            
            const getButtonConfig = (part) => {
                const configs = {
                    'segment': { 
                        continue: 'Continue to Part 2: ICP Definition ‚Üí',
                        export: 'Export Foundation'
                    },
                    'icp': { 
                        continue: 'Continue to Part 3: Positioning ‚Üí',
                        export: 'Export ICP'
                    },
                    'positioning': { 
                        continue: 'Continue to Part 4: Category Design ‚Üí',
                        export: 'Export Positioning'
                    },
                    'category': { 
                        continue: 'Complete Blueprint',
                        export: 'Export Category Design'
                    }
                };
                return configs[part] || { continue: 'Continue ‚Üí', export: 'Export' };
            };

            const config = getButtonConfig(currentPart);
            
            return (
                <div style={{ display: 'flex', gap: '0.75rem', alignItems: 'center' }}>
                    {onReset && (
                        <button 
                            onClick={onReset}
                            style={{
                                background: 'transparent',
                                color: '#6b7280',
                                fontWeight: 500,
                                padding: '0.5rem 0.75rem',
                                borderRadius: '0.5rem',
                                border: '1px solid #d1d5db',
                                cursor: 'pointer'
                            }}
                        >
                            Reset
                        </button>
                    )}
                    <button 
                        onClick={onExport}
                        style={{
                            background: '#f3f4f6',
                            color: '#374151',
                            fontWeight: 600,
                            padding: '0.5rem 1rem',
                            borderRadius: '0.5rem',
                            border: 'none',
                            cursor: 'pointer'
                        }}
                    >
                        {config.export}
                    </button>
                    <button 
                        onClick={onContinue}
                        style={{
                            background: '#10b981',
                            color: 'white',
                            fontWeight: 600,
                            padding: '0.5rem 1rem',
                            borderRadius: '0.5rem',
                            border: 'none',
                            cursor: 'pointer'
                        }}
                    >
                        {config.continue}
                    </button>
                </div>
            );
        };

        // Export Modal Component
        const ExportModal = ({ isOpen, onClose, title, content, appState, filename = 'gtm-blueprint-export' }) => {
            const [copied, setCopied] = useState(false);

            const handleCopy = () => {
                navigator.clipboard.writeText(content).then(() => {
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                });
            };

            const handleDownloadJSON = () => {
                const jsonData = JSON.stringify(appState, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
                        <div className="flex justify-between items-center p-4 border-b">
                            <h2 className="text-2xl font-bold scale-green-text">{title}</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-800 text-3xl font-light">√ó</button>
                        </div>
                        <div className="p-6 overflow-y-auto">
                            <pre className="whitespace-pre-wrap text-sm bg-gray-50 p-4 rounded-md font-mono">{content}</pre>
                        </div>
                        <div className="p-4 border-t bg-gray-50 flex justify-end space-x-3">
                            <button 
                                onClick={handleDownloadJSON}
                                className="border border-gray-300 text-gray-600 font-bold py-2 px-4 rounded-lg hover:bg-gray-50 transition-colors"
                            >
                                Download JSON
                            </button>
                            <button 
                                onClick={handleCopy}
                                className="scale-green-bg text-white font-bold py-2 px-4 rounded-lg hover:bg-opacity-90"
                            >
                                {copied ? 'Copied!' : 'Copy to Clipboard'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // CompanySetupModal Component
        const CompanySetupModal = ({ isOpen, onComplete, companyData, setCompanyData }) => {
          console.log('CompanySetupModal rendered, isOpen:', isOpen, 'companyData:', companyData);
          
          if (!isOpen) return null;

          // Ensure companyData has all required properties with defaults
          const safeCompanyData = {
            companyName: '',
            companyWebsite: '',
            industry: '',
            productName: '',
            targetMarket: 'B2B',
            competitorNames: ['', '', ''],
            caseStudyUrls: [],
            documentationUrls: [],
            isSetupComplete: false,
            ...companyData
          };

          const [errors, setErrors] = useState({});
          
          const industries = [
            'SaaS/Software',
            'Financial Services', 
            'Healthcare',
            'E-commerce',
            'Manufacturing',
            'Professional Services',
            'Other'
          ];

          const validateForm = () => {
            const newErrors = {};
            
            // Validate required fields
            if (!safeCompanyData.companyName || safeCompanyData.companyName.length < 2) {
              newErrors.companyName = 'Company name must be at least 2 characters';
            }
            
            if (!safeCompanyData.companyWebsite) {
              newErrors.companyWebsite = 'Website is required';
            } else if (!/^https?:\/\/.+/.test(safeCompanyData.companyWebsite)) {
              newErrors.companyWebsite = 'Website must start with http:// or https://';
            }
            
            if (!safeCompanyData.industry) {
              newErrors.industry = 'Please select an industry';
            }
            
            if (!safeCompanyData.productName || safeCompanyData.productName.length < 2) {
              newErrors.productName = 'Product name must be at least 2 characters';
            }
            
            setErrors(newErrors);
            return Object.keys(newErrors).length === 0;
          };

          const handleSubmit = () => {
            if (validateForm()) {
              setCompanyData(prev => ({ ...safeCompanyData, ...prev, isSetupComplete: true }));
              onComplete();
            }
          };

          const updateCompetitor = (index, value) => {
            const newCompetitors = [...safeCompanyData.competitorNames];
            newCompetitors[index] = value;
            setCompanyData(prev => ({ ...safeCompanyData, ...prev, competitorNames: newCompetitors }));
          };

          return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div className="p-6">
                  <h2 className="text-2xl font-bold mb-2">Welcome! Let's set up your company context</h2>
                  <p className="text-gray-600 mb-6">This information helps our AI provide more accurate insights and recommendations.</p>
                  
                  {/* Required Fields Section */}
                  <div className="mb-8">
                    <h3 className="text-lg font-semibold mb-4 flex items-center">
                      <span className="text-red-500 mr-2">*</span>Required Information
                    </h3>
                    
                    {/* Company Name */}
                    <div className="mb-4">
                      <label className="block font-bold text-gray-700 mb-1">Company Name</label>
                      <input
                        type="text"
                        className={`w-full p-2 border rounded-md ${errors.companyName ? 'border-red-500' : 'border-gray-300'}`}
                        value={safeCompanyData.companyName}
                        onChange={(e) => setCompanyData(prev => ({ ...safeCompanyData, ...prev, companyName: e.target.value }))}
                        placeholder="e.g., Acme Corporation"
                      />
                      {errors.companyName && <p className="text-red-500 text-sm mt-1">{errors.companyName}</p>}
                    </div>

                    {/* Company Website */}
                    <div className="mb-4">
                      <label className="block font-bold text-gray-700 mb-1">Company Website</label>
                      <input
                        type="url"
                        className={`w-full p-2 border rounded-md ${errors.companyWebsite ? 'border-red-500' : 'border-gray-300'}`}
                        value={safeCompanyData.companyWebsite}
                        onChange={(e) => setCompanyData(prev => ({ ...safeCompanyData, ...prev, companyWebsite: e.target.value }))}
                        placeholder="https://example.com"
                      />
                      {errors.companyWebsite && <p className="text-red-500 text-sm mt-1">{errors.companyWebsite}</p>}
                    </div>

                    {/* Industry */}
                    <div className="mb-4">
                      <label className="block font-bold text-gray-700 mb-1">Industry</label>
                      <select
                        className={`w-full p-2 border rounded-md ${errors.industry ? 'border-red-500' : 'border-gray-300'}`}
                        value={safeCompanyData.industry}
                        onChange={(e) => setCompanyData(prev => ({ ...safeCompanyData, ...prev, industry: e.target.value }))}
                      >
                        <option value="">Select an industry</option>
                        {industries.map(ind => (
                          <option key={ind} value={ind}>{ind}</option>
                        ))}
                      </select>
                      {errors.industry && <p className="text-red-500 text-sm mt-1">{errors.industry}</p>}
                    </div>

                    {/* Product Name */}
                    <div className="mb-4">
                      <label className="block font-bold text-gray-700 mb-1">Product/Service Name</label>
                      <input
                        type="text"
                        className={`w-full p-2 border rounded-md ${errors.productName ? 'border-red-500' : 'border-gray-300'}`}
                        value={safeCompanyData.productName}
                        onChange={(e) => setCompanyData(prev => ({ ...safeCompanyData, ...prev, productName: e.target.value }))}
                        placeholder="e.g., Analytics Platform"
                      />
                      {errors.productName && <p className="text-red-500 text-sm mt-1">{errors.productName}</p>}
                    </div>

                    {/* Target Market */}
                    <div className="mb-4">
                      <label className="block font-bold text-gray-700 mb-1">Target Market</label>
                      <div className="flex gap-4">
                        <label className="flex items-center">
                          <input
                            type="radio"
                            name="targetMarket"
                            value="B2B"
                            checked={safeCompanyData.targetMarket === 'B2B'}
                            onChange={(e) => setCompanyData(prev => ({ ...safeCompanyData, ...prev, targetMarket: e.target.value }))}
                            className="mr-2"
                          />
                          B2B
                        </label>
                        <label className="flex items-center">
                          <input
                            type="radio"
                            name="targetMarket"
                            value="B2C"
                            checked={safeCompanyData.targetMarket === 'B2C'}
                            onChange={(e) => setCompanyData(prev => ({ ...safeCompanyData, ...prev, targetMarket: e.target.value }))}
                            className="mr-2"
                          />
                          B2C
                        </label>
                      </div>
                    </div>
                  </div>

                  {/* Optional Fields Section */}
                  <div className="mb-8">
                    <h3 className="text-lg font-semibold mb-4">Optional Information</h3>
                    
                    {/* Top 3 Competitors */}
                    <div className="mb-4">
                      <label className="block font-bold text-gray-700 mb-1">Top 3 Competitors</label>
                      <p className="text-sm text-gray-600 mb-2">Helps us understand your competitive landscape</p>
                      {[0, 1, 2].map(i => (
                        <input
                          key={i}
                          type="text"
                          className="w-full p-2 border border-gray-300 rounded-md mb-2"
                          value={safeCompanyData.competitorNames[i]}
                          onChange={(e) => updateCompetitor(i, e.target.value)}
                          placeholder={`Competitor ${i + 1}`}
                        />
                      ))}
                    </div>
                  </div>

                  {/* Action Buttons */}
                  <div className="flex justify-end gap-4 pt-4 border-t">
                    <button
                      onClick={handleSubmit}
                      className="scale-green-bg text-white font-bold py-2 px-6 rounded-lg hover:bg-opacity-90"
                    >
                      Get Started
                    </button>
                  </div>
                </div>
              </div>
            </div>
          );
        };

        // SubSectionNav Component
        const SubSectionNav = ({ sections, activeSection, currentPart }) => {
            return React.createElement('div', {
                style: { display: 'none' }
            }, 'Navigation temporarily disabled');
        };

        // AnalysisView Component - REMOVED for simplification
        // Navigation now goes directly from Home to Segment Foundation

        // SegmentFoundationTool Component
        const SegmentFoundationTool = ({ appState, setAppState, onNavigate }) => {
            console.log('SegmentFoundationTool rendering, appState:', appState);
            const [exportModalOpen, setExportModalOpen] = useState(false);
            const [exportContent, setExportContent] = useState('');
            const [validationState, setValidationState] = useState({});
            
            // AI Draft State Variables
            const [aiDraftLoading, setAiDraftLoading] = useState(false);
            const [aiDraftsAvailable, setAiDraftsAvailable] = useState(false);
            const [aiDraftError, setAiDraftError] = useState(null);
            
            // WTP AI Draft State Variables
            const [wtpDraftLoading, setWtpDraftLoading] = useState(false);
            const [wtpDraftsAvailable, setWtpDraftsAvailable] = useState(false);
            const [wtpDraftError, setWtpDraftError] = useState(null);

            const handleValidateJtbd = async (jtbdElementName, userInput) => {
                // Check if company context is properly set up
                if (!appState.companyContext?.industry || !appState.companyContext?.productName) {
                    setValidationState(prev => ({ 
                        ...prev, 
                        [jtbdElementName]: { 
                            status: 'error', 
                            result: {
                                alignmentScore: 0,
                                marketLanguage: [],
                                refinementSuggestions: ['Please complete the Company Context setup first by clicking "Dev Tools: Reset Company Context" in the footer and filling out your company information.']
                            }
                        }
                    }));
                    return;
                }
                
                setValidationState(prev => ({ ...prev, [jtbdElementName]: { status: 'validating' } }));
                try {
                    const response = await fetch('/api/validate-jtbd?debug=true', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            companyContext: appState.companyContext,
                            jtbdElementName,
                            userInput
                        })
                    });
                    if (!response.ok) {
                        throw new Error('Validation failed');
                    }
                    const results = await response.json();
                    
                    // Log debug information to console
                    console.log(`üîç VAL-FEAT-001 Debug: ${jtbdElementName}`, {
                        userInput: userInput,
                        queries: results.debug?.queries,
                        searchResults: {
                            snippetCount: results.debug?.searchResultsCount.snippets,
                            titleCount: results.debug?.searchResultsCount.titles,
                            sampleSnippets: results.debug?.sampleSnippets
                        },
                        analysis: {
                            alignmentScore: results.alignmentScore,
                            marketLanguage: results.marketLanguage,
                            suggestions: results.refinementSuggestions
                        }
                    });
                    
                    setValidationState(prev => ({ ...prev, [jtbdElementName]: { status: 'success', results } }));
                } catch (error) {
                    console.error(`‚ùå VAL-FEAT-001 Error: ${jtbdElementName}`, error);
                    setValidationState(prev => ({ ...prev, [jtbdElementName]: { status: 'error', error: error.message } }));
                }
            };

            const renderValidationResult = (elementName) => {
                const state = validationState[elementName];
                if (!state) return null;
                if (state.status === 'validating') {
                    return <div className="text-sm text-gray-500 italic mt-2">Validating...</div>;
                }
                if (state.status === 'error') {
                    const errorMessage = state.error || 'Validation service is unavailable. Please try again later.';
                    return <div className="text-sm text-red-500 mt-2">Error: {errorMessage}</div>;
                }
                if (state.status === 'success' && state.results) {
                    const { alignmentScore, marketLanguage, refinementSuggestions } = state.results;
                    return (
                        <div className="mt-2 p-3 bg-gray-50 border border-gray-200 rounded-md">
                            <h4 className="text-sm font-bold text-gray-700 mb-2">
                                Validation Results 
                                <span className="ml-2 text-xs text-blue-600 cursor-help" title="Check browser console for detailed analysis">
                                    (Debug: Check Console)
                                </span>
                            </h4>
                            <p className="text-sm text-gray-600"><strong>Alignment Score:</strong> {alignmentScore}%</p>
                            <p className="text-sm text-gray-600"><strong>Market Language:</strong> {marketLanguage.join(', ')}</p>
                            <div>
                                <p className="text-sm font-bold text-gray-700 mt-2">Suggestions:</p>
                                <ul className="list-disc list-inside text-sm text-gray-600">
                                    {refinementSuggestions.map((suggestion, index) => (
                                        <li key={index}>{suggestion}</li>
                                    ))}
                                </ul>
                            </div>
                        </div>
                    );
                }
                return null;
            };

            const handleReset = () => {
                if (window.confirm('Are you sure you want to reset all segment data? This action cannot be undone.')) {
                    setAppState(prev => ({ ...prev, segmentData: {} }));
                }
            };

            const generateExportContent = () => {
                const formatSection = (title, fields) => {
                    let section = `## ${title}\n`;
                    fields.forEach(field => {
                        const value = appState.segmentData[field] || 'Not provided';
                        section += `**${field}:** ${value}\n\n`;
                    });
                    return section;
                };
                
                let summary = `# Segment Foundation Summary\n\n`;
                
                summary += formatSection('Jobs To Be Done', [
                    'Context',
                    'Struggling Moments', 
                    'Pushes & Pulls',
                    'Anxieties & Habits',
                    'Desired Outcomes',
                    'Basic Quality (Table Stakes)',
                    'Hiring Criteria',
                    'Firing Criteria',
                    'Key Trade-offs'
                ]);
                
                summary += formatSection('Customer Value', [
                    'Table Stakes',
                    'Functional Value',
                    'Ease of Doing Business', 
                    'Individual Value',
                    'Aspirational Value'
                ]);
                
                summary += formatSection('Willingness to Pay', [
                    'Ability to Pay',
                    'Economic Justification',
                    'Relative Value vs. Alternatives',
                    'Risk',
                    'Market Reference Points'
                ]);
                
                return summary;
            };
            
            const handleExport = () => {
                const content = generateExportContent();
                setExportContent(content);
                setExportModalOpen(true);
            };
            
            // AI Customer Value Generation Handler
            const handleGenerateCustomerValue = async () => {
                setAiDraftLoading(true);
                setAiDraftError(null);
                
                try {
                    const jtbdFields = ['Context', 'Struggling Moments', 'Pushes & Pulls', 'Anxieties & Habits', 'Desired Outcomes', 'Basic Quality (Table Stakes)', 'Hiring Criteria', 'Firing Criteria', 'Key Trade-offs'];
                    const filledFields = jtbdFields.filter(field => appState.segmentData[field]?.trim());
                    
                    if (filledFields.length < 3) {
                        setAiDraftError('Please complete at least 3 Jobs-to-be-Done fields before using the AI assistant.');
                        setAiDraftLoading(false);
                        return;
                    }
                    
                    const response = await fetch('/api/draft-customer-value', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            jtbdData: appState.segmentData
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API call failed: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success && data.drafts) {
                        // Update segmentData with AI-generated drafts
                        setAppState(prev => ({
                            ...prev,
                            segmentData: {
                                ...prev.segmentData,
                                'Table Stakes': data.drafts['Table Stakes'],
                                'Functional Value': data.drafts['Functional Value'],
                                'Ease of Doing Business': data.drafts['Ease of Doing Business'],
                                'Individual Value': data.drafts['Individual Value'],
                                'Aspirational Value': data.drafts['Aspirational Value']
                            }
                        }));
                        
                        setAiDraftsAvailable(true);
                    } else {
                        throw new Error(data.error || 'AI generation failed');
                    }
                } catch (error) {
                    console.error('AI Customer Value Generation Error:', error);
                    setAiDraftError(error.message || 'AI assistant is currently unavailable. Please try again later.');
                }
                
                setAiDraftLoading(false);
            };
            
            // AI WTP Generation Handler
            const handleGenerateWTP = async () => {
                setWtpDraftLoading(true);
                setWtpDraftError(null);
                
                try {
                    const customerValueFields = ['Table Stakes', 'Functional Value', 'Ease of Doing Business', 'Individual Value', 'Aspirational Value'];
                    const hasCustomerValue = customerValueFields.some(field => appState.segmentData[field]?.trim());
                    
                    if (!hasCustomerValue) {
                        setWtpDraftError('Please complete the Customer Value section first before generating WTP drivers.');
                        setWtpDraftLoading(false);
                        return;
                    }
                    
                    const response = await fetch('/api/draft-wtp-value', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            jtbdData: appState.segmentData,
                            customerValueData: {
                                'Table Stakes': appState.segmentData['Table Stakes'],
                                'Functional Value': appState.segmentData['Functional Value'],
                                'Ease of Doing Business': appState.segmentData['Ease of Doing Business'],
                                'Individual Value': appState.segmentData['Individual Value'],
                                'Aspirational Value': appState.segmentData['Aspirational Value']
                            }
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API call failed: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success && data.drafts) {
                        // Update segmentData with AI-generated WTP drafts
                        setAppState(prev => ({
                            ...prev,
                            segmentData: {
                                ...prev.segmentData,
                                'Ability to Pay': data.drafts['Ability to Pay'],
                                'Economic Justification': data.drafts['Economic Justification'],
                                'Relative Value vs. Alternatives': data.drafts['Relative Value vs. Alternatives'],
                                'Risk': data.drafts['Risk'],
                                'Market Reference Points': data.drafts['Market Reference Points']
                            }
                        }));
                        
                        setWtpDraftsAvailable(true);
                    } else {
                        throw new Error(data.error || 'AI generation failed');
                    }
                } catch (error) {
                    console.error('AI WTP Generation Error:', error);
                    setWtpDraftError(error.message || 'AI assistant is currently unavailable. Please try again later.');
                }
                
                setWtpDraftLoading(false);
            };
            
            return (
                <div className="container mx-auto px-4 sm:px-6 lg:px-8 min-h-screen pb-16">
                    {/* AI-Generated Banner */}
                    {appState.aiGeneratedSegment && !appState.aiGeneratedBannerDismissed && (
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 flex items-center justify-between">
                            <div className="flex items-center space-x-3">
                                <div className="flex-shrink-0">
                                    <svg className="w-5 h-5 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd"></path>
                                    </svg>
                                </div>
                                <div className="flex-1">
                                    <p className="text-sm font-medium text-blue-800">
                                        AI-Generated Draft
                                    </p>
                                    <p className="text-sm text-blue-600">
                                        This form has been pre-populated with AI-generated insights based on your company analysis. Review and edit as needed.
                                    </p>
                                </div>
                            </div>
                            <button
                                onClick={() => setAppState(prev => ({ ...prev, aiGeneratedBannerDismissed: true }))}
                                className="flex-shrink-0 ml-4 text-blue-400 hover:text-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-blue-50 rounded-md p-1"
                                aria-label="Dismiss banner"
                            >
                                <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                    )}
                    
                    <header className="sticky top-16 bg-white border-b border-gray-200 z-40 py-3">
                        <div className="flex justify-between items-center py-3">
                            <div className="flex items-center space-x-4">
                                <button onClick={() => onNavigate('home')} className="text-gray-600 hover:scale-gold-text">‚Üê Back to Home</button>
                                <h1 className="text-xl sm:text-2xl font-bold scale-green-text">Part 1: Segment Foundation</h1>
                            </div>
                            {React.createElement(PrimaryActions, {
                                currentPart: 'segment',
                                onReset: handleReset,
                                onExport: handleExport,
                                onContinue: () => { onNavigate('icp'); window.scrollTo(0, 0); }
                            })}
                        </div>
                    </header>

                    <div className="mt-8">
                        <div className="lg:flex lg:space-x-8">
                            {/* Sticky Navigation Sidebar */}
                            <nav className="hidden lg:block w-64 flex-shrink-0 sticky top-36 h-fit">
                                <div className="bg-white p-6 rounded-lg shadow-md">
                                    <h3 className="text-lg font-semibold text-gray-800 mb-4">Section Navigation</h3>
                                    <ul className="space-y-3">
                                        <li>
                                            <a 
                                                href="#jtbd-section" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('jtbd-section').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                Jobs to be Done
                                            </a>
                                        </li>
                                        <li>
                                            <a 
                                                href="#value-section" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('value-section').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                Customer Value
                                            </a>
                                        </li>
                                        <li>
                                            <a 
                                                href="#wtp-section" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('wtp-section').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                Willingness to Pay
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </nav>
                            
                            <main className="flex-1 min-w-0">
                                <div className="space-y-8">
                                    {/* Market Segment Definition Header */}
                                    <div id="segment-definition-section" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                                        <div className="text-center mb-8">
                                            <p className="text-lg text-gray-700 mb-8 max-w-4xl mx-auto">
                                                A true market segment is composed of customers who share a common Job to be Done, 
                                                perceive value similarly, and have a similar Willingness to Pay.
                                            </p>
                                            
                                            {/* Custom SVG Funnel Diagram */}
                                            <div className="flex justify-center">
                                                <svg width="400" height="450" viewBox="0 0 400 450" className="max-w-full h-auto">
                                                    <defs>
                                                        <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                                                                refX="9" refY="3.5" orient="auto">
                                                            <polygon points="0 0, 10 3.5, 0 7" fill="#224f41"/>
                                                        </marker>
                                                    </defs>
                                                    
                                                    {/* Top of Funnel - Total Market */}
                                                    <rect x="50" y="20" width="300" height="60" fill="#e5ecea" stroke="#224f41" strokeWidth="2" rx="4"/>
                                                    <text x="200" y="55" textAnchor="middle" fill="#224f41" fontSize="16" fontWeight="600">
                                                        Total Market of Buyers
                                                    </text>
                                                    
                                                    {/* Arrow 1 */}
                                                    <line x1="200" y1="80" x2="200" y2="110" stroke="#224f41" strokeWidth="2" markerEnd="url(#arrowhead)"/>
                                                    
                                                    {/* Filter Gate 1 - Job to be Done */}
                                                    <rect x="80" y="115" width="240" height="50" fill="#7da399" stroke="#224f41" strokeWidth="2" rx="4"/>
                                                    <text x="200" y="135" textAnchor="middle" fill="white" fontSize="14" fontWeight="500">
                                                        Shared Job to be Done
                                                    </text>
                                                    <text x="200" y="150" textAnchor="middle" fill="white" fontSize="12">
                                                        (Common Context &amp; Struggling Moments)
                                                    </text>
                                                    
                                                    {/* Arrow 2 */}
                                                    <line x1="200" y1="165" x2="200" y2="195" stroke="#224f41" strokeWidth="2" markerEnd="url(#arrowhead)"/>
                                                    
                                                    {/* Filter Gate 2 - Perceived Value */}
                                                    <rect x="110" y="200" width="180" height="50" fill="#528577" stroke="#224f41" strokeWidth="2" rx="4"/>
                                                    <text x="200" y="220" textAnchor="middle" fill="white" fontSize="14" fontWeight="500">
                                                        Commonly Perceived Value
                                                    </text>
                                                    <text x="200" y="235" textAnchor="middle" fill="white" fontSize="12">
                                                        (Similar Value Priorities)
                                                    </text>
                                                    
                                                    {/* Arrow 3 */}
                                                    <line x1="200" y1="250" x2="200" y2="280" stroke="#224f41" strokeWidth="2" markerEnd="url(#arrowhead)"/>
                                                    
                                                    {/* Filter Gate 3 - Willingness to Pay */}
                                                    <rect x="140" y="285" width="120" height="50" fill="#224f41" stroke="#224f41" strokeWidth="2" rx="4"/>
                                                    <text x="200" y="305" textAnchor="middle" fill="white" fontSize="14" fontWeight="500">
                                                        Similar Willingness
                                                    </text>
                                                    <text x="200" y="320" textAnchor="middle" fill="white" fontSize="14" fontWeight="500">
                                                        to Pay
                                                    </text>
                                                    
                                                    {/* Arrow 4 */}
                                                    <line x1="200" y1="335" x2="200" y2="365" stroke="#224f41" strokeWidth="2" markerEnd="url(#arrowhead)"/>
                                                    
                                                    {/* Bottom of Funnel - True Market Segment */}
                                                    <rect x="160" y="370" width="80" height="60" fill="#e5a819" stroke="#224f41" strokeWidth="2" rx="4"/>
                                                    <text x="200" y="390" textAnchor="middle" fill="#224f41" fontSize="14" fontWeight="600">
                                                        A True
                                                    </text>
                                                    <text x="200" y="405" textAnchor="middle" fill="#224f41" fontSize="14" fontWeight="600">
                                                        Market
                                                    </text>
                                                    <text x="200" y="420" textAnchor="middle" fill="#224f41" fontSize="14" fontWeight="600">
                                                        Segment
                                                    </text>
                                                    
                                                    {/* Side Labels */}
                                                    <text x="30" y="225" textAnchor="middle" fill="#224f41" fontSize="12" transform="rotate(-90, 30, 225)">
                                                        Filtering Process
                                                    </text>
                                                    <text x="370" y="225" textAnchor="middle" fill="#224f41" fontSize="12" transform="rotate(90, 370, 225)">
                                                        Strategic Focus
                                                    </text>
                                                </svg>
                                            </div>
                                            
                                            <p className="text-sm text-gray-600 mt-6 max-w-3xl mx-auto">
                                                The three input sections below help you define each filter criterion to identify your true market segment.
                                            </p>
                                        </div>
                                    </div>
                                    
                                    {/* Jobs To Be Done Section */}
                                    <div id="jtbd-section" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                                        <h2 className="text-2xl font-bold scale-green-text mb-6">Jobs To Be Done</h2>
                                        <div className="space-y-6">
                                            {[
                                                { name: 'Context', description: 'The business situation or operating environment.', placeholder: 'Quarterly close process across distributed finance teams.' },
                                                { name: 'Struggling Moments', description: 'Breakdowns, inefficiencies, or risks that trigger the search.', placeholder: 'Errors in revenue recognition delaying financial reporting.' },
                                                { name: 'Pushes & Pulls', description: 'Internal and external forces moving them toward or away from change.', placeholder: 'CFO pressure to modernize systems vs. IT reluctance to add new vendors.' },
                                                { name: 'Anxieties & Habits', description: 'Concerns about adopting something new, and inertia with current processes/tools.', placeholder: 'Fear of migration failure; comfort with spreadsheets.' },
                                                { name: 'Desired Outcomes', description: 'We will refine this outcome into specific types of value in the **Customer Value** section', placeholder: 'Reduce audit prep time by 50%; ensure SOX compliance.' },
                                                { name: 'Basic Quality (Table Stakes)', description: 'Minimum standards a solution must meet to even be considered.', placeholder: 'SOC2 compliance, API integrations with ERP, enterprise-grade security.' },
                                                { name: 'Hiring Criteria', description: 'Differentiators that make them select one vendor.', placeholder: 'Proven implementation playbook; reference customers in financial services.' },
                                                { name: 'Firing Criteria', description: 'Triggers that get a vendor rejected or replaced.', placeholder: 'System downtime; lack of role-based access control.' },
                                                { name: 'Key Trade-offs', description: 'Acceptable compromises or limits.', placeholder: 'May sacrifice customization for faster time to value.' }
                                            ].map(field => (
                                                <div key={field.name}>
                                                    <label className="block text-lg font-semibold text-gray-800 mb-2">{field.name}</label>
                                                    <p className="text-gray-600 text-sm mb-3">{field.description}</p>
                                                    <textarea
                                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                        rows="3"
                                                        value={appState.segmentData[field.name] || ''}
                                                        onChange={(e) => {
                                                            const newSegmentData = { ...appState.segmentData, [field.name]: e.target.value };
                                                            setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                        }}
                                                        placeholder={field.placeholder}
                                                    />
                                                    {/* Validate button removed for simplification */}
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Customer Value Section */}
                                    <div id="value-section" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                                        <h2 className="text-2xl font-bold scale-green-text mb-6">Customer Value</h2>
                                        
                                        <div className="space-y-6">
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Table Stakes</label>
                                                <p className="text-gray-600 text-sm mb-3">The non-negotiables for credibility and trust. Baseline requirements.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Table Stakes'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Table Stakes': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: SOC2 certification; ERP integration; 99.9% uptime SLAs."
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Functional Value</label>
                                                <p className="text-gray-600 text-sm mb-3">Tangible, measurable outcomes‚ÄîROI, efficiency, cost savings, growth, or risk mitigation.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Functional Value'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Functional Value': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: $500K OpEx savings from faster close cycles and fewer errors."
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Ease of Doing Business</label>
                                                <p className="text-gray-600 text-sm mb-3">How simple you make adoption and daily use. Less friction wins.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Ease of Doing Business'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Ease of Doing Business': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: Fast implementation playbook; role-based onboarding; 24/7 enterprise support."
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Individual Value</label>
                                                <p className="text-gray-600 text-sm mb-3">What matters to each buyer personally‚Äîstatus, workload relief, confidence, or career gains.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Individual Value'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Individual Value': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: CFO is seen as innovator; IT leader feels secure; end users save hours."
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Aspirational Value</label>
                                                <p className="text-gray-600 text-sm mb-3">Alignment with higher-order goals and purpose. Motivations beyond rational ROI.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Aspirational Value'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Aspirational Value': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: Supports ESG reporting; signals innovation to board and investors."
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    {/* Willingness to Pay Section */}
                                    <div id="wtp-section" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                                        <h2 className="text-2xl font-bold scale-green-text mb-6">Willingness to Pay</h2>
                                        
                                        <div className="space-y-6">
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Ability to Pay</label>
                                                <p className="text-gray-600 text-sm mb-3">Whether the customer has budget and capacity to spend. Even strong solutions fail without funding.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Ability to Pay'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Ability to Pay': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: Line item already approved in FY25 budget for compliance automation."
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Economic Justification</label>
                                                <p className="text-gray-600 text-sm mb-3">Whether the ROI and payback case makes financial sense. Customers want proof it pays for itself.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Economic Justification'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Economic Justification': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: Pays for itself in under 12 months through $1M annual cost avoidance."
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Relative Value vs. Alternatives</label>
                                                <p className="text-gray-600 text-sm mb-3">How your solution compares to competitors or the status quo. Clear differentiation increases willingness to pay.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Relative Value vs. Alternatives'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Relative Value vs. Alternatives': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: Automates 80% of manual work versus consultant-heavy models."
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Risk & Switching Costs</label>
                                                <p className="text-gray-600 text-sm mb-3">How much risk or friction they see in making the change. Higher risk lowers willingness; mitigation raises it.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Risk & Switching Costs'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Risk & Switching Costs': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: Migration takes days, not months; vendor assumes implementation risk."
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Market Reference Points</label>
                                                <p className="text-gray-600 text-sm mb-3">The pricing anchors customers bring from prior spend or competitors. Buyers benchmark against "similar" tools.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Market Reference Points'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Market Reference Points': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: Analytics platforms in this space usually run $100K‚Äì$150K annually."
                                                />
                                            </div>
                                        </div>
                                        
                                        {/* Clear All Fields Button */}
                                        <div className="mt-8 text-center">
                                            <button
                                                onClick={() => {
                                                    // Clear all JTBD and Customer Value fields
                                                    const clearedSegmentData = {};
                                                    setAppState(prev => ({ ...prev, segmentData: clearedSegmentData }));
                                                    alert('All fields cleared! Refresh the page to see placeholder text.');
                                                }}
                                                className="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600 transition-colors mr-4"
                                            >
                                                Clear All Fields
                                            </button>
                                            
                                            {/* Continue to Part 2 Button */}
                                            <button
                                                onClick={() => { onNavigate('icp'); window.scrollTo(0, 0); }}
                                                className="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition-colors"
                                            >
                                                Continue to Part 2: ICP Definition
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </main>
                        </div>
                    </div>

                    <ExportModal 
                        isOpen={exportModalOpen}
                        onClose={() => setExportModalOpen(false)}
                        title="Segment Foundation Summary"
                        content={exportContent}
                        appState={appState}
                        filename="segment-foundation-export"
                    />
                </div>
            );
        };

        // ICPFlowVisualization Component
        const ICPFlowVisualization = ({ appState, onNavigate }) => {
            const [hoveredSection, setHoveredSection] = useState(null);
            const [tooltipPosition, setTooltipPosition] = useState({ x: 0, y: 0 });
            
            // Check completion status for progressive states
            const isSegmentComplete = appState.segmentData && 
                Object.values(appState.segmentData).some(value => value && value.trim().length > 0);
            
            const isICPStarted = appState.positioningData && (
                appState.positioningData.icp_summary ||
                (appState.positioningData.values && appState.positioningData.values.some(v => v.val1))
            );
            
            const isICPComplete = appState.positioningData && 
                appState.positioningData.icp_summary && 
                appState.positioningData.values && 
                appState.positioningData.values.length > 0 &&
                appState.positioningData.values[0].val1;
            
            // Tooltip content for each section
            const tooltips = {
                segment: {
                    title: "Market Segment Foundation",
                    content: "Your foundational customer understanding from Part 1: Segment Foundation. This includes Jobs-to-be-Done, Customer Value propositions, and Willingness to Pay analysis.",
                    action: "Click to edit Segment Foundation"
                },
                bridge: {
                    title: "Strategic Bridge Analysis",
                    content: "The analytical work required to transform market segment insights into actionable ICP. This involves validating Product-Problem Fit and confirming your Scalable Business Model.",
                    action: "This represents your current analysis work"
                },
                strategic: {
                    title: "Strategic ICP - The 'Why'",
                    content: "The strategic reasoning behind your ICP focused on messaging and positioning. Includes the fundamental motivations, value drivers, and job-to-be-done insights.",
                    action: "Click to work on Strategic ICP elements"
                },
                operational: {
                    title: "Operational ICP - The 'Where'",
                    content: "The tactical targeting criteria for campaigns and sales. Includes firmographics, technographics, and behavioral signals for finding and reaching prospects.",
                    action: "Click to work on Operational ICP elements"
                }
            };
            
            // Handle mouse events for tooltips
            const handleMouseEnter = (section, event) => {
                setHoveredSection(section);
                const rect = event.currentTarget.getBoundingClientRect();
                setTooltipPosition({
                    x: rect.left + rect.width / 2,
                    y: rect.top - 10
                });
            };
            
            const handleMouseLeave = () => {
                setHoveredSection(null);
            };
            
            // Handle click navigation
            const handleSectionClick = (section) => {
                switch (section) {
                    case 'segment':
                        onNavigate('segment');
                        window.scrollTo(0, 0);
                        break;
                    case 'strategic':
                    case 'operational':
                        // Stay on current page but scroll to ICP definition
                        const icpSection = document.getElementById('section-1');
                        if (icpSection) {
                            icpSection.scrollIntoView({ behavior: 'smooth' });
                        }
                        break;
                    default:
                        break;
                }
            };
            
            return (
                <div className="mb-8 bg-white p-6 rounded-lg shadow-md">
                    <h3 className="text-lg font-bold text-gray-800 mb-4 text-center">Strategic Flow: From Market Segment to Actionable ICP</h3>
                    
                    {/* Desktop and Tablet Layout */}
                    <div className="hidden md:block">
                        <svg
                            viewBox="0 0 800 300"
                            className="w-full h-auto max-w-4xl mx-auto"
                            role="img"
                            aria-labelledby="icp-flow-title"
                            aria-describedby="icp-flow-desc"
                        >
                            <title id="icp-flow-title">Strategic ICP Development Flow</title>
                            <desc id="icp-flow-desc">Visual representation of the progression from market segment to actionable ICP through product and business model fit</desc>
                            
                            {/* Market Segment Box (Left) - Interactive */}
                            <g
                                onMouseEnter={(e) => handleMouseEnter('segment', e)}
                                onMouseLeave={handleMouseLeave}
                                onClick={() => handleSectionClick('segment')}
                                style={{ cursor: 'pointer' }}
                            >
                                <rect
                                    x="30"
                                    y="100"
                                    width="150"
                                    height="100"
                                    rx="8"
                                    fill={isSegmentComplete ? "#059669" : "#9CA3AF"}
                                    opacity={hoveredSection === 'segment' ? "0.8" : (isSegmentComplete ? "1" : "0.5")}
                                    stroke={hoveredSection === 'segment' ? "#047857" : "transparent"}
                                    strokeWidth="2"
                                />
                                <text x="105" y="125" textAnchor="middle" fill="white" fontSize="14" fontWeight="bold" fontFamily="Work Sans, sans-serif">Market Segment</text>
                                <text x="105" y="145" textAnchor="middle" fill="white" fontSize="12" fontFamily="Outfit, sans-serif">JTBD ‚Ä¢ Value ‚Ä¢ WTP</text>
                                <text x="105" y="165" textAnchor="middle" fill="white" fontSize="10" fontFamily="Outfit, sans-serif">Foundation Complete</text>
                                <text x="105" y="180" textAnchor="middle" fill="white" fontSize="10" fontFamily="Outfit, sans-serif">{isSegmentComplete ? "‚úì" : "‚óã"}</text>
                                {hoveredSection === 'segment' && (
                                    <text x="105" y="195" textAnchor="middle" fill="white" fontSize="9" fontFamily="Outfit, sans-serif" fontStyle="italic">Click to edit</text>
                                )}
                            </g>
                            
                            {/* Bridge Arrow */}
                            <defs>
                                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                                    <polygon points="0 0, 10 3.5, 0 7" fill="#6B7280" />
                                </marker>
                            </defs>
                            
                            {/* Arrow Line */}
                            <line x1="180" y1="150" x2="380" y2="150" stroke="#6B7280" strokeWidth="3" markerEnd="url(#arrowhead)" />
                            
                            {/* Bridge Content Box - Interactive */}
                            <g
                                onMouseEnter={(e) => handleMouseEnter('bridge', e)}
                                onMouseLeave={handleMouseLeave}
                                style={{ cursor: 'help' }}
                            >
                                <rect 
                                    x="220" 
                                    y="60" 
                                    width="180" 
                                    height="80" 
                                    rx="6" 
                                    fill={hoveredSection === 'bridge' ? "#E5E7EB" : "#F3F4F6"} 
                                    stroke={hoveredSection === 'bridge' ? "#374151" : "#6B7280"} 
                                    strokeWidth="1" 
                                />
                                <text x="310" y="80" textAnchor="middle" fill="#374151" fontSize="12" fontWeight="bold" fontFamily="Work Sans, sans-serif">Add Product &amp; Business</text>
                                <text x="310" y="95" textAnchor="middle" fill="#374151" fontSize="12" fontWeight="bold" fontFamily="Work Sans, sans-serif">Model Fit</text>
                                <text x="310" y="115" textAnchor="middle" fill="#6B7280" fontSize="10" fontFamily="Outfit, sans-serif">Product-Problem Fit</text>
                                <text x="310" y="128" textAnchor="middle" fill="#6B7280" fontSize="10" fontFamily="Outfit, sans-serif">Scalable Business Model</text>
                            </g>
                            
                            {/* Actionable ICP Container (Right) */}
                            <rect x="420" y="50" width="350" height="200" rx="8" fill="#F9FAFB" stroke="#D1D5DB" strokeWidth="1" />
                            
                            {/* Header */}
                            <text x="595" y="75" textAnchor="middle" fill="#111827" fontSize="16" fontWeight="bold" fontFamily="Work Sans, sans-serif">Actionable ICP</text>
                            
                            {/* Strategic Why Section (Left Half) - Interactive */}
                            <g
                                onMouseEnter={(e) => handleMouseEnter('strategic', e)}
                                onMouseLeave={handleMouseLeave}
                                onClick={() => handleSectionClick('strategic')}
                                style={{ cursor: 'pointer' }}
                            >
                                <rect 
                                    x="440" 
                                    y="90" 
                                    width="155" 
                                    height="140" 
                                    rx="6" 
                                    fill={hoveredSection === 'strategic' ? "#BBF7D0" : "#DCFCE7"}
                                    stroke={hoveredSection === 'strategic' ? "#059669" : "#16A34A"} 
                                    strokeWidth={hoveredSection === 'strategic' ? "2" : "1"}
                                />
                                <text x="517.5" y="110" textAnchor="middle" fill="#166534" fontSize="12" fontWeight="bold" fontFamily="Work Sans, sans-serif">Strategic Why</text>
                                <text x="455" y="130" fill="#15803D" fontSize="10" fontFamily="Outfit, sans-serif">‚Ä¢ Jobs to be Done</text>
                                <text x="455" y="145" fill="#15803D" fontSize="10" fontFamily="Outfit, sans-serif">‚Ä¢ Value Drivers</text>
                                <text x="455" y="160" fill="#15803D" fontSize="10" fontFamily="Outfit, sans-serif">‚Ä¢ Buyer Motivations</text>
                                <text x="517.5" y="185" textAnchor="middle" fill="#059669" fontSize="9" fontFamily="Outfit, sans-serif" fontStyle="italic">For messaging</text>
                                <text x="517.5" y="200" textAnchor="middle" fill="#059669" fontSize="9" fontFamily="Outfit, sans-serif" fontStyle="italic">&amp; positioning</text>
                                {hoveredSection === 'strategic' && (
                                    <text x="517.5" y="215" textAnchor="middle" fill="#059669" fontSize="8" fontFamily="Outfit, sans-serif" fontStyle="italic">Click to work on ICP</text>
                                )}
                            </g>
                            
                            {/* Operational Where Section (Right Half) - Interactive */}
                            <g
                                onMouseEnter={(e) => handleMouseEnter('operational', e)}
                                onMouseLeave={handleMouseLeave}
                                onClick={() => handleSectionClick('operational')}
                                style={{ cursor: 'pointer' }}
                            >
                                <rect 
                                    x="610" 
                                    y="90" 
                                    width="155" 
                                    height="140" 
                                    rx="6" 
                                    fill={hoveredSection === 'operational' ? "#FDE68A" : "#FEF3C7"}
                                    stroke={hoveredSection === 'operational' ? "#D97706" : "#F59E0B"} 
                                    strokeWidth={hoveredSection === 'operational' ? "2" : "1"}
                                />
                                <text x="687.5" y="110" textAnchor="middle" fill="#92400E" fontSize="12" fontWeight="bold" fontFamily="Work Sans, sans-serif">Operational Where</text>
                                <text x="625" y="130" fill="#A16207" fontSize="10" fontFamily="Outfit, sans-serif">‚Ä¢ Firmographics</text>
                                <text x="625" y="145" fill="#A16207" fontSize="10" fontFamily="Outfit, sans-serif">‚Ä¢ Technographics</text>
                                <text x="625" y="160" fill="#A16207" fontSize="10" fontFamily="Outfit, sans-serif">‚Ä¢ Behavioral Signals</text>
                                <text x="687.5" y="185" textAnchor="middle" fill="#D97706" fontSize="9" fontFamily="Outfit, sans-serif" fontStyle="italic">For targeting</text>
                                <text x="687.5" y="200" textAnchor="middle" fill="#D97706" fontSize="9" fontFamily="Outfit, sans-serif" fontStyle="italic">&amp; campaigns</text>
                                {hoveredSection === 'operational' && (
                                    <text x="687.5" y="215" textAnchor="middle" fill="#D97706" fontSize="8" fontFamily="Outfit, sans-serif" fontStyle="italic">Click to work on ICP</text>
                                )}
                            </g>
                        </svg>
                    </div>
                    
                    {/* Mobile Layout */}
                    <div className="md:hidden space-y-6">
                        {/* Market Segment - Interactive */}
                        <div 
                            className={`p-4 rounded-lg text-center cursor-pointer transition-all duration-200 ${isSegmentComplete ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-gray-400 text-white opacity-50 hover:opacity-70'}`}
                            onClick={() => handleSectionClick('segment')}
                            onTouchStart={(e) => handleMouseEnter('segment', e)}
                            onTouchEnd={handleMouseLeave}
                        >
                            <h4 className="font-bold text-lg mb-1">Market Segment</h4>
                            <p className="text-sm">JTBD ‚Ä¢ Value ‚Ä¢ WTP</p>
                            <p className="text-xs mt-2">Foundation {isSegmentComplete ? '‚úì Complete' : '‚óã Pending'}</p>
                            <p className="text-xs mt-1 italic">Tap to edit</p>
                        </div>
                        
                        {/* Arrow Down */}
                        <div className="text-center">
                            <div className="inline-block w-8 h-8 bg-gray-400 rounded-full flex items-center justify-center">
                                <span className="text-white font-bold">‚Üì</span>
                            </div>
                        </div>
                        
                        {/* Bridge */}
                        <div className="bg-gray-100 border border-gray-300 p-4 rounded-lg text-center">
                            <h4 className="font-bold text-gray-800 mb-2">Add Product & Business Model Fit</h4>
                            <p className="text-sm text-gray-600">Product-Problem Fit</p>
                            <p className="text-sm text-gray-600">Scalable Business Model</p>
                        </div>
                        
                        {/* Arrow Down */}
                        <div className="text-center">
                            <div className="inline-block w-8 h-8 bg-gray-400 rounded-full flex items-center justify-center">
                                <span className="text-white font-bold">‚Üì</span>
                            </div>
                        </div>
                        
                        {/* Actionable ICP */}
                        <div className="border border-gray-200 rounded-lg p-4">
                            <h4 className="font-bold text-gray-800 text-center mb-4">Actionable ICP</h4>
                            
                            {/* Strategic Why - Interactive */}
                            <div 
                                className="bg-green-50 border border-green-200 p-3 rounded-lg mb-3 cursor-pointer transition-all duration-200 hover:bg-green-100 hover:border-green-300"
                                onClick={() => handleSectionClick('strategic')}
                                onTouchStart={(e) => handleMouseEnter('strategic', e)}
                                onTouchEnd={handleMouseLeave}
                            >
                                <h5 className="font-bold text-green-700 text-center mb-2">Strategic Why</h5>
                                <ul className="text-sm text-green-600 space-y-1">
                                    <li>‚Ä¢ Jobs to be Done</li>
                                    <li>‚Ä¢ Value Drivers</li>
                                    <li>‚Ä¢ Buyer Motivations</li>
                                </ul>
                                <p className="text-xs text-green-600 text-center mt-2 italic">For messaging & positioning</p>
                                <p className="text-xs text-green-500 text-center mt-1 italic">Tap to work on ICP</p>
                            </div>
                            
                            {/* Operational Where - Interactive */}
                            <div 
                                className="bg-yellow-50 border border-yellow-200 p-3 rounded-lg cursor-pointer transition-all duration-200 hover:bg-yellow-100 hover:border-yellow-300"
                                onClick={() => handleSectionClick('operational')}
                                onTouchStart={(e) => handleMouseEnter('operational', e)}
                                onTouchEnd={handleMouseLeave}
                            >
                                <h5 className="font-bold text-yellow-700 text-center mb-2">Operational Where</h5>
                                <ul className="text-sm text-yellow-600 space-y-1">
                                    <li>‚Ä¢ Firmographics</li>
                                    <li>‚Ä¢ Technographics</li>
                                    <li>‚Ä¢ Behavioral Signals</li>
                                </ul>
                                <p className="text-xs text-yellow-600 text-center mt-2 italic">For targeting & campaigns</p>
                                <p className="text-xs text-yellow-500 text-center mt-1 italic">Tap to work on ICP</p>
                            </div>
                        </div>
                    </div>
                    
                    {/* Educational Context */}
                    <div className="mt-4 text-center">
                        <p className="text-sm text-gray-600 italic">
                            This visualization shows how your market segment analysis transforms into targeted ICP insights for both strategic messaging and operational execution.
                        </p>
                        <p className="text-xs text-gray-500 mt-2">
                            Hover over sections for more details ‚Ä¢ Click to navigate
                        </p>
                    </div>
                    
                    {/* Interactive Tooltip */}
                    {hoveredSection && tooltips[hoveredSection] && (
                        <div 
                            className="fixed z-50 bg-gray-900 text-white p-4 rounded-lg shadow-xl max-w-xs"
                            style={{
                                left: tooltipPosition.x - 150,
                                top: tooltipPosition.y - 120,
                                pointerEvents: 'none'
                            }}
                        >
                            <div className="text-sm font-semibold mb-2">{tooltips[hoveredSection].title}</div>
                            <div className="text-xs leading-relaxed mb-2">{tooltips[hoveredSection].content}</div>
                            <div className="text-xs text-gray-300 italic">{tooltips[hoveredSection].action}</div>
                            <div className="absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-full">
                                <div className="w-3 h-3 bg-gray-900 transform rotate-45"></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ICPDefinitionTool Component
        const ICPDefinitionTool = ({ appState, setAppState, onNavigate }) => {
            const [exportModal, setExportModal] = useState({ isOpen: false, content: '', title: '' });
            const [gradingState, setGradingState] = useState({});
            const [analysisState, setAnalysisState] = useState({});
            const [uniquenessResults, setUniquenessResults] = useState({});
            const [trendAnalysisResults, setTrendAnalysisResults] = useState({});
            
            // F-8: Pillar Generation Modal State
            const [pillarGenModalOpen, setPillarGenModalOpen] = useState(false);
            const [pillarGenState, setPillarGenState] = useState({
                isGenerating: false,
                suggestedPillars: [],
                error: null,
                refinementInputs: {}
            });
            
            // Simulate AI grading for value propositions
            const simulateAIGrading = async (proposition, index) => {
                const { val1, val2, val3 } = proposition;
                
                // Set loading state
                setGradingState(prev => ({
                    ...prev,
                    [index]: { isGrading: true, score: null, feedback: null }
                }));
                
                // Simulate network delay
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Analyze proposition quality
                let score = 'C';
                let feedback = [];
                
                // Check attribute quality
                if (!val1 || val1.length < 10) {
                    feedback.push('Attribute needs more specificity and detail');
                } else if (val1.includes('AI') || val1.includes('intelligent') || val1.includes('automated')) {
                    score = score < 'B' ? 'B' : score;
                    feedback.push('Good use of compelling technology terms');
                }
                
                // Check benefit quality
                if (!val2 || val2.length < 15) {
                    feedback.push('Benefit statement should explain customer impact more clearly');
                } else if (val2.includes('reduces') || val2.includes('increases') || val2.includes('enables')) {
                    score = score < 'B+' ? 'B+' : score;
                    feedback.push('Strong benefit articulation with clear outcomes');
                }
                
                // Check value quality
                if (!val3 || val3.length < 10) {
                    feedback.push('Value statement needs quantifiable outcomes or proof points');
                } else if (val3.match(/\$|%|months?|weeks?|days?|hours?|\d+/)) {
                    score = 'A-';
                    feedback.push('Excellent quantifiable value with specific metrics');
                }
                
                // Assign final score
                if (val1 && val2 && val3 && val1.length > 10 && val2.length > 15 && val3.length > 15) {
                    if (score === 'C') score = 'B';
                }
                
                // Create final feedback
                const finalFeedback = feedback.length > 0 
                    ? feedback.join('. ') + '.'
                    : 'Complete all three fields with more specific details for better grading.';
                
                // Update grading state with results
                setGradingState(prev => ({
                    ...prev,
                    [index]: {
                        isGrading: false,
                        score,
                        feedback: finalFeedback,
                        timestamp: new Date().toISOString()
                    }
                }));
            };

            // Analyze uniqueness using web search API
            const analyzeUniqueness = async (attributeText, index) => {
                if (!attributeText || !attributeText.trim()) {
                    return;
                }

                setUniquenessResults(prev => ({
                    ...prev,
                    [index]: { isAnalyzing: true, results: null }
                }));

                try {
                    const response = await fetch('/api/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            query: `"${attributeText.trim()}" software features capabilities`
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const searchData = await response.json();
                    
                    // Extract relevant results for display
                    const results = searchData.web?.results?.slice(0, 3).map(result => ({
                        title: result.title,
                        description: result.description || result.snippet || 'No description available',
                        url: result.url
                    })) || [];

                    setUniquenessResults(prev => ({
                        ...prev,
                        [index]: {
                            isAnalyzing: false,
                            results,
                            timestamp: new Date().toISOString()
                        }
                    }));

                } catch (error) {
                    console.error('Uniqueness analysis error:', error);
                    setUniquenessResults(prev => ({
                        ...prev,
                        [index]: {
                            isAnalyzing: false,
                            error: 'Analysis unavailable - please try again later',
                            timestamp: new Date().toISOString()
                        }
                    }));
                }
            };
            
            // Analyze trend validation using web search
            const analyzeTrend = async (trendText, index) => {
                if (!trendText || !trendText.trim()) {
                    return;
                }

                setTrendAnalysisResults(prev => ({
                    ...prev,
                    [index]: { isAnalyzing: true, results: null }
                }));

                try {
                    const response = await fetch('/api/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            query: `"${trendText.trim()}" market trend industry analysis`
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const searchData = await response.json();
                    
                    // Extract relevant results for display
                    const results = searchData.web?.results?.slice(0, 3).map(result => ({
                        title: result.title,
                        description: result.description || result.snippet || 'No description available',
                        url: result.url
                    })) || [];

                    setTrendAnalysisResults(prev => ({
                        ...prev,
                        [index]: {
                            isAnalyzing: false,
                            results,
                            timestamp: new Date().toISOString()
                        }
                    }));

                } catch (error) {
                    console.error('Trend analysis error:', error);
                    setTrendAnalysisResults(prev => ({
                        ...prev,
                        [index]: {
                            isAnalyzing: false,
                            error: 'No strong evidence found for this trend. Consider rephrasing.',
                            timestamp: new Date().toISOString()
                        }
                    }));
                }
            };

            const handleExport = () => {
                const formatSection = (title, content) => `## ${title}\n${content || 'N/A'}\n\n`;
                const formatList = (items, k1, k2) => items.map(item => `- ${item[k1]}: ${item[k2]}`).join('\n');
                
                let summary = `Part 2: ICP & Positioning Blueprint\n======================================\n\n`;
                summary += `## 1. Ideal Customer Profile (ICP)\n`;
                summary += `- Segment Foundation: See Part 1 export for complete segment data\n`;
                summary += `- Quick Decision Making: ${appState.positioningData.icp_quick_decision_making || 'N/A'}\n`;
                summary += `- Prioritized Requirements: ${appState.positioningData.icp_prioritized_requirements || 'N/A'}\n`;
                summary += `- Implementation Readiness: ${appState.positioningData.icp_implementation_readiness || 'N/A'}\n`;
                summary += `- Firmographic: ${appState.positioningData.icp_firmographic || 'N/A'}\n`;
                summary += `- Technographic: ${appState.positioningData.icp_technographic || 'N/A'}\n`;
                summary += `- Behavioral: ${appState.positioningData.icp_behavioral || 'N/A'}\n\n`;

                summary += formatSection('2. Competitive Alternatives', appState.positioningData.alternatives ? formatList(appState.positioningData.alternatives, 'val1', 'val2') : 'N/A');
                summary += formatSection('5. Summarize Target Market', appState.positioningData.icp_summary || 'N/A');
                let marketContext = appState.positioningData['market-context'] === 'Other' ? appState.positioningData['market-context-other'] : appState.positioningData['market-context'];
                summary += formatSection('6. Market Context (Today)', marketContext);
                let trendsContent = '';
                if (appState.positioningData.trend1_desc) trendsContent += `- Industry Trend 1: ${appState.positioningData.trend1_desc}\n`;
                if (appState.positioningData.trend2_desc) trendsContent += `- Industry Trend 2: ${appState.positioningData.trend2_desc}\n`;
                if (appState.positioningData.trend3_desc) trendsContent += `- Industry Trend 3: ${appState.positioningData.trend3_desc}\n`;
                if (appState.positioningData.trend4_desc) trendsContent += `- Industry Trend 4: ${appState.positioningData.trend4_desc}\n`;
                summary += formatSection('4. Relevant Trends', trendsContent || 'N/A');

                setExportModal({ isOpen: true, content: summary, title: 'Positioning Summary' });
            };

            return (
                <div className="container mx-auto px-4 sm:px-6 lg:px-8 min-h-screen pb-16">
                    <header className="sticky top-16 bg-white border-b border-gray-200 z-40 py-3">
                        <div className="flex justify-between items-center py-3">
                            <div className="flex items-center space-x-4">
                                <button onClick={() => onNavigate('segment')} className="text-gray-600 hover:scale-gold-text">‚Üê Back to Segment Foundation</button>
                                <h1 className="text-xl sm:text-2xl font-bold scale-green-text">Part 2: ICP Definition</h1>
                            </div>
                            {React.createElement(PrimaryActions, {
                                currentPart: 'icp',
                                onReset: () => {
                                    if (window.confirm("Are you sure you want to reset all data for Part 2? This will clear all ICP and Positioning fields.")) {
                                        setAppState(prev => ({
                                            ...prev,
                                            positioningData: getInitialState().positioningData
                                        }));
                                    }
                                },
                                onExport: handleExport,
                                onContinue: () => { onNavigate('positioning'); window.scrollTo(0, 0); }
                            })}
                        </div>
                    </header>

                    <div className="mt-8">
                        <div className="lg:flex lg:space-x-8">
                            <main className="w-full">
                                <div className="space-y-8">
                        
                        {/* ICP Flow Visualization */}
                        <ICPFlowVisualization appState={appState} onNavigate={onNavigate} />
                        
                        <div id="section-1" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                            <h2 className="text-2xl font-bold scale-green-text mb-2">1. Define Your Ideal Customer Profile (ICP)</h2>
                            <p className="text-gray-600 mb-6">This is the foundation. A precise ICP provides the lens through which all other positioning elements are viewed. Be specific and use data where possible.</p>
                            
                            {/* Segment Foundation Summary */}
                            <div className="mb-8 p-6 bg-green-50 border border-green-200 rounded-lg">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold scale-green-text">Segment Foundation Summary</h3>
                                    <button 
                                        onClick={() => onNavigate('segment')}
                                        className="text-sm text-green-600 hover:text-green-800 font-semibold flex items-center gap-1"
                                    >
                                        ‚Üê Edit Segment Foundation
                                    </button>
                                </div>
                                
                                {/* Check if segment data exists */}
                                {appState.segmentData && Object.keys(appState.segmentData).some(key => appState.segmentData[key]?.trim()) ? (
                                    <div className="space-y-4">
                                        {/* Jobs to be Done Summary */}
                                        {appState.segmentData['Desired Outcomes'] && (
                                            <div>
                                                <h4 className="font-semibold text-gray-700 mb-1">Desired Outcomes</h4>
                                                <p className="text-sm text-gray-600 bg-white p-3 rounded border">
                                                    {appState.segmentData['Desired Outcomes']}
                                                </p>
                                            </div>
                                        )}
                                        
                                        {/* Customer Value Summary */}
                                        <div className="grid md:grid-cols-2 gap-4">
                                            {appState.segmentData['Functional Value'] && (
                                                <div>
                                                    <h4 className="font-semibold text-gray-700 mb-1">Functional Value</h4>
                                                    <p className="text-sm text-gray-600 bg-white p-3 rounded border">
                                                        {appState.segmentData['Functional Value']}
                                                    </p>
                                                </div>
                                            )}
                                            
                                            {appState.segmentData['Economic Justification'] && (
                                                <div>
                                                    <h4 className="font-semibold text-gray-700 mb-1">Economic Justification</h4>
                                                    <p className="text-sm text-gray-600 bg-white p-3 rounded border">
                                                        {appState.segmentData['Economic Justification']}
                                                    </p>
                                                </div>
                                            )}
                                            
                                            {appState.segmentData['Table Stakes'] && (
                                                <div>
                                                    <h4 className="font-semibold text-gray-700 mb-1">Table Stakes</h4>
                                                    <p className="text-sm text-gray-600 bg-white p-3 rounded border">
                                                        {appState.segmentData['Table Stakes']}
                                                    </p>
                                                </div>
                                            )}
                                            
                                            {appState.segmentData['Ease of Doing Business'] && (
                                                <div>
                                                    <h4 className="font-semibold text-gray-700 mb-1">Ease of Doing Business</h4>
                                                    <p className="text-sm text-gray-600 bg-white p-3 rounded border">
                                                        {appState.segmentData['Ease of Doing Business']}
                                                    </p>
                                                </div>
                                            )}
                                        </div>
                                        
                                        {/* Additional context fields if available */}
                                        {(appState.segmentData['Context'] || appState.segmentData['Struggling Moments']) && (
                                            <div className="pt-4 border-t border-green-200">
                                                <h4 className="font-semibold text-gray-700 mb-2">Business Context</h4>
                                                <div className="space-y-2">
                                                    {appState.segmentData['Context'] && (
                                                        <p className="text-sm text-gray-600">
                                                            <span className="font-medium">Context:</span> {appState.segmentData['Context']}
                                                        </p>
                                                    )}
                                                    {appState.segmentData['Struggling Moments'] && (
                                                        <p className="text-sm text-gray-600">
                                                            <span className="font-medium">Struggling Moments:</span> {appState.segmentData['Struggling Moments']}
                                                        </p>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <div className="text-center py-8">
                                        <div className="text-gray-500 mb-3">
                                            <span className="text-2xl">üìù</span>
                                        </div>
                                        <h4 className="font-semibold text-gray-700 mb-2">No Segment Data Yet</h4>
                                        <p className="text-sm text-gray-600 mb-4">
                                            Complete Part 1 (Segment Foundation) to see your market segment data here.
                                        </p>
                                        <button 
                                            onClick={() => onNavigate('segment')}
                                            className="scale-green-bg text-white font-semibold py-2 px-4 rounded-lg hover:bg-opacity-90"
                                        >
                                            Go to Part 1: Segment Foundation
                                        </button>
                                    </div>
                                )}
                            </div>
                            
                            <div className="space-y-6">
                                <div>
                                    <label className="block font-bold text-gray-700">Quick Decision Making</label>
                                    <p className="text-sm text-gray-500 mb-2">Who is the economic buyer and can they approve the purchase efficiently?</p>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="3" 
                                        placeholder="Example: The VP of Finance is the economic buyer. They have budget authority up to $250k for transformation projects and can sign off without a lengthy committee review."
                                        value={appState.positioningData.icp_quick_decision_making || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, icp_quick_decision_making: e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Prioritized Requirements</label>
                                    <p className="text-sm text-gray-500 mb-2">What do they value most in a solution for this problem?</p>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="3" 
                                        placeholder="Example: Speed-to-insight is #1. We cannot wait 6 months for consultants. #2 is accuracy; the data must be audit-grade. #3 is ease of use for our internal team."
                                        value={appState.positioningData.icp_prioritized_requirements || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, icp_prioritized_requirements: e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Implementation Readiness</label>
                                    <p className="text-sm text-gray-500 mb-2">Can they adopt and get value from the product today?</p>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="3" 
                                        placeholder="Example: They have a dedicated transformation team ready to start. All relevant contracts and process documents are digitized and accessible."
                                        value={appState.positioningData.icp_implementation_readiness || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, icp_implementation_readiness: e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Firmographic</label>
                                    <p className="text-sm text-gray-500 mb-2">What are the key company attributes (size, industry, revenue)?</p>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="3" 
                                        placeholder="Example: Publicly traded B2B SaaS company, >$1B in annual revenue, 2000+ employees. Headquartered in North America."
                                        value={appState.positioningData.icp_firmographic || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, icp_firmographic: e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Technographic</label>
                                    <p className="text-sm text-gray-500 mb-2">What is their current technology stack?</p>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="3" 
                                        placeholder="Example: Currently using NetSuite, Salesforce, and Coupa. Moving to Oracle Fusion. Internal BI uses Tableau."
                                        value={appState.positioningData.icp_technographic || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, icp_technographic: e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Behavioral</label>
                                    <p className="text-sm text-gray-500 mb-2">How do they act, buy, and use technology?</p>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="3" 
                                        placeholder="Example: They are early adopters of AI technology in their finance stack. They prefer to buy best-of-breed solutions over suite extensions. They have a history of successful, large-scale software implementations."
                                        value={appState.positioningData.icp_behavioral || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, icp_behavioral: e.target.value } }))}
                                    />
                                </div>
                            </div>
                        </div>


                        <div className="text-center mt-12 pb-24">
                            <button 
                                onClick={() => { onNavigate('positioning'); window.scrollTo(0, 0); }}
                                className="scale-gold-bg text-white font-bold py-4 px-8 rounded-lg hover:bg-opacity-90 text-lg"
                            >
                                Continue to Part 3: Positioning ‚Üí
                            </button>
                        </div>
                                </div>
                            </main>
                        </div>
                    </div>

                    <ExportModal 
                        isOpen={exportModal.isOpen}
                        onClose={() => setExportModal(prev => ({ ...prev, isOpen: false }))}
                        title={exportModal.title}
                        content={exportModal.content}
                        appState={appState}
                        filename="positioning-blueprint"
                    />
                    
                </div>
            );
        };

        // Dynamic Field Components for PositioningTool
        const RemovableRow = ({ index, item, onUpdate, onRemove, placeholder1, placeholder2, onAnalyze, analysisResult }) => (
            <div className="space-y-3">
                <div className="flex items-center space-x-2">
                    <input 
                        type="text" 
                        className="w-1/2 p-2 border border-gray-300 rounded-md focus-ring-gold"
                        placeholder={placeholder1}
                        value={item.val1}
                        onChange={(e) => onUpdate(index, 'val1', e.target.value)}
                    />
                    <textarea 
                        className="w-1/2 p-2 border border-gray-300 rounded-md focus-ring-gold"
                        rows="3" 
                        placeholder={placeholder2}
                        value={item.val2}
                        onChange={(e) => onUpdate(index, 'val2', e.target.value)}
                    ></textarea>
                    <div className="flex flex-col space-y-2">
                        <button 
                            onClick={() => onRemove(index)}
                            className="text-gray-400 hover:text-red-600 font-bold text-2xl transition-colors"
                        >
                            √ó
                        </button>
                        {onAnalyze && (
                            <button 
                                onClick={() => onAnalyze(item, index)}
                                disabled={analysisResult?.isAnalyzing}
                                className="text-xs font-bold py-1 px-2 rounded transition-colors bg-blue-100 hover:bg-blue-200 text-blue-700 disabled:opacity-50"
                            >
                                {analysisResult?.isAnalyzing ? 'Analyzing...' : 'Analyze Weakness'}
                            </button>
                        )}
                    </div>
                </div>
                
                {analysisResult && !analysisResult.isAnalyzing && analysisResult.angles && (
                    <div className="bg-white p-4 rounded-md border-l-4 border-blue-500 shadow-sm">
                        <div className="flex items-center justify-between mb-3">
                            <h4 className="text-sm font-bold text-gray-800">Strategic Angles</h4>
                            <span className="text-xs text-gray-500">{analysisResult.angles.length} talking points</span>
                        </div>
                        <ul className="space-y-2">
                            {analysisResult.angles.map((angle, idx) => (
                                <li key={idx} className="text-sm text-gray-700 flex items-start">
                                    <span className="inline-block w-2 h-2 bg-blue-500 rounded-full mr-3 mt-1.5 flex-shrink-0"></span>
                                    <span>{angle}</span>
                                </li>
                            ))}
                        </ul>
                        <button 
                            onClick={() => {
                                const text = analysisResult.angles.join('\n‚Ä¢ ');
                                navigator.clipboard.writeText(`Strategic angles for ${item.val1}:\n‚Ä¢ ${text}`);
                            }}
                            className="mt-3 text-xs text-blue-600 hover:text-blue-800 font-medium"
                        >
                            Copy talking points
                        </button>
                    </div>
                )}
            </div>
        );

        const RemovableInput = ({ index, item, onUpdate, onRemove, placeholder }) => (
            <div className="flex items-center space-x-2">
                <input 
                    type="text" 
                    className="w-full p-2 border border-gray-300 rounded-md focus-ring-gold"
                    placeholder={placeholder}
                    value={item.value}
                    onChange={(e) => onUpdate(index, 'value', e.target.value)}
                />
                <button 
                    onClick={() => onRemove(index)}
                    className="text-gray-400 hover:text-red-600 font-bold text-2xl transition-colors"
                >
                    √ó
                </button>
            </div>
        );

        const RemovableTriple = ({ index, item, onUpdate, onRemove, onGrade, gradingResult, onAnalyzeUniqueness, uniquenessResult }) => (
            <div className="p-4 border border-gray-200 rounded-lg space-y-3 bg-gray-50">
                <div className="flex items-start space-x-2">
                    <div className="flex-grow">
                        <label className="block text-sm font-semibold text-gray-700 mb-1">
                            Truly Unique Attribute: The Feature or Capability
                        </label>
                        <input 
                            type="text" 
                            className="w-full p-2 border border-gray-300 rounded-md focus-ring-gold"
                            placeholder="Example: Day-one insights from existing documents"
                            value={item.val1}
                            onChange={(e) => onUpdate(index, 'val1', e.target.value)}
                        />
                    </div>
                    <button 
                        onClick={() => onRemove(index)}
                        className="mt-6 text-gray-400 hover:text-red-600 font-bold text-2xl transition-colors"
                    >
                        √ó
                    </button>
                </div>
                <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-1">
                        Benefit: What the attribute enables for a customer
                    </label>
                    <textarea 
                        className="w-full p-2 border border-gray-300 rounded-md focus-ring-gold"
                        rows="2" 
                        placeholder="Example: Enables immediate analysis without lengthy discovery interviews"
                        value={item.val2}
                        onChange={(e) => onUpdate(index, 'val2', e.target.value)}
                    ></textarea>
                </div>
                <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-1">
                        Value: The metrics and KPIs the customer use to measure value created by this attribute
                    </label>
                    <input 
                        type="text" 
                        className="w-full p-2 border border-gray-300 rounded-md focus-ring-gold"
                        placeholder="Example: Reduces transformation timeline by 6 months, saving $500k in consulting fees"
                        value={item.val3}
                        onChange={(e) => onUpdate(index, 'val3', e.target.value)}
                    />
                </div>
                <div className="pt-2 space-y-3">
                    <div className="flex space-x-2">
                        <button 
                            className="text-sm font-bold py-2 px-3 rounded-lg transition-colors bg-gray-200 hover:bg-gray-300 text-gray-700 disabled:opacity-50"
                            onClick={() => onGrade(item, index)}
                            disabled={gradingResult?.isGrading}
                        >
                            {gradingResult?.isGrading ? 'Grading...' : 'Grade Proposition'}
                        </button>
                        <button 
                            className="text-sm font-bold py-2 px-3 rounded-lg transition-colors bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-50"
                            onClick={() => onAnalyzeUniqueness(item.val1, index)}
                            disabled={uniquenessResult?.isAnalyzing || !item.val1?.trim()}
                        >
                            {uniquenessResult?.isAnalyzing ? 'Analyzing market...' : 'Analyze Uniqueness'}
                        </button>
                    </div>
                    
                    {gradingResult && !gradingResult.isGrading && gradingResult.score && (
                        <div className="bg-white p-3 rounded-md border border-gray-300">
                            <div className="flex items-center justify-between mb-2">
                                <span className="text-sm font-bold text-gray-700">AI Grade:</span>
                                <span 
                                    className={`text-lg font-bold px-2 py-1 rounded ${ 
                                        gradingResult.score.startsWith('A') ? 'bg-green-100 text-green-800' :
                                        gradingResult.score.startsWith('B') ? 'bg-yellow-100 text-yellow-800' :
                                        'bg-red-100 text-red-800'
                                    }`}
                                >
                                    {gradingResult.score}
                                </span>
                            </div>
                            <p className="text-sm text-gray-600 leading-relaxed">
                                {gradingResult.feedback}
                            </p>
                        </div>
                    )}

                    {uniquenessResult && !uniquenessResult.isAnalyzing && (
                        <div className="bg-white p-3 rounded-md border border-gray-300">
                            <div className="mb-2">
                                <span className="text-sm font-bold text-gray-700">Uniqueness Analysis:</span>
                            </div>
                            {uniquenessResult.error ? (
                                <div className="text-sm text-red-600">
                                    {uniquenessResult.error}
                                </div>
                            ) : uniquenessResult.results && uniquenessResult.results.length > 0 ? (
                                <div className="space-y-2">
                                    {uniquenessResult.results.slice(0, 3).map((result, idx) => (
                                        <div key={idx} className="text-sm text-gray-600">
                                            <a href={result.url} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:text-blue-800 font-medium">
                                                {result.title}
                                            </a>
                                            <p className="text-xs text-gray-500 mt-1">{result.description}</p>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="text-sm text-green-600 font-medium">
                                    No similar claims found - this appears to be a unique attribute!
                                </div>
                            )}
                        </div>
                    )}
                </div>
            </div>
        );

        // PositioningTool Component
        const PositioningTool = ({ appState, setAppState, onNavigate }) => {
            const [exportModal, setExportModal] = useState({ isOpen: false, content: '', title: '' });
            const [analysisState, setAnalysisState] = useState({});
            const [uniquenessResults, setUniquenessResults] = useState({});
            const [trendAnalysisResults, setTrendAnalysisResults] = useState({});
            const [gradingState, setGradingState] = useState({});
            const [pillarGenState, setPillarGenState] = useState({
                isGenerating: false,
                suggestedPillars: [],
                error: null,
                refinementInputs: {}
            });
            const [pillarGenModalOpen, setPillarGenModalOpen] = useState(false);

            // Helper functions for nested data management
            const updateNestedValue = (section, index, key, value) => {
                const newData = { ...appState.positioningData };
                if (!newData[section]) newData[section] = [];
                if (!newData[section][index]) newData[section][index] = {};
                newData[section][index][key] = value;
                setAppState(prev => ({ ...prev, positioningData: newData }));
            };

            const addItem = (section, template) => {
                const newData = { ...appState.positioningData };
                if (!newData[section]) newData[section] = [];
                newData[section].push(template);
                setAppState(prev => ({ ...prev, positioningData: newData }));
            };

            const removeItem = (section, index) => {
                const newData = { ...appState.positioningData };
                if (newData[section]) {
                    newData[section].splice(index, 1);
                    setAppState(prev => ({ ...prev, positioningData: newData }));
                    // Clear grading state for removed item
                    setGradingState(prev => {
                        const newState = { ...prev };
                        delete newState[index];
                        return newState;
                    });
                }
            };

            // Simulate AI grading for value propositions
            const simulateAIGrading = async (proposition, index) => {
                const { val1, val2, val3 } = proposition;
                
                // Set loading state
                setGradingState(prev => ({
                    ...prev,
                    [index]: { isGrading: true, score: null, feedback: null }
                }));
                
                // Simulate network delay
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Analyze proposition quality
                let score = 'C';
                let feedback = [];
                
                // Check attribute quality
                if (!val1 || val1.length < 10) {
                    feedback.push('Attribute needs more specificity and detail');
                } else if (val1.includes('AI') || val1.includes('intelligent') || val1.includes('automated')) {
                    score = score < 'B' ? 'B' : score;
                    feedback.push('Good use of compelling technology terms');
                }
                
                // Check benefit quality
                if (!val2 || val2.length < 15) {
                    feedback.push('Benefit statement should explain customer impact more clearly');
                } else if (val2.includes('reduces') || val2.includes('increases') || val2.includes('enables')) {
                    score = score < 'B+' ? 'B+' : score;
                    feedback.push('Strong benefit articulation with clear outcomes');
                }
                
                // Check value quality
                if (!val3 || val3.length < 10) {
                    feedback.push('Value statement needs quantifiable outcomes or proof points');
                } else if (val3.match(/\$|%|months?|weeks?|days?|hours?|\d+/)) {
                    score = 'A-';
                    feedback.push('Excellent quantifiable value with specific metrics');
                }
                
                // Assign final score
                if (val1 && val2 && val3 && val1.length > 10 && val2.length > 15 && val3.length > 15) {
                    if (score === 'C') score = 'B';
                }
                
                // Create final feedback
                const finalFeedback = feedback.length > 0 
                    ? feedback.join('. ') + '.'
                    : 'Complete all three fields with more specific details for better grading.';
                
                // Update grading state with results
                setGradingState(prev => ({
                    ...prev,
                    [index]: {
                        isGrading: false,
                        score,
                        feedback: finalFeedback,
                        timestamp: new Date().toISOString()
                    }
                }));
            };

            // Analyze uniqueness using web search API
            const analyzeUniqueness = async (attributeText, index) => {
                if (!attributeText || !attributeText.trim()) {
                    return;
                }

                setUniquenessResults(prev => ({
                    ...prev,
                    [index]: { isAnalyzing: true, results: null }
                }));

                try {
                    const response = await fetch('/api/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            query: `"${attributeText.trim()}" software features capabilities`
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const searchData = await response.json();
                    
                    // Extract relevant results for display
                    const results = searchData.web?.results?.slice(0, 3).map(result => ({
                        title: result.title,
                        description: result.description || result.snippet || 'No description available',
                        url: result.url
                    })) || [];

                    setUniquenessResults(prev => ({
                        ...prev,
                        [index]: {
                            isAnalyzing: false,
                            results,
                            timestamp: new Date().toISOString()
                        }
                    }));

                } catch (error) {
                    console.error('Uniqueness analysis error:', error);
                    setUniquenessResults(prev => ({
                        ...prev,
                        [index]: {
                            isAnalyzing: false,
                            error: 'Analysis unavailable - please try again later',
                            timestamp: new Date().toISOString()
                        }
                    }));
                }
            };

            // AI Analysis functions (placeholders for now)
            const simulateCompetitiveAnalysis = async (item, idx) => {
                setAnalysisState(prev => ({ ...prev, [idx]: { isAnalyzing: true, result: null } }));
                
                // Simulate API call
                setTimeout(() => {
                    setAnalysisState(prev => ({
                        ...prev,
                        [idx]: {
                            isAnalyzing: false,
                            angles: [
                                'Emphasize speed advantage over their legacy systems',
                                'Position as future-ready while they require modernization',
                                'Highlight cost benefits vs their hidden fees',
                                'Showcase intuitive UX vs their complexity'
                            ]
                        }
                    }));
                }, 1500);
            };


            // Export functionality for positioning data
            const exportData = () => {
                const formatSection = (title, content) => content ? `## ${title}\n${content}\n\n` : '';
                const formatList = (items, k1, k2) => items.map(item => `- ${item[k1]}: ${item[k2]}`).join('\n');
                
                let summary = `Part 3: Positioning Blueprint\n======================================\n\n`;
                
                summary += formatSection('1. Competitive Alternatives', 
                    appState.positioningData.alternatives ? 
                    formatList(appState.positioningData.alternatives, 'val1', 'val2') : 'N/A');
                
                let valuesContent = '';
                if (appState.positioningData.values) {
                    appState.positioningData.values.forEach(v => {
                        if (v.val1) valuesContent += `- Attribute: ${v.val1}\n  Benefit: ${v.val2}\n  Value: ${v.val3}\n\n`;
                    });
                }
                summary += formatSection('2. Unique Value & Proof', valuesContent || 'N/A');
                
                let marketContext = appState.positioningData['market-context'] === 'Other' ? 
                    appState.positioningData['market-context-other'] : appState.positioningData['market-context'];
                summary += formatSection('3. Market Category', marketContext || 'N/A');
                
                summary += formatSection('4. Target Market Characteristics', 
                    appState.positioningData.icp_summary || 'N/A');
                
                let trendsContent = '';
                if (appState.positioningData.trend1_desc) trendsContent += `- Trend 1: ${appState.positioningData.trend1_desc}\n`;
                if (appState.positioningData.trend2_desc) trendsContent += `- Trend 2: ${appState.positioningData.trend2_desc}\n`;
                if (appState.positioningData.trend3_desc) trendsContent += `- Trend 3: ${appState.positioningData.trend3_desc}\n`;
                if (appState.positioningData.trend4_desc) trendsContent += `- Trend 4: ${appState.positioningData.trend4_desc}\n`;
                summary += formatSection('5. Relevant Trends', trendsContent || 'N/A');
                
                setExportModal({ isOpen: true, content: summary, title: 'Positioning Summary' });
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    <ExportModal 
                        isOpen={exportModal.isOpen}
                        onClose={() => setExportModal({ isOpen: false, content: '', title: '' })}
                        title={exportModal.title}
                        content={exportModal.content}
                        appState={appState}
                        filename="positioning-blueprint"
                    />
                    
                    {/* Header */}
                    <header className="sticky top-16 bg-white border-b border-gray-200 z-40 py-3">
                        <div className="flex justify-between items-center py-3">
                            <div className="flex items-center space-x-4">
                                <button onClick={() => onNavigate('icp')} className="text-gray-600 hover:scale-gold-text">‚Üê Back to ICP Definition</button>
                                <h1 className="text-xl sm:text-2xl font-bold scale-green-text">Part 3: Positioning</h1>
                            </div>
                            {React.createElement(PrimaryActions, {
                                currentPart: 'positioning',
                                onReset: () => {
                                    if (window.confirm("Are you sure you want to reset all data for Part 3? This will clear all Positioning fields.")) {
                                        setAppState(prev => ({
                                            ...prev,
                                            positioningData: getInitialState().positioningData
                                        }));
                                    }
                                },
                                onExport: exportData,
                                onContinue: () => { onNavigate('category'); window.scrollTo(0, 0); }
                            })}
                        </div>
                    </header>

                    {/* Layout with Sidebar Navigation */}
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        <div className="lg:flex lg:space-x-8">
                            <main className="w-full">
                                <div className="space-y-8">
                            
                            {/* Section 1: Competitive Alternatives */}
                            <div id="section-1" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                                <h2 className="text-2xl font-bold scale-green-text mb-2">1. Competitive Alternatives</h2>
                                <p className="text-gray-600 mb-6">What are your target customers currently using to solve this problem?</p>
                                <div className="space-y-4">
                                    {(appState.positioningData?.alternatives || []).map((item, index) => 
                                        React.createElement(RemovableRow, {
                                            key: index,
                                            index: index,
                                            item: item,
                                            onUpdate: (idx, key, value) => updateNestedValue('alternatives', idx, key, value),
                                            onRemove: (idx) => removeItem('alternatives', idx),
                                            placeholder1: 'Alternative',
                                            placeholder2: 'Why it\'s inadequate',
                                            onAnalyze: (item, idx) => simulateCompetitiveAnalysis(item, idx),
                                            analysisResult: analysisState[index]
                                        })
                                    )}
                                    <button
                                        onClick={() => addItem('alternatives', { val1: '', val2: '' })}
                                        className="bg-blue-600 text-white font-bold py-2 px-4 rounded hover:bg-blue-700"
                                    >
                                        + Add Alternative
                                    </button>
                                </div>
                            </div>
                            
                            {/* Section 2: Unique Value & Proof */}
                            <div id="section-2" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                                <h2 className="text-2xl font-bold scale-green-text mb-2">2. Unique Value & Proof</h2>
                                <p className="text-gray-600 mb-6">What unique attributes deliver measurable value to your customers?</p>
                                <div className="space-y-4">
                                    {(appState.positioningData?.values || []).map((item, index) => 
                                        React.createElement(RemovableTriple, {
                                            key: index,
                                            index: index,
                                            item: item,
                                            onUpdate: (idx, key, value) => updateNestedValue('values', idx, key, value),
                                            onRemove: (idx) => removeItem('values', idx),
                                            onGrade: (item, idx) => simulateAIGrading(item, idx),
                                            gradingResult: gradingState[index],
                                            onAnalyzeUniqueness: (attributeText, idx) => analyzeUniqueness(attributeText, idx),
                                            uniquenessResult: uniquenessResults[index]
                                        })
                                    )}
                                    <button
                                        onClick={() => addItem('values', { val1: '', val2: '', val3: '' })}
                                        className="bg-blue-600 text-white font-bold py-2 px-4 rounded hover:bg-blue-700"
                                    >
                                        + Add Value Proposition
                                    </button>
                                </div>
                            </div>
                            
                            {/* Section 3: Market Category */}
                            <div id="section-3" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                                <h2 className="text-2xl font-bold scale-green-text mb-2">3. Market Category</h2>
                                <p className="text-gray-600 mb-6">Define how customers and analysts will categorize your solution.</p>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block font-bold text-gray-700 mb-2">Market Context</label>
                                        <select
                                            className="w-full p-2 border border-gray-300 rounded-md"
                                            value={appState.positioningData?.['market-context'] || ''}
                                            onChange={(e) => setAppState(prev => ({ 
                                                ...prev, 
                                                positioningData: { ...prev.positioningData, 'market-context': e.target.value } 
                                            }))}
                                        >
                                            <option value="">Select market category...</option>
                                            <option value="New Category">New Category</option>
                                            <option value="Existing Category">Existing Category</option>
                                            <option value="Sub-category">Sub-category</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    {/* Show additional input if "Other" is selected */}
                                    {appState.positioningData?.['market-context'] === 'Other' && (
                                        <div>
                                            <label className="block font-bold text-gray-700 mb-2">Specify Market Context</label>
                                            <input
                                                type="text"
                                                className="w-full p-2 border border-gray-300 rounded-md"
                                                placeholder="Enter your specific market context..."
                                                value={appState.positioningData?.['market-context-other'] || ''}
                                                onChange={(e) => setAppState(prev => ({ 
                                                    ...prev, 
                                                    positioningData: { ...prev.positioningData, 'market-context-other': e.target.value } 
                                                }))}
                                            />
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            {/* Section 4: Target Market Characteristics */}
                            <div id="section-4" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                                <h2 className="text-2xl font-bold scale-green-text mb-2">4. Target Market Characteristics</h2>
                                <p className="text-gray-600 mb-6">Who will care most about your unique value?</p>
                                <div className="space-y-4">
                                    {/* Display ICP data from Part 2 */}
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                        <h3 className="text-lg font-bold text-blue-800 mb-2">ICP Summary from Part 2</h3>
                                        <div className="space-y-2">
                                            {appState.positioningData?.icp_summary ? 
                                                <p className="text-blue-700">{appState.positioningData.icp_summary}</p> :
                                                <p className="text-blue-600 italic">Complete Part 2: ICP Definition to see your target market characteristics here</p>
                                            }
                                        </div>
                                    </div>
                                    {/* Additional ICP details */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {/* Firmographic */}
                                        {appState.positioningData?.icp_firmographic && (
                                            <div className="p-3 bg-gray-50 rounded-lg">
                                                <h4 className="font-bold text-gray-800 mb-1">Firmographic</h4>
                                                <p className="text-sm text-gray-700">{appState.positioningData.icp_firmographic}</p>
                                            </div>
                                        )}
                                        {/* Technographic */}
                                        {appState.positioningData?.icp_technographic && (
                                            <div className="p-3 bg-gray-50 rounded-lg">
                                                <h4 className="font-bold text-gray-800 mb-1">Technographic</h4>
                                                <p className="text-sm text-gray-700">{appState.positioningData.icp_technographic}</p>
                                            </div>
                                        )}
                                        {/* Behavioral */}
                                        {appState.positioningData?.icp_behavioral && (
                                            <div className="p-3 bg-gray-50 rounded-lg">
                                                <h4 className="font-bold text-gray-800 mb-1">Behavioral</h4>
                                                <p className="text-sm text-gray-700">{appState.positioningData.icp_behavioral}</p>
                                            </div>
                                        )}
                                        {/* Implementation Readiness */}
                                        {appState.positioningData?.icp_implementation_readiness && (
                                            <div className="p-3 bg-gray-50 rounded-lg">
                                                <h4 className="font-bold text-gray-800 mb-1">Implementation Readiness</h4>
                                                <p className="text-sm text-gray-700">{appState.positioningData.icp_implementation_readiness}</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                            
                            {/* Section 5: Relevant Trends */}
                            <div id="section-5" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                                <h2 className="text-2xl font-bold scale-green-text mb-2">5. Relevant Trends</h2>
                                <p className="text-gray-600 mb-6">What market trends create urgency for your solution?</p>
                                <div className="space-y-6">
                                    {/* Trend 1 */}
                                    <div>
                                        <label className="block font-bold text-gray-700 mb-2">Industry Trend 1</label>
                                        <textarea
                                            className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                            rows="2"
                                            placeholder="Example: AI automation is becoming table stakes in enterprise software"
                                            value={appState.positioningData?.trend1_desc || ''}
                                            onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, trend1_desc: e.target.value } }))}
                                        />
                                    </div>
                                    {/* Trend 2 */}
                                    <div>
                                        <label className="block font-bold text-gray-700 mb-2">Industry Trend 2</label>
                                        <textarea
                                            className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                            rows="2"
                                            placeholder="Example: Remote work is driving demand for cloud-based collaboration"
                                            value={appState.positioningData?.trend2_desc || ''}
                                            onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, trend2_desc: e.target.value } }))}
                                        />
                                    </div>
                                    {/* Trend 3 */}
                                    <div>
                                        <label className="block font-bold text-gray-700 mb-2">Industry Trend 3</label>
                                        <textarea
                                            className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                            rows="2"
                                            placeholder="Example: Regulatory compliance requirements are becoming more stringent"
                                            value={appState.positioningData?.trend3_desc || ''}
                                            onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, trend3_desc: e.target.value } }))}
                                        />
                                    </div>
                                    {/* Trend 4 */}
                                    <div>
                                        <label className="block font-bold text-gray-700 mb-2">Industry Trend 4</label>
                                        <textarea
                                            className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                            rows="2"
                                            placeholder="Example: Customer expectations for real-time data insights"
                                            value={appState.positioningData?.trend4_desc || ''}
                                            onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, trend4_desc: e.target.value } }))}
                                        />
                                    </div>
                                </div>
                            </div>
                            
                            {/* Navigation Footer */}
                            <div className="flex justify-between items-center pt-8">
                                <button
                                    onClick={() => { onNavigate('icp'); window.scrollTo(0, 0); }}
                                    className="text-blue-600 hover:text-blue-800 font-medium flex items-center gap-2"
                                >
                                    ‚Üê Back to Part 2: ICP Definition
                                </button>
                                <button
                                    onClick={() => { onNavigate('category'); window.scrollTo(0, 0); }}
                                    className="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 flex items-center gap-2"
                                >
                                    Continue to Part 4: Category Design ‚Üí
                                </button>
                            </div>
                                </div>
                            </main>
                        </div>
                    </div>
                </div>
            );
        };

        // CategoryDesignTool Component
        const CategoryDesignTool = ({ appState, setAppState, onNavigate }) => {
            const [exportModal, setExportModal] = useState({ isOpen: false, content: '', title: '' });
            const [showSuggestions, setShowSuggestions] = useState(false);
            const [isLoadingNames, setIsLoadingNames] = useState(false);
            const [suggestedNames, setSuggestedNames] = useState([]);
            
            // AI Category State Variables
            const [aiCategoryLoading, setAiCategoryLoading] = useState(false);
            const [aiCategoryError, setAiCategoryError] = useState(null);
            
            // AI Category Drafter API Integration
            const handleGenerateCategory = async (context) => {
                setAiCategoryLoading(true);
                setAiCategoryError(null);
                
                try {
                    const response = await fetch('/api/draft-category', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            icpSummary: context.icpSummary,
                            valueProps: context.valueProps,
                            fromStatement: context.fromStatement,
                            toStatement: context.toStatement
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    return data.categories || [];
                } catch (error) {
                    console.error('Category generation failed:', error);
                    setAiCategoryError(error.message);
                    // Fallback names on error
                    return [
                        'Digital Transformation Platform',
                        'Business Intelligence Suite', 
                        'Operational Excellence System',
                        'Market Innovation Engine',
                        'Growth Acceleration Framework'
                    ];
                } finally {
                    setAiCategoryLoading(false);
                }
            };

            const handleExport = () => {
                const formatSection = (title, content) => `## ${title}\n${content || 'N/A'}\n\n`;
                
                let summary = `Part 2: Category Design Blueprint\n==================================\n\n`;
                summary += `## Positioning Foundation (from Part 1)\n`;
                summary += `- ICP Summary: ${appState.positioningData.icp_summary || 'N/A'}\n`;
                summary += `- Unique Value: ${appState.positioningData.values ? appState.positioningData.values.map(v => v.val2).join('; ') : 'N/A'}\n\n`;

                summary += `## 5. The Point of View (The "From/To" Shift)\n- From: ${appState.categoryData['from-statement'] || 'N/A'}\n- To: ${appState.categoryData['to-statement'] || 'N/A'}\n\n`;
                summary += formatSection('6. The New Opportunity', appState.categoryData['new-opportunity']);
                summary += `## 7. Category Name & Definition\n- Name: ${appState.categoryData['category-name'] || 'N/A'}\n- Definition: ${appState.categoryData['category-definition'] || 'N/A'}\n\n`;
                summary += formatSection('8. The Manifesto', appState.categoryData['manifesto']);

                setExportModal({ isOpen: true, content: summary, title: 'Category Design Summary' });
            };

            return (
                <div className="container mx-auto px-4 sm:px-6 lg:px-8">
                    <header className="sticky top-16 bg-white border-b border-gray-200 z-40 py-3">
                        <div className="flex justify-between items-center py-3">
                            <div className="flex items-center space-x-4">
                                <button onClick={() => { onNavigate('positioning'); window.scrollTo(0, 0); }} className="text-gray-600 hover:scale-gold-text">‚Üê Back to Part 3: Positioning</button>
                                <h1 className="text-xl sm:text-2xl font-bold scale-green-text">Part 4: Category Design</h1>
                            </div>
                            {React.createElement(PrimaryActions, {
                                currentPart: 'category',
                                onReset: () => {
                                    if (window.confirm("Are you sure you want to reset all data for Part 2? This will clear all Category Design fields.")) {
                                        setAppState(prev => ({
                                            ...prev,
                                            categoryData: getInitialState().categoryData
                                        }));
                                    }
                                },
                                onExport: handleExport,
                                onContinue: () => {
                                    // Complete Blueprint - could navigate to completion page or show success message
                                    alert('Blueprint Complete! All parts have been finished.');
                                    window.scrollTo(0, 0);
                                }
                            })}
                        </div>
                    </header>

                    <div className="mt-8">
                        <div className="lg:flex lg:space-x-8">
                            <main className="w-full">
                                <div className="space-y-8">
                        <div className="bg-green-50 border-l-4 border-green-600 p-6 rounded-r-lg shadow-sm">
                            <h3 className="text-xl font-bold text-green-800 mb-3">Positioning Foundation</h3>
                            <p className="text-green-700 mb-4">This category design exercise builds upon the positioning work from Part 1. Here is a summary of your key inputs:</p>
                            <div className="bg-white p-4 rounded-md border border-green-200">
                                <h4 className="font-bold text-gray-800">Ideal Customer Profile (Summary)</h4>
                                <p className="text-sm text-gray-600 mt-1 italic">{appState.positioningData.icp_summary || 'Complete Part 1 first'}</p>
                                <h4 className="font-bold text-gray-800 mt-3">Unique Value</h4>
                                <div className="text-sm text-gray-600 mt-1">
                                    {(appState.positioningData.values && appState.positioningData.values[0]?.val1) ? (
                                        <ul className="list-disc pl-5 space-y-2">
                                            {appState.positioningData.values.map((item, index) => (
                                                item.val1 && <li key={index}><strong>{item.val1}:</strong> <span className="italic">{item.val3}</span></li>
                                            ))}
                                        </ul>
                                    ) : (
                                        <span className="italic">Complete Part 1 first</span>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div id="section-1" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                            <h2 className="text-2xl font-bold scale-green-text mb-2">1. The Point of View (The "From/To" Shift)</h2>
                            <p className="font-semibold text-gray-600 mb-2">Question: What is the old, broken way of thinking, and what is our new, better way?</p>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label className="block font-bold text-gray-700">From (The Old, Broken Way)</label>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="4" 
                                        placeholder="Example: Business transformation is a series of slow, high-risk, episodic projects."
                                        value={appState.categoryData['from-statement'] || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'from-statement': e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">To (Our New, Better Way)</label>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="4" 
                                        placeholder="Example: Operational excellence is a continuous, automated, data-driven business function."
                                        value={appState.categoryData['to-statement'] || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'to-statement': e.target.value } }))}
                                    />
                                </div>
                            </div>
                        </div>

                        <div id="section-2" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                            <h2 className="text-2xl font-bold scale-green-text mb-2">2. The New Opportunity</h2>
                            <p className="font-semibold text-gray-600 mb-2">Question: What becomes possible for businesses that adopt our point of view?</p>
                            <textarea 
                                className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                rows="4" 
                                placeholder="Example: Businesses can now move beyond reactive, crisis-driven change and achieve continuous transformation..."
                                value={appState.categoryData['new-opportunity'] || ''}
                                onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'new-opportunity': e.target.value } }))}
                            />
                        </div>

                        <div id="section-3" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                            <h2 className="text-2xl font-bold scale-green-text mb-2">3. Category Name & Definition</h2>
                            <div className="space-y-4">
                                <div>
                                    <label className="block font-bold text-gray-700">Category Name</label>
                                    <div className="flex gap-2 mt-1">
                                        <input 
                                            type="text" 
                                            className="flex-1 p-2 border border-gray-300 rounded-md"
                                            placeholder="Example: Continuous Transformation"
                                            value={appState.categoryData['category-name'] || ''}
                                            onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'category-name': e.target.value } }))}
                                        />
                                        <button 
                                            className="px-4 py-2 text-white font-bold rounded-md transition-colors hover:opacity-90 disabled:opacity-50"
                                            style={{backgroundColor: '#e5a819'}}
                                            onClick={async () => {
                                                // Gather strategic inputs from appState
                                                const icpSummary = appState.positioningData.icp_summary || '';
                                                const valueProps = appState.positioningData.values 
                                                    ? appState.positioningData.values
                                                        .filter(v => v.val3)
                                                        .map(v => v.val3)
                                                    : [];
                                                const fromStatement = appState.categoryData['from-statement'] || '';
                                                const toStatement = appState.categoryData['to-statement'] || '';
                                                
                                                // Construct context for AI
                                                const context = {
                                                    icpSummary,
                                                    valueProps,
                                                    fromStatement,
                                                    toStatement
                                                };
                                                
                                                // Show loading state
                                                setShowSuggestions(true);
                                                setIsLoadingNames(true);
                                                
                                                try {
                                                    // Call AI Category Drafter API
                                                    const names = await handleGenerateCategory(context);
                                                    setSuggestedNames(names);
                                                } catch (error) {
                                                    console.error('Failed to generate names:', error);
                                                    setSuggestedNames(['Error generating names']);
                                                } finally {
                                                    setIsLoadingNames(false);
                                                }
                                            }}
                                            disabled={isLoadingNames}
                                        >
                                            {isLoadingNames ? 'Brainstorming...' : 'Brainstorm with AI'}
                                        </button>
                                    </div>
                                    {showSuggestions && (
                                        <div className="mt-2 p-3 bg-gray-50 border border-gray-200 rounded-md">
                                            {isLoadingNames ? (
                                                <p className="text-sm text-gray-600 italic">Analyzing your strategic context and generating category names...</p>
                                            ) : (
                                                <>
                                                    <p className="text-sm font-medium text-gray-700 mb-2">Select a category name:</p>
                                                    <div className="space-y-1">
                                                        {suggestedNames.map((name, index) => (
                                                    <button
                                                        key={index}
                                                        className="block w-full text-left px-3 py-2 text-sm rounded-md hover:bg-gray-100 transition-colors"
                                                        onClick={() => {
                                                            setAppState(prev => ({
                                                                ...prev, 
                                                                categoryData: {
                                                                    ...prev.categoryData, 
                                                                    'category-name': name 
                                                                }
                                                            }));
                                                            setShowSuggestions(false);
                                                        }}
                                                    >
                                                        {name}
                                                    </button>
                                                ))}
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    )}
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">One-Sentence Definition</label>
                                    <input 
                                        type="text" 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        placeholder="Example: The practice of using AI to continuously analyze and optimize business processes in real-time."
                                        value={appState.categoryData['category-definition'] || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'category-definition': e.target.value } }))}
                                    />
                                </div>
                            </div>
                        </div>

                        <div id="section-4" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                            <h2 className="text-2xl font-bold scale-green-text mb-2">4. The Manifesto</h2>
                            <p className="font-semibold text-gray-600 mb-2">Question: What is our story?</p>
                            <textarea 
                                className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                rows="8" 
                                placeholder="Enter your manifesto here..."
                                value={appState.categoryData['manifesto'] || ''}
                                onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'manifesto': e.target.value } }))}
                            />
                        </div>
                                </div>
                            </main>
                        </div>
                    </div>

                    <ExportModal 
                        isOpen={exportModal.isOpen}
                        onClose={() => setExportModal(prev => ({ ...prev, isOpen: false }))}
                        title={exportModal.title}
                        content={exportModal.content}
                        appState={appState}
                        filename="category-design-blueprint"
                    />
                </div>
            );
        };

        // Home Component
        const Home = ({ appState, setAppState, onNavigate }) => {
            console.log('HomeView props:', { appState, setAppState, onNavigate });
            
            const [showCompanySetupModal, setShowCompanySetupModal] = useState(() => {
                // Initialize modal state based on setup completion
                return !appState.companyContext?.isSetupComplete;
            });

            // Separate useEffect for debugging
            useEffect(() => {
                console.log('CompanyContext:', appState.companyContext);
                console.log('Should show modal:', !appState.companyContext?.isSetupComplete);
                console.log('Modal state:', showCompanySetupModal);
            });

            return (
                <div className="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div className="min-h-screen flex flex-col items-center justify-center">
                        <header className="text-center mb-12">
                            <h1 className="text-4xl md:text-5xl font-bold scale-green-text">Interactive GTM Blueprint Series</h1>
                            <p className="mt-4 text-lg text-gray-600 max-w-2xl mx-auto">A guided, step-by-step workshop to define your market segment, ideal customer, and category.</p>
                        </header>

                        <main className="w-full max-w-md text-center">
                            <button 
                                onClick={() => onNavigate('segment')}
                                className="w-full scale-green-bg text-white font-bold text-xl py-4 px-8 rounded-xl shadow-lg hover:bg-opacity-90 transition-transform transform hover:scale-105"
                            >
                                Get Started ‚Üí
                            </button>
                        </main>

                        <p className="text-sm text-gray-500 mt-8 text-center max-w-2xl mx-auto">
                            Your progress is saved automatically in your browser. This data is private and is not sent to any server.
                        </p>

                        <footer className="text-center text-sm text-gray-500 py-8 mt-12">
                            Scale Venture Partners
                            {window.location.hostname === 'localhost' && (
                                <div className="mt-2">
                                    <button 
                                        onClick={() => {
                                            setShowCompanySetupModal(true);
                                        }}
                                        className="text-xs text-gray-400 hover:text-gray-600 underline cursor-pointer transition-colors"
                                    >
                                        Dev Tools: Show Company Setup
                                    </button>
                                </div>
                            )}
                        </footer>
                    </div>

                    <CompanySetupModal
                        isOpen={showCompanySetupModal}
                        onComplete={() => {
                            console.log('Modal onComplete called');
                            setShowCompanySetupModal(false);
                            saveAppState(appState);
                        }}
                        companyData={appState.companyContext || {}}
                        setCompanyData={(updater) => {
                            console.log('setCompanyData called with:', updater);
                            setAppState(prev => {
                                console.log('Previous state:', prev);
                                const updatedContext = typeof updater === 'function' 
                                    ? updater(prev.companyContext || {})
                                    : updater;
                                const newState = { ...prev, companyContext: updatedContext };
                                console.log('New state:', newState);
                                return newState;
                            });
                        }}
                    />
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const [appState, setAppState] = useState(() => {
                const savedState = loadAppState();
                const state = savedState || getInitialState();
                return state;
            });

            useEffect(() => {
                saveAppState(appState);
            }, [appState]);

            const navigate = (view) => {
                setAppState(prev => {
                    const newState = { ...prev, currentView: view };
                    
                    // Update navigationProgress for workflow pages
                    if (['segment', 'icp', 'positioning', 'category'].includes(view)) {
                        newState.navigationProgress = {
                            ...prev.navigationProgress,
                            currentPart: view
                        };
                    }
                    
                    return newState;
                });
            };

            const renderCurrentView = () => {
                switch (appState.currentView) {
                    // case 'analysis': - REMOVED for simplification
                    case 'segment':
                        return <SegmentFoundationTool appState={appState} setAppState={setAppState} onNavigate={navigate} />;
                    case 'icp':
                        return <ICPDefinitionTool appState={appState} setAppState={setAppState} onNavigate={navigate} />;
                    case 'positioning':
                        return <PositioningTool appState={appState} setAppState={setAppState} onNavigate={navigate} />;
                    case 'category':
                        return <CategoryDesignTool appState={appState} setAppState={setAppState} onNavigate={navigate} />;
                    case 'home':
                    default:
                        return <Home appState={appState} setAppState={setAppState} onNavigate={navigate} />;
                }
            };

            // Show progress stepper only on workflow pages
            const showProgressStepper = ['segment', 'icp', 'positioning', 'category'].includes(appState.currentView);

            
            return (
                <div>
                    {showProgressStepper && (
                        <ProgressStepper
                            currentPart={appState.navigationProgress.currentPart}
                            completedParts={appState.navigationProgress.completedParts}
                            onNavigate={navigate}
                        />
                    )}
                    {renderCurrentView()}
                </div>
            );
        };

        
        const container = document.getElementById('root');
        if (container) {
            try {
                const root = ReactDOM.createRoot(container);
                
                root.render(<App />);
            } catch (error) {
                serverLog('error', 'Failed to create or render React root', error);
            }
        } else {
            serverLog('error', 'Root container not found!');
        }
    </script>
</body>
</html>