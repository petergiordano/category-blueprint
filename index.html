<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Category Blueprint Series</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700&family=Work+Sans:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f6f6f6;
        }
        
        .scale-green-bg {
            background-color: #10b981;
        }
        
        .scale-green-text {
            color: #10b981;
        }
        
        .scale-gold-text {
            color: #d97706;
        }
    </style>
</head>
<body class="text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        // Get all React hooks we need
        const { useState, useEffect, useRef } = React;

        // Enhanced logging that sends to server
        const serverLog = async (level, message, error = null) => {
            // Temporarily disabled to prevent infinite loops
            return;
        };

        // Console overrides temporarily disabled to prevent infinite loops
        // const originalConsoleError = console.error;
        // const originalConsoleLog = console.log;
        // const originalConsoleWarn = console.warn;

        // Error listeners temporarily disabled to prevent infinite loops
        // window.addEventListener('error', (event) => {
        //     serverLog('error', `Unhandled error: ${event.message}`, event.error);
        // });

        // window.addEventListener('unhandledrejection', (event) => {
        //     serverLog('error', `Unhandled promise rejection: ${event.reason}`);
        // });


        // localStorage helper functions
        const saveAppState = (state) => {
          try {
            const stateWithTimestamp = {
              ...state,
              lastSaved: new Date().toISOString()
            };
            localStorage.setItem('klarityCategoryBlueprintState', JSON.stringify(stateWithTimestamp));
          } catch (error) {
            console.error('Could not save state to localStorage', error);
          }
        };
        
        // Deep Research Prompt Generation Engine
        const generateDeepResearchPrompt = (companyData) => {
          try {
            // Ensure we have safe defaults for all required fields
            const safeData = {
              companyName: companyData?.companyName?.trim() || 'Your Company',
              companyWebsite: companyData?.companyWebsite?.trim() || 'your-website.com',
              industry: companyData?.industry?.trim() || 'Technology',
              productName: companyData?.productName?.trim() || 'Your Product',
              targetMarket: companyData?.targetMarket || 'B2B',
              competitorNames: companyData?.competitorNames || ['', '', '']
            };
            
            // Format competitors list
            const competitors = safeData.competitorNames
              .filter(comp => comp && comp.trim())
              .join(', ') || 'Competitor 1, Competitor 2, Competitor 3';
            
            // Embedded template from prompt-deep-research.md
            const promptTemplate = `**System Role:** You are a "Senior GTM Analyst & Intelligence Architect." Your primary mission is to synthesize public information into a comprehensive market intelligence brief that strictly adheres to a predefined framework.

**Prompt Title:** Positioning and Category Deep Research Brief for [Company Name]

**Objective:** To conduct comprehensive, outside-in research into **[Company Name]** and its product **[Product or Service Name]**. This brief will serve as a foundational intelligence layer for a strategic workshop, providing the external market view to contrast with the company's internal assumptions. The structure of your output MUST be a perfect 1-to-1 mirror of the application framework outlined below.

**Target Company:** [Company Name]
**Company Website:** [Company Website]
**Industry:** [Industry]
**Product or Service Name:** [Product or Service Name]
**User-Provided Competitors (Starting Point):** [Competitor 1, Competitor 2, Competitor 3]

**Core Research Mandate:** Your mission is to populate every element in the outline below by synthesizing public information. Go beyond simple data collection to find the qualitative "breadcrumbs and clues"—the nuance, sentiment, and semantics in the market's language. Your final output MUST strictly adhere to the formatting rules in the "Deliverable" section.

---

### **Key Areas of Deep Investigation**

**(Your entire deliverable will be a well-written report that follows the structured outline format defined in the "Deliverable" section below. You must provide a finding for every single element listed.)**

#### **Part 1: The Segment Foundation (The Market's "Why")**

**1A. Jobs To Be Done (JTBD):**
1.  **Context:** The business situation or operating environment.
2.  **Struggling Moments:** The breakdowns, inefficiencies, or risks that trigger the search.
3.  **Pushes & Pulls:** Internal and external forces moving them toward or away from change.
4.  **Anxieties & Habits:** Concerns about adopting something new and inertia with current processes.
5.  **Desired Outcomes:** The business goals and success metrics they want to achieve.
6.  **Basic Quality (Table Stakes):** Minimum standards a solution must meet to be considered.
7.  **Hiring Criteria:** Differentiators that make them select one vendor over another.
8.  **Firing Criteria:** Triggers that get a vendor rejected or replaced.
9.  **Key Trade-offs:** Acceptable compromises customers are willing to make.

**1B. Customer Value:**
1.  **Table Stakes:** Non-negotiables for credibility (compliance, security, integrations).
2.  **Functional Value:** Tangible, measurable business outcomes (ROI, efficiency gains, cost savings).
3.  **Ease of Doing Business:** Simplicity of adoption, implementation, and use.
4.  **Individual Value:** Personal wins for stakeholders (status, workload relief, career wins).
5.  **Aspirational Value:** Alignment with the customer's vision or higher-order goals.

**1C. Willingness to Pay (WTP):**
1.  **Ability to Pay:** Evidence of budget and capacity to spend.
2.  **Economic Justification:** The ROI and payback case that makes financial sense.
3.  **Relative Value vs. Alternatives:** How the solution's value compares to competitors or the status quo.
4.  **Risk & Switching Costs:** The perceived risk or friction in making a change.
5.  **Market Reference Points:** The pricing anchors customers use from competitors or prior spend.

#### **Part 2: The Ideal Customer Profile & Buyer Personas**

**2A. Operational ICP:**
1.  **Firmographics:** Common industries, company sizes, and revenue stages.
2.  **Technographics:** The technology stack or specific tools used by ideal customers.
3.  **Behavioral:** Observable actions that signal a 'change-ready' mindset (e.g., job postings).
4.  **Quick Decision Making:** Evidence of who the economic buyer is and their purchasing authority.
5.  **Prioritized Requirements:** What they appear to value most in a solution.
6.  **Implementation Readiness:** Public signals of their ability to adopt a new product.

**2B. Key Buyer Personas & Stakeholder Roles:**
* **Task:** For each of the key stakeholder roles listed below, identify the typical job titles, their primary goals, and their common challenges/concerns when evaluating a product like **[Product or Service Name]**.
1.  **Initiator**
2.  **Primary Decision Maker**
3.  **Approver**
4.  **Economic Buyer**
5.  **End User**
6.  **Champion (Influencer)**
7.  **Blocker**
8.  **Technical Operational Evaluator**
9.  **Legal & Compliance**
10. **Gatekeeper**
11. **External Consultants**

#### **Part 3: Positioning (The Market's "How")**

1.  **Competitive Alternatives:** Investigate and list the top Direct, Indirect, and Status Quo alternatives. For each, describe why customers choose it and its primary weaknesses.
2.  **Unique Value and Proof (The Positioning Table):** Identify 3-5 key value propositions as perceived by the market. For each one, detail the **Unique Attribute**, the **Benefit** it enables, and the **Value/Proof** (quantifiable metrics).
3.  **Relevant Trends:** Identify 2-3 major market trends. For each, explain:
    * How this trend aligns with and enhances the product.
    * How this trend makes the product more appealing.
    * How this trend creates urgency for the product.
    * How this trend impacts the underlying need for the product.

#### **Part 4: Category Design (The Market's "What")**

1.  **The Point of View (From/To Shift):** Based on market narratives, what is the "From" (old, broken way) and what is the emerging "To" (new, better way)?
2.  **The New Opportunity:** What becomes possible for businesses that adopt the "To" perspective?
3.  **Category Name & Definition:** What market category do analysts and customers currently place the company in? Is there evidence of an attempt to create a new one?
4.  **The Manifesto:** Synthesize the public-facing story and narrative into a concise manifesto draft.

---
**Deliverable: "Positioning and Category Deep Research Brief for [Company Name]"**

The output MUST be a single markdown document titled "Positioning and Category Deep Research Brief for [Company Name]". You MUST adhere to the following **Structured Outline** format.

**Formatting and Structure Mandates:**
* Use markdown headings (\`##\`, \`###\`) to structure the report precisely as outlined in the "Key Areas of Deep Investigation."
* For each element in the outline (e.g., "1. Context", "2. Struggling Moments"), first write a synthesized paragraph that represents your best-analyzed finding for that element.
* Below your synthesized finding, you MUST provide at least one piece of specific evidence as a sub-bullet.
* Direct quotes MUST be *italicized and enclosed in quotation marks*.
* Each piece of evidence MUST be followed by a \`[Source: URL or Document Name, Date]\` tag.

**Example Output Snippet (Follow this "Synthesis then Evidence" structure precisely for ALL elements):**
\`\`\`markdown
### 1A. Jobs To Be Done (JTBD)

**1. Context:**
The most common context for customers of [Product or Service Name] appears to be mid-sized B2B SaaS companies that have recently completed a Series B or C funding round and are now under pressure from their board to professionalize their financial and operational processes.
- Evidence: Analysis of 5 public customers shows that 4 of them announced a Series B/C round within 12 months prior to being listed as a customer. [Source: Crunchbase, 2025-09-15]

**2. Struggling Moments:**
The primary trigger is the high rate of manual errors during the financial close process, which creates significant downstream risk and rework, often jeopardizing audit readiness.
- Evidence: *"We spent the first week of every quarter just finding and fixing spreadsheet errors from the last one. It was a nightmare."* [Source: G2 Review for Competitor X, 2025-08-15]
\`\`\`

---

**Research Execution Instructions:**

1. **Web Search Protocol:** You MUST perform comprehensive web searches to gather current, specific evidence for each element listed above.

2. **Quality Standards:** Each finding must be supported by specific, recent evidence with proper source attribution.

3. **Market Language Focus:** Pay special attention to the exact language, terms, and phrases that customers and the market use when discussing problems, solutions, and outcomes.

4. **Competitive Intelligence:** Analyze not just the target company, but also how competitors position themselves and what customers say about the competitive landscape.

5. **Trend Validation:** Ensure all identified trends are current (within 12-18 months) and can be substantiated with multiple sources.

**Final Deliverable Requirements:**
- Complete markdown document following the exact structure outlined above
- Every element must have a finding with supporting evidence
- Minimum 8,000 words, maximum 15,000 words
- Professional, analyst-level writing quality
- Actionable insights that can inform strategic positioning decisions`;

            // Replace all placeholders with actual data
            const placeholders = {
              '[Company Name]': safeData.companyName,
              '[Company Website]': safeData.companyWebsite,
              '[Industry]': safeData.industry,
              '[Product or Service Name]': safeData.productName,
              '[Competitor 1, Competitor 2, Competitor 3]': competitors
            };
            
            let finalPrompt = promptTemplate;
            Object.entries(placeholders).forEach(([placeholder, value]) => {
              finalPrompt = finalPrompt.replace(new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), value);
            });
            
            return finalPrompt;
            
          } catch (error) {
            console.error('Error generating deep research prompt:', error);
            return 'Error generating prompt. Please check your company data and try again.';
          }
        };

        const loadAppState = () => {
          try {
            const savedState = localStorage.getItem('klarityCategoryBlueprintState');
            if (!savedState) {
              return null;
            }
            
            const parsedState = JSON.parse(savedState);
            
            // Merge with initial state to ensure all new properties exist
            const initialState = getInitialState();
            const mergedState = {
              ...initialState,
              ...parsedState,
              // Ensure nested objects are properly merged
              positioningData: { ...initialState.positioningData, ...(parsedState.positioningData || {}) },
              categoryData: { ...initialState.categoryData, ...(parsedState.categoryData || {}) },
              segmentData: { ...initialState.segmentData, ...(parsedState.segmentData || {}) },
              companyContext: { ...initialState.companyContext, ...(parsedState.companyContext || {}) },
              navigationProgress: { 
                ...initialState.navigationProgress, 
                ...(parsedState.navigationProgress || {}),
                partCompletionData: {
                  ...initialState.navigationProgress.partCompletionData,
                  ...(parsedState.navigationProgress?.partCompletionData || {})
                }
              }
            };
            return mergedState;
          } catch (error) {
            console.error('Could not load state from localStorage', error);
            return null;
          }
        };

        const getInitialState = () => {
          return {
            positioningData: {
              icp_common_needs: '',
              icp_desired_business_value: '',
              icp_problem_urgency: '',
              icp_quick_decision_making: '',
              icp_prioritized_requirements: '',
              icp_willingness_to_pay: '',
              icp_implementation_readiness: '',
              icp_firmographic: '',
              icp_technographic: '',
              icp_behavioral: '',
              icp_summary: '',
              'market-context': '',
              'market-context-other': '',
              alternatives: [{ val1: '', val2: '' }],
              pillars: [{ id: 1, name: '', benefit: '' }],
              values: [{ val1: '', val2: '', val3: '', val4: '', pillarId: null }],
              trend1_desc: '',
              trend2_desc: '',
              trend3_desc: '',
              trend4_desc: ''
            },
            categoryData: {
              'from-statement': '',
              'to-statement': '',
              'new-opportunity': '',
              'category-name': '',
              'category-definition': '',
              'manifesto': ''
            },
            segmentData: {},
            companyContext: {
              isSetupComplete: false,
              companyName: '',
              companyWebsite: '',
              industry: '',
              productName: '',
              targetMarket: 'B2B',
              caseStudyUrls: [],
              documentationUrls: [],
              competitorNames: ['', '', '']
            },
            navigationProgress: {
              completedParts: [],
              currentPart: 'segment',
              partCompletionData: {
                segment: { completed: false, completedAt: null },
                icp: { completed: false, completedAt: null },
                positioning: { completed: false, completedAt: null },
                category: { completed: false, completedAt: null }
              }
            },
            currentView: 'home'
          };
        };

        // Enhanced Interactive Progress Stepper Component
        const ProgressStepper = ({ currentPart, completedParts, onNavigate, appState, saveAppState }) => {
            const parts = [
                { id: 'segment', name: 'Foundation', number: 1, fullName: 'Segment Foundation' },
                { id: 'icp', name: 'ICP Definition', number: 2, fullName: 'ICP Definition' },
                { id: 'positioning', name: 'Positioning', number: 3, fullName: 'Positioning' },
                { id: 'category', name: 'Category Design', number: 4, fullName: 'Category Design' }
            ];

            const [isMobile, setIsMobile] = useState(window.innerWidth < 640);

            useEffect(() => {
                const handleResize = () => setIsMobile(window.innerWidth < 640);
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            const isNavigable = (partId) => {
                // Can navigate to completed parts or the current part
                if (completedParts.includes(partId) || partId === currentPart) {
                    return true;
                }
                
                // Auto-allow navigation to previous parts if we're on a later part
                const partOrder = ['segment', 'icp', 'positioning', 'category'];
                const partIndex = partOrder.indexOf(partId);
                const currentIndex = partOrder.indexOf(currentPart);
                
                // If the part comes before the current part, it should be navigable
                return partIndex < currentIndex && currentIndex > 0;
            };

            const getStepStatus = (partId) => {
                if (partId === currentPart) return 'current';
                if (completedParts.includes(partId)) return 'completed';
                
                // Show previous parts as completed if we're on a later part
                const partOrder = ['segment', 'icp', 'positioning', 'category'];
                const partIndex = partOrder.indexOf(partId);
                const currentIndex = partOrder.indexOf(currentPart);
                
                if (partIndex < currentIndex && currentIndex > 0) {
                    return 'completed';
                }
                
                return 'upcoming';
            };

            const handleStepClick = (partId) => {
                if (!isNavigable(partId)) return;
                
                // Save current state before navigation
                if (saveAppState && appState) {
                    saveAppState(appState);
                }
                
                // Navigate to the selected part
                onNavigate(partId);
                
                // Smooth scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const handleHomeClick = () => {
                // Save current state before navigating home
                if (saveAppState && appState) {
                    saveAppState(appState);
                }
                
                // Navigate to home
                onNavigate('home');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const getStepStyles = (status, isHoverable) => {
                const baseStyles = {
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.5rem',
                    padding: '0.75rem 1rem',
                    borderRadius: '0.5rem',
                    transition: 'all 0.2s ease',
                    cursor: isHoverable ? 'pointer' : 'not-allowed',
                    userSelect: 'none',
                    position: 'relative',
                    border: 'none',
                    outline: 'none'
                };

                const statusStyles = {
                    completed: {
                        backgroundColor: '#10b981',
                        color: 'white',
                        opacity: 1
                    },
                    current: {
                        backgroundColor: '#3b82f6',
                        color: 'white',
                        opacity: 1,
                        boxShadow: '0 0 0 3px rgba(59, 130, 246, 0.1)'
                    },
                    upcoming: {
                        backgroundColor: '#f3f4f6',
                        color: '#6b7280',
                        opacity: 0.6
                    }
                };

                return { ...baseStyles, ...statusStyles[status] };
            };

            return (
                <div style={{ 
                    display: 'flex', 
                    justifyContent: 'space-between',  // Changed from 'center'
                    alignItems: 'center',
                    padding: '1rem',
                    backgroundColor: 'white',
                    borderBottom: '1px solid #e5e7eb',
                    position: 'sticky',
                    top: 0,
                    zIndex: 50,
                    boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)'
                }}>
                    {/* Home Button - Left Side */}
                    <button
                        onClick={handleHomeClick}
                        style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '0.5rem',
                            padding: '0.5rem 1rem',
                            borderRadius: '0.5rem',
                            backgroundColor: '#f3f4f6',
                            color: '#374151',
                            border: 'none',
                            cursor: 'pointer',
                            transition: 'all 0.2s ease',
                            fontSize: '0.9rem',
                            fontWeight: '500'
                        }}
                        onMouseEnter={(e) => {
                            e.currentTarget.style.backgroundColor = '#e5e7eb';
                        }}
                        onMouseLeave={(e) => {
                            e.currentTarget.style.backgroundColor = '#f3f4f6';
                        }}
                        title="Return to Home"
                        aria-label="Return to Home Screen"
                    >
                        {/* Home Icon SVG */}
                        <svg 
                            width="16" 
                            height="16" 
                            viewBox="0 0 20 20" 
                            fill="currentColor"
                            style={{ marginRight: '0.25rem' }}
                        >
                            <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                        </svg>
                        <span className="hidden sm:inline">Category Blueprint</span>
                        <span className="sm:hidden">Home</span>
                    </button>

                    {/* Progress Steps - Center */}
                    <nav role="navigation" aria-label="Blueprint progress">
                        <ol role="list" style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', listStyle: 'none', margin: 0, padding: 0 }}>
                            {parts.map((part, index) => {
                                const status = getStepStatus(part.id);
                                const isHoverable = isNavigable(part.id);
                                
                                return (
                                    <React.Fragment key={part.id}>
                                        <li role="listitem">
                                            <button
                                                onClick={() => handleStepClick(part.id)}
                                                onKeyDown={(e) => {
                                                    if (e.key === 'Enter' || e.key === ' ') {
                                                        e.preventDefault();
                                                        handleStepClick(part.id);
                                                    }
                                                }}
                                                disabled={!isHoverable}
                                                aria-label={`Part ${part.number}: ${part.fullName} - ${status}`}
                                                aria-current={part.id === currentPart ? 'step' : undefined}
                                                style={getStepStyles(status, isHoverable)}
                                                onMouseEnter={(e) => {
                                                    if (isHoverable) {
                                                        e.currentTarget.style.transform = 'scale(1.02)';
                                                        e.currentTarget.style.opacity = '0.9';
                                                    }
                                                }}
                                                onMouseLeave={(e) => {
                                                    e.currentTarget.style.transform = 'scale(1)';
                                                    e.currentTarget.style.opacity = '1';
                                                }}
                                                onFocus={(e) => {
                                                    if (isHoverable) {
                                                        e.currentTarget.style.boxShadow = status === 'current' ? 
                                                            '0 0 0 3px rgba(59, 130, 246, 0.3)' : 
                                                            '0 0 0 3px rgba(16, 185, 129, 0.3)';
                                                    }
                                                }}
                                                onBlur={(e) => {
                                                    e.currentTarget.style.boxShadow = status === 'current' ? 
                                                        '0 0 0 3px rgba(59, 130, 246, 0.1)' : 
                                                        'none';
                                                }}
                                                title={
                                                    isHoverable 
                                                        ? `Navigate to Part ${part.number}: ${part.fullName}`
                                                        : `Part ${part.number}: ${part.fullName} (Not yet available)`
                                                }
                                            >
                                                {status === 'completed' ? (
                                                    <span style={{ fontSize: '1.1rem' }}>✓</span>
                                                ) : (
                                                    <span style={{ 
                                                        fontWeight: 'bold',
                                                        fontSize: '0.9rem',
                                                        minWidth: '1.5rem',
                                                        textAlign: 'center'
                                                    }}>{part.number}</span>
                                                )}
                                                <span style={{ fontSize: '0.9rem', fontWeight: '500' }}>
                                                    {isMobile ? (
                                                        part.number
                                                    ) : (
                                                        <>
                                                            <span className="hidden sm:inline">Part {part.number}: </span>
                                                            {part.name}
                                                        </>
                                                    )}
                                                </span>
                                            </button>
                                        </li>
                                        {index < parts.length - 1 && (
                                            <li role="presentation" aria-hidden="true">
                                                <div style={{ 
                                                    width: '2rem',
                                                    height: '2px',
                                                    backgroundColor: completedParts.includes(parts[index + 1].id) || parts[index + 1].id === currentPart ? '#10b981' : '#d1d5db',
                                                    transition: 'background-color 0.3s ease'
                                                }} />
                                            </li>
                                        )}
                                    </React.Fragment>
                                );
                            })}
                        </ol>
                    </nav>

                    {/* Spacer for balance - Right Side */}
                    <div style={{ width: '140px' }}></div>
                </div>
            );
        };

        // Primary Action Buttons Component
        const PrimaryActions = ({ currentPart, onExport, onContinue, onReset, onImport }) => {
            
            const getButtonConfig = (part) => {
                const configs = {
                    'segment': { 
                        continue: 'Continue to Part 2: ICP Definition →',
                        export: 'Export Foundation'
                    },
                    'icp': { 
                        continue: 'Continue to Part 3: Positioning →',
                        export: 'Export ICP'
                    },
                    'positioning': { 
                        continue: 'Continue to Part 4: Category Design →',
                        export: 'Export Positioning'
                    },
                    'category': { 
                        continue: 'Complete Blueprint',
                        export: 'Export Category Design'
                    }
                };
                return configs[part] || { continue: 'Continue →', export: 'Export' };
            };

            const config = getButtonConfig(currentPart);
            
            return (
                <div style={{ display: 'flex', gap: '0.75rem', alignItems: 'center' }}>
                    {onReset && (
                        <button 
                            onClick={onReset}
                            style={{
                                background: 'transparent',
                                color: '#6b7280',
                                fontWeight: 500,
                                padding: '0.5rem 0.75rem',
                                borderRadius: '0.5rem',
                                border: '1px solid #d1d5db',
                                cursor: 'pointer'
                            }}
                        >
                            Reset
                        </button>
                    )}
                    {onImport && (currentPart === 'segment' || currentPart === 'icp' || currentPart === 'positioning' || currentPart === 'category') && (
                        <button 
                            onClick={onImport}
                            style={{
                                background: '#3b82f6',
                                color: 'white',
                                fontWeight: 500,
                                padding: '0.5rem 0.75rem',
                                borderRadius: '0.5rem',
                                border: 'none',
                                cursor: 'pointer'
                            }}
                        >
                            Import Data
                        </button>
                    )}
                    <button 
                        onClick={onExport}
                        style={{
                            background: '#f3f4f6',
                            color: '#374151',
                            fontWeight: 600,
                            padding: '0.5rem 1rem',
                            borderRadius: '0.5rem',
                            border: 'none',
                            cursor: 'pointer'
                        }}
                    >
                        {config.export}
                    </button>
                    <button 
                        onClick={onContinue}
                        style={{
                            background: '#10b981',
                            color: 'white',
                            fontWeight: 600,
                            padding: '0.5rem 1rem',
                            borderRadius: '0.5rem',
                            border: 'none',
                            cursor: 'pointer'
                        }}
                    >
                        {config.continue}
                    </button>
                </div>
            );
        };

        // Export Modal Component
        const ExportModal = ({ isOpen, onClose, title, content, appState, filename = 'category-blueprint-export', partData = null }) => {
            const [copied, setCopied] = useState(false);

            const handleCopy = () => {
                navigator.clipboard.writeText(content).then(() => {
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                });
            };

            const handleDownloadJSON = () => {
                // Use part-specific data if available, otherwise fall back to full appState
                const jsonData = JSON.stringify(partData || appState, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
                        <div className="flex justify-between items-center p-4 border-b">
                            <h2 className="text-2xl font-bold scale-green-text">{title}</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-800 text-3xl font-light">×</button>
                        </div>
                        <div className="p-6 overflow-y-auto">
                            <pre className="whitespace-pre-wrap text-sm bg-gray-50 p-4 rounded-md font-mono">{content}</pre>
                        </div>
                        <div className="p-4 border-t bg-gray-50 flex justify-end space-x-3">
                            <button 
                                onClick={handleDownloadJSON}
                                className="border border-gray-300 text-gray-600 font-bold py-2 px-4 rounded-lg hover:bg-gray-50 transition-colors"
                            >
                                Download JSON
                            </button>
                            <button 
                                onClick={handleCopy}
                                className="scale-green-bg text-white font-bold py-2 px-4 rounded-lg hover:bg-opacity-90"
                            >
                                {copied ? 'Copied!' : 'Copy to Clipboard'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // PromptDisplayModal Component
        const PromptDisplayModal = ({ isOpen, onClose, promptText, title = "Deep Research Prompt" }) => {
            const [copied, setCopied] = useState(false);

            const handleCopy = async () => {
                try {
                    await navigator.clipboard.writeText(promptText);
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = promptText;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                }
            };

            const handleDownload = () => {
                try {
                    const blob = new Blob([promptText], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${title.toLowerCase().replace(/\s+/g, '-')}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (err) {
                    console.error('Failed to download file: ', err);
                }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-6xl h-[95vh] flex flex-col">
                        <div className="flex justify-between items-center p-6 border-b">
                            <h2 className="text-2xl font-bold scale-green-text">{title}</h2>
                            <button 
                                onClick={onClose} 
                                className="text-gray-400 hover:text-gray-800 text-3xl font-light transition-colors"
                                aria-label="Close modal"
                            >
                                ×
                            </button>
                        </div>
                        
                        <div className="p-8 flex-1 overflow-hidden flex flex-col">
                            <p className="text-base text-gray-600 mb-6">
                                Your customized deep research prompt is ready. Copy it to use with your preferred AI assistant or download as a text file.
                            </p>
                            
                            <textarea
                                className="w-full flex-1 p-6 border border-gray-300 rounded-lg font-mono text-sm bg-gray-50 resize-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                value={promptText}
                                readOnly
                                placeholder="Generated prompt will appear here..."
                                style={{ minHeight: '400px' }}
                            />
                        </div>
                        
                        <div className="p-6 border-t bg-gray-50 flex justify-between items-center">
                            <div className="text-sm text-gray-500">
                                Prompt length: {promptText ? promptText.length.toLocaleString() : 0} characters
                            </div>
                            
                            <div className="flex gap-3">
                                <button 
                                    onClick={handleDownload}
                                    className="border border-gray-300 text-gray-600 font-bold py-2 px-4 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2"
                                    disabled={!promptText}
                                >
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    Download as .txt
                                </button>
                                
                                <button 
                                    onClick={handleCopy}
                                    className="scale-green-bg text-white font-bold py-2 px-4 rounded-lg hover:bg-opacity-90 transition-colors flex items-center gap-2"
                                    disabled={!promptText}
                                >
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                    {copied ? 'Copied!' : 'Copy to Clipboard'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // CompanySetupModal Component
        const CompanySetupModal = ({ isOpen, onComplete, companyData, setCompanyData }) => {
          console.log('CompanySetupModal rendered, isOpen:', isOpen, 'companyData:', companyData);
          
          if (!isOpen) return null;

          // Ensure companyData has all required properties with defaults
          const safeCompanyData = {
            companyName: '',
            companyWebsite: '',
            industry: '',
            productName: '',
            targetMarket: 'B2B',
            competitorNames: ['', '', ''],
            caseStudyUrls: [],
            documentationUrls: [],
            isSetupComplete: false,
            ...companyData
          };

          const [errors, setErrors] = useState({});
          
          const industries = [
            'SaaS/Software',
            'Financial Services', 
            'Healthcare',
            'E-commerce',
            'Manufacturing',
            'Professional Services',
            'Other'
          ];

          const validateForm = () => {
            const newErrors = {};
            
            // Validate required fields
            if (!safeCompanyData.companyName || safeCompanyData.companyName.length < 2) {
              newErrors.companyName = 'Company name must be at least 2 characters';
            }
            
            if (!safeCompanyData.companyWebsite) {
              newErrors.companyWebsite = 'Website is required';
            } else if (!/^[a-zA-Z0-9][a-zA-Z0-9-_.]*\.[a-zA-Z]{2,}/.test(safeCompanyData.companyWebsite.replace(/^https?:\/\//, ''))) {
              newErrors.companyWebsite = 'Please enter a valid domain (e.g., example.com)';
            }
            
            if (!safeCompanyData.industry) {
              newErrors.industry = 'Please select an industry';
            }
            
            if (!safeCompanyData.productName || safeCompanyData.productName.length < 2) {
              newErrors.productName = 'Product name must be at least 2 characters';
            }
            
            setErrors(newErrors);
            return Object.keys(newErrors).length === 0;
          };

          const handleSubmit = () => {
            if (validateForm()) {
              // Ensure website has https:// prefix
              const websiteWithProtocol = safeCompanyData.companyWebsite.startsWith('http://') || safeCompanyData.companyWebsite.startsWith('https://') 
                ? safeCompanyData.companyWebsite 
                : `https://${safeCompanyData.companyWebsite}`;
              
              setCompanyData(prev => ({ 
                ...safeCompanyData, 
                ...prev, 
                companyWebsite: websiteWithProtocol,
                isSetupComplete: true 
              }));
              onComplete();
            }
          };


          const updateCompetitor = (index, value) => {
            const newCompetitors = [...safeCompanyData.competitorNames];
            newCompetitors[index] = value;
            setCompanyData(prev => ({ ...safeCompanyData, ...prev, competitorNames: newCompetitors }));
          };

          return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div className="p-6">
                  <h2 className="text-2xl font-bold mb-2">Welcome! Let's set up your company context</h2>
                  <p className="text-gray-600 mb-6">This information helps our AI provide more accurate insights and recommendations.</p>
                  
                  {/* Required Fields Section */}
                  <div className="mb-8">
                    <h3 className="text-lg font-semibold mb-4 flex items-center">
                      <span className="text-red-500 mr-2">*</span>Required Information
                    </h3>
                    
                    {/* Company Name */}
                    <div className="mb-4">
                      <label className="block font-bold text-gray-700 mb-1">Company Name</label>
                      <input
                        type="text"
                        className={`w-full p-2 border rounded-md ${errors.companyName ? 'border-red-500' : 'border-gray-300'}`}
                        value={safeCompanyData.companyName}
                        onChange={(e) => setCompanyData(prev => ({ ...safeCompanyData, ...prev, companyName: e.target.value }))}
                        placeholder="e.g., Acme Corporation"
                      />
                      {errors.companyName && <p className="text-red-500 text-sm mt-1">{errors.companyName}</p>}
                    </div>

                    {/* Company Website */}
                    <div className="mb-4">
                      <label className="block font-bold text-gray-700 mb-1">Company Website</label>
                      <input
                        type="url"
                        className={`w-full p-2 border rounded-md ${errors.companyWebsite ? 'border-red-500' : 'border-gray-300'}`}
                        value={safeCompanyData.companyWebsite}
                        onChange={(e) => setCompanyData(prev => ({ ...safeCompanyData, ...prev, companyWebsite: e.target.value }))}
                        placeholder="example.com"
                      />
                      {errors.companyWebsite && <p className="text-red-500 text-sm mt-1">{errors.companyWebsite}</p>}
                    </div>

                    {/* Industry */}
                    <div className="mb-4">
                      <label className="block font-bold text-gray-700 mb-1">Industry</label>
                      <select
                        className={`w-full p-2 border rounded-md ${errors.industry ? 'border-red-500' : 'border-gray-300'}`}
                        value={safeCompanyData.industry}
                        onChange={(e) => setCompanyData(prev => ({ ...safeCompanyData, ...prev, industry: e.target.value }))}
                      >
                        <option value="">Select an industry</option>
                        {industries.map(ind => (
                          <option key={ind} value={ind}>{ind}</option>
                        ))}
                      </select>
                      {errors.industry && <p className="text-red-500 text-sm mt-1">{errors.industry}</p>}
                    </div>

                    {/* Product Name */}
                    <div className="mb-4">
                      <label className="block font-bold text-gray-700 mb-1">Product/Service Name</label>
                      <input
                        type="text"
                        className={`w-full p-2 border rounded-md ${errors.productName ? 'border-red-500' : 'border-gray-300'}`}
                        value={safeCompanyData.productName}
                        onChange={(e) => setCompanyData(prev => ({ ...safeCompanyData, ...prev, productName: e.target.value }))}
                        placeholder="e.g., Analytics Platform"
                      />
                      {errors.productName && <p className="text-red-500 text-sm mt-1">{errors.productName}</p>}
                    </div>

                    {/* Target Market */}
                    <div className="mb-4">
                      <label className="block font-bold text-gray-700 mb-1">Target Market</label>
                      <div className="flex gap-4">
                        <label className="flex items-center">
                          <input
                            type="radio"
                            name="targetMarket"
                            value="B2B"
                            checked={safeCompanyData.targetMarket === 'B2B'}
                            onChange={(e) => setCompanyData(prev => ({ ...safeCompanyData, ...prev, targetMarket: e.target.value }))}
                            className="mr-2"
                          />
                          B2B
                        </label>
                        <label className="flex items-center">
                          <input
                            type="radio"
                            name="targetMarket"
                            value="B2C"
                            checked={safeCompanyData.targetMarket === 'B2C'}
                            onChange={(e) => setCompanyData(prev => ({ ...safeCompanyData, ...prev, targetMarket: e.target.value }))}
                            className="mr-2"
                          />
                          B2C
                        </label>
                      </div>
                    </div>
                  </div>

                  {/* Optional Fields Section */}
                  <div className="mb-8">
                    <h3 className="text-lg font-semibold mb-4">Optional Information</h3>
                    
                    {/* Top 3 Competitors */}
                    <div className="mb-4">
                      <label className="block font-bold text-gray-700 mb-1">Top 3 Competitors</label>
                      <p className="text-sm text-gray-600 mb-2">Helps us understand your competitive landscape</p>
                      {[0, 1, 2].map(i => (
                        <input
                          key={i}
                          type="text"
                          className="w-full p-2 border border-gray-300 rounded-md mb-2"
                          value={safeCompanyData.competitorNames[i]}
                          onChange={(e) => updateCompetitor(i, e.target.value)}
                          placeholder={`Competitor ${i + 1}`}
                        />
                      ))}
                    </div>
                  </div>

                  {/* Action Buttons */}
                  <div className="flex justify-end gap-4 pt-4 border-t">
                    <button
                      onClick={handleSubmit}
                      className="scale-green-bg text-white font-bold py-2 px-6 rounded-lg hover:bg-opacity-90"
                    >
                      Get Started
                    </button>
                  </div>
                </div>
              </div>
            </div>
          );
        };

        // SubSectionNav Component
        const SubSectionNav = ({ sections, activeSection, currentPart }) => {
            return React.createElement('div', {
                style: { display: 'none' }
            }, 'Navigation temporarily disabled');
        };

        // AnalysisView Component - REMOVED for simplification
        // Navigation now goes directly from Home to Segment Foundation

        // SegmentFoundationTool Component
        const SegmentFoundationTool = ({ appState, setAppState, onNavigate, markPartAsCompleted }) => {
            console.log('SegmentFoundationTool rendering, appState:', appState);
            const [exportModalOpen, setExportModalOpen] = useState(false);
            const [exportContent, setExportContent] = useState('');
            const [exportData, setExportData] = useState(null);
            const [validationState, setValidationState] = useState({});
            
            // Import state variables
            const [importMessage, setImportMessage] = useState(null);
            const [importMessageType, setImportMessageType] = useState(''); // 'success', 'error', 'warning'
            
            // AI Draft State Variables
            const [aiDraftLoading, setAiDraftLoading] = useState(false);
            const [aiDraftsAvailable, setAiDraftsAvailable] = useState(false);
            const [aiDraftError, setAiDraftError] = useState(null);
            
            // WTP AI Draft State Variables
            const [wtpDraftLoading, setWtpDraftLoading] = useState(false);
            const [wtpDraftsAvailable, setWtpDraftsAvailable] = useState(false);
            const [wtpDraftError, setWtpDraftError] = useState(null);

            const handleValidateJtbd = async (jtbdElementName, userInput) => {
                // Check if company context is properly set up
                if (!appState.companyContext?.industry || !appState.companyContext?.productName) {
                    setValidationState(prev => ({ 
                        ...prev, 
                        [jtbdElementName]: { 
                            status: 'error', 
                            result: {
                                alignmentScore: 0,
                                marketLanguage: [],
                                refinementSuggestions: ['Please complete the Company Context setup first by clicking "Dev Tools: Reset Company Context" in the footer and filling out your company information.']
                            }
                        }
                    }));
                    return;
                }
                
                setValidationState(prev => ({ ...prev, [jtbdElementName]: { status: 'validating' } }));
                try {
                    const response = await fetch('/api/validate-jtbd?debug=true', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            companyContext: appState.companyContext,
                            jtbdElementName,
                            userInput
                        })
                    });
                    if (!response.ok) {
                        throw new Error('Validation failed');
                    }
                    const results = await response.json();
                    
                    // Log debug information to console
                    console.log(`🔍 VAL-FEAT-001 Debug: ${jtbdElementName}`, {
                        userInput: userInput,
                        queries: results.debug?.queries,
                        searchResults: {
                            snippetCount: results.debug?.searchResultsCount.snippets,
                            titleCount: results.debug?.searchResultsCount.titles,
                            sampleSnippets: results.debug?.sampleSnippets
                        },
                        analysis: {
                            alignmentScore: results.alignmentScore,
                            marketLanguage: results.marketLanguage,
                            suggestions: results.refinementSuggestions
                        }
                    });
                    
                    setValidationState(prev => ({ ...prev, [jtbdElementName]: { status: 'success', results } }));
                } catch (error) {
                    console.error(`❌ VAL-FEAT-001 Error: ${jtbdElementName}`, error);
                    setValidationState(prev => ({ ...prev, [jtbdElementName]: { status: 'error', error: error.message } }));
                }
            };

            const renderValidationResult = (elementName) => {
                const state = validationState[elementName];
                if (!state) return null;
                if (state.status === 'validating') {
                    return <div className="text-sm text-gray-500 italic mt-2">Validating...</div>;
                }
                if (state.status === 'error') {
                    const errorMessage = state.error || 'Validation service is unavailable. Please try again later.';
                    return <div className="text-sm text-red-500 mt-2">Error: {errorMessage}</div>;
                }
                if (state.status === 'success' && state.results) {
                    const { alignmentScore, marketLanguage, refinementSuggestions } = state.results;
                    return (
                        <div className="mt-2 p-3 bg-gray-50 border border-gray-200 rounded-md">
                            <h4 className="text-sm font-bold text-gray-700 mb-2">
                                Validation Results 
                                <span className="ml-2 text-xs text-blue-600 cursor-help" title="Check browser console for detailed analysis">
                                    (Debug: Check Console)
                                </span>
                            </h4>
                            <p className="text-sm text-gray-600"><strong>Alignment Score:</strong> {alignmentScore}%</p>
                            <p className="text-sm text-gray-600"><strong>Market Language:</strong> {marketLanguage.join(', ')}</p>
                            <div>
                                <p className="text-sm font-bold text-gray-700 mt-2">Suggestions:</p>
                                <ul className="list-disc list-inside text-sm text-gray-600">
                                    {refinementSuggestions.map((suggestion, index) => (
                                        <li key={index}>{suggestion}</li>
                                    ))}
                                </ul>
                            </div>
                        </div>
                    );
                }
                return null;
            };

            const handleReset = () => {
                if (window.confirm('Are you sure you want to reset all segment data? This action cannot be undone.')) {
                    setAppState(prev => ({ ...prev, segmentData: {} }));
                }
            };

            // Generate part-specific structured data for consistent exports
            const generatePartSpecificData = () => {
                const formatFieldValue = (fieldValue) => {
                    // Handle arrays (future dynamic content)
                    if (Array.isArray(fieldValue)) {
                        return fieldValue.filter(item => item && item.toString().trim()).join('; ');
                    }
                    // Handle objects (future complex data)
                    if (typeof fieldValue === 'object' && fieldValue !== null) {
                        return Object.entries(fieldValue)
                            .filter(([k, v]) => v && v.toString().trim())
                            .map(([k, v]) => `${k}: ${v}`)
                            .join('; ');
                    }
                    // Handle strings (current implementation)
                    return fieldValue && fieldValue.toString().trim() || null;
                };

                // Build company object excluding null values
                const companyData = {};
                const companyName = formatFieldValue(appState.companyContext?.companyName);
                const companyWebsite = formatFieldValue(appState.companyContext?.companyWebsite);
                const industry = formatFieldValue(appState.companyContext?.industry);
                const productName = formatFieldValue(appState.companyContext?.productName);
                const targetMarket = formatFieldValue(appState.companyContext?.targetMarket);
                
                if (companyName) companyData.name = companyName;
                if (companyWebsite) companyData.website = companyWebsite;
                if (industry) companyData.industry = industry;
                if (productName) companyData.productName = productName;
                if (targetMarket) companyData.targetMarket = targetMarket;

                return {
                    metadata: {
                        exportDate: new Date().toISOString(),
                        partName: "Segment Foundation",
                        partNumber: 1,
                        company: companyData
                    },
                    content: {
                        jobsToBeDone: {
                            "Context": formatFieldValue(appState.segmentData?.['Context']),
                            "Struggling Moments": formatFieldValue(appState.segmentData?.['Struggling Moments']),
                            "Pushes & Pulls": formatFieldValue(appState.segmentData?.['Pushes & Pulls']),
                            "Anxieties & Habits": formatFieldValue(appState.segmentData?.['Anxieties & Habits']),
                            "Desired Outcomes": formatFieldValue(appState.segmentData?.['Desired Outcomes']),
                            "Basic Quality (Table Stakes)": formatFieldValue(appState.segmentData?.['Basic Quality (Table Stakes)']),
                            "Hiring Criteria": formatFieldValue(appState.segmentData?.['Hiring Criteria']),
                            "Firing Criteria": formatFieldValue(appState.segmentData?.['Firing Criteria']),
                            "Key Trade-offs": formatFieldValue(appState.segmentData?.['Key Trade-offs'])
                        },
                        customerValue: {
                            "Table Stakes": formatFieldValue(appState.segmentData?.['Table Stakes']),
                            "Functional Value": formatFieldValue(appState.segmentData?.['Functional Value']),
                            "Ease of Doing Business": formatFieldValue(appState.segmentData?.['Ease of Doing Business']),
                            "Individual Value": formatFieldValue(appState.segmentData?.['Individual Value']),
                            "Aspirational Value": formatFieldValue(appState.segmentData?.['Aspirational Value'])
                        },
                        willingnessToPay: {
                            "Ability to Pay": formatFieldValue(appState.segmentData?.['Ability to Pay']),
                            "Economic Justification": formatFieldValue(appState.segmentData?.['Economic Justification']),
                            "Relative Value vs. Alternatives": formatFieldValue(appState.segmentData?.['Relative Value vs. Alternatives']),
                            "Risk & Switching Costs": formatFieldValue(appState.segmentData?.['Risk & Switching Costs']),
                            "Market Reference Points": formatFieldValue(appState.segmentData?.['Market Reference Points'])
                        }
                    }
                };
            };

            // Generate markdown from structured data
            const generateMarkdownFromData = (data) => {
                const { metadata, content } = data;
                
                let markdown = `# Segment Foundation Summary\n\n`;
                
                // Add company context header
                if (metadata.company.name || metadata.company.website) {
                    markdown += `**Export Date:** ${new Date(metadata.exportDate).toLocaleDateString()}\n`;
                    if (metadata.company.name) {
                        markdown += `**Company:** ${metadata.company.name}`;
                        if (metadata.company.website) markdown += ` (${metadata.company.website})`;
                        markdown += `\n`;
                    }
                    if (metadata.company.industry || metadata.company.productName || metadata.company.targetMarket) {
                        const companyDetails = [];
                        if (metadata.company.industry) companyDetails.push(`**Industry:** ${metadata.company.industry}`);
                        if (metadata.company.productName) companyDetails.push(`**Product:** ${metadata.company.productName}`);
                        if (metadata.company.targetMarket) companyDetails.push(`**Market:** ${metadata.company.targetMarket}`);
                        markdown += `${companyDetails.join(' | ')}\n`;
                    }
                    markdown += `\n`;
                }

                // Jobs to be Done section
                markdown += `## Jobs to be Done\n`;
                Object.entries(content.jobsToBeDone).forEach(([key, value]) => {
                    markdown += `**${key}:** ${value || 'Not provided'}\n\n`;
                });

                // Customer Value section
                markdown += `## Customer Value\n`;
                Object.entries(content.customerValue).forEach(([key, value]) => {
                    markdown += `**${key}:** ${value || 'Not provided'}\n\n`;
                });

                // Willingness to Pay section
                markdown += `## Willingness to Pay\n`;
                Object.entries(content.willingnessToPay).forEach(([key, value]) => {
                    markdown += `**${key}:** ${value || 'Not provided'}\n\n`;
                });

                return markdown;
            };
            
            const handleExport = () => {
                const partData = generatePartSpecificData();
                const markdownContent = generateMarkdownFromData(partData);
                
                setExportData(partData);
                setExportContent(markdownContent);
                setExportModalOpen(true);
            };
            
            // AI Customer Value Generation Handler
            const handleGenerateCustomerValue = async () => {
                setAiDraftLoading(true);
                setAiDraftError(null);
                
                try {
                    const jtbdFields = ['Context', 'Struggling Moments', 'Pushes & Pulls', 'Anxieties & Habits', 'Desired Outcomes', 'Basic Quality (Table Stakes)', 'Hiring Criteria', 'Firing Criteria', 'Key Trade-offs'];
                    const filledFields = jtbdFields.filter(field => appState.segmentData[field]?.trim());
                    
                    if (filledFields.length < 3) {
                        setAiDraftError('Please complete at least 3 Jobs-to-be-Done fields before using the AI assistant.');
                        setAiDraftLoading(false);
                        return;
                    }
                    
                    const response = await fetch('/api/draft-customer-value', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            jtbdData: appState.segmentData
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API call failed: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success && data.drafts) {
                        // Update segmentData with AI-generated drafts
                        setAppState(prev => ({
                            ...prev,
                            segmentData: {
                                ...prev.segmentData,
                                'Table Stakes': data.drafts['Table Stakes'],
                                'Functional Value': data.drafts['Functional Value'],
                                'Ease of Doing Business': data.drafts['Ease of Doing Business'],
                                'Individual Value': data.drafts['Individual Value'],
                                'Aspirational Value': data.drafts['Aspirational Value']
                            }
                        }));
                        
                        setAiDraftsAvailable(true);
                    } else {
                        throw new Error(data.error || 'AI generation failed');
                    }
                } catch (error) {
                    console.error('AI Customer Value Generation Error:', error);
                    setAiDraftError(error.message || 'AI assistant is currently unavailable. Please try again later.');
                }
                
                setAiDraftLoading(false);
            };
            
            // AI WTP Generation Handler
            const handleGenerateWTP = async () => {
                setWtpDraftLoading(true);
                setWtpDraftError(null);
                
                try {
                    const customerValueFields = ['Table Stakes', 'Functional Value', 'Ease of Doing Business', 'Individual Value', 'Aspirational Value'];
                    const hasCustomerValue = customerValueFields.some(field => appState.segmentData[field]?.trim());
                    
                    if (!hasCustomerValue) {
                        setWtpDraftError('Please complete the Customer Value section first before generating WTP drivers.');
                        setWtpDraftLoading(false);
                        return;
                    }
                    
                    const response = await fetch('/api/draft-wtp-value', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            jtbdData: appState.segmentData,
                            customerValueData: {
                                'Table Stakes': appState.segmentData['Table Stakes'],
                                'Functional Value': appState.segmentData['Functional Value'],
                                'Ease of Doing Business': appState.segmentData['Ease of Doing Business'],
                                'Individual Value': appState.segmentData['Individual Value'],
                                'Aspirational Value': appState.segmentData['Aspirational Value']
                            }
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API call failed: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success && data.drafts) {
                        // Update segmentData with AI-generated WTP drafts
                        setAppState(prev => ({
                            ...prev,
                            segmentData: {
                                ...prev.segmentData,
                                'Ability to Pay': data.drafts['Ability to Pay'],
                                'Economic Justification': data.drafts['Economic Justification'],
                                'Relative Value vs. Alternatives': data.drafts['Relative Value vs. Alternatives'],
                                'Risk': data.drafts['Risk'],
                                'Market Reference Points': data.drafts['Market Reference Points']
                            }
                        }));
                        
                        setWtpDraftsAvailable(true);
                    } else {
                        throw new Error(data.error || 'AI generation failed');
                    }
                } catch (error) {
                    console.error('AI WTP Generation Error:', error);
                    setWtpDraftError(error.message || 'AI assistant is currently unavailable. Please try again later.');
                }
                
                setWtpDraftLoading(false);
            };

            // Schema validation function for import data
            const validateImportData = (data) => {
                const errors = [];
                const warnings = [];

                // Check if data is an object
                if (!data || typeof data !== 'object') {
                    errors.push('Invalid file format. Expected JSON object.');
                    return { isValid: false, errors, warnings };
                }

                // Check required top-level structure
                if (!data.metadata || typeof data.metadata !== 'object') {
                    errors.push('Missing or invalid metadata section.');
                }

                if (!data.content || typeof data.content !== 'object') {
                    errors.push('Missing or invalid content section.');
                }

                if (errors.length > 0) {
                    return { isValid: false, errors, warnings };
                }

                // Validate metadata structure
                const { metadata } = data;
                if (!metadata.partName || metadata.partName !== 'Segment Foundation') {
                    const detectedType = metadata?.partName || 'Unknown';
                    errors.push(`Wrong data type: Found "${detectedType}" data, but expected "Segment Foundation" data. Please select a Segment Foundation export file.`);
                }

                if (!metadata.company || typeof metadata.company !== 'object') {
                    warnings.push('Company information is missing or invalid.');
                }

                // Validate content structure
                const { content } = data;
                const requiredSections = ['jobsToBeDone', 'customerValue', 'willingnessToPay'];
                const missingSections = requiredSections.filter(section => !content[section]);
                
                if (missingSections.length > 0) {
                    errors.push(`Missing required sections: ${missingSections.join(', ')}`);
                }

                // Validate individual sections exist
                const jtbdFields = [
                    'Context', 'Struggling Moments', 'Pushes & Pulls', 
                    'Anxieties & Habits', 'Desired Outcomes', 'Basic Quality (Table Stakes)',
                    'Hiring Criteria', 'Firing Criteria', 'Key Trade-offs'
                ];

                const customerValueFields = [
                    'Table Stakes', 'Functional Value', 'Ease of Doing Business',
                    'Individual Value', 'Aspirational Value'
                ];

                const wtpFields = [
                    'Ability to Pay', 'Economic Justification', 'Relative Value vs. Alternatives',
                    'Risk & Switching Costs', 'Market Reference Points'
                ];

                // Count populated fields for quality assessment
                const populatedJtbd = jtbdFields.filter(field => 
                    content.jobsToBeDone?.[field] && content.jobsToBeDone[field].trim()
                ).length;

                const populatedCustomerValue = customerValueFields.filter(field => 
                    content.customerValue?.[field] && content.customerValue[field].trim()
                ).length;

                const populatedWtp = wtpFields.filter(field => 
                    content.willingnessToPay?.[field] && content.willingnessToPay[field].trim()
                ).length;

                if (populatedJtbd < 3) {
                    warnings.push(`Only ${populatedJtbd} of ${jtbdFields.length} Jobs-to-be-Done fields are populated.`);
                }

                if (populatedCustomerValue < 2) {
                    warnings.push(`Only ${populatedCustomerValue} of ${customerValueFields.length} Customer Value fields are populated.`);
                }

                if (populatedWtp < 2) {
                    warnings.push(`Only ${populatedWtp} of ${wtpFields.length} Willingness to Pay fields are populated.`);
                }

                return { 
                    isValid: errors.length === 0, 
                    errors, 
                    warnings,
                    stats: {
                        populatedJtbd,
                        populatedCustomerValue,
                        populatedWtp,
                        totalFields: jtbdFields.length + customerValueFields.length + wtpFields.length
                    }
                };
            };

            // Import handler function
            const handleImport = () => {
                // Create a hidden file input element
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.json';
                fileInput.style.display = 'none';
                
                fileInput.onchange = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    // Clear any previous messages
                    setImportMessage(null);
                    setImportMessageType('');
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            
                            // Validate the imported data
                            const validation = validateImportData(importedData);
                            
                            if (!validation.isValid) {
                                setImportMessage(`Import failed: ${validation.errors.join('; ')}`);
                                setImportMessageType('error');
                                return;
                            }
                            
                            // Process the import
                            const { content, metadata } = importedData;
                            const { jobsToBeDone, customerValue, willingnessToPay } = content;
                            
                            // Create new segment data by merging imported data
                            const newSegmentData = { ...appState.segmentData };
                            
                            // Import Jobs-to-be-Done fields
                            if (jobsToBeDone) {
                                Object.keys(jobsToBeDone).forEach(field => {
                                    if (jobsToBeDone[field] && jobsToBeDone[field].trim()) {
                                        newSegmentData[field] = jobsToBeDone[field];
                                    }
                                });
                            }
                            
                            // Import Customer Value fields
                            if (customerValue) {
                                Object.keys(customerValue).forEach(field => {
                                    if (customerValue[field] && customerValue[field].trim()) {
                                        newSegmentData[field] = customerValue[field];
                                    }
                                });
                            }
                            
                            // Import Willingness to Pay fields
                            if (willingnessToPay) {
                                Object.keys(willingnessToPay).forEach(field => {
                                    if (willingnessToPay[field] && willingnessToPay[field].trim()) {
                                        newSegmentData[field] = willingnessToPay[field];
                                    }
                                });
                            }
                            
                            // Update app state with imported data
                            setAppState(prev => ({
                                ...prev,
                                segmentData: newSegmentData
                            }));
                            
                            // Show success message with statistics
                            const { stats, warnings } = validation;
                            let message = `Successfully imported ${stats.populatedJtbd + stats.populatedCustomerValue + stats.populatedWtp} fields from ${stats.totalFields} total fields.`;
                            
                            if (warnings.length > 0) {
                                message += ` Warnings: ${warnings.join('; ')}`;
                                setImportMessageType('warning');
                            } else {
                                setImportMessageType('success');
                            }
                            
                            setImportMessage(message);
                            
                            // Auto-clear message after 10 seconds
                            setTimeout(() => {
                                setImportMessage(null);
                                setImportMessageType('');
                            }, 10000);
                            
                        } catch (error) {
                            setImportMessage(`Failed to parse JSON file: ${error.message}`);
                            setImportMessageType('error');
                        }
                    };
                    
                    reader.onerror = () => {
                        setImportMessage('Failed to read file. Please try again.');
                        setImportMessageType('error');
                    };
                    
                    reader.readAsText(file);
                };
                
                // Trigger file selection
                document.body.appendChild(fileInput);
                fileInput.click();
                document.body.removeChild(fileInput);
            };
            
            return (
                <div className="container mx-auto px-4 sm:px-6 lg:px-8 min-h-screen pb-16">
                    {/* AI-Generated Banner */}
                    {appState.aiGeneratedSegment && !appState.aiGeneratedBannerDismissed && (
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 flex items-center justify-between">
                            <div className="flex items-center space-x-3">
                                <div className="flex-shrink-0">
                                    <svg className="w-5 h-5 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd"></path>
                                    </svg>
                                </div>
                                <div className="flex-1">
                                    <p className="text-sm font-medium text-blue-800">
                                        AI-Generated Draft
                                    </p>
                                    <p className="text-sm text-blue-600">
                                        This form has been pre-populated with AI-generated insights based on your company analysis. Review and edit as needed.
                                    </p>
                                </div>
                            </div>
                            <button
                                onClick={() => setAppState(prev => ({ ...prev, aiGeneratedBannerDismissed: true }))}
                                className="flex-shrink-0 ml-4 text-blue-400 hover:text-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-blue-50 rounded-md p-1"
                                aria-label="Dismiss banner"
                            >
                                <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                    )}
                    
                    <header style={{
                        position: 'sticky',
                        top: '73px',
                        zIndex: 40,
                        backgroundColor: 'white',
                        borderBottom: '1px solid #e5e7eb',
                        padding: '1rem 0',
                        boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)'
                    }}>
                        <div className="flex justify-between items-center">
                            <h1 className="text-xl sm:text-2xl font-bold scale-green-text">Part 1: Segment Foundation</h1>
                            {React.createElement(PrimaryActions, {
                                currentPart: 'segment',
                                onReset: handleReset,
                                onImport: handleImport,
                                onExport: handleExport,
                                onContinue: () => { 
                                    markPartAsCompleted('segment'); 
                                    onNavigate('icp'); 
                                    window.scrollTo(0, 0); 
                                }
                            })}
                        </div>
                    </header>

                    {/* Import Status Message */}
                    {importMessage && (
                        <div className={`mt-4 p-4 rounded-lg border ${
                            importMessageType === 'success' ? 'bg-green-50 border-green-200 text-green-800' :
                            importMessageType === 'warning' ? 'bg-yellow-50 border-yellow-200 text-yellow-800' :
                            'bg-red-50 border-red-200 text-red-800'
                        }`}>
                            <div className="flex items-center">
                                <div className="flex-shrink-0">
                                    {importMessageType === 'success' && (
                                        <svg className="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                                        </svg>
                                    )}
                                    {importMessageType === 'warning' && (
                                        <svg className="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                                        </svg>
                                    )}
                                    {importMessageType === 'error' && (
                                        <svg className="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                                        </svg>
                                    )}
                                </div>
                                <div className="ml-3 flex-1">
                                    <p className="text-sm font-medium">
                                        {importMessage}
                                    </p>
                                </div>
                                <div className="ml-4 flex-shrink-0">
                                    <button
                                        onClick={() => {
                                            setImportMessage(null);
                                            setImportMessageType('');
                                        }}
                                        className="text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 rounded-md p-1"
                                    >
                                        <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="mt-8">
                        <div className="lg:flex lg:space-x-8">
                            {/* Sticky Navigation Sidebar */}
                            <nav className="hidden lg:block w-64 flex-shrink-0 sticky top-36 h-fit">
                                <div className="bg-white p-6 rounded-lg shadow-md">
                                    <h3 className="text-lg font-semibold text-gray-800 mb-4">Section Navigation</h3>
                                    <ul className="space-y-3">
                                        <li>
                                            <a 
                                                href="#jtbd-section" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('jtbd-section').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                Jobs to be Done
                                            </a>
                                        </li>
                                        <li>
                                            <a 
                                                href="#value-section" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('value-section').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                Customer Value
                                            </a>
                                        </li>
                                        <li>
                                            <a 
                                                href="#wtp-section" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('wtp-section').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                Willingness to Pay
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </nav>
                            
                            <main className="flex-1 min-w-0">
                                <div className="space-y-8">
                                    {/* Market Segment Definition Header */}
                                    <div id="segment-definition-section" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                                        <div className="text-center mb-8">
                                            <p className="text-lg text-gray-700 mb-8 max-w-4xl mx-auto">
                                                A true market segment is composed of customers who share a common Job to be Done, 
                                                perceive value similarly, and have a similar Willingness to Pay.
                                            </p>
                                            
                                            {/* Custom SVG Funnel Diagram */}
                                            <div className="flex justify-center">
                                                <svg width="850" height="450" viewBox="0 0 850 450" className="max-w-full h-auto">
                                                    <defs>
                                                        <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                                                                refX="9" refY="3.5" orient="auto">
                                                            <polygon points="0 0, 10 3.5, 0 7" fill="#224f41"/>
                                                        </marker>
                                                    </defs>
                                                    
                                                    {/* Top of Funnel - Total Market */}
                                                    <rect x="50" y="20" width="300" height="60" fill="#e5ecea" stroke="#224f41" strokeWidth="2" rx="4"/>
                                                    <text x="200" y="55" textAnchor="middle" fill="#224f41" fontSize="16" fontWeight="600">
                                                        Total Market of Buyers
                                                    </text>
                                                    
                                                    {/* Arrow 1 */}
                                                    <line x1="200" y1="80" x2="200" y2="110" stroke="#224f41" strokeWidth="2" markerEnd="url(#arrowhead)"/>
                                                    
                                                    {/* Filter Gate 1 - Job to be Done */}
                                                    <rect x="80" y="115" width="240" height="50" fill="#7da399" stroke="#224f41" strokeWidth="2" rx="4"/>
                                                    <text x="200" y="135" textAnchor="middle" fill="white" fontSize="14" fontWeight="500">
                                                        Shared Job to be Done
                                                    </text>
                                                    <text x="200" y="150" textAnchor="middle" fill="white" fontSize="12">
                                                        (Common Context &amp; Struggling Moments)
                                                    </text>
                                                    
                                                    {/* Arrow 2 */}
                                                    <line x1="200" y1="165" x2="200" y2="195" stroke="#224f41" strokeWidth="2" markerEnd="url(#arrowhead)"/>
                                                    
                                                    {/* Filter Gate 2 - Perceived Value */}
                                                    <rect x="110" y="200" width="180" height="50" fill="#528577" stroke="#224f41" strokeWidth="2" rx="4"/>
                                                    <text x="200" y="220" textAnchor="middle" fill="white" fontSize="14" fontWeight="500">
                                                        Commonly Perceived Value
                                                    </text>
                                                    <text x="200" y="235" textAnchor="middle" fill="white" fontSize="12">
                                                        (Similar Value Priorities)
                                                    </text>
                                                    
                                                    {/* Arrow 3 */}
                                                    <line x1="200" y1="250" x2="200" y2="280" stroke="#224f41" strokeWidth="2" markerEnd="url(#arrowhead)"/>
                                                    
                                                    {/* Filter Gate 3 - Willingness to Pay */}
                                                    <rect x="140" y="285" width="120" height="50" fill="#224f41" stroke="#224f41" strokeWidth="2" rx="4"/>
                                                    <text x="200" y="305" textAnchor="middle" fill="white" fontSize="14" fontWeight="500">
                                                        Similar Willingness
                                                    </text>
                                                    <text x="200" y="320" textAnchor="middle" fill="white" fontSize="14" fontWeight="500">
                                                        to Pay
                                                    </text>
                                                    
                                                    {/* Arrow 4 */}
                                                    <line x1="200" y1="335" x2="200" y2="365" stroke="#224f41" strokeWidth="2" markerEnd="url(#arrowhead)"/>
                                                    
                                                    {/* Bottom of Funnel - True Market Segment */}
                                                    <rect x="160" y="370" width="80" height="60" fill="#e5a819" stroke="#224f41" strokeWidth="2" rx="4"/>
                                                    <text x="200" y="390" textAnchor="middle" fill="#224f41" fontSize="14" fontWeight="600">
                                                        A True
                                                    </text>
                                                    <text x="200" y="405" textAnchor="middle" fill="#224f41" fontSize="14" fontWeight="600">
                                                        Market
                                                    </text>
                                                    <text x="200" y="420" textAnchor="middle" fill="#224f41" fontSize="14" fontWeight="600">
                                                        Segment
                                                    </text>
                                                    
                                                    {/* Side Labels */}
                                                    <text x="30" y="225" textAnchor="middle" fill="#224f41" fontSize="12" transform="rotate(-90, 30, 225)">
                                                        Filtering Process
                                                    </text>
                                                    <text x="370" y="225" textAnchor="middle" fill="#224f41" fontSize="12" transform="rotate(90, 370, 225)">
                                                        Strategic Focus
                                                    </text>
                                                    
                                                    {/* Divider Line */}
                                                    <line x1="425" y1="50" x2="425" y2="400" stroke="#e5e7eb" strokeWidth="2" strokeDasharray="5,5"/>
                                                    
                                                    {/* Relationship Flow Title */}
                                                    <text x="625" y="40" textAnchor="middle" fill="#224f41" fontSize="18" fontWeight="600">
                                                        How the Components Relate
                                                    </text>
                                                    
                                                    {/* Box 1: Jobs to be Done */}
                                                    <rect x="450" y="120" width="110" height="120" fill="#7da399" stroke="#224f41" strokeWidth="2" rx="4"/>
                                                    <text x="505" y="145" textAnchor="middle" fill="white" fontSize="16" fontWeight="600">
                                                        (1)
                                                    </text>
                                                    <text x="505" y="170" textAnchor="middle" fill="white" fontSize="12" fontWeight="500">
                                                        Why the
                                                    </text>
                                                    <text x="505" y="185" textAnchor="middle" fill="white" fontSize="12" fontWeight="500">
                                                        customer is
                                                    </text>
                                                    <text x="505" y="200" textAnchor="middle" fill="white" fontSize="12" fontWeight="500">
                                                        motivated
                                                    </text>
                                                    <text x="505" y="220" textAnchor="middle" fill="white" fontSize="11" fontStyle="italic">
                                                        (Jobs to be Done)
                                                    </text>
                                                    
                                                    {/* Arrow 1 to 2 */}
                                                    <line x1="560" y1="180" x2="590" y2="180" stroke="#224f41" strokeWidth="3" markerEnd="url(#arrowhead)"/>
                                                    
                                                    {/* Box 2: Customer Value */}
                                                    <rect x="590" y="120" width="110" height="120" fill="#528577" stroke="#224f41" strokeWidth="2" rx="4"/>
                                                    <text x="645" y="145" textAnchor="middle" fill="white" fontSize="16" fontWeight="600">
                                                        (2)
                                                    </text>
                                                    <text x="645" y="170" textAnchor="middle" fill="white" fontSize="12" fontWeight="500">
                                                        How they
                                                    </text>
                                                    <text x="645" y="185" textAnchor="middle" fill="white" fontSize="12" fontWeight="500">
                                                        define
                                                    </text>
                                                    <text x="645" y="200" textAnchor="middle" fill="white" fontSize="12" fontWeight="500">
                                                        success
                                                    </text>
                                                    <text x="645" y="220" textAnchor="middle" fill="white" fontSize="11" fontStyle="italic">
                                                        (Customer Value)
                                                    </text>
                                                    
                                                    {/* Arrow 2 to 3 */}
                                                    <line x1="700" y1="180" x2="730" y2="180" stroke="#224f41" strokeWidth="3" markerEnd="url(#arrowhead)"/>
                                                    
                                                    {/* Box 3: Willingness to Pay */}
                                                    <rect x="730" y="120" width="110" height="120" fill="#224f41" stroke="#224f41" strokeWidth="2" rx="4"/>
                                                    <text x="785" y="145" textAnchor="middle" fill="white" fontSize="16" fontWeight="600">
                                                        (3)
                                                    </text>
                                                    <text x="785" y="165" textAnchor="middle" fill="white" fontSize="12" fontWeight="500">
                                                        How much
                                                    </text>
                                                    <text x="785" y="180" textAnchor="middle" fill="white" fontSize="12" fontWeight="500">
                                                        they will
                                                    </text>
                                                    <text x="785" y="195" textAnchor="middle" fill="white" fontSize="12" fontWeight="500">
                                                        invest &amp; why
                                                    </text>
                                                    <text x="785" y="215" textAnchor="middle" fill="white" fontSize="11" fontStyle="italic">
                                                        (Willingness
                                                    </text>
                                                    <text x="785" y="228" textAnchor="middle" fill="white" fontSize="11" fontStyle="italic">
                                                        to Pay)
                                                    </text>
                                                    
                                                    {/* Bottom explanation text */}
                                                    <text x="645" y="290" textAnchor="middle" fill="#224f41" fontSize="14" fontWeight="500">
                                                        Understanding Progression
                                                    </text>
                                                    <text x="645" y="310" textAnchor="middle" fill="#6b7280" fontSize="12">
                                                        Customer motivation drives what they value,
                                                    </text>
                                                    <text x="645" y="325" textAnchor="middle" fill="#6b7280" fontSize="12">
                                                        which determines their investment threshold
                                                    </text>
                                                </svg>
                                            </div>
                                            
                                            <p className="text-sm text-gray-600 mt-6 max-w-3xl mx-auto">
                                                The three input sections below help you define each filter criterion to identify your true market segment.
                                            </p>
                                        </div>
                                    </div>
                                    
                                    {/* Jobs To Be Done Section */}
                                    <div id="jtbd-section" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                                        <h2 className="text-2xl font-bold scale-green-text mb-6">Jobs To Be Done</h2>
                                        <div className="space-y-6">
                                            {[
                                                { name: 'Context', description: 'The business situation or operating environment.', placeholder: 'Quarterly close process across distributed finance teams.' },
                                                { name: 'Struggling Moments', description: 'Breakdowns, inefficiencies, or risks that trigger the search.', placeholder: 'Errors in revenue recognition delaying financial reporting.' },
                                                { name: 'Pushes & Pulls', description: 'Internal and external forces moving them toward or away from change.', placeholder: 'CFO pressure to modernize systems vs. IT reluctance to add new vendors.' },
                                                { name: 'Anxieties & Habits', description: 'Concerns about adopting something new, and inertia with current processes/tools.', placeholder: 'Fear of migration failure; comfort with spreadsheets.' },
                                                { name: 'Desired Outcomes', description: 'We will refine this outcome into specific types of value in the **Customer Value** section', placeholder: 'Reduce audit prep time by 50%; ensure SOX compliance.' },
                                                { name: 'Basic Quality (Table Stakes)', description: 'Minimum standards a solution must meet to even be considered.', placeholder: 'SOC2 compliance, API integrations with ERP, enterprise-grade security.' },
                                                { name: 'Hiring Criteria', description: 'Differentiators that make them select one vendor.', placeholder: 'Proven implementation playbook; reference customers in financial services.' },
                                                { name: 'Firing Criteria', description: 'Triggers that get a vendor rejected or replaced.', placeholder: 'System downtime; lack of role-based access control.' },
                                                { name: 'Key Trade-offs', description: 'Acceptable compromises or limits.', placeholder: 'May sacrifice customization for faster time to value.' }
                                            ].map(field => (
                                                <div key={field.name}>
                                                    <label className="block text-lg font-semibold text-gray-800 mb-2">{field.name}</label>
                                                    <p className="text-gray-600 text-sm mb-3">{field.description}</p>
                                                    <textarea
                                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                        rows="3"
                                                        value={appState.segmentData[field.name] || ''}
                                                        onChange={(e) => {
                                                            const newSegmentData = { ...appState.segmentData, [field.name]: e.target.value };
                                                            setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                        }}
                                                        placeholder={field.placeholder}
                                                    />
                                                    {/* Validate button removed for simplification */}
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Customer Value Section */}
                                    <div id="value-section" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                                        <h2 className="text-2xl font-bold scale-green-text mb-6">Customer Value</h2>
                                        
                                        <div className="space-y-6">
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Table Stakes</label>
                                                <p className="text-gray-600 text-sm mb-3">The non-negotiables for credibility and trust. Baseline requirements.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Table Stakes'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Table Stakes': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: SOC2 certification; ERP integration; 99.9% uptime SLAs."
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Functional Value</label>
                                                <p className="text-gray-600 text-sm mb-3">Tangible, measurable outcomes—ROI, efficiency, cost savings, growth, or risk mitigation.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Functional Value'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Functional Value': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: $500K OpEx savings from faster close cycles and fewer errors."
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Ease of Doing Business</label>
                                                <p className="text-gray-600 text-sm mb-3">How simple you make adoption and daily use. Less friction wins.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Ease of Doing Business'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Ease of Doing Business': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: Fast implementation playbook; role-based onboarding; 24/7 enterprise support."
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Individual Value</label>
                                                <p className="text-gray-600 text-sm mb-3">What matters to each buyer personally—status, workload relief, confidence, or career gains.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Individual Value'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Individual Value': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: CFO is seen as innovator; IT leader feels secure; end users save hours."
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Aspirational Value</label>
                                                <p className="text-gray-600 text-sm mb-3">Alignment with higher-order goals and purpose. Motivations beyond rational ROI.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Aspirational Value'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Aspirational Value': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: Supports ESG reporting; signals innovation to board and investors."
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    {/* Willingness to Pay Section */}
                                    <div id="wtp-section" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                                        <h2 className="text-2xl font-bold scale-green-text mb-6">Willingness to Pay</h2>
                                        
                                        <div className="space-y-6">
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Ability to Pay</label>
                                                <p className="text-gray-600 text-sm mb-3">Whether the customer has budget and capacity to spend. Even strong solutions fail without funding.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Ability to Pay'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Ability to Pay': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: Line item already approved in FY25 budget for compliance automation."
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Economic Justification</label>
                                                <p className="text-gray-600 text-sm mb-3">Whether the ROI and payback case makes financial sense. Customers want proof it pays for itself.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Economic Justification'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Economic Justification': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: Pays for itself in under 12 months through $1M annual cost avoidance."
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Relative Value vs. Alternatives</label>
                                                <p className="text-gray-600 text-sm mb-3">How your solution compares to competitors or the status quo. Clear differentiation increases willingness to pay.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Relative Value vs. Alternatives'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Relative Value vs. Alternatives': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: Automates 80% of manual work versus consultant-heavy models."
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Risk & Switching Costs</label>
                                                <p className="text-gray-600 text-sm mb-3">How much risk or friction they see in making the change. Higher risk lowers willingness; mitigation raises it.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Risk & Switching Costs'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Risk & Switching Costs': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: Migration takes days, not months; vendor assumes implementation risk."
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-lg font-semibold text-gray-800 mb-2">Market Reference Points</label>
                                                <p className="text-gray-600 text-sm mb-3">The pricing anchors customers bring from prior spend or competitors. Buyers benchmark against "similar" tools.</p>
                                                <textarea
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    rows="3"
                                                    value={appState.segmentData['Market Reference Points'] || ''}
                                                    onChange={(e) => {
                                                        const newSegmentData = { ...appState.segmentData, 'Market Reference Points': e.target.value };
                                                        setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                    }}
                                                    placeholder="Example: Analytics platforms in this space usually run $100K–$150K annually."
                                                />
                                            </div>
                                        </div>
                                        
                                        {/* Clear All Fields Button */}
                                        <div className="mt-8 text-center">
                                            <button
                                                onClick={() => {
                                                    // Clear all JTBD and Customer Value fields
                                                    const clearedSegmentData = {};
                                                    setAppState(prev => ({ ...prev, segmentData: clearedSegmentData }));
                                                    alert('All fields cleared! Refresh the page to see placeholder text.');
                                                }}
                                                className="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600 transition-colors mr-4"
                                            >
                                                Clear All Fields
                                            </button>
                                            
                                            {/* Continue to Part 2 Button */}
                                            <button
                                                onClick={() => { 
                                                    markPartAsCompleted('segment');
                                                    onNavigate('icp'); 
                                                    window.scrollTo(0, 0); 
                                                }}
                                                className="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition-colors"
                                            >
                                                Continue to Part 2: ICP Definition
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </main>
                        </div>
                    </div>

                    <ExportModal 
                        isOpen={exportModalOpen}
                        onClose={() => setExportModalOpen(false)}
                        title="Segment Foundation Summary"
                        content={exportContent}
                        appState={appState}
                        filename="segment-foundation-export"
                        partData={exportData}
                    />
                </div>
            );
        };

        // ICPFlowVisualization Component
        const ICPFlowVisualization = ({ appState, onNavigate }) => {
            const [hoveredSection, setHoveredSection] = useState(null);
            const [tooltipPosition, setTooltipPosition] = useState({ x: 0, y: 0 });
            
            // Check completion status for progressive states
            const isSegmentComplete = appState.segmentData && 
                Object.values(appState.segmentData).some(value => value && value.trim().length > 0);
            
            const isICPStarted = appState.positioningData && (
                appState.positioningData.icp_summary ||
                (appState.positioningData.values && appState.positioningData.values.some(v => v.val1))
            );
            
            const isICPComplete = appState.positioningData && 
                appState.positioningData.icp_summary && 
                appState.positioningData.values && 
                appState.positioningData.values.length > 0 &&
                appState.positioningData.values[0].val1;
            
            // Tooltip content for each section
            const tooltips = {
                segment: {
                    title: "Market Segment Foundation",
                    content: "Your foundational customer understanding from Part 1: Segment Foundation. This includes Jobs-to-be-Done, Customer Value propositions, and Willingness to Pay analysis.",
                    action: "Click to edit Segment Foundation"
                },
                bridge: {
                    title: "Strategic Bridge Analysis",
                    content: "The analytical work required to transform market segment insights into actionable ICP. This involves validating Product-Problem Fit and confirming your Scalable Business Model.",
                    action: "This represents your current analysis work"
                },
                strategic: {
                    title: "Strategic ICP - The 'Why'",
                    content: "The strategic reasoning behind your ICP focused on messaging and positioning. Includes the fundamental motivations, value drivers, and job-to-be-done insights.",
                    action: "Click to work on Strategic ICP elements"
                },
                operational: {
                    title: "Operational ICP - The 'Where'",
                    content: "The tactical targeting criteria for campaigns and sales. Includes firmographics, technographics, and behavioral signals for finding and reaching prospects.",
                    action: "Click to work on Operational ICP elements"
                }
            };
            
            // Handle mouse events for tooltips
            const handleMouseEnter = (section, event) => {
                setHoveredSection(section);
                const rect = event.currentTarget.getBoundingClientRect();
                setTooltipPosition({
                    x: rect.left + rect.width / 2,
                    y: rect.top - 10
                });
            };
            
            const handleMouseLeave = () => {
                setHoveredSection(null);
            };
            
            // Handle click navigation
            const handleSectionClick = (section) => {
                switch (section) {
                    case 'segment':
                        onNavigate('segment');
                        window.scrollTo(0, 0);
                        break;
                    case 'strategic':
                    case 'operational':
                        // Stay on current page but scroll to ICP definition
                        const icpSection = document.getElementById('section-1');
                        if (icpSection) {
                            icpSection.scrollIntoView({ behavior: 'smooth' });
                        }
                        break;
                    default:
                        break;
                }
            };
            
            return (
                <div className="mb-8 bg-white p-6 rounded-lg shadow-md">
                    <h3 className="text-lg font-bold text-gray-800 mb-4 text-center">Strategic Flow: From Market Segment to Actionable ICP</h3>
                    
                    {/* Desktop and Tablet Layout */}
                    <div className="hidden md:block">
                        <svg
                            viewBox="0 0 800 300"
                            className="w-full h-auto max-w-4xl mx-auto"
                            role="img"
                            aria-labelledby="icp-flow-title"
                            aria-describedby="icp-flow-desc"
                        >
                            <title id="icp-flow-title">Strategic ICP Development Flow</title>
                            <desc id="icp-flow-desc">Visual representation of the progression from market segment to actionable ICP through product and business model fit</desc>
                            
                            {/* Market Segment Box (Left) - Interactive */}
                            <g
                                onMouseEnter={(e) => handleMouseEnter('segment', e)}
                                onMouseLeave={handleMouseLeave}
                                onClick={() => handleSectionClick('segment')}
                                style={{ cursor: 'pointer' }}
                            >
                                <rect
                                    x="30"
                                    y="100"
                                    width="150"
                                    height="100"
                                    rx="8"
                                    fill={isSegmentComplete ? "#059669" : "#9CA3AF"}
                                    opacity={hoveredSection === 'segment' ? "0.8" : (isSegmentComplete ? "1" : "0.5")}
                                    stroke={hoveredSection === 'segment' ? "#047857" : "transparent"}
                                    strokeWidth="2"
                                />
                                <text x="105" y="125" textAnchor="middle" fill="white" fontSize="14" fontWeight="bold" fontFamily="Work Sans, sans-serif">Market Segment</text>
                                <text x="105" y="145" textAnchor="middle" fill="white" fontSize="12" fontFamily="Outfit, sans-serif">JTBD • Value • WTP</text>
                                <text x="105" y="165" textAnchor="middle" fill="white" fontSize="10" fontFamily="Outfit, sans-serif">Foundation Complete</text>
                                <text x="105" y="180" textAnchor="middle" fill="white" fontSize="10" fontFamily="Outfit, sans-serif">{isSegmentComplete ? "✓" : "○"}</text>
                                {hoveredSection === 'segment' && (
                                    <text x="105" y="195" textAnchor="middle" fill="white" fontSize="9" fontFamily="Outfit, sans-serif" fontStyle="italic">Click to edit</text>
                                )}
                            </g>
                            
                            {/* Bridge Arrow */}
                            <defs>
                                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                                    <polygon points="0 0, 10 3.5, 0 7" fill="#6B7280" />
                                </marker>
                            </defs>
                            
                            {/* Arrow Line */}
                            <line x1="180" y1="150" x2="380" y2="150" stroke="#6B7280" strokeWidth="3" markerEnd="url(#arrowhead)" />
                            
                            {/* Bridge Content Box - Interactive */}
                            <g
                                onMouseEnter={(e) => handleMouseEnter('bridge', e)}
                                onMouseLeave={handleMouseLeave}
                                style={{ cursor: 'help' }}
                            >
                                <rect 
                                    x="220" 
                                    y="60" 
                                    width="180" 
                                    height="80" 
                                    rx="6" 
                                    fill={hoveredSection === 'bridge' ? "#E5E7EB" : "#F3F4F6"} 
                                    stroke={hoveredSection === 'bridge' ? "#374151" : "#6B7280"} 
                                    strokeWidth="1" 
                                />
                                <text x="310" y="80" textAnchor="middle" fill="#374151" fontSize="12" fontWeight="bold" fontFamily="Work Sans, sans-serif">Add Product &amp; Business</text>
                                <text x="310" y="95" textAnchor="middle" fill="#374151" fontSize="12" fontWeight="bold" fontFamily="Work Sans, sans-serif">Model Fit</text>
                                <text x="310" y="115" textAnchor="middle" fill="#6B7280" fontSize="10" fontFamily="Outfit, sans-serif">Product-Problem Fit</text>
                                <text x="310" y="128" textAnchor="middle" fill="#6B7280" fontSize="10" fontFamily="Outfit, sans-serif">Scalable Business Model</text>
                            </g>
                            
                            {/* Actionable ICP Container (Right) */}
                            <rect x="420" y="50" width="350" height="200" rx="8" fill="#F9FAFB" stroke="#D1D5DB" strokeWidth="1" />
                            
                            {/* Header */}
                            <text x="595" y="75" textAnchor="middle" fill="#111827" fontSize="16" fontWeight="bold" fontFamily="Work Sans, sans-serif">Actionable ICP</text>
                            
                            {/* Strategic Why Section (Left Half) - Interactive */}
                            <g
                                onMouseEnter={(e) => handleMouseEnter('strategic', e)}
                                onMouseLeave={handleMouseLeave}
                                onClick={() => handleSectionClick('strategic')}
                                style={{ cursor: 'pointer' }}
                            >
                                <rect 
                                    x="440" 
                                    y="90" 
                                    width="155" 
                                    height="140" 
                                    rx="6" 
                                    fill={hoveredSection === 'strategic' ? "#BBF7D0" : "#DCFCE7"}
                                    stroke={hoveredSection === 'strategic' ? "#059669" : "#16A34A"} 
                                    strokeWidth={hoveredSection === 'strategic' ? "2" : "1"}
                                />
                                <text x="517.5" y="110" textAnchor="middle" fill="#166534" fontSize="12" fontWeight="bold" fontFamily="Work Sans, sans-serif">Strategic Why</text>
                                <text x="455" y="130" fill="#15803D" fontSize="10" fontFamily="Outfit, sans-serif">• Jobs to be Done</text>
                                <text x="455" y="145" fill="#15803D" fontSize="10" fontFamily="Outfit, sans-serif">• Value Drivers</text>
                                <text x="455" y="160" fill="#15803D" fontSize="10" fontFamily="Outfit, sans-serif">• Buyer Motivations</text>
                                <text x="517.5" y="185" textAnchor="middle" fill="#059669" fontSize="9" fontFamily="Outfit, sans-serif" fontStyle="italic">For messaging</text>
                                <text x="517.5" y="200" textAnchor="middle" fill="#059669" fontSize="9" fontFamily="Outfit, sans-serif" fontStyle="italic">&amp; positioning</text>
                                {hoveredSection === 'strategic' && (
                                    <text x="517.5" y="215" textAnchor="middle" fill="#059669" fontSize="8" fontFamily="Outfit, sans-serif" fontStyle="italic">Click to work on ICP</text>
                                )}
                            </g>
                            
                            {/* Operational Where Section (Right Half) - Interactive */}
                            <g
                                onMouseEnter={(e) => handleMouseEnter('operational', e)}
                                onMouseLeave={handleMouseLeave}
                                onClick={() => handleSectionClick('operational')}
                                style={{ cursor: 'pointer' }}
                            >
                                <rect 
                                    x="610" 
                                    y="90" 
                                    width="155" 
                                    height="140" 
                                    rx="6" 
                                    fill={hoveredSection === 'operational' ? "#FDE68A" : "#FEF3C7"}
                                    stroke={hoveredSection === 'operational' ? "#D97706" : "#F59E0B"} 
                                    strokeWidth={hoveredSection === 'operational' ? "2" : "1"}
                                />
                                <text x="687.5" y="110" textAnchor="middle" fill="#92400E" fontSize="12" fontWeight="bold" fontFamily="Work Sans, sans-serif">Operational Where</text>
                                <text x="625" y="130" fill="#A16207" fontSize="10" fontFamily="Outfit, sans-serif">• Firmographics</text>
                                <text x="625" y="145" fill="#A16207" fontSize="10" fontFamily="Outfit, sans-serif">• Technographics</text>
                                <text x="625" y="160" fill="#A16207" fontSize="10" fontFamily="Outfit, sans-serif">• Behavioral Signals</text>
                                <text x="687.5" y="185" textAnchor="middle" fill="#D97706" fontSize="9" fontFamily="Outfit, sans-serif" fontStyle="italic">For targeting</text>
                                <text x="687.5" y="200" textAnchor="middle" fill="#D97706" fontSize="9" fontFamily="Outfit, sans-serif" fontStyle="italic">&amp; campaigns</text>
                                {hoveredSection === 'operational' && (
                                    <text x="687.5" y="215" textAnchor="middle" fill="#D97706" fontSize="8" fontFamily="Outfit, sans-serif" fontStyle="italic">Click to work on ICP</text>
                                )}
                            </g>
                        </svg>
                    </div>
                    
                    {/* Mobile Layout */}
                    <div className="md:hidden space-y-6">
                        {/* Market Segment - Interactive */}
                        <div 
                            className={`p-4 rounded-lg text-center cursor-pointer transition-all duration-200 ${isSegmentComplete ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-gray-400 text-white opacity-50 hover:opacity-70'}`}
                            onClick={() => handleSectionClick('segment')}
                            onTouchStart={(e) => handleMouseEnter('segment', e)}
                            onTouchEnd={handleMouseLeave}
                        >
                            <h4 className="font-bold text-lg mb-1">Market Segment</h4>
                            <p className="text-sm">JTBD • Value • WTP</p>
                            <p className="text-xs mt-2">Foundation {isSegmentComplete ? '✓ Complete' : '○ Pending'}</p>
                            <p className="text-xs mt-1 italic">Tap to edit</p>
                        </div>
                        
                        {/* Arrow Down */}
                        <div className="text-center">
                            <div className="inline-block w-8 h-8 bg-gray-400 rounded-full flex items-center justify-center">
                                <span className="text-white font-bold">↓</span>
                            </div>
                        </div>
                        
                        {/* Bridge */}
                        <div className="bg-gray-100 border border-gray-300 p-4 rounded-lg text-center">
                            <h4 className="font-bold text-gray-800 mb-2">Add Product & Business Model Fit</h4>
                            <p className="text-sm text-gray-600">Product-Problem Fit</p>
                            <p className="text-sm text-gray-600">Scalable Business Model</p>
                        </div>
                        
                        {/* Arrow Down */}
                        <div className="text-center">
                            <div className="inline-block w-8 h-8 bg-gray-400 rounded-full flex items-center justify-center">
                                <span className="text-white font-bold">↓</span>
                            </div>
                        </div>
                        
                        {/* Actionable ICP */}
                        <div className="border border-gray-200 rounded-lg p-4">
                            <h4 className="font-bold text-gray-800 text-center mb-4">Actionable ICP</h4>
                            
                            {/* Strategic Why - Interactive */}
                            <div 
                                className="bg-green-50 border border-green-200 p-3 rounded-lg mb-3 cursor-pointer transition-all duration-200 hover:bg-green-100 hover:border-green-300"
                                onClick={() => handleSectionClick('strategic')}
                                onTouchStart={(e) => handleMouseEnter('strategic', e)}
                                onTouchEnd={handleMouseLeave}
                            >
                                <h5 className="font-bold text-green-700 text-center mb-2">Strategic Why</h5>
                                <ul className="text-sm text-green-600 space-y-1">
                                    <li>• Jobs to be Done</li>
                                    <li>• Value Drivers</li>
                                    <li>• Buyer Motivations</li>
                                </ul>
                                <p className="text-xs text-green-600 text-center mt-2 italic">For messaging & positioning</p>
                                <p className="text-xs text-green-500 text-center mt-1 italic">Tap to work on ICP</p>
                            </div>
                            
                            {/* Operational Where - Interactive */}
                            <div 
                                className="bg-yellow-50 border border-yellow-200 p-3 rounded-lg cursor-pointer transition-all duration-200 hover:bg-yellow-100 hover:border-yellow-300"
                                onClick={() => handleSectionClick('operational')}
                                onTouchStart={(e) => handleMouseEnter('operational', e)}
                                onTouchEnd={handleMouseLeave}
                            >
                                <h5 className="font-bold text-yellow-700 text-center mb-2">Operational Where</h5>
                                <ul className="text-sm text-yellow-600 space-y-1">
                                    <li>• Firmographics</li>
                                    <li>• Technographics</li>
                                    <li>• Behavioral Signals</li>
                                </ul>
                                <p className="text-xs text-yellow-600 text-center mt-2 italic">For targeting & campaigns</p>
                                <p className="text-xs text-yellow-500 text-center mt-1 italic">Tap to work on ICP</p>
                            </div>
                        </div>
                    </div>
                    
                    {/* Educational Context */}
                    <div className="mt-4 text-center">
                        <p className="text-sm text-gray-600 italic">
                            This visualization shows how your market segment analysis transforms into targeted ICP insights for both strategic messaging and operational execution.
                        </p>
                        <p className="text-xs text-gray-500 mt-2">
                            Hover over sections for more details • Click to navigate
                        </p>
                    </div>
                    
                    {/* Interactive Tooltip */}
                    {hoveredSection && tooltips[hoveredSection] && (
                        <div 
                            className="fixed z-50 bg-gray-900 text-white p-4 rounded-lg shadow-xl max-w-xs"
                            style={{
                                left: tooltipPosition.x - 150,
                                top: tooltipPosition.y - 120,
                                pointerEvents: 'none'
                            }}
                        >
                            <div className="text-sm font-semibold mb-2">{tooltips[hoveredSection].title}</div>
                            <div className="text-xs leading-relaxed mb-2">{tooltips[hoveredSection].content}</div>
                            <div className="text-xs text-gray-300 italic">{tooltips[hoveredSection].action}</div>
                            <div className="absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-full">
                                <div className="w-3 h-3 bg-gray-900 transform rotate-45"></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ICPDefinitionTool Component
        const ICPDefinitionTool = ({ appState, setAppState, onNavigate, markPartAsCompleted }) => {
            const [exportModal, setExportModal] = useState({ isOpen: false, content: '', title: '' });
            const [gradingState, setGradingState] = useState({});
            const [analysisState, setAnalysisState] = useState({});
            const [uniquenessResults, setUniquenessResults] = useState({});
            const [trendAnalysisResults, setTrendAnalysisResults] = useState({});
            
            // F-8: Pillar Generation Modal State
            const [pillarGenModalOpen, setPillarGenModalOpen] = useState(false);
            const [pillarGenState, setPillarGenState] = useState({
                isGenerating: false,
                suggestedPillars: [],
                error: null,
                refinementInputs: {}
            });
            
            // Import state variables
            const [importMessage, setImportMessage] = useState(null);
            const [importMessageType, setImportMessageType] = useState(''); // 'success', 'error', 'warning'
            
            // Simulate AI grading for value propositions
            const simulateAIGrading = async (proposition, index) => {
                const { val1, val2, val3 } = proposition;
                
                // Set loading state
                setGradingState(prev => ({
                    ...prev,
                    [index]: { isGrading: true, score: null, feedback: null }
                }));
                
                // Simulate network delay
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Analyze proposition quality
                let score = 'C';
                let feedback = [];
                
                // Check attribute quality
                if (!val1 || val1.length < 10) {
                    feedback.push('Attribute needs more specificity and detail');
                } else if (val1.includes('AI') || val1.includes('intelligent') || val1.includes('automated')) {
                    score = score < 'B' ? 'B' : score;
                    feedback.push('Good use of compelling technology terms');
                }
                
                // Check benefit quality
                if (!val2 || val2.length < 15) {
                    feedback.push('Benefit statement should explain customer impact more clearly');
                } else if (val2.includes('reduces') || val2.includes('increases') || val2.includes('enables')) {
                    score = score < 'B+' ? 'B+' : score;
                    feedback.push('Strong benefit articulation with clear outcomes');
                }
                
                // Check value quality
                if (!val3 || val3.length < 10) {
                    feedback.push('Value statement needs quantifiable outcomes or proof points');
                } else if (val3.match(/\$|%|months?|weeks?|days?|hours?|\d+/)) {
                    score = 'A-';
                    feedback.push('Excellent quantifiable value with specific metrics');
                }
                
                // Assign final score
                if (val1 && val2 && val3 && val1.length > 10 && val2.length > 15 && val3.length > 15) {
                    if (score === 'C') score = 'B';
                }
                
                // Create final feedback
                const finalFeedback = feedback.length > 0 
                    ? feedback.join('. ') + '.'
                    : 'Complete all three fields with more specific details for better grading.';
                
                // Update grading state with results
                setGradingState(prev => ({
                    ...prev,
                    [index]: {
                        isGrading: false,
                        score,
                        feedback: finalFeedback,
                        timestamp: new Date().toISOString()
                    }
                }));
            };

            // Analyze uniqueness using web search API
            const analyzeUniqueness = async (attributeText, index) => {
                if (!attributeText || !attributeText.trim()) {
                    return;
                }

                setUniquenessResults(prev => ({
                    ...prev,
                    [index]: { isAnalyzing: true, results: null }
                }));

                try {
                    const response = await fetch('/api/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            query: `"${attributeText.trim()}" software features capabilities`
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const searchData = await response.json();
                    
                    // Extract relevant results for display
                    const results = searchData.web?.results?.slice(0, 3).map(result => ({
                        title: result.title,
                        description: result.description || result.snippet || 'No description available',
                        url: result.url
                    })) || [];

                    setUniquenessResults(prev => ({
                        ...prev,
                        [index]: {
                            isAnalyzing: false,
                            results,
                            timestamp: new Date().toISOString()
                        }
                    }));

                } catch (error) {
                    console.error('Uniqueness analysis error:', error);
                    setUniquenessResults(prev => ({
                        ...prev,
                        [index]: {
                            isAnalyzing: false,
                            error: 'Analysis unavailable - please try again later',
                            timestamp: new Date().toISOString()
                        }
                    }));
                }
            };
            
            // Analyze trend validation using web search
            const analyzeTrend = async (trendText, index) => {
                if (!trendText || !trendText.trim()) {
                    return;
                }

                setTrendAnalysisResults(prev => ({
                    ...prev,
                    [index]: { isAnalyzing: true, results: null }
                }));

                try {
                    const response = await fetch('/api/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            query: `"${trendText.trim()}" market trend industry analysis`
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const searchData = await response.json();
                    
                    // Extract relevant results for display
                    const results = searchData.web?.results?.slice(0, 3).map(result => ({
                        title: result.title,
                        description: result.description || result.snippet || 'No description available',
                        url: result.url
                    })) || [];

                    setTrendAnalysisResults(prev => ({
                        ...prev,
                        [index]: {
                            isAnalyzing: false,
                            results,
                            timestamp: new Date().toISOString()
                        }
                    }));

                } catch (error) {
                    console.error('Trend analysis error:', error);
                    setTrendAnalysisResults(prev => ({
                        ...prev,
                        [index]: {
                            isAnalyzing: false,
                            error: 'No strong evidence found for this trend. Consider rephrasing.',
                            timestamp: new Date().toISOString()
                        }
                    }));
                }
            };

            // --- START OF REPLACEMENT CODE for generatePart2SpecificData ---
            const generatePart2SpecificData = () => {
                const formatFieldValue = (fieldValue) => {
                    if (!fieldValue) return null;
                    return fieldValue.toString().trim() || null;
                };

                const segmentSummary = {
                    desiredOutcomes: formatFieldValue(appState.segmentData?.['Desired Outcomes']),
                    functionalValue: formatFieldValue(appState.segmentData?.['Functional Value']),
                    economicJustification: formatFieldValue(appState.segmentData?.['Economic Justification']),
                    tableStakes: formatFieldValue(appState.segmentData?.['Table Stakes']),
                    easeOfDoingBusiness: formatFieldValue(appState.segmentData?.['Ease of Doing Business']),
                    businessContext: `Context: ${formatFieldValue(appState.segmentData?.['Context']) || 'N/A'}\nStruggling Moments: ${formatFieldValue(appState.segmentData?.['Struggling Moments']) || 'N/A'}`
                };

                const icpData = {
                    quickDecisionMaking: formatFieldValue(appState.positioningData?.icp_quick_decision_making),
                    prioritizedRequirements: formatFieldValue(appState.positioningData?.icp_prioritized_requirements),
                    implementationReadiness: formatFieldValue(appState.positioningData?.icp_implementation_readiness),
                    firmographic: formatFieldValue(appState.positioningData?.icp_firmographic),
                    technographic: formatFieldValue(appState.positioningData?.icp_technographic),
                    behavioral: formatFieldValue(appState.positioningData?.icp_behavioral)
                };

                return {
                    metadata: {
                        exportDate: new Date().toISOString(),
                        partName: "ICP Definition",
                        company: {
                            name: appState.companyContext?.companyName || null,
                            url: appState.companyContext?.companyWebsite || null,
                            industry: appState.companyContext?.industry || null
                        }
                    },
                    content: {
                        segmentFoundationSummary: segmentSummary,
                        icpDefinition: icpData
                    }
                };
            };
            // --- END OF REPLACEMENT CODE ---

            // --- START OF REPLACEMENT CODE for generatePart2Markdown ---
            const generatePart2Markdown = (partData) => {
                let markdown = `# ICP Definition Summary\n\n`;

                // Company context
                if (partData.metadata.company.name) {
                    markdown += `**Company:** ${partData.metadata.company.name}\n`;
                    if (partData.metadata.company.url) {
                        markdown += `**URL:** ${partData.metadata.company.url}\n`;
                    }
                    markdown += `\n`;
                }

                markdown += `---\n\n`;

                // Segment Foundation Summary
                markdown += `## Segment Foundation Summary\n\n`;
                const summary = partData.content.segmentFoundationSummary;
                if (summary) {
                    markdown += `**Desired Outcomes:** ${summary.desiredOutcomes || 'Not provided'}\n\n`;
                    markdown += `**Functional Value:** ${summary.functionalValue || 'Not provided'}\n\n`;
                    markdown += `**Economic Justification:** ${summary.economicJustification || 'Not provided'}\n\n`;
                    markdown += `**Table Stakes:** ${summary.tableStakes || 'Not provided'}\n\n`;
                    markdown += `**Ease of Doing Business:** ${summary.easeOfDoingBusiness || 'Not provided'}\n\n`;
                    markdown += `**Business Context:**\n${summary.businessContext || 'Not provided'}\n\n`;
                }

                markdown += `---\n\n`;

                // ICP Definition fields
                markdown += `## ICP Definition\n\n`;
                const icp = partData.content.icpDefinition;
                if (icp) {
                    markdown += `**Quick Decision Making:** ${icp.quickDecisionMaking || 'Not provided'}\n\n`;
                    markdown += `**Prioritized Requirements:** ${icp.prioritizedRequirements || 'Not provided'}\n\n`;
                    markdown += `**Implementation Readiness:** ${icp.implementationReadiness || 'Not provided'}\n\n`;
                    markdown += `**Firmographic:** ${icp.firmographic || 'Not provided'}\n\n`;
                    markdown += `**Technographic:** ${icp.technographic || 'Not provided'}\n\n`;
                    markdown += `**Behavioral:** ${icp.behavioral || 'Not provided'}\n\n`;
                }

                markdown += `*Export generated on ${new Date(partData.metadata.exportDate).toLocaleString()}*`;
                return markdown;
            };
            // --- END OF REPLACEMENT CODE ---

            const handleExport = () => {
                // Generate structured data for both formats
                const partData = generatePart2SpecificData();
                
                // Generate markdown from structured data  
                const markdownContent = generatePart2Markdown(partData);
                
                // Open modal with both markdown and JSON data (fixed title)
                setExportModal({ 
                    isOpen: true, 
                    content: markdownContent, 
                    title: 'ICP Definition Summary',
                    partData: partData,
                    filename: 'icp-definition-export'
                });
            };

            // Schema validation function for ICP import data
            const validateICPImportData = (data) => {
                const errors = [];
                const warnings = [];

                // Check if data is an object
                if (!data || typeof data !== 'object') {
                    errors.push('Invalid file format. Expected JSON object.');
                    return { isValid: false, errors, warnings };
                }

                // Check required top-level structure
                if (!data.metadata || typeof data.metadata !== 'object') {
                    errors.push('Missing or invalid metadata section.');
                }

                if (!data.content || typeof data.content !== 'object') {
                    errors.push('Missing or invalid content section.');
                }

                if (errors.length > 0) {
                    return { isValid: false, errors, warnings };
                }

                // Validate metadata structure
                const { metadata } = data;
                if (!metadata.partName || metadata.partName !== 'ICP Definition') {
                    const detectedType = metadata?.partName || 'Unknown';
                    errors.push(`Wrong data type: Found "${detectedType}" data, but expected "ICP Definition" data. Please select an ICP Definition export file.`);
                }

                if (!metadata.company || typeof metadata.company !== 'object') {
                    warnings.push('Company information is missing or invalid.');
                }

                // Validate content structure
                const { content } = data;
                if (!content.icpDefinition || typeof content.icpDefinition !== 'object') {
                    errors.push('Missing or invalid icpDefinition section.');
                    return { isValid: false, errors, warnings };
                }

                // Validate ICP fields
                const icpFields = [
                    'quickDecisionMaking', 'prioritizedRequirements', 'implementationReadiness',
                    'firmographic', 'technographic', 'behavioral'
                ];

                // Count populated fields for quality assessment
                const populatedFields = icpFields.filter(field => 
                    content.icpDefinition[field] && content.icpDefinition[field].trim()
                ).length;

                if (populatedFields < 3) {
                    warnings.push(`Only ${populatedFields} of ${icpFields.length} ICP fields are populated.`);
                }

                return { 
                    isValid: errors.length === 0, 
                    errors, 
                    warnings,
                    stats: {
                        populatedFields,
                        totalFields: icpFields.length
                    }
                };
            };

            // Import handler function for ICP
            const handleImportICP = () => {
                // Create a hidden file input element
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.json';
                fileInput.style.display = 'none';
                
                fileInput.onchange = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    // Clear any previous messages
                    setImportMessage(null);
                    setImportMessageType('');
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            
                            // Validate the imported data
                            const validation = validateICPImportData(importedData);
                            
                            if (!validation.isValid) {
                                setImportMessage(`Import failed: ${validation.errors.join('; ')}`);
                                setImportMessageType('error');
                                return;
                            }
                            
                            // Process the import
                            const { content } = importedData;
                            const { icpDefinition } = content;
                            
                            // Map imported fields to the state
                            const fieldMapping = {
                                quickDecisionMaking: 'icp_quick_decision_making',
                                prioritizedRequirements: 'icp_prioritized_requirements',
                                implementationReadiness: 'icp_implementation_readiness',
                                firmographic: 'icp_firmographic',
                                technographic: 'icp_technographic',
                                behavioral: 'icp_behavioral'
                            };

                            const updates = {};
                            Object.keys(fieldMapping).forEach(importField => {
                                if (icpDefinition[importField] && icpDefinition[importField].trim()) {
                                    const stateField = fieldMapping[importField];
                                    updates[stateField] = icpDefinition[importField];
                                }
                            });

                            // Explicitly update the state to ensure re-render
                            setAppState(prev => ({
                                ...prev,
                                positioningData: {
                                    ...prev.positioningData,
                                    ...updates
                                }
                            }));
                            
                            // Show success message with statistics
                            const { stats, warnings } = validation;
                            let message = `Successfully imported ${stats.populatedFields} fields from ${stats.totalFields} total ICP fields.`;
                            
                            if (warnings.length > 0) {
                                message += ` Warnings: ${warnings.join('; ')}`;
                                setImportMessageType('warning');
                            } else {
                                setImportMessageType('success');
                            }
                            
                            setImportMessage(message);
                            
                            // Auto-clear message after 10 seconds
                            setTimeout(() => {
                                setImportMessage(null);
                                setImportMessageType('');
                            }, 10000);
                            
                        } catch (error) {
                            setImportMessage(`Failed to parse JSON file: ${error.message}`);
                            setImportMessageType('error');
                        }
                    };
                    
                    reader.onerror = () => {
                        setImportMessage('Failed to read file. Please try again.');
                        setImportMessageType('error');
                    };
                    
                    reader.readAsText(file);
                };
                
                // Trigger file selection
                document.body.appendChild(fileInput);
                fileInput.click();
                document.body.removeChild(fileInput);
            };

            return (
                <div className="container mx-auto px-4 sm:px-6 lg:px-8 min-h-screen pb-16">
                    <header style={{
                        position: 'sticky',
                        top: '73px',
                        zIndex: 40,
                        backgroundColor: 'white',
                        borderBottom: '1px solid #e5e7eb',
                        padding: '1rem 0',
                        boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)'
                    }}>
                        <div className="flex justify-between items-center">
                            <h1 className="text-xl sm:text-2xl font-bold scale-green-text">Part 2: ICP Definition</h1>
                            {React.createElement(PrimaryActions, {
                                currentPart: 'icp',
                                onReset: () => {
                                    if (window.confirm("Are you sure you want to reset all data for Part 2? This will clear all ICP and Positioning fields.")) {
                                        setAppState(prev => ({
                                            ...prev,
                                            positioningData: getInitialState().positioningData
                                        }));
                                    }
                                },
                                onImport: handleImportICP,
                                onExport: handleExport,
                                onContinue: () => { 
                                    markPartAsCompleted('icp'); 
                                    onNavigate('positioning'); 
                                    window.scrollTo(0, 0); 
                                }
                            })}
                        </div>
                    </header>

                    {/* Import Status Message */}
                    {importMessage && (
                        <div className={`mt-4 p-4 rounded-lg border ${
                            importMessageType === 'success' ? 'bg-green-50 border-green-200 text-green-800' :
                            importMessageType === 'warning' ? 'bg-yellow-50 border-yellow-200 text-yellow-800' :
                            'bg-red-50 border-red-200 text-red-800'
                        }`}>
                            <div className="flex items-center">
                                <div className="flex-shrink-0">
                                    {importMessageType === 'success' && (
                                        <svg className="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                                        </svg>
                                    )}
                                    {importMessageType === 'warning' && (
                                        <svg className="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                                        </svg>
                                    )}
                                    {importMessageType === 'error' && (
                                        <svg className="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                                        </svg>
                                    )}
                                </div>
                                <div className="ml-3 flex-1">
                                    <p className="text-sm font-medium">
                                        {importMessage}
                                    </p>
                                </div>
                                <div className="ml-4 flex-shrink-0">
                                    <button
                                        onClick={() => {
                                            setImportMessage(null);
                                            setImportMessageType('');
                                        }}
                                        className="text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 rounded-md p-1"
                                    >
                                        <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="mt-8">
                        <div className="lg:flex lg:space-x-8">
                            <main className="w-full">
                                <div className="space-y-8">
                        
                        {/* ICP Flow Visualization */}
                        <ICPFlowVisualization appState={appState} onNavigate={onNavigate} />
                        
                        <div id="section-1" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                            <h2 className="text-2xl font-bold scale-green-text mb-2">Define Your Ideal Customer Profile (ICP)</h2>
                            <p className="text-gray-600 mb-6">This is the foundation. A precise ICP provides the lens through which all other positioning elements are viewed. Be specific and use data where possible.</p>
                            
                            {/* Segment Foundation Summary */}
                            <div className="mb-8 p-6 bg-green-50 border border-green-200 rounded-lg">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold scale-green-text">Segment Foundation Summary</h3>
                                    <button 
                                        onClick={() => onNavigate('segment')}
                                        className="text-sm text-green-600 hover:text-green-800 font-semibold flex items-center gap-1"
                                    >
                                        ← Edit Segment Foundation
                                    </button>
                                </div>
                                
                                {/* Check if segment data exists */}
                                {appState.segmentData && Object.keys(appState.segmentData).some(key => appState.segmentData[key]?.trim()) ? (
                                    <div className="space-y-4">
                                        {/* Jobs to be Done Summary */}
                                        {appState.segmentData['Desired Outcomes'] && (
                                            <div>
                                                <h4 className="font-semibold text-gray-700 mb-1">Desired Outcomes</h4>
                                                <p className="text-sm text-gray-600 bg-white p-3 rounded border">
                                                    {appState.segmentData['Desired Outcomes']}
                                                </p>
                                            </div>
                                        )}
                                        
                                        {/* Customer Value Summary */}
                                        <div className="grid md:grid-cols-2 gap-4">
                                            {appState.segmentData['Functional Value'] && (
                                                <div>
                                                    <h4 className="font-semibold text-gray-700 mb-1">Functional Value</h4>
                                                    <p className="text-sm text-gray-600 bg-white p-3 rounded border">
                                                        {appState.segmentData['Functional Value']}
                                                    </p>
                                                </div>
                                            )}
                                            
                                            {appState.segmentData['Economic Justification'] && (
                                                <div>
                                                    <h4 className="font-semibold text-gray-700 mb-1">Economic Justification</h4>
                                                    <p className="text-sm text-gray-600 bg-white p-3 rounded border">
                                                        {appState.segmentData['Economic Justification']}
                                                    </p>
                                                </div>
                                            )}
                                            
                                            {appState.segmentData['Table Stakes'] && (
                                                <div>
                                                    <h4 className="font-semibold text-gray-700 mb-1">Table Stakes</h4>
                                                    <p className="text-sm text-gray-600 bg-white p-3 rounded border">
                                                        {appState.segmentData['Table Stakes']}
                                                    </p>
                                                </div>
                                            )}
                                            
                                            {appState.segmentData['Ease of Doing Business'] && (
                                                <div>
                                                    <h4 className="font-semibold text-gray-700 mb-1">Ease of Doing Business</h4>
                                                    <p className="text-sm text-gray-600 bg-white p-3 rounded border">
                                                        {appState.segmentData['Ease of Doing Business']}
                                                    </p>
                                                </div>
                                            )}
                                        </div>
                                        
                                        {/* Additional context fields if available */}
                                        {(appState.segmentData['Context'] || appState.segmentData['Struggling Moments']) && (
                                            <div className="pt-4 border-t border-green-200">
                                                <h4 className="font-semibold text-gray-700 mb-2">Business Context</h4>
                                                <div className="space-y-2">
                                                    {appState.segmentData['Context'] && (
                                                        <p className="text-sm text-gray-600">
                                                            <span className="font-medium">Context:</span> {appState.segmentData['Context']}
                                                        </p>
                                                    )}
                                                    {appState.segmentData['Struggling Moments'] && (
                                                        <p className="text-sm text-gray-600">
                                                            <span className="font-medium">Struggling Moments:</span> {appState.segmentData['Struggling Moments']}
                                                        </p>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <div className="text-center py-8">
                                        <div className="text-gray-500 mb-3">
                                            <span className="text-2xl">📝</span>
                                        </div>
                                        <h4 className="font-semibold text-gray-700 mb-2">No Segment Data Yet</h4>
                                        <p className="text-sm text-gray-600 mb-4">
                                            Complete Part 1 (Segment Foundation) to see your market segment data here.
                                        </p>
                                        <button 
                                            onClick={() => onNavigate('segment')}
                                            className="scale-green-bg text-white font-semibold py-2 px-4 rounded-lg hover:bg-opacity-90"
                                        >
                                            Go to Part 1: Segment Foundation
                                        </button>
                                    </div>
                                )}
                            </div>
                            
                            <div className="space-y-6">
                                <div>
                                    <label className="block font-bold text-gray-700">Quick Decision Making</label>
                                    <p className="text-sm text-gray-500 mb-2">Who is the economic buyer and can they approve the purchase efficiently?</p>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="3" 
                                        placeholder="Example: The VP of Finance is the economic buyer. They have budget authority up to $250k for transformation projects and can sign off without a lengthy committee review."
                                        value={appState.positioningData.icp_quick_decision_making || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, icp_quick_decision_making: e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Prioritized Requirements</label>
                                    <p className="text-sm text-gray-500 mb-2">What do they value most in a solution for this problem?</p>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="3" 
                                        placeholder="Example: Speed-to-insight is #1. We cannot wait 6 months for consultants. #2 is accuracy; the data must be audit-grade. #3 is ease of use for our internal team."
                                        value={appState.positioningData.icp_prioritized_requirements || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, icp_prioritized_requirements: e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Implementation Readiness</label>
                                    <p className="text-sm text-gray-500 mb-2">Can they adopt and get value from the product today?</p>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="3" 
                                        placeholder="Example: They have a dedicated transformation team ready to start. All relevant contracts and process documents are digitized and accessible."
                                        value={appState.positioningData.icp_implementation_readiness || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, icp_implementation_readiness: e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Firmographic</label>
                                    <p className="text-sm text-gray-500 mb-2">What are the key company attributes (size, industry, revenue)?</p>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="3" 
                                        placeholder="Example: Publicly traded B2B SaaS company, >$1B in annual revenue, 2000+ employees. Headquartered in North America."
                                        value={appState.positioningData.icp_firmographic || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, icp_firmographic: e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Technographic</label>
                                    <p className="text-sm text-gray-500 mb-2">What is their current technology stack?</p>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="3" 
                                        placeholder="Example: Currently using NetSuite, Salesforce, and Coupa. Moving to Oracle Fusion. Internal BI uses Tableau."
                                        value={appState.positioningData.icp_technographic || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, icp_technographic: e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Behavioral</label>
                                    <p className="text-sm text-gray-500 mb-2">How do they act, buy, and use technology?</p>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="3" 
                                        placeholder="Example: They are early adopters of AI technology in their finance stack. They prefer to buy best-of-breed solutions over suite extensions. They have a history of successful, large-scale software implementations."
                                        value={appState.positioningData.icp_behavioral || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, icp_behavioral: e.target.value } }))}
                                    />
                                </div>
                            </div>
                        </div>


                        {/* Navigation Buttons */}
                        <div className="mt-8 text-center">
                            <button
                                onClick={() => {
                                    // Clear all ICP and Positioning fields
                                    setAppState(prev => ({
                                        ...prev,
                                        positioningData: getInitialState().positioningData
                                    }));
                                    alert('All fields cleared! Refresh the page to see placeholder text.');
                                }}
                                className="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600 transition-colors mr-4"
                            >
                                Clear All Fields
                            </button>
                            
                            {/* Continue to Part 3 Button */}
                            <button
                                onClick={() => { 
                                    markPartAsCompleted('icp');
                                    onNavigate('positioning'); 
                                    window.scrollTo(0, 0); 
                                }}
                                className="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition-colors"
                            >
                                Continue to Part 3: Positioning
                            </button>
                        </div>
                                </div>
                            </main>
                        </div>
                    </div>

                    <ExportModal 
                        isOpen={exportModal.isOpen}
                        onClose={() => setExportModal(prev => ({ ...prev, isOpen: false }))}
                        title={exportModal.title}
                        content={exportModal.content}
                        appState={appState}
                        filename={exportModal.filename || "icp-definition-export"}
                        partData={exportModal.partData}
                    />
                    
                </div>
            );
        };

        // Dynamic Field Components for PositioningTool
        const RemovableRow = ({ index, item, onUpdate, onRemove, placeholder1, placeholder2 }) => (
            <div className="space-y-3">
                <div className="flex items-center space-x-2">
                    <input 
                        type="text" 
                        className="w-1/2 p-2 border border-gray-300 rounded-md focus-ring-gold"
                        placeholder={placeholder1}
                        value={item.val1}
                        onChange={(e) => onUpdate(index, 'val1', e.target.value)}
                    />
                    <textarea 
                        className="w-1/2 p-2 border border-gray-300 rounded-md focus-ring-gold"
                        rows="3" 
                        placeholder={placeholder2}
                        value={item.val2}
                        onChange={(e) => onUpdate(index, 'val2', e.target.value)}
                    ></textarea>
                    <div className="flex flex-col space-y-2">
                        <button 
                            onClick={() => onRemove(index)}
                            className="text-gray-400 hover:text-red-600 font-bold text-2xl transition-colors"
                        >
                            ×
                        </button>
                    </div>
                </div>
                
            </div>
        );

        const RemovableInput = ({ index, item, onUpdate, onRemove, placeholder }) => (
            <div className="flex items-center space-x-2">
                <input 
                    type="text" 
                    className="w-full p-2 border border-gray-300 rounded-md focus-ring-gold"
                    placeholder={placeholder}
                    value={item.value}
                    onChange={(e) => onUpdate(index, 'value', e.target.value)}
                />
                <button 
                    onClick={() => onRemove(index)}
                    className="text-gray-400 hover:text-red-600 font-bold text-2xl transition-colors"
                >
                    ×
                </button>
            </div>
        );

        const RemovableTriple = ({ index, item, onUpdate, onRemove }) => (
            <div className="p-4 border border-gray-200 rounded-lg space-y-3 bg-gray-50">
                <div className="flex items-start space-x-2">
                    <div className="flex-grow">
                        <label className="block text-sm font-semibold text-gray-700 mb-1">
                            Truly Unique Attribute Name (&lt; 5 word name for the Feature or Capability):
                        </label>
                        <input 
                            type="text" 
                            className="w-full p-2 border border-gray-300 rounded-md focus-ring-gold"
                            placeholder="Example: Real-time collaborative analytics"
                            value={item.val1}
                            onChange={(e) => onUpdate(index, 'val1', e.target.value)}
                        />
                    </div>
                    <button 
                        onClick={() => onRemove(index)}
                        className="mt-6 text-gray-400 hover:text-red-600 font-bold text-2xl transition-colors"
                    >
                        ×
                    </button>
                </div>
                <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-1">
                        Attribute Description: (10+ word description highlighting the differentiation)
                    </label>
                    <textarea 
                        className="w-full p-2 border border-gray-300 rounded-md focus-ring-gold"
                        rows="3" 
                        placeholder="Example: Industry's only platform enabling simultaneous multi-user data exploration with instant synchronization across all dashboards"
                        value={item.val2}
                        onChange={(e) => onUpdate(index, 'val2', e.target.value)}
                    ></textarea>
                </div>
                <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-1">
                        Benefit: What the attribute enables for a customer
                    </label>
                    <textarea 
                        className="w-full p-2 border border-gray-300 rounded-md focus-ring-gold"
                        rows="2" 
                        placeholder="Example: Enables teams to make data-driven decisions together in real-time, eliminating version control issues and reducing meeting cycles"
                        value={item.val3}
                        onChange={(e) => onUpdate(index, 'val3', e.target.value)}
                    ></textarea>
                </div>
                <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-1">
                        Value: The metrics and KPIs the customer use to measure value created by this attribute
                    </label>
                    <textarea 
                        className="w-full p-2 border border-gray-300 rounded-md focus-ring-gold"
                        rows="2" 
                        placeholder="Example: 50% reduction in decision-making time, 3x faster insight discovery, $2M annual savings from eliminated redundant analysis"
                        value={item.val4}
                        onChange={(e) => onUpdate(index, 'val4', e.target.value)}
                    ></textarea>
                </div>
            </div>
        );

        // PositioningTool Component
        const PositioningTool = ({ appState, setAppState, onNavigate, markPartAsCompleted }) => {
            const [exportModal, setExportModal] = useState({ isOpen: false, content: '', title: '' });
            const [trendAnalysisResults, setTrendAnalysisResults] = useState({});
            const [pillarGenState, setPillarGenState] = useState({
                isGenerating: false,
                suggestedPillars: [],
                error: null,
                refinementInputs: {}
            });
            const [pillarGenModalOpen, setPillarGenModalOpen] = useState(false);
            const [importMessage, setImportMessage] = useState(null);
            const [importMessageType, setImportMessageType] = useState('');

            // Helper functions for nested data management
            const updateNestedValue = (section, index, key, value) => {
                const newData = { ...appState.positioningData };
                if (!newData[section]) newData[section] = [];
                if (!newData[section][index]) newData[section][index] = {};
                newData[section][index][key] = value;
                setAppState(prev => ({ ...prev, positioningData: newData }));
            };

            const addItem = (section, template) => {
                const newData = { ...appState.positioningData };
                if (!newData[section]) newData[section] = [];
                newData[section].push(template);
                setAppState(prev => ({ ...prev, positioningData: newData }));
            };

            const removeItem = (section, index) => {
                const newData = { ...appState.positioningData };
                if (newData[section]) {
                    newData[section].splice(index, 1);
                    setAppState(prev => ({ ...prev, positioningData: newData }));
                    // Clear grading state for removed item
                    setGradingState(prev => {
                        const newState = { ...prev };
                        delete newState[index];
                        return newState;
                    });
                }
            };

            // Simulate AI grading for value propositions
            const simulateAIGrading = async (proposition, index) => {
                const { val1, val2, val3 } = proposition;
                
                // Set loading state
                setGradingState(prev => ({
                    ...prev,
                    [index]: { isGrading: true, score: null, feedback: null }
                }));
                
                // Simulate network delay
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Analyze proposition quality
                let score = 'C';
                let feedback = [];
                
                // Check attribute quality
                if (!val1 || val1.length < 10) {
                    feedback.push('Attribute needs more specificity and detail');
                } else if (val1.includes('AI') || val1.includes('intelligent') || val1.includes('automated')) {
                    score = score < 'B' ? 'B' : score;
                    feedback.push('Good use of compelling technology terms');
                }
                
                // Check benefit quality
                if (!val2 || val2.length < 15) {
                    feedback.push('Benefit statement should explain customer impact more clearly');
                } else if (val2.includes('reduces') || val2.includes('increases') || val2.includes('enables')) {
                    score = score < 'B+' ? 'B+' : score;
                    feedback.push('Strong benefit articulation with clear outcomes');
                }
                
                // Check value quality
                if (!val3 || val3.length < 10) {
                    feedback.push('Value statement needs quantifiable outcomes or proof points');
                } else if (val3.match(/\$|%|months?|weeks?|days?|hours?|\d+/)) {
                    score = 'A-';
                    feedback.push('Excellent quantifiable value with specific metrics');
                }
                
                // Assign final score
                if (val1 && val2 && val3 && val1.length > 10 && val2.length > 15 && val3.length > 15) {
                    if (score === 'C') score = 'B';
                }
                
                // Create final feedback
                const finalFeedback = feedback.length > 0 
                    ? feedback.join('. ') + '.'
                    : 'Complete all three fields with more specific details for better grading.';
                
                // Update grading state with results
                setGradingState(prev => ({
                    ...prev,
                    [index]: {
                        isGrading: false,
                        score,
                        feedback: finalFeedback,
                        timestamp: new Date().toISOString()
                    }
                }));
            };

            // Analyze uniqueness using web search API
            const analyzeUniqueness = async (attributeText, index) => {
                if (!attributeText || !attributeText.trim()) {
                    return;
                }

                setUniquenessResults(prev => ({
                    ...prev,
                    [index]: { isAnalyzing: true, results: null }
                }));

                try {
                    const response = await fetch('/api/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            query: `"${attributeText.trim()}" software features capabilities`
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const searchData = await response.json();
                    
                    // Extract relevant results for display
                    const results = searchData.web?.results?.slice(0, 3).map(result => ({
                        title: result.title,
                        description: result.description || result.snippet || 'No description available',
                        url: result.url
                    })) || [];

                    setUniquenessResults(prev => ({
                        ...prev,
                        [index]: {
                            isAnalyzing: false,
                            results,
                            timestamp: new Date().toISOString()
                        }
                    }));

                } catch (error) {
                    console.error('Uniqueness analysis error:', error);
                    setUniquenessResults(prev => ({
                        ...prev,
                        [index]: {
                            isAnalyzing: false,
                            error: 'Analysis unavailable - please try again later',
                            timestamp: new Date().toISOString()
                        }
                    }));
                }
            };

            // Validate imported Part 3 positioning data
            const validatePositioningImportData = (data) => {
                console.log('DEBUG: validatePositioningImportData called with data:', data);
                const errors = [];

                // Validate basic structure
                if (!data || typeof data !== 'object') {
                    errors.push('Invalid file structure - expected JSON object');
                    console.log('DEBUG: Positioning validation - Invalid JSON structure');
                    return { isValid: false, errors };
                }

                // Validate metadata
                if (!data.metadata || typeof data.metadata !== 'object') {
                    errors.push('Missing or invalid metadata section');
                    console.log('DEBUG: Positioning validation - Missing metadata');
                } else {
                    console.log('DEBUG: Positioning validation - Checking partName:', data.metadata.partName);
                    if (!data.metadata.partName || data.metadata.partName !== 'Positioning') {
                        const detectedType = data.metadata?.partName || 'Unknown';
                        console.log('DEBUG: Positioning validation - Wrong partName. Expected: Positioning, Got:', detectedType);
                        errors.push(`Wrong data type: Found "${detectedType}" data, but expected "Positioning" data. Please select a Positioning export file.`);
                    }
                    if (!data.metadata.exportDate) {
                        errors.push('Missing export date in metadata');
                    }
                }

                // Validate content structure
                if (!data.content || typeof data.content !== 'object') {
                    errors.push('Missing or invalid content section');
                    return { isValid: false, errors };
                }

                const { content } = data;

                // Validate competitiveAlternatives
                if (content.competitiveAlternatives !== undefined) {
                    if (!Array.isArray(content.competitiveAlternatives)) {
                        errors.push('competitiveAlternatives must be an array');
                    } else {
                        content.competitiveAlternatives.forEach((alt, index) => {
                            if (typeof alt !== 'object' || alt === null) {
                                errors.push(`competitiveAlternatives[${index}] must be an object`);
                            } else {
                                if (!alt.hasOwnProperty('alternative') || !alt.hasOwnProperty('description')) {
                                    errors.push(`competitiveAlternatives[${index}] must have 'alternative' and 'description' fields`);
                                }
                            }
                        });
                    }
                }

                // Validate uniqueValueAndProof
                if (content.uniqueValueAndProof !== undefined) {
                    if (!Array.isArray(content.uniqueValueAndProof)) {
                        errors.push('uniqueValueAndProof must be an array');
                    } else {
                        content.uniqueValueAndProof.forEach((val, index) => {
                            if (typeof val !== 'object' || val === null) {
                                errors.push(`uniqueValueAndProof[${index}] must be an object`);
                            } else {
                                // --- START of replacement for the 'if' condition in the uniqueValueAndProof validation loop ---
                                if (!val.hasOwnProperty('attributeName') || !val.hasOwnProperty('attributeDescription') || !val.hasOwnProperty('benefit') || !val.hasOwnProperty('value')) {
                                    errors.push(`uniqueValueAndProof[${index}] must have 'attributeName', 'attributeDescription', 'benefit', and 'value' fields`);
                                }
                                // --- END of replacement ---
                            }
                        });
                    }
                }

                // Validate marketCategory (optional string)
                if (content.marketCategory !== undefined && typeof content.marketCategory !== 'string') {
                    errors.push('marketCategory must be a string');
                }

                // Validate categoryName (optional string)
                if (content.categoryName !== undefined && typeof content.categoryName !== 'string') {
                    errors.push('categoryName must be a string');
                }

                // Validate relevantTrends
                if (content.relevantTrends !== undefined) {
                    if (typeof content.relevantTrends !== 'object' || content.relevantTrends === null || Array.isArray(content.relevantTrends)) {
                        errors.push('relevantTrends must be an object');
                    } else {
                        // Validate trend fields
                        const validTrendKeys = ['trend1', 'trend2', 'trend3', 'trend4'];
                        Object.keys(content.relevantTrends).forEach(key => {
                            if (!validTrendKeys.includes(key)) {
                                errors.push(`Invalid trend key: ${key}. Valid keys are: ${validTrendKeys.join(', ')}`);
                            }
                            if (typeof content.relevantTrends[key] !== 'string') {
                                errors.push(`${key} must be a string`);
                            }
                        });
                    }
                }

                return {
                    isValid: errors.length === 0,
                    errors
                };
            };

            // Handle import of Part 3 positioning data
            const handleImportPositioning = () => {
                console.log('DEBUG: handleImportPositioning called for Part 3');
                // Create a hidden file input element
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.json';
                fileInput.style.display = 'none';
                
                fileInput.onchange = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    console.log('DEBUG: File selected for Part 3 import:', file.name);
                    
                    // Clear any previous messages
                    setImportMessage(null);
                    setImportMessageType('');
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            console.log('DEBUG: Part 3 - Parsed JSON data:', importedData);
                            console.log('DEBUG: Part 3 - Detected partName:', importedData?.metadata?.partName);
                            
                            // Validate the imported data
                            console.log('DEBUG: Part 3 - Calling validatePositioningImportData');
                            const validation = validatePositioningImportData(importedData);
                            
                            if (!validation.isValid) {
                                setImportMessage(`Import failed: ${validation.errors.join('; ')}`);
                                setImportMessageType('error');
                                return;
                            }
                            
                            // Process the import - perform reverse transformation
                            const { content } = importedData;
                            const updates = {};
                            
                            // Transform competitive alternatives: {alternative, description} → {val1, val2}
                            if (content.competitiveAlternatives && Array.isArray(content.competitiveAlternatives)) {
                                updates.alternatives = content.competitiveAlternatives.map(alt => ({
                                    val1: alt.alternative || '',
                                    val2: alt.description || ''
                                }));
                            }
                            
                            // --- START of replacement for the uniqueValueAndProof transformation ---
                            if (content.uniqueValueAndProof && Array.isArray(content.uniqueValueAndProof)) {
                                updates.values = content.uniqueValueAndProof.map(val => ({
                                    val1: val.attributeName || '',
                                    val2: val.attributeDescription || '',
                                    val3: val.benefit || '',
                                    val4: val.value || ''
                                }));
                            }
                            // --- END of replacement ---
                            
                            // Map market category
                            if (content.marketCategory && content.marketCategory.trim()) {
                                updates['market-context'] = content.marketCategory;
                            }
                            
                            // Map category name
                            if (content.categoryName && content.categoryName.trim()) {
                                updates['category-name'] = content.categoryName;
                            }
                            
                            // Transform trends: {trend1, trend2, ...} → trend1_desc, trend2_desc, ...
                            if (content.relevantTrends && typeof content.relevantTrends === 'object') {
                                Object.entries(content.relevantTrends).forEach(([key, value]) => {
                                    if (value && value.trim()) {
                                        updates[`${key}_desc`] = value;
                                    }
                                });
                            }
                            
                            // Apply updates using immutable pattern, preserving existing ICP fields
                            setAppState(prev => ({
                                ...prev,
                                positioningData: {
                                    ...prev.positioningData,
                                    ...updates
                                }
                            }));
                            
                            setImportMessage('Part 3 positioning data imported successfully!');
                            setImportMessageType('success');
                            
                        } catch (error) {
                            setImportMessage(`Import failed: Invalid JSON file format - ${error.message}`);
                            setImportMessageType('error');
                        }
                    };
                    
                    reader.readAsText(file);
                };
                
                // Trigger file selection
                document.body.appendChild(fileInput);
                fileInput.click();
                document.body.removeChild(fileInput);
            };

            // Generate Part 3 specific data for dual-format export
            const generatePart3SpecificData = () => {
                const exportDate = new Date().toISOString();
                
                // Utility to format field values with future-proofing
                const formatFieldValue = (fieldValue) => {
                    if (Array.isArray(fieldValue)) {
                        return fieldValue.filter(item => item && item.toString().trim()).join('; ');
                    }
                    return fieldValue && fieldValue.toString().trim() || null;
                };

                // Generate focused ICP summary for Target Market Characteristics
                const generateTargetMarketIcpSummary = () => {
                    if (!appState.segmentData?.icpDefinition) return null;
                    
                    const icp = appState.segmentData.icpDefinition;
                    const characteristics = {};
                    
                    if (icp.firmographic) {
                        characteristics.firmographic = formatFieldValue(icp.firmographic);
                    }
                    if (icp.technographic) {
                        characteristics.technographic = formatFieldValue(icp.technographic);
                    }
                    if (icp.behavioral) {
                        characteristics.behavioral = formatFieldValue(icp.behavioral);
                    }
                    if (icp.quickDecisionMaking) {
                        characteristics.decisionMaking = formatFieldValue(icp.quickDecisionMaking);
                    }
                    if (icp.prioritizedRequirements) {
                        characteristics.keyRequirements = formatFieldValue(icp.prioritizedRequirements);
                    }
                    
                    return Object.keys(characteristics).length > 0 ? characteristics : null;
                };

                // Format competitive alternatives
                const formatCompetitiveAlternatives = () => {
                    if (!appState.positioningData.alternatives || !Array.isArray(appState.positioningData.alternatives)) {
                        return [{ alternative: null, description: null }];
                    }
                    
                    return appState.positioningData.alternatives.map(alt => ({
                        alternative: formatFieldValue(alt.val1),
                        description: formatFieldValue(alt.val2)
                    }));
                };

                // Format unique value and proof
                const formatUniqueValueAndProof = () => {
                    if (!appState.positioningData.values || !Array.isArray(appState.positioningData.values)) {
                        return [{ attribute: null, benefit: null, value: null }];
                    }
                    
                    // --- START of replacement for formatUniqueValueAndProof return statement ---
                    return appState.positioningData.values.map(val => ({
                        attributeName: formatFieldValue(val.val1),
                        attributeDescription: formatFieldValue(val.val2),
                        benefit: formatFieldValue(val.val3),
                        value: formatFieldValue(val.val4)
                    }));
                    // --- END of replacement ---
                };

                // Get market category
                const getMarketCategory = () => {
                    if (appState.positioningData['market-context'] === 'Other') {
                        return formatFieldValue(appState.positioningData['market-context-other']);
                    }
                    return formatFieldValue(appState.positioningData['market-context']);
                };

                // Format relevant trends
                const formatRelevantTrends = () => {
                    return {
                        trend1: formatFieldValue(appState.positioningData.trend1_desc),
                        trend2: formatFieldValue(appState.positioningData.trend2_desc),
                        trend3: formatFieldValue(appState.positioningData.trend3_desc),
                        trend4: formatFieldValue(appState.positioningData.trend4_desc)
                    };
                };

                return {
                    metadata: {
                        exportDate: exportDate,
                        partName: "Positioning",
                        company: {
                            name: formatFieldValue(appState.companyData?.name),
                            url: formatFieldValue(appState.companyData?.url),
                            productName: formatFieldValue(appState.companyData?.productName),
                            industry: formatFieldValue(appState.companyData?.industry)
                        }
                    },
                    content: {
                        competitiveAlternatives: formatCompetitiveAlternatives(),
                        uniqueValueAndProof: formatUniqueValueAndProof(),
                        marketCategory: getMarketCategory(),
                        categoryName: formatFieldValue(appState.positioningData?.['category-name']),
                        targetMarketCharacteristics: generateTargetMarketIcpSummary(),
                        relevantTrends: formatRelevantTrends()
                    }
                };
            };

            // Generate Part 3 markdown content
            const generatePart3Markdown = (data) => {
                let markdown = `# Positioning\n\n`;
                
                // Add metadata
                if (data.metadata.company.name) {
                    markdown += `**Company:** ${data.metadata.company.name}\n`;
                }
                if (data.metadata.company.url) {
                    markdown += `**Website:** ${data.metadata.company.url}\n`;
                }
                if (data.metadata.company.productName) {
                    markdown += `**Product:** ${data.metadata.company.productName}\n`;
                }
                if (data.metadata.company.industry) {
                    markdown += `**Industry:** ${data.metadata.company.industry}\n`;
                }
                markdown += `**Export Date:** ${new Date(data.metadata.exportDate).toLocaleString()}\n\n`;
                
                markdown += `---\n\n`;

                // Competitive Alternatives
                markdown += `## Competitive Alternatives\n\n`;
                if (data.content.competitiveAlternatives.length > 0 && data.content.competitiveAlternatives[0].alternative) {
                    data.content.competitiveAlternatives.forEach((alt, index) => {
                        if (alt.alternative) {
                            markdown += `**${index + 1}. ${alt.alternative}**\n`;
                            if (alt.description) {
                                markdown += `   ${alt.description}\n\n`;
                            } else {
                                markdown += `\n`;
                            }
                        }
                    });
                } else {
                    markdown += `*No competitive alternatives defined*\n\n`;
                }

                // Unique Value and Proof
                markdown += `## Unique Value and Proof\n\n`;
                if (data.content.uniqueValueAndProof.length > 0 && data.content.uniqueValueAndProof[0].attribute) {
                    data.content.uniqueValueAndProof.forEach((item, index) => {
                        if (item.attribute) {
                            markdown += `**${index + 1}. ${item.attribute}**\n`;
                            if (item.benefit) {
                                markdown += `   **Benefit:** ${item.benefit}\n`;
                            }
                            if (item.value) {
                                markdown += `   **Value:** ${item.value}\n`;
                            }
                            markdown += `\n`;
                        }
                    });
                } else {
                    markdown += `*No unique value and proof defined*\n\n`;
                }

                // Market Category
                markdown += `## Market Category\n\n`;
                if (data.content.marketCategory) {
                    markdown += `**Market Context:** ${data.content.marketCategory}\n\n`;
                } else {
                    markdown += `**Market Context:** *No market category defined*\n\n`;
                }
                
                // Category Name
                if (data.content.categoryName) {
                    markdown += `**Category Name:** ${data.content.categoryName}\n\n`;
                } else {
                    markdown += `**Category Name:** *No category name specified*\n\n`;
                }

                // Target Market Characteristics
                markdown += `## Target Market Characteristics\n\n`;
                if (data.content.targetMarketCharacteristics) {
                    const characteristics = data.content.targetMarketCharacteristics;
                    if (characteristics.firmographic) {
                        markdown += `    **Firmographic**: ${characteristics.firmographic}\n`;
                    }
                    if (characteristics.technographic) {
                        markdown += `    **Technographic**: ${characteristics.technographic}\n`;
                    }
                    if (characteristics.behavioral) {
                        markdown += `    **Behavioral**: ${characteristics.behavioral}\n`;
                    }
                    if (characteristics.decisionMaking) {
                        markdown += `    **Decision Making**: ${characteristics.decisionMaking}\n`;
                    }
                    if (characteristics.keyRequirements) {
                        markdown += `    **Key Requirements**: ${characteristics.keyRequirements}\n`;
                    }
                    markdown += `\n`;
                } else {
                    markdown += `*No target market characteristics defined*\n\n`;
                }

                // Relevant Trends
                markdown += `## Relevant Trends\n\n`;
                const trends = data.content.relevantTrends;
                let hasTrends = false;
                
                ['trend1', 'trend2', 'trend3', 'trend4'].forEach((trendKey, index) => {
                    if (trends[trendKey]) {
                        markdown += `    **Trend ${index + 1}:** ${trends[trendKey]}\n`;
                        hasTrends = true;
                    }
                });
                
                if (hasTrends) {
                    markdown += `\n`;
                } else {
                    markdown += `*No relevant trends defined*\n\n`;
                }

                return markdown;
            };

            // Export functionality for positioning data (dual-format)
            const exportData = () => {
                const data = generatePart3SpecificData();
                const markdownContent = generatePart3Markdown(data);
                
                setExportModal({
                    isOpen: true,
                    content: markdownContent,
                    title: 'Positioning Export',
                    filename: 'positioning-export',
                    partData: data
                });
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    <ExportModal 
                        isOpen={exportModal.isOpen}
                        onClose={() => setExportModal({ isOpen: false, content: '', title: '' })}
                        title={exportModal.title}
                        content={exportModal.content}
                        appState={appState}
                        filename={exportModal.filename || "positioning-export"}
                        partData={exportModal.partData}
                    />
                    
                    {/* Header */}
                    <header style={{
                        position: 'sticky',
                        top: '73px',
                        zIndex: 40,
                        backgroundColor: 'white',
                        borderBottom: '1px solid #e5e7eb',
                        padding: '1rem 0',
                        boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)'
                    }}>
                        <div className="container mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center">
                                <h1 className="text-xl sm:text-2xl font-bold scale-green-text">Part 3: Positioning</h1>
                            {React.createElement(PrimaryActions, {
                                currentPart: 'positioning',
                                onReset: () => {
                                    if (window.confirm("Are you sure you want to reset all data for Part 3? This will clear all Positioning fields.")) {
                                        setAppState(prev => ({
                                            ...prev,
                                            positioningData: getInitialState().positioningData
                                        }));
                                    }
                                },
                                onExport: exportData,
                                onImport: handleImportPositioning,
                                onContinue: () => { 
                                    markPartAsCompleted('positioning'); 
                                    onNavigate('category'); 
                                    window.scrollTo(0, 0); 
                                }
                            })}
                            </div>
                        </div>
                    </header>

                    {/* Import Message */}
                    {importMessage && (
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-4">
                            <div className={`p-4 rounded-md ${importMessageType === 'error' ? 'bg-red-50 border border-red-200' : 'bg-green-50 border border-green-200'}`}>
                                <div className="flex">
                                    <div className={`${importMessageType === 'error' ? 'text-red-800' : 'text-green-800'}`}>
                                        <p className="text-sm font-medium">{importMessage}</p>
                                    </div>
                                    <div className="ml-auto pl-3">
                                        <button
                                            onClick={() => setImportMessage(null)}
                                            className={`${importMessageType === 'error' ? 'text-red-400 hover:text-red-600' : 'text-green-400 hover:text-green-600'} transition-colors`}
                                        >
                                            <span className="sr-only">Dismiss</span>
                                            <svg className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Layout with Sidebar Navigation */}
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        <div className="lg:flex lg:space-x-8">
                            {/* Sticky Navigation Sidebar */}
                            <nav className="hidden lg:block w-64 flex-shrink-0 sticky top-36 h-fit">
                                <div className="bg-white p-6 rounded-lg shadow-md">
                                    <h3 className="text-lg font-semibold text-gray-800 mb-4">Section Navigation</h3>
                                    <ul className="space-y-3">
                                        <li>
                                            <a 
                                                href="#section-1" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('section-1').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                Competitive Alternatives
                                            </a>
                                        </li>
                                        <li>
                                            <a 
                                                href="#section-2" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('section-2').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                Unique Value and Proof
                                            </a>
                                        </li>
                                        <li>
                                            <a 
                                                href="#section-3" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('section-3').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                Market Category
                                            </a>
                                        </li>
                                        <li>
                                            <a 
                                                href="#section-4" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('section-4').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                Target Market Characteristics
                                            </a>
                                        </li>
                                        <li>
                                            <a 
                                                href="#section-5" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('section-5').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                Relevant Trends
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </nav>
                            
                            <main className="flex-1 min-w-0">
                                <div className="space-y-8">
                            
                            {/* Section 1: Competitive Alternatives */}
                            <div id="section-1" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                                <h2 className="text-2xl font-bold scale-green-text mb-2">Competitive Alternatives</h2>
                                <p className="text-gray-600 mb-6">What are your target customers currently using to solve this problem?</p>
                                <div className="space-y-4">
                                    {(appState.positioningData?.alternatives || []).map((item, index) => 
                                        React.createElement(RemovableRow, {
                                            key: index,
                                            index: index,
                                            item: item,
                                            onUpdate: (idx, key, value) => updateNestedValue('alternatives', idx, key, value),
                                            onRemove: (idx) => removeItem('alternatives', idx),
                                            placeholder1: 'Alternative',
                                            placeholder2: 'Why it\'s inadequate'
                                        })
                                    )}
                                    <button
                                        onClick={() => addItem('alternatives', { val1: '', val2: '' })}
                                        className="bg-blue-600 text-white font-bold py-2 px-4 rounded hover:bg-blue-700"
                                    >
                                        + Add Alternative
                                    </button>
                                </div>
                            </div>
                            
                            {/* Section 2: Unique Value & Proof */}
                            <div id="section-2" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                                <h2 className="text-2xl font-bold scale-green-text mb-2">Unique Value & Proof</h2>
                                <p className="text-gray-600 mb-6">What unique attributes deliver measurable value to your customers?</p>
                                <div className="space-y-4">
                                    {(appState.positioningData?.values || []).map((item, index) => 
                                        React.createElement(RemovableTriple, {
                                            key: index,
                                            index: index,
                                            item: item,
                                            onUpdate: (idx, key, value) => updateNestedValue('values', idx, key, value),
                                            onRemove: (idx) => removeItem('values', idx)
                                        })
                                    )}
                                    <button
                                        onClick={() => addItem('values', { val1: '', val2: '', val3: '', val4: '' })}
                                        className="bg-blue-600 text-white font-bold py-2 px-4 rounded hover:bg-blue-700"
                                    >
                                        + Add Value Proposition
                                    </button>
                                </div>
                            </div>
                            
                            {/* Section 3: Market Category */}
                            <div id="section-3" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                                <h2 className="text-2xl font-bold scale-green-text mb-2">Market Category</h2>
                                <p className="text-gray-600 mb-6">Define how customers and analysts will categorize your solution.</p>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block font-bold text-gray-700 mb-2">Market Context</label>
                                        <select
                                            className="w-full p-2 border border-gray-300 rounded-md"
                                            value={appState.positioningData?.['market-context'] || ''}
                                            onChange={(e) => setAppState(prev => ({ 
                                                ...prev, 
                                                positioningData: { ...prev.positioningData, 'market-context': e.target.value } 
                                            }))}
                                        >
                                            <option value="">Select market category...</option>
                                            <option value="New Category">New Category</option>
                                            <option value="Existing Category">Existing Category</option>
                                            <option value="Sub-category">Sub-category</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    {/* Show additional input if "Other" is selected */}
                                    {appState.positioningData?.['market-context'] === 'Other' && (
                                        <div>
                                            <label className="block font-bold text-gray-700 mb-2">Specify Market Context</label>
                                            <input
                                                type="text"
                                                className="w-full p-2 border border-gray-300 rounded-md"
                                                placeholder="Enter your specific market context..."
                                                value={appState.positioningData?.['market-context-other'] || ''}
                                                onChange={(e) => setAppState(prev => ({ 
                                                    ...prev, 
                                                    positioningData: { ...prev.positioningData, 'market-context-other': e.target.value } 
                                                }))}
                                            />
                                        </div>
                                    )}
                                    
                                    {/* Category Name Field */}
                                    <div>
                                        <label className="block font-bold text-gray-700 mb-2">Category Name</label>
                                        <input
                                            type="text"
                                            className="w-full p-2 border border-gray-300 rounded-md"
                                            placeholder="Enter the name of your chosen category..."
                                            value={appState.positioningData?.['category-name'] || ''}
                                            onChange={(e) => setAppState(prev => ({ 
                                                ...prev, 
                                                positioningData: { ...prev.positioningData, 'category-name': e.target.value } 
                                            }))}
                                        />
                                    </div>
                                </div>
                            </div>
                            
                            {/* Section 4: Target Market Characteristics */}
                            <div id="section-4" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                                <h2 className="text-2xl font-bold scale-green-text mb-2">Target Market Characteristics</h2>
                                <p className="text-gray-600 mb-6">Who will care most about your unique value?</p>
                                <div className="space-y-4">
                                    {/* Display ICP data from Part 2 */}
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                        <h3 className="text-lg font-bold text-blue-800 mb-2">ICP Summary from Part 2</h3>
                                        <div className="space-y-2">
                                            {appState.positioningData?.icp_summary ? 
                                                <p className="text-blue-700">{appState.positioningData.icp_summary}</p> :
                                                <p className="text-blue-600 italic">Complete Part 2: ICP Definition to see your target market characteristics here</p>
                                            }
                                        </div>
                                    </div>
                                    {/* Additional ICP details */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {/* Firmographic */}
                                        {appState.positioningData?.icp_firmographic && (
                                            <div className="p-3 bg-gray-50 rounded-lg">
                                                <h4 className="font-bold text-gray-800 mb-1">Firmographic</h4>
                                                <p className="text-sm text-gray-700">{appState.positioningData.icp_firmographic}</p>
                                            </div>
                                        )}
                                        {/* Technographic */}
                                        {appState.positioningData?.icp_technographic && (
                                            <div className="p-3 bg-gray-50 rounded-lg">
                                                <h4 className="font-bold text-gray-800 mb-1">Technographic</h4>
                                                <p className="text-sm text-gray-700">{appState.positioningData.icp_technographic}</p>
                                            </div>
                                        )}
                                        {/* Behavioral */}
                                        {appState.positioningData?.icp_behavioral && (
                                            <div className="p-3 bg-gray-50 rounded-lg">
                                                <h4 className="font-bold text-gray-800 mb-1">Behavioral</h4>
                                                <p className="text-sm text-gray-700">{appState.positioningData.icp_behavioral}</p>
                                            </div>
                                        )}
                                        {/* Implementation Readiness */}
                                        {appState.positioningData?.icp_implementation_readiness && (
                                            <div className="p-3 bg-gray-50 rounded-lg">
                                                <h4 className="font-bold text-gray-800 mb-1">Implementation Readiness</h4>
                                                <p className="text-sm text-gray-700">{appState.positioningData.icp_implementation_readiness}</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                            
                            {/* Section 5: Relevant Trends */}
                            <div id="section-5" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                                <h2 className="text-2xl font-bold scale-green-text mb-2">Relevant Trends</h2>
                                <p className="text-gray-600 mb-6">What market trends create urgency for your solution?</p>
                                <div className="space-y-6">
                                    {/* Trend 1 */}
                                    <div>
                                        <label className="block font-bold text-gray-700 mb-2">Industry Trend 1</label>
                                        <textarea
                                            className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                            rows="2"
                                            placeholder="Example: AI automation is becoming table stakes in enterprise software"
                                            value={appState.positioningData?.trend1_desc || ''}
                                            onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, trend1_desc: e.target.value } }))}
                                        />
                                    </div>
                                    {/* Trend 2 */}
                                    <div>
                                        <label className="block font-bold text-gray-700 mb-2">Industry Trend 2</label>
                                        <textarea
                                            className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                            rows="2"
                                            placeholder="Example: Remote work is driving demand for cloud-based collaboration"
                                            value={appState.positioningData?.trend2_desc || ''}
                                            onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, trend2_desc: e.target.value } }))}
                                        />
                                    </div>
                                    {/* Trend 3 */}
                                    <div>
                                        <label className="block font-bold text-gray-700 mb-2">Industry Trend 3</label>
                                        <textarea
                                            className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                            rows="2"
                                            placeholder="Example: Regulatory compliance requirements are becoming more stringent"
                                            value={appState.positioningData?.trend3_desc || ''}
                                            onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, trend3_desc: e.target.value } }))}
                                        />
                                    </div>
                                    {/* Trend 4 */}
                                    <div>
                                        <label className="block font-bold text-gray-700 mb-2">Industry Trend 4</label>
                                        <textarea
                                            className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                            rows="2"
                                            placeholder="Example: Customer expectations for real-time data insights"
                                            value={appState.positioningData?.trend4_desc || ''}
                                            onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, trend4_desc: e.target.value } }))}
                                        />
                                    </div>
                                </div>
                            </div>
                            
                            {/* Clear All Fields Button */}
                            <div className="mt-8 text-center">
                                <button
                                    onClick={() => {
                                        // Clear all Positioning fields
                                        const clearedPositioningData = {};
                                        setAppState(prev => ({ ...prev, positioningData: clearedPositioningData }));
                                        alert('All fields cleared! Refresh the page to see placeholder text.');
                                    }}
                                    className="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600 transition-colors mr-4"
                                >
                                    Clear All Fields
                                </button>
                                
                                {/* Continue to Part 4 Button */}
                                <button
                                    onClick={() => { 
                                        markPartAsCompleted('positioning');
                                        onNavigate('category'); 
                                        window.scrollTo(0, 0); 
                                    }}
                                    className="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition-colors"
                                >
                                    Continue to Part 4: Category Design
                                </button>
                            </div>
                                </div>
                            </main>
                        </div>
                    </div>
                </div>
            );
        };

        // CategoryDesignTool Component
        const CategoryDesignTool = ({ appState, setAppState, onNavigate, markPartAsCompleted }) => {
            const [exportModal, setExportModal] = useState({ isOpen: false, content: '', title: '' });
            const [importMessage, setImportMessage] = useState(null);
            const [importMessageType, setImportMessageType] = useState('');

            // Validation function for category import data
            const validateCategoryImportData = (data) => {
                const errors = [];
                
                if (!data || typeof data !== 'object') {
                    errors.push('Invalid JSON format');
                    return { isValid: false, errors };
                }
                
                if (!data.metadata || data.metadata.partName !== 'Category Design') {
                    const detectedType = data.metadata?.partName || 'Unknown';
                    errors.push(`Wrong data type: Found "${detectedType}" data, but expected "Category Design" data. Please select a Category Design export file.`);
                }
                
                if (!data.content || typeof data.content !== 'object') {
                    errors.push('Missing or invalid content section');
                }
                
                return { isValid: errors.length === 0, errors };
            };

            // Handle import for Category Design
            const handleImportCategory = () => {
                // Create a hidden file input element
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.json';
                fileInput.style.display = 'none';
                
                fileInput.onchange = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    // Clear any previous messages
                    setImportMessage(null);
                    setImportMessageType('');
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            
                            // Validate the imported data
                            const validation = validateCategoryImportData(importedData);
                            
                            if (!validation.isValid) {
                                setImportMessage(`Import failed: ${validation.errors.join('; ')}`);
                                setImportMessageType('error');
                                return;
                            }
                            
                            // Process the import
                            const { content } = importedData;
                            const updates = {};
                            
                            // Map all the category fields from import format to internal state
                            if (content.pointOfView) updates['point-of-view'] = content.pointOfView;
                            if (content.newOpportunity) updates['new-opportunity'] = content.newOpportunity;
                            if (content.categoryName && content.categoryName.name) updates['category-name'] = content.categoryName.name;
                            if (content.categoryName && content.categoryName.definition) updates['category-definition'] = content.categoryName.definition;
                            if (content.manifesto) updates['manifesto'] = content.manifesto;
                            if (content.marketCategory) updates['market-category'] = content.marketCategory;
                            
                            // Target market characteristics
                            if (content.targetMarketCharacteristics) {
                                const tm = content.targetMarketCharacteristics;
                                if (tm.summary) updates['target-market-summary'] = tm.summary;
                                if (tm.firmographic) updates['target-market-firmographic'] = tm.firmographic;
                                if (tm.technographic) updates['target-market-technographic'] = tm.technographic;
                                if (tm.behavioral) updates['target-market-behavioral'] = tm.behavioral;
                                if (tm.implementationReadiness) updates['target-market-readiness'] = tm.implementationReadiness;
                            }
                            
                            // Update the state
                            setAppState(prev => ({
                                ...prev,
                                categoryData: {
                                    ...prev.categoryData,
                                    ...updates
                                }
                            }));
                            
                            setImportMessage(`Successfully imported ${Object.keys(updates).length} fields from Category Design data`);
                            setImportMessageType('success');
                            
                        } catch (error) {
                            console.error('Import error:', error);
                            setImportMessage(`Import failed: ${error.message}`);
                            setImportMessageType('error');
                        }
                    };
                    
                    reader.readAsText(file);
                };
                
                // Trigger file dialog
                document.body.appendChild(fileInput);
                fileInput.click();
                document.body.removeChild(fileInput);
            };
            

            // Generate Part 4 specific data for dual-format export
            const generatePart4SpecificData = () => {
                const exportDate = new Date().toISOString();
                
                // Utility to format field values with future-proofing
                const formatFieldValue = (fieldValue) => {
                    if (Array.isArray(fieldValue)) {
                        return fieldValue.filter(item => item && item.toString().trim()).join('; ');
                    }
                    return fieldValue && fieldValue.toString().trim() || null;
                };

                // Generate comprehensive positioning foundation summary from Part 3 data
                const generatePositioningFoundationSummary = () => {
                    if (!appState.positioningData) return null;
                    
                    const foundation = {};
                    
                    // 1. Competitive Alternatives
                    if (appState.positioningData.alternatives && Array.isArray(appState.positioningData.alternatives)) {
                        const alternatives = appState.positioningData.alternatives
                            .filter(alt => alt && alt.val1)
                            .map(alt => ({
                                name: formatFieldValue(alt.val1),
                                description: formatFieldValue(alt.val2)
                            }));
                        if (alternatives.length > 0) {
                            foundation.competitiveAlternatives = alternatives;
                        }
                    }
                    
                    // 2. Unique Value & Proof
                    if (appState.positioningData.values && Array.isArray(appState.positioningData.values)) {
                        const values = appState.positioningData.values
                            .filter(v => v && v.val1)
                            .map(v => ({
                                attribute: formatFieldValue(v.val1),
                                benefit: formatFieldValue(v.val2),
                                proof: formatFieldValue(v.val3)
                            }));
                        if (values.length > 0) {
                            foundation.uniqueValueAndProof = values;
                        }
                    }
                    
                    // 3. Market Category
                    if (appState.positioningData['market-context']) {
                        foundation.marketCategory = appState.positioningData['market-context'] === 'Other' 
                            ? formatFieldValue(appState.positioningData['market-context-other'])
                            : formatFieldValue(appState.positioningData['market-context']);
                    }
                    
                    // 4. Target Market Characteristics
                    const targetMarket = {};
                    if (appState.positioningData.icp_summary) {
                        targetMarket.summary = formatFieldValue(appState.positioningData.icp_summary);
                    }
                    if (appState.positioningData.icp_firmographic) {
                        targetMarket.firmographic = formatFieldValue(appState.positioningData.icp_firmographic);
                    }
                    if (appState.positioningData.icp_technographic) {
                        targetMarket.technographic = formatFieldValue(appState.positioningData.icp_technographic);
                    }
                    if (appState.positioningData.icp_behavioral) {
                        targetMarket.behavioral = formatFieldValue(appState.positioningData.icp_behavioral);
                    }
                    if (appState.positioningData.icp_implementation_readiness) {
                        targetMarket.implementationReadiness = formatFieldValue(appState.positioningData.icp_implementation_readiness);
                    }
                    if (Object.keys(targetMarket).length > 0) {
                        foundation.targetMarketCharacteristics = targetMarket;
                    }
                    
                    // 5. Relevant Trends
                    const trends = [];
                    if (appState.positioningData.trend1_desc) trends.push(formatFieldValue(appState.positioningData.trend1_desc));
                    if (appState.positioningData.trend2_desc) trends.push(formatFieldValue(appState.positioningData.trend2_desc));
                    if (appState.positioningData.trend3_desc) trends.push(formatFieldValue(appState.positioningData.trend3_desc));
                    if (appState.positioningData.trend4_desc) trends.push(formatFieldValue(appState.positioningData.trend4_desc));
                    if (trends.length > 0) {
                        foundation.relevantTrends = trends;
                    }
                    
                    return Object.keys(foundation).length > 0 ? foundation : null;
                };

                return {
                    metadata: {
                        exportDate: exportDate,
                        partName: "Category Design",
                        company: {
                            name: formatFieldValue(appState.companyData?.name),
                            url: formatFieldValue(appState.companyData?.url),
                            productName: formatFieldValue(appState.companyData?.productName),
                            industry: formatFieldValue(appState.companyData?.industry)
                        }
                    },
                    content: {
                        positioningFoundation: generatePositioningFoundationSummary(),
                        pointOfView: {
                            fromStatement: formatFieldValue(appState.categoryData?.['from-statement']),
                            toStatement: formatFieldValue(appState.categoryData?.['to-statement'])
                        },
                        newOpportunity: formatFieldValue(appState.categoryData?.['new-opportunity']),
                        categoryNameAndDefinition: {
                            name: formatFieldValue(appState.categoryData?.['category-name']),
                            definition: formatFieldValue(appState.categoryData?.['category-definition'])
                        },
                        manifesto: formatFieldValue(appState.categoryData?.['manifesto']),
                        marketCategory: formatFieldValue(appState.categoryData?.['market-category']),
                        targetMarketCharacteristics: {
                            summary: formatFieldValue(appState.categoryData?.['target-market-summary']),
                            firmographic: formatFieldValue(appState.categoryData?.['target-market-firmographic']),
                            technographic: formatFieldValue(appState.categoryData?.['target-market-technographic']),
                            behavioral: formatFieldValue(appState.categoryData?.['target-market-behavioral']),
                            implementationReadiness: formatFieldValue(appState.categoryData?.['target-market-readiness'])
                        }
                    }
                };
            };

            // Generate Part 4 markdown content
            const generatePart4Markdown = (data) => {
                let markdown = `# Category Design\n\n`;
                
                // Add metadata
                if (data.metadata.company.name) {
                    markdown += `**Company:** ${data.metadata.company.name}\n`;
                }
                if (data.metadata.company.url) {
                    markdown += `**Website:** ${data.metadata.company.url}\n`;
                }
                if (data.metadata.company.productName) {
                    markdown += `**Product:** ${data.metadata.company.productName}\n`;
                }
                if (data.metadata.company.industry) {
                    markdown += `**Industry:** ${data.metadata.company.industry}\n`;
                }
                markdown += `**Export Date:** ${new Date(data.metadata.exportDate).toLocaleString()}\n\n`;
                
                markdown += `---\n\n`;

                // Positioning Foundation
                markdown += `## Positioning Foundation\n\n`;
                if (data.content.positioningFoundation) {
                    const foundation = data.content.positioningFoundation;
                    
                    // 1. Competitive Alternatives
                    if (foundation.competitiveAlternatives && foundation.competitiveAlternatives.length > 0) {
                        markdown += `### 1. Competitive Alternatives\n`;
                        foundation.competitiveAlternatives.forEach(alt => {
                            markdown += `- **${alt.name}**${alt.description ? `: ${alt.description}` : ''}\n`;
                        });
                        markdown += `\n`;
                    }
                    
                    // 2. Unique Value & Proof
                    if (foundation.uniqueValueAndProof && foundation.uniqueValueAndProof.length > 0) {
                        markdown += `### 2. Unique Value & Proof\n`;
                        foundation.uniqueValueAndProof.forEach(value => {
                            markdown += `- **${value.attribute}**`;
                            if (value.benefit) markdown += `: ${value.benefit}`;
                            if (value.proof) markdown += ` - ${value.proof}`;
                            markdown += `\n`;
                        });
                        markdown += `\n`;
                    }
                    
                    // 3. Market Category
                    if (foundation.marketCategory) {
                        markdown += `### 3. Market Category\n`;
                        markdown += `${foundation.marketCategory}\n\n`;
                    }
                    
                    // 4. Target Market Characteristics
                    if (foundation.targetMarketCharacteristics) {
                        markdown += `### 4. Target Market Characteristics\n`;
                        const tm = foundation.targetMarketCharacteristics;
                        if (tm.summary) {
                            markdown += `**Summary:** ${tm.summary}\n\n`;
                        }
                        if (tm.firmographic) {
                            markdown += `**Firmographic:** ${tm.firmographic}\n\n`;
                        }
                        if (tm.technographic) {
                            markdown += `**Technographic:** ${tm.technographic}\n\n`;
                        }
                        if (tm.behavioral) {
                            markdown += `**Behavioral:** ${tm.behavioral}\n\n`;
                        }
                        if (tm.implementationReadiness) {
                            markdown += `**Implementation Readiness:** ${tm.implementationReadiness}\n\n`;
                        }
                    }
                    
                    // 5. Relevant Trends
                    if (foundation.relevantTrends && foundation.relevantTrends.length > 0) {
                        markdown += `### 5. Relevant Trends\n`;
                        foundation.relevantTrends.forEach((trend, index) => {
                            markdown += `${index + 1}. ${trend}\n`;
                        });
                        markdown += `\n`;
                    }
                } else {
                    markdown += `*No positioning foundation data available*\n\n`;
                }

                // Point of View (The "From/To" Shift)
                markdown += `## The Point of View (The "From/To" Shift)\n\n`;
                if (data.content.pointOfView.fromStatement || data.content.pointOfView.toStatement) {
                    if (data.content.pointOfView.fromStatement) {
                        markdown += `    **From:** ${data.content.pointOfView.fromStatement}\n`;
                    }
                    if (data.content.pointOfView.toStatement) {
                        markdown += `    **To:** ${data.content.pointOfView.toStatement}\n`;
                    }
                    markdown += `\n`;
                } else {
                    markdown += `*No point of view defined*\n\n`;
                }

                // The New Opportunity
                markdown += `## The New Opportunity\n\n`;
                if (data.content.newOpportunity) {
                    markdown += `${data.content.newOpportunity}\n\n`;
                } else {
                    markdown += `*No new opportunity defined*\n\n`;
                }

                // Category Name & Definition
                markdown += `## Category Name & Definition\n\n`;
                if (data.content.categoryNameAndDefinition.name || data.content.categoryNameAndDefinition.definition) {
                    if (data.content.categoryNameAndDefinition.name) {
                        markdown += `    **Name:** ${data.content.categoryNameAndDefinition.name}\n`;
                    }
                    if (data.content.categoryNameAndDefinition.definition) {
                        markdown += `    **Definition:** ${data.content.categoryNameAndDefinition.definition}\n`;
                    }
                    markdown += `\n`;
                } else {
                    markdown += `*No category name and definition specified*\n\n`;
                }

                // The Manifesto
                markdown += `## The Manifesto\n\n`;
                if (data.content.manifesto) {
                    markdown += `${data.content.manifesto}\n\n`;
                } else {
                    markdown += `*No manifesto defined*\n\n`;
                }

                // Market Category (Part 4 specific)
                markdown += `## Market Category\n\n`;
                if (data.content.marketCategory) {
                    markdown += `${data.content.marketCategory}\n\n`;
                } else {
                    markdown += `*No market category defined*\n\n`;
                }

                // Target Market Characteristics (Part 4 specific)
                markdown += `## Target Market Characteristics\n\n`;
                if (data.content.targetMarketCharacteristics && 
                    (data.content.targetMarketCharacteristics.summary ||
                     data.content.targetMarketCharacteristics.firmographic ||
                     data.content.targetMarketCharacteristics.technographic ||
                     data.content.targetMarketCharacteristics.behavioral ||
                     data.content.targetMarketCharacteristics.implementationReadiness)) {
                    const tm = data.content.targetMarketCharacteristics;
                    if (tm.summary) {
                        markdown += `**Summary:** ${tm.summary}\n\n`;
                    }
                    if (tm.firmographic) {
                        markdown += `**Firmographic:** ${tm.firmographic}\n\n`;
                    }
                    if (tm.technographic) {
                        markdown += `**Technographic:** ${tm.technographic}\n\n`;
                    }
                    if (tm.behavioral) {
                        markdown += `**Behavioral:** ${tm.behavioral}\n\n`;
                    }
                    if (tm.implementationReadiness) {
                        markdown += `**Implementation Readiness:** ${tm.implementationReadiness}\n\n`;
                    }
                } else {
                    markdown += `*No target market characteristics defined*\n\n`;
                }

                return markdown;
            };

            const handleExport = () => {
                try {
                    const data = generatePart4SpecificData();
                    const markdown = generatePart4Markdown(data);
                    
                    setExportModal({
                        isOpen: true,
                        content: markdown,
                        title: 'Category Design Export',
                        filename: 'category-design-export',
                        partData: data
                    });
                } catch (error) {
                    console.error("Error during Part 4 export:", error);
                    setExportModal({
                        isOpen: true,
                        content: "Error generating export. Please try again.",
                        title: 'Export Error'
                    });
                }
            };

            return (
                <div className="container mx-auto px-4 sm:px-6 lg:px-8 pb-32">
                    <header style={{
                        position: 'sticky',
                        top: '73px',
                        zIndex: 40,
                        backgroundColor: 'white',
                        borderBottom: '1px solid #e5e7eb',
                        padding: '1rem 0',
                        boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)'
                    }}>
                        <div className="flex justify-between items-center">
                            <h1 className="text-xl sm:text-2xl font-bold scale-green-text">Part 4: Category Design</h1>
                            {React.createElement(PrimaryActions, {
                                currentPart: 'category',
                                onImport: handleImportCategory,
                                onReset: () => {
                                    if (window.confirm("Are you sure you want to reset all data for Part 4? This will clear all Category Design fields.")) {
                                        setAppState(prev => ({
                                            ...prev,
                                            categoryData: getInitialState().categoryData
                                        }));
                                    }
                                },
                                onExport: handleExport,
                                onContinue: () => {
                                    // Complete Blueprint - could navigate to completion page or show success message
                                    alert('Blueprint Complete! All parts have been finished.');
                                    window.scrollTo(0, 0);
                                }
                            })}
                        </div>
                    </header>

                    {/* Import Message Display */}
                    {importMessage && (
                        <div className={`mt-4 p-4 rounded-md ${
                            importMessageType === 'success' 
                                ? 'bg-green-50 border border-green-200 text-green-800' 
                                : 'bg-red-50 border border-red-200 text-red-800'
                        }`}>
                            <div className="flex items-center">
                                <span className="font-medium">
                                    {importMessageType === 'success' ? '✅ ' : '❌ '}
                                    {importMessage}
                                </span>
                                <button 
                                    onClick={() => setImportMessage(null)}
                                    className="ml-auto text-sm opacity-70 hover:opacity-100"
                                >
                                    ✕
                                </button>
                            </div>
                        </div>
                    )}

                    <div className="mt-8">
                        <div className="lg:flex lg:space-x-8">
                            {/* Sticky Navigation Sidebar */}
                            <nav className="hidden lg:block w-64 flex-shrink-0 sticky top-36 h-fit">
                                <div className="bg-white p-6 rounded-lg shadow-md">
                                    <h3 className="text-lg font-semibold text-gray-800 mb-4">Section Navigation</h3>
                                    <ul className="space-y-3">
                                        <li>
                                            <a 
                                                href="#positioning-foundation" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('positioning-foundation').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                Positioning Foundation
                                            </a>
                                        </li>
                                        <li>
                                            <a 
                                                href="#section-1" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('section-1').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                The Point of View
                                            </a>
                                        </li>
                                        <li>
                                            <a 
                                                href="#section-2" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('section-2').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                The New Opportunity
                                            </a>
                                        </li>
                                        <li>
                                            <a 
                                                href="#section-3" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('section-3').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                Category Name & Definition
                                            </a>
                                        </li>
                                        <li>
                                            <a 
                                                href="#section-4" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('section-4').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                The Manifesto
                                            </a>
                                        </li>
                                        <li>
                                            <a 
                                                href="#section-5" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('section-5').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                Market Category
                                            </a>
                                        </li>
                                        <li>
                                            <a 
                                                href="#section-6" 
                                                className="block px-3 py-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    document.getElementById('section-6').scrollIntoView({ behavior: 'smooth' });
                                                }}
                                            >
                                                Target Market Characteristics
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </nav>

                            <main className="w-full">
                                <div className="space-y-8">
                        <div id="positioning-foundation" className="bg-green-50 border-l-4 border-green-600 p-6 rounded-r-lg shadow-sm scroll-mt-32">
                            <h3 className="text-xl font-bold text-green-800 mb-3">Positioning Foundation</h3>
                            <p className="text-green-700 mb-4">This category design exercise builds upon the positioning work from Part 3. Here is a comprehensive summary of your positioning inputs:</p>
                            <div className="bg-white p-4 rounded-md border border-green-200 space-y-4">
                                
                                {/* 1. Competitive Alternatives */}
                                <div>
                                    <h4 className="font-bold text-gray-800 mb-2">1. Competitive Alternatives</h4>
                                    <div className="text-sm text-gray-600">
                                        {(appState.positioningData.alternatives && appState.positioningData.alternatives.some(alt => alt.val1)) ? (
                                            <ul className="list-disc pl-5 space-y-1">
                                                {appState.positioningData.alternatives.map((alt, index) => (
                                                    alt.val1 && <li key={index}>
                                                        <strong>{alt.val1}:</strong> {alt.val2 && <span className="italic">{alt.val2}</span>}
                                                    </li>
                                                ))}
                                            </ul>
                                        ) : (
                                            <span className="italic">Complete Part 3 first</span>
                                        )}
                                    </div>
                                </div>

                                {/* 2. Unique Value & Proof */}
                                <div>
                                    <h4 className="font-bold text-gray-800 mb-2">2. Unique Value & Proof</h4>
                                    <div className="text-sm text-gray-600">
                                        {(appState.positioningData.values && appState.positioningData.values.some(v => v.val1)) ? (
                                            <ul className="list-disc pl-5 space-y-1">
                                                {appState.positioningData.values.map((item, index) => (
                                                    item.val1 && <li key={index}>
                                                        <strong>{item.val1}:</strong> {item.val2 && <span>{item.val2}</span>}
                                                        {item.val3 && <span className="italic"> - {item.val3}</span>}
                                                    </li>
                                                ))}
                                            </ul>
                                        ) : (
                                            <span className="italic">Complete Part 3 first</span>
                                        )}
                                    </div>
                                </div>

                                {/* --- START of Market Category replacement --- */}
                                <div>
                                    <h4 className="font-bold text-gray-800 mb-2">3. Market Category</h4>
                                    <div className="text-sm text-gray-600">
                                        {appState.positioningData['market-context'] ? (
                                            <p>
                                                <strong>Context:</strong> {appState.positioningData['market-context'] === 'Other'
                                                    ? appState.positioningData['market-context-other']
                                                    : appState.positioningData['market-context']}
                                                <br />
                                                <strong>Name:</strong> {appState.positioningData['category-name'] || <span className="italic">Not provided</span>}
                                            </p>
                                        ) : (
                                            <span className="italic">Complete Part 3 first</span>
                                        )}
                                    </div>
                                </div>
                                {/* --- END of Market Category replacement --- */}

                                {/* --- START of Target Market Characteristics replacement --- */}
                                <div>
                                    <h4 className="font-bold text-gray-800 mb-2">4. Target Market Characteristics</h4>
                                    <div className="text-sm text-gray-600">
                                        {(appState.positioningData.icp_firmographic || appState.positioningData.icp_technographic || appState.positioningData.icp_behavioral) ? (
                                            <div className="space-y-2 ml-4">
                                                {appState.positioningData.icp_firmographic && (
                                                    <div><strong>Firmographic:</strong> {appState.positioningData.icp_firmographic}</div>
                                                )}
                                                {appState.positioningData.icp_technographic && (
                                                    <div><strong>Technographic:</strong> {appState.positioningData.icp_technographic}</div>
                                                )}
                                                {appState.positioningData.icp_behavioral && (
                                                    <div><strong>Behavioral:</strong> {appState.positioningData.icp_behavioral}</div>
                                                )}
                                                {appState.positioningData.icp_implementation_readiness && (
                                                    <div><strong>Implementation Readiness:</strong> {appState.positioningData.icp_implementation_readiness}</div>
                                                )}
                                            </div>
                                        ) : (
                                            <span className="italic">Complete Part 3 first</span>
                                        )}
                                    </div>
                                </div>
                                {/* --- END of Target Market Characteristics replacement --- */}

                                {/* 5. Relevant Trends */}
                                <div>
                                    <h4 className="font-bold text-gray-800 mb-2">5. Relevant Trends</h4>
                                    <div className="text-sm text-gray-600">
                                        {(appState.positioningData.trend1_desc || 
                                          appState.positioningData.trend2_desc || 
                                          appState.positioningData.trend3_desc || 
                                          appState.positioningData.trend4_desc) ? (
                                            <ul className="list-disc pl-5 space-y-1">
                                                {appState.positioningData.trend1_desc && (
                                                    <li>{appState.positioningData.trend1_desc}</li>
                                                )}
                                                {appState.positioningData.trend2_desc && (
                                                    <li>{appState.positioningData.trend2_desc}</li>
                                                )}
                                                {appState.positioningData.trend3_desc && (
                                                    <li>{appState.positioningData.trend3_desc}</li>
                                                )}
                                                {appState.positioningData.trend4_desc && (
                                                    <li>{appState.positioningData.trend4_desc}</li>
                                                )}
                                            </ul>
                                        ) : (
                                            <span className="italic">Complete Part 3 first</span>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="section-1" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                            <h2 className="text-2xl font-bold scale-green-text mb-2">The Point of View (The "From/To" Shift)</h2>
                            <p className="font-semibold text-gray-600 mb-2">Question: What is the old, broken way of thinking, and what is our new, better way?</p>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label className="block font-bold text-gray-700">From (The Old, Broken Way)</label>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="4" 
                                        placeholder="Example: Business transformation is a series of slow, high-risk, episodic projects."
                                        value={appState.categoryData['from-statement'] || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'from-statement': e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">To (Our New, Better Way)</label>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="4" 
                                        placeholder="Example: Operational excellence is a continuous, automated, data-driven business function."
                                        value={appState.categoryData['to-statement'] || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'to-statement': e.target.value } }))}
                                    />
                                </div>
                            </div>
                        </div>

                        <div id="section-2" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                            <h2 className="text-2xl font-bold scale-green-text mb-2">The New Opportunity</h2>
                            <p className="font-semibold text-gray-600 mb-2">Question: What becomes possible for businesses that adopt our point of view?</p>
                            <textarea 
                                className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                rows="4" 
                                placeholder="Example: Businesses can now move beyond reactive, crisis-driven change and achieve continuous transformation..."
                                value={appState.categoryData['new-opportunity'] || ''}
                                onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'new-opportunity': e.target.value } }))}
                            />
                        </div>

                        <div id="section-3" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                            <h2 className="text-2xl font-bold scale-green-text mb-2">Category Name & Definition</h2>
                            <div className="space-y-4">
                                <div>
                                    <label className="block font-bold text-gray-700">Category Name</label>
                                    <div className="flex gap-2 mt-1">
                                        <input 
                                            type="text" 
                                            className="flex-1 p-2 border border-gray-300 rounded-md"
                                            placeholder="Example: Continuous Transformation"
                                            value={appState.categoryData['category-name'] || ''}
                                            onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'category-name': e.target.value } }))}
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">One-Sentence Definition</label>
                                    <input 
                                        type="text" 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        placeholder="Example: The practice of using AI to continuously analyze and optimize business processes in real-time."
                                        value={appState.categoryData['category-definition'] || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'category-definition': e.target.value } }))}
                                    />
                                </div>
                            </div>
                        </div>

                        <div id="section-4" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                            <h2 className="text-2xl font-bold scale-green-text mb-2">The Manifesto</h2>
                            <p className="font-semibold text-gray-600 mb-2">Question: What is our story?</p>
                            <textarea 
                                className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                rows="8" 
                                placeholder="Enter your manifesto here..."
                                value={appState.categoryData['manifesto'] || ''}
                                onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'manifesto': e.target.value } }))}
                            />
                        </div>

                        <div id="section-5" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                            <h2 className="text-2xl font-bold scale-green-text mb-2">Market Category</h2>
                            <p className="font-semibold text-gray-600 mb-2">Question: What market category does your solution belong to?</p>
                            <textarea 
                                className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                rows="3" 
                                placeholder="Example: Customer Success Platform, Marketing Automation, etc."
                                value={appState.categoryData['market-category'] || ''}
                                onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'market-category': e.target.value } }))}
                            />
                        </div>

                        <div id="section-6" className="bg-white p-8 rounded-lg shadow-md scroll-mt-32">
                            <h2 className="text-2xl font-bold scale-green-text mb-2">Target Market Characteristics</h2>
                            <p className="font-semibold text-gray-600 mb-2">Question: Who is the ideal customer for this category?</p>
                            <div className="space-y-4">
                                <div>
                                    <label className="block font-bold text-gray-700">Summary</label>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="3" 
                                        placeholder="Brief overview of your target market..."
                                        value={appState.categoryData['target-market-summary'] || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'target-market-summary': e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Firmographic</label>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="2" 
                                        placeholder="Company size, industry, revenue..."
                                        value={appState.categoryData['target-market-firmographic'] || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'target-market-firmographic': e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Technographic</label>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="2" 
                                        placeholder="Technology stack, tools used..."
                                        value={appState.categoryData['target-market-technographic'] || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'target-market-technographic': e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Behavioral</label>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="2" 
                                        placeholder="Buying patterns, preferences..."
                                        value={appState.categoryData['target-market-behavioral'] || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'target-market-behavioral': e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Implementation Readiness</label>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="2" 
                                        placeholder="Readiness to adopt new solutions..."
                                        value={appState.categoryData['target-market-readiness'] || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'target-market-readiness': e.target.value } }))}
                                    />
                                </div>
                            </div>
                        </div>
                        
                        {/* Clear All Fields Button */}
                        <div className="mt-8 mb-32 text-center">
                            <button
                                onClick={() => {
                                    // Clear all Category Design fields
                                    const clearedCategoryData = {};
                                    setAppState(prev => ({ ...prev, categoryData: clearedCategoryData }));
                                    alert('All fields cleared! Refresh the page to see placeholder text.');
                                }}
                                className="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600 transition-colors mr-4"
                            >
                                Clear All Fields
                            </button>
                            
                            {/* Complete Blueprint Button */}
                            <button
                                onClick={() => {
                                    // Complete Blueprint - could navigate to completion page or show success message
                                    alert('Blueprint Complete! All parts have been finished.');
                                    window.scrollTo(0, 0);
                                }}
                                className="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition-colors"
                            >
                                Complete Blueprint
                            </button>
                        </div>
                                </div>
                            </main>
                        </div>
                    </div>

                    <ExportModal 
                        isOpen={exportModal.isOpen}
                        onClose={() => setExportModal(prev => ({ ...prev, isOpen: false }))}
                        title={exportModal.title}
                        content={exportModal.content}
                        appState={appState}
                        filename="category-design-blueprint"
                    />
                </div>
            );
        };

        // Home Component
        const Home = ({ appState, setAppState, onNavigate, onExport }) => {
            console.log('HomeView props:', { appState, setAppState, onNavigate });
            
            const [showCompanySetupModal, setShowCompanySetupModal] = useState(() => {
                // Initialize modal state based on setup completion
                return !appState.companyContext?.isSetupComplete;
            });
            
            // State for the prompt display modal
            const [promptModalData, setPromptModalData] = useState({
                isOpen: false,
                title: '',
                promptText: ''
            });
            

            // Separate useEffect for debugging
            useEffect(() => {
                console.log('CompanyContext:', appState.companyContext);
                console.log('Should show modal:', !appState.companyContext?.isSetupComplete);
                console.log('Modal state:', showCompanySetupModal);
            });

            return (
                <div className="min-h-screen bg-gray-50 py-12 px-4">
                    <div className="max-w-3xl mx-auto">
                        {/* Existing welcome content */}
                        <h1 className="text-4xl font-bold text-center mb-8 scale-green-text">Welcome to Category Blueprint</h1>
                        
                        {/* Company Context Display */}
                        {appState.companyContext?.isSetupComplete && (
                            <div className="bg-white rounded-lg shadow-md p-6 mb-8">
                                <h3 className="text-lg font-semibold mb-3">Current Company Context</h3>
                                <div className="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <span className="font-medium">Company:</span> {appState.companyContext.companyName || 'Not specified'}
                                    </div>
                                    <div>
                                        <span className="font-medium">Product:</span> {appState.companyContext.productName || 'Not specified'}
                                    </div>
                                    <div>
                                        <span className="font-medium">Industry:</span> {appState.companyContext.industry || 'Not specified'}
                                    </div>
                                    <div>
                                        <span className="font-medium">Market:</span> {appState.companyContext.targetMarket || 'Not specified'}
                                    </div>
                                </div>
                                
                                {/* Reset Company Setup Button */}
                                <div className="mt-4 flex flex-col sm:flex-row gap-2 items-start">
                                    <button
                                        onClick={() => {
                                            if (window.confirm('This will reset your company setup and clear all form data. Are you sure?')) {
                                                // Reset company context
                                                setAppState(prev => ({
                                                    ...prev,
                                                    companyContext: {
                                                        ...prev.companyContext,
                                                        isSetupComplete: false
                                                    }
                                                }));
                                                // This will trigger the CompanySetupModal to show again
                                            }
                                        }}
                                        className="text-sm text-gray-600 hover:text-blue-600 underline"
                                    >
                                        Change Company Setup
                                    </button>
                                    
                                    {/* Export Buttons - Only show if there's data to export */}
                                    {(appState.segmentData || appState.positioningData || appState.categoryData) && (
                                        <div className="flex gap-2">
                                            <button
                                                onClick={onExport}
                                                className="px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
                                            >
                                                Export All Data
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                        
                        {/* Continue/Start Buttons */}
                        <div className="flex flex-col sm:flex-row gap-4 justify-center">
                            {appState.navigationProgress.completedParts.length > 0 ? (
                                <>
                                    <button
                                        onClick={() => {
                                            try {
                                                const promptText = generateDeepResearchPrompt(appState.companyContext);
                                                
                                                if (promptText && promptText.startsWith('Error generating prompt')) {
                                                    alert(promptText);
                                                    return;
                                                }
                                                
                                                setPromptModalData({
                                                    isOpen: true,
                                                    title: `Deep Research Prompt for ${appState.companyContext?.companyName || 'Your Company'}`,
                                                    promptText: promptText
                                                });
                                            } catch (error) {
                                                console.error('Failed to generate prompt:', error);
                                                alert('Failed to generate research prompt. Please try again.');
                                            }
                                        }}
                                        className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
                                    >
                                        Generate Research Prompt
                                    </button>
                                    <button
                                        onClick={() => {
                                            // Find the last incomplete part
                                            const parts = ['segment', 'icp', 'positioning', 'category'];
                                            const nextPart = parts.find(p => !appState.navigationProgress.completedParts.includes(p));
                                            onNavigate(nextPart || 'segment');
                                        }}
                                        className="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold"
                                    >
                                        Continue Where You Left Off
                                    </button>
                                    <button
                                        onClick={() => {
                                            if (window.confirm('This will clear all your progress and form data. Are you sure?')) {
                                                // Clear all progress
                                                localStorage.removeItem('klarityCategoryBlueprintState');
                                                window.location.reload();
                                            }
                                        }}
                                        className="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-semibold"
                                    >
                                        Start Fresh
                                    </button>
                                </>
                            ) : (
                                <>
                                    <button
                                        onClick={() => {
                                            try {
                                                const promptText = generateDeepResearchPrompt(appState.companyContext);
                                                
                                                if (promptText && promptText.startsWith('Error generating prompt')) {
                                                    alert(promptText);
                                                    return;
                                                }
                                                
                                                setPromptModalData({
                                                    isOpen: true,
                                                    title: `Deep Research Prompt for ${appState.companyContext?.companyName || 'Your Company'}`,
                                                    promptText: promptText
                                                });
                                            } catch (error) {
                                                console.error('Failed to generate prompt:', error);
                                                alert('Failed to generate research prompt. Please try again.');
                                            }
                                        }}
                                        className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
                                    >
                                        Generate Research Prompt
                                    </button>
                                    <button
                                        onClick={() => onNavigate('segment')}
                                        className="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold text-xl"
                                    >
                                        Start Blueprint Process
                                    </button>
                                </>
                            )}
                        </div>

                        <p className="text-sm text-gray-500 mt-8 text-center max-w-2xl mx-auto">
                            Your progress is saved automatically in your browser. This data is private and is not sent to any server.
                        </p>

                        <footer className="text-center text-sm text-gray-500 py-8 mt-12">
                            Scale Venture Partners
                            {window.location.hostname === 'localhost' && (
                                <div className="mt-2">
                                    <button 
                                        onClick={() => {
                                            setShowCompanySetupModal(true);
                                        }}
                                        className="text-xs text-gray-400 hover:text-gray-600 underline cursor-pointer transition-colors"
                                    >
                                        Dev Tools: Show Company Setup
                                    </button>
                                </div>
                            )}
                        </footer>
                    </div>

                    <CompanySetupModal
                        isOpen={showCompanySetupModal}
                        onComplete={() => {
                            console.log('Modal onComplete called');
                            setShowCompanySetupModal(false);
                            saveAppState(appState);
                        }}
                        companyData={appState.companyContext || {}}
                        setCompanyData={(updater) => {
                            console.log('setCompanyData called with:', updater);
                            setAppState(prev => {
                                console.log('Previous state:', prev);
                                const updatedContext = typeof updater === 'function' 
                                    ? updater(prev.companyContext || {})
                                    : updater;
                                const newState = { ...prev, companyContext: updatedContext };
                                console.log('New state:', newState);
                                return newState;
                            });
                        }}
                    />
                    
                    <PromptDisplayModal
                        isOpen={promptModalData.isOpen}
                        onClose={() => setPromptModalData(prev => ({ ...prev, isOpen: false }))}
                        promptText={promptModalData.promptText}
                        title={promptModalData.title}
                    />
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const [appState, setAppState] = useState(() => {
                const savedState = loadAppState();
                const state = savedState || getInitialState();
                return state;
            });

            useEffect(() => {
                saveAppState(appState);
            }, [appState]);

            // Generate complete application data for home page export
            const generateFullApplicationData = () => {
                const formatFieldValue = (fieldValue) => {
                    if (Array.isArray(fieldValue)) {
                        return fieldValue.filter(item => item && item.toString().trim()).join('; ');
                    }
                    if (typeof fieldValue === 'object' && fieldValue !== null) {
                        return Object.entries(fieldValue)
                            .filter(([k, v]) => v && v.toString().trim())
                            .map(([k, v]) => `${k}: ${v}`)
                            .join('; ');
                    }
                    return fieldValue && fieldValue.toString().trim() || null;
                };

                // Build company object excluding null values
                const companyData = {};
                const companyName = formatFieldValue(appState.companyContext?.companyName);
                const companyWebsite = formatFieldValue(appState.companyContext?.companyWebsite);
                const industry = formatFieldValue(appState.companyContext?.industry);
                const productName = formatFieldValue(appState.companyContext?.productName);
                
                if (companyName) companyData.name = companyName;
                if (companyWebsite) companyData.website = companyWebsite;
                if (industry) companyData.industry = industry;
                if (productName) companyData.productName = productName;

                return {
                    metadata: {
                        exportDate: new Date().toISOString(),
                        exportType: "Complete Application Data",
                        company: companyData
                    },
                    parts: {
                        segmentFoundation: {
                            partName: "Segment Foundation",
                            partNumber: 1,
                            jobsToBeDone: {
                                "Context": formatFieldValue(appState.segmentData?.['Context']),
                                "Struggling Moments": formatFieldValue(appState.segmentData?.['Struggling Moments']),
                                "Pushes & Pulls": formatFieldValue(appState.segmentData?.['Pushes & Pulls']),
                                "Anxieties & Habits": formatFieldValue(appState.segmentData?.['Anxieties & Habits']),
                                "Desired Outcomes": formatFieldValue(appState.segmentData?.['Desired Outcomes']),
                                "Basic Quality (Table Stakes)": formatFieldValue(appState.segmentData?.['Basic Quality (Table Stakes)']),
                                "Hiring Criteria": formatFieldValue(appState.segmentData?.['Hiring Criteria']),
                                "Firing Criteria": formatFieldValue(appState.segmentData?.['Firing Criteria']),
                                "Key Trade-offs": formatFieldValue(appState.segmentData?.['Key Trade-offs'])
                            },
                            customerValue: {
                                "Table Stakes": formatFieldValue(appState.segmentData?.['Table Stakes']),
                                "Functional Value": formatFieldValue(appState.segmentData?.['Functional Value']),
                                "Ease of Doing Business": formatFieldValue(appState.segmentData?.['Ease of Doing Business']),
                                "Individual Value": formatFieldValue(appState.segmentData?.['Individual Value']),
                                "Aspirational Value": formatFieldValue(appState.segmentData?.['Aspirational Value'])
                            },
                            willingnessToPay: {
                                "Ability to Pay": formatFieldValue(appState.segmentData?.['Ability to Pay']),
                                "Economic Justification": formatFieldValue(appState.segmentData?.['Economic Justification']),
                                "Relative Value vs. Alternatives": formatFieldValue(appState.segmentData?.['Relative Value vs. Alternatives']),
                                "Risk & Switching Costs": formatFieldValue(appState.segmentData?.['Risk & Switching Costs']),
                                "Market Reference Points": formatFieldValue(appState.segmentData?.['Market Reference Points'])
                            }
                        },
                        icpDefinition: {
                            partName: "ICP Definition",
                            partNumber: 2,
                            data: appState.positioningData ? Object.keys(appState.positioningData)
                                .filter(key => key.startsWith('icp_'))
                                .reduce((obj, key) => {
                                    const formattedValue = formatFieldValue(appState.positioningData[key]);
                                    if (formattedValue) obj[key] = formattedValue;
                                    return obj;
                                }, {}) : {}
                        },
                        positioning: {
                            partName: "Positioning",
                            partNumber: 3,
                            data: appState.positioningData ? Object.keys(appState.positioningData)
                                .filter(key => !key.startsWith('icp_'))
                                .reduce((obj, key) => {
                                    const formattedValue = formatFieldValue(appState.positioningData[key]);
                                    if (formattedValue) obj[key] = formattedValue;
                                    return obj;
                                }, {}) : {}
                        },
                        categoryDesign: {
                            partName: "Category Design",
                            partNumber: 4,
                            data: appState.categoryData ? Object.keys(appState.categoryData)
                                .reduce((obj, key) => {
                                    const formattedValue = formatFieldValue(appState.categoryData[key]);
                                    if (formattedValue) obj[key] = formattedValue;
                                    return obj;
                                }, {}) : {}
                        }
                    }
                };
            };

            // Home Page Export Handler - Complete Application Data
            const handleHomePageExport = () => {
                const fullAppData = generateFullApplicationData();
                
                const jsonData = JSON.stringify(fullAppData, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'category-blueprint-complete-export.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            // Helper function to mark a part as completed
            const markPartAsCompleted = (partId) => {
                setAppState(prev => {
                    const updatedCompletedParts = prev.navigationProgress.completedParts.includes(partId)
                        ? prev.navigationProgress.completedParts
                        : [...prev.navigationProgress.completedParts, partId];
                    
                    return {
                        ...prev,
                        navigationProgress: {
                            ...prev.navigationProgress,
                            completedParts: updatedCompletedParts,
                            partCompletionData: {
                                ...prev.navigationProgress.partCompletionData,
                                [partId]: {
                                    completed: true,
                                    completedAt: new Date().toISOString()
                                }
                            }
                        }
                    };
                });
            };

            const navigate = (view) => {
                setAppState(prev => {
                    const newState = { ...prev, currentView: view };
                    
                    // Update navigationProgress for workflow pages
                    if (['segment', 'icp', 'positioning', 'category'].includes(view)) {
                        newState.navigationProgress = {
                            ...prev.navigationProgress,
                            currentPart: view
                        };
                    }
                    
                    return newState;
                });
            };

            const renderCurrentView = () => {
                switch (appState.currentView) {
                    // case 'analysis': - REMOVED for simplification
                    case 'segment':
                        return <SegmentFoundationTool appState={appState} setAppState={setAppState} onNavigate={navigate} markPartAsCompleted={markPartAsCompleted} />;
                    case 'icp':
                        return <ICPDefinitionTool appState={appState} setAppState={setAppState} onNavigate={navigate} markPartAsCompleted={markPartAsCompleted} />;
                    case 'positioning':
                        return <PositioningTool appState={appState} setAppState={setAppState} onNavigate={navigate} markPartAsCompleted={markPartAsCompleted} />;
                    case 'category':
                        return <CategoryDesignTool appState={appState} setAppState={setAppState} onNavigate={navigate} markPartAsCompleted={markPartAsCompleted} />;
                    case 'home':
                    default:
                        return <Home appState={appState} setAppState={setAppState} onNavigate={navigate} onExport={handleHomePageExport} />;
                }
            };

            // Show progress stepper only on workflow pages
            const showProgressStepper = ['segment', 'icp', 'positioning', 'category'].includes(appState.currentView);

            
            return (
                <div>
                    {showProgressStepper && (
                        <ProgressStepper
                            currentPart={appState.currentView}
                            completedParts={appState.navigationProgress.completedParts}
                            onNavigate={navigate}
                            appState={appState}
                            saveAppState={saveAppState}
                        />
                    )}
                    {renderCurrentView()}
                </div>
            );
        };

        
        const container = document.getElementById('root');
        if (container) {
            try {
                const root = ReactDOM.createRoot(container);
                
                root.render(<App />);
            } catch (error) {
                serverLog('error', 'Failed to create or render React root', error);
            }
        } else {
            serverLog('error', 'Root container not found!');
        }
    </script>
</body>
</html>