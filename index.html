<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<!--
    ================================================================================================
    INTERACTIVE GTM BLUEPRINT SERIES - SINGLE PAGE APPLICATION (SPA)
    ================================================================================================
    
    PROJECT EVOLUTION:
    This file represents the evolution from a 3-file system to a unified Single Page Application.
    
    ORIGINAL ARCHITECTURE (3 files):
    1. positioning.html - Standalone page for Part 1: ICP & Positioning
    2. category_design.html - Standalone page for Part 2: Category Design  
    3. index.html - Simple landing page with links to the two tools
    
    CURRENT ARCHITECTURE (1 file):
    - index.html (this file) - Complete SPA containing all functionality:
      * Home page with navigation cards
      * Full ICPDefinitionTool (Part 1)
      * Full Category Design Tool (Part 2)
      * Unified state management with localStorage persistence
      * Seamless navigation between all views
      * Consistent branding and user experience
    
    WHY THE CHANGE:
    1. Better User Experience - No page reloads, instant navigation, persistent state
    2. Code Reusability - Shared components, consistent styling, DRY principles
    3. Maintainability - Single source of truth, no duplicate code to sync
    4. State Management - Data flows seamlessly between tools using React state
    5. Modern Architecture - Follows current web development best practices
    
    TECHNICAL APPROACH:
    - React 18 with CDN loading (no build process required)
    - Babel standalone for JSX transformation in the browser
    - Tailwind CSS for styling
    - localStorage for data persistence
    - Component-based architecture with shared state
    
    NOTE: The original positioning.html and category_design.html files have been archived
    in the /archive directory for reference, but are no longer needed or maintained.
    ================================================================================================
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive GTM Blueprint Series</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700&family=Work+Sans:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f6f6f6;
        }
        h1, h2, h3, button {
            font-family: 'Work Sans', sans-serif;
        }
        .scale-gold-text { color: #e5a819; }
        .scale-gold-bg { background-color: #e5a819; }
        .scale-gold-border { border-color: #e5a819; }
        .scale-green-text { color: #224f41; }
        .scale-green-bg { background-color: #224f41; }
        .scale-blue-bg { background-color: #0d71a9; }
        .scale-blue-text { color: #0d71a9; }
        .nav-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .nav-card:hover {
            transform: translateY(-0.5rem);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        .nav-link {
            transition: all 0.2s ease-in-out;
        }
        .nav-link:hover {
            background-color: #faeed1;
            color: #224f41;
        }
        .nav-link.active {
            background-color: #e5a819;
            color: #224f41;
            font-weight: 700;
        }
        .nav-link.active:hover {
            background-color: #faeed1;
            color: #224f41;
        }
        textarea, input[type="text"] {
            font-family: 'Outfit', sans-serif;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        textarea:focus, input[type="text"]:focus {
            border-color: #e5a819;
            box-shadow: 0 0 0 2px rgba(229, 168, 25, 0.4);
            outline: none;
        }
        .progress-bar-fill {
            transition: width 0.5s ease-in-out;
        }
        /* Ensure sticky header works properly */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 40;
            background: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        /* Sticky section headers */
        .sticky-section-header {
            position: sticky;
            top: 0;
            background: white;
            z-index: 30;
            padding: 16px 0;
            margin-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }
    </style>
</head>
<body class="text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        /*
         * ============================================================================================ 
         * REACT SINGLE PAGE APPLICATION IMPLEMENTATION
         * ============================================================================================ 
         * 
         * This React application consolidates what was previously three separate HTML files:
         * 1. A simple index.html with navigation links
         * 2. positioning.html for the ICP & Positioning tool
         * 3. category_design.html for the Category Design tool
         * 
         * KEY COMPONENTS:
         * - HomeView: Landing page with navigation cards (replaces old index.html content)
         * - SegmentFoundationTool: Placeholder for Part 1
         * - ICPDefinitionTool: Complete Part 2 functionality (replaces positioning.html)
         * - CategoryDesignTool: Complete Part 3 functionality (replaces category_design.html)
         * - App: Main component that manages routing and global state
         * p
         * STATE MANAGEMENT:
         * - All form data is stored in a unified appState object
         * - State persists to localStorage automatically on changes
         * - Data flows seamlessly between tools (e.g., ICP data appears in Category Design)
         * 
         * BENEFITS OVER 3-FILE SYSTEM:
         * - No data loss when navigating between tools
         * - Consistent UI/UX across all views
         * - Single codebase to maintain
         * - Better performance (no full page reloads)
         * - Easier to add new features that span multiple tools
         * ============================================================================================ 
         */
        
        const { useState, useEffect, useRef } = React;

        // localStorage helper functions
        const saveAppState = (state) => {
          try {
            const stateWithTimestamp = {
              ...state,
              lastSaved: new Date().toISOString()
            };
            localStorage.setItem('klarityGTMBlueprintState', JSON.stringify(stateWithTimestamp));
          } catch (error) {
            console.error("Could not save state to localStorage", error);
          }
        };

        const loadAppState = () => {
          try {
            const savedState = localStorage.getItem('klarityGTMBlueprintState');
            if (!savedState) return null;
            
            const parsedState = JSON.parse(savedState);
            
            // Validate state structure - check for required top-level properties
            if (parsedState && 
                typeof parsedState === 'object' && 
                parsedState.hasOwnProperty('positioningData') && 
                parsedState.hasOwnProperty('categoryData') &&
                parsedState.hasOwnProperty('segmentData')) {
              return parsedState;
            }
            
            // Invalid structure - return null to use default state
            return null;
          } catch (error) {
            console.error("Could not load state from localStorage", error);
            return null;
          }
        };

        // Format timestamp for display
        const formatLastSaved = (isoString) => {
          if (!isoString) return null;
          try {
            const date = new Date(isoString);
            return date.toLocaleTimeString('en-US', { 
              hour: 'numeric', 
              minute: '2-digit',
              hour12: true 
            });
          } catch (error) {
            return null;
          }
        };

        // Initial state structure
        const getInitialState = () => ({
          positioningData: {
            icp_common_needs: '',
            icp_desired_business_value: '',
            icp_problem_urgency: '',
            icp_quick_decision_making: '',
            icp_prioritized_requirements: '',
            icp_willingness_to_pay: '',
            icp_implementation_readiness: '',
            icp_firmographic: '',
            icp_technographic: '',
            icp_behavioral: '',
            icp_summary: '',
            'market-context': '',
            'market-context-other': '',
            alternatives: [{ val1: '', val2: '' }],
            pillars: [{ id: 1, name: '', benefit: '' }],
            values: [{ val1: '', val2: '', val3: '', pillarId: null }],
            trend1_desc: '',
            trend2_desc: '',
            trend3_desc: '',
            trend4_desc: ''
          },
          categoryData: {
            'from-statement': '',
            'to-statement': '',
            'new-opportunity': '',
            'category-name': '',
            'category-definition': '',
            'manifesto': ''
          },
          segmentData: {},
          companyContext: {
            isSetupComplete: false,
            companyName: '',
            companyWebsite: '',
            industry: '',
            productName: '',
            targetMarket: 'B2B',
            caseStudyUrls: [],
            documentationUrls: [],
            competitorNames: ['', '', '']
          },
          currentView: 'home'
        });

        // Home Component
        const Home = ({ onNavigate }) => (
            <div className="container mx-auto px-4 sm:px-6 lg:px-8">
                <div className="min-h-screen flex flex-col items-center justify-center">
                    <header className="text-center mb-12">
                        <h1 className="text-4xl md:text-5xl font-bold scale-green-text">Interactive GTM Blueprint Series</h1>
                        <p className="mt-4 text-lg text-gray-600 max-w-2xl mx-auto">A guided, step-by-step workshop to define your market segment, ideal customer, and category.</p>
                    </header>

                    <main className="w-full max-w-md text-center">
                        <button 
                            onClick={() => onNavigate('segment')}
                            className="w-full scale-green-bg text-white font-bold text-xl py-4 px-8 rounded-xl shadow-lg hover:bg-opacity-90 transition-transform transform hover:scale-105"
                        >
                            Start the Blueprint →
                        </button>
                    </main>

                    <p className="text-sm text-gray-500 mt-8 text-center max-w-2xl mx-auto">
                        Your progress is saved automatically in your browser. This data is private and is not sent to any server.
                    </p>

                    <footer className="text-center text-sm text-gray-500 py-8 mt-12">
                        Scale Venture Partners
                    </footer>
                </div>
            </div>
        );

        // Export Modal Component
        const ExportModal = ({ isOpen, onClose, title, content, appState, filename = 'gtm-blueprint-export' }) => {
            const [copied, setCopied] = useState(false);

            const handleCopy = () => {
                navigator.clipboard.writeText(content).then(() => {
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                });
            };

            const handleDownloadJSON = () => {
                const jsonData = JSON.stringify(appState, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
                        <div className="flex justify-between items-center p-4 border-b">
                            <h2 className="text-2xl font-bold scale-green-text">{title}</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-800 text-3xl font-light">×</button>
                        </div>
                        <div className="p-6 overflow-y-auto">
                            <pre className="whitespace-pre-wrap text-sm bg-gray-50 p-4 rounded-md font-mono">{content}</pre>
                        </div>
                        <div className="p-4 border-t bg-gray-50 flex justify-end space-x-3">
                            <button 
                                onClick={handleDownloadJSON}
                                className="border border-gray-300 text-gray-600 font-bold py-2 px-4 rounded-lg hover:bg-gray-50 transition-colors"
                            >
                                Download JSON
                            </button>
                            <button 
                                onClick={handleCopy}
                                className="scale-green-bg text-white font-bold py-2 px-4 rounded-lg hover:bg-opacity-90"
                            >
                                {copied ? 'Copied!' : 'Copy to Clipboard'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // CompanySetupModal Component - temporarily removed for debugging

        // JTBD Analysis Modal Component
        const JTBDModal = ({ isOpen, onClose, analysisData, setAnalysisData, onSave }) => {
            if (!isOpen) return null;

            const jtbdFields = [
                { key: 'context', label: 'Context', description: 'The business situation or operating environment' },
                { key: 'strugglingMoments', label: 'Struggling Moments', description: 'Breakdowns, inefficiencies, or risks that trigger the search' },
                { key: 'pushesPulls', label: 'Pushes & Pulls', description: 'Internal and external forces moving toward or away from change' },
                { key: 'anxietiesHabits', label: 'Anxieties & Habits', description: 'Concerns about new solutions and inertia with current processes' },
                { key: 'desiredOutcomes', label: 'Desired Outcomes', description: 'Business goals and success metrics they want to achieve' },
                { key: 'basicQuality', label: 'Basic Quality (Table Stakes)', description: 'Minimum standards a solution must meet to be considered' },
                { key: 'hiringCriteria', label: 'Hiring Criteria', description: 'Differentiators that make them select one vendor' },
                { key: 'firingCriteria', label: 'Firing Criteria', description: 'Triggers that get a vendor rejected or replaced' },
                { key: 'keyTradeoffs', label: 'Key Trade-offs', description: 'Acceptable compromises or limits' }
            ];

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col">
                        <div className="flex justify-between items-center p-6 border-b">
                            <div>
                                <h2 className="text-2xl font-bold scale-green-text">AI-Assisted JTBD Structuring</h2>
                                <p className="text-sm text-gray-600 mt-1">Bottom-up breadcrumb analysis of your Common Needs text</p>
                            </div>
                            <button 
                                onClick={onClose}
                                className="text-gray-400 hover:text-gray-600 text-3xl font-light"
                            >
                                ×
                            </button>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-6">
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                {/* Original Text Column */}
                                <div>
                                    <h3 className="text-lg font-bold mb-4">Original Text</h3>
                                    <div className="bg-gray-50 border border-gray-200 rounded-lg p-4 h-full min-h-[200px]">
                                        <p className="text-gray-800 whitespace-pre-wrap">
                                            {analysisData.originalText || 'No text provided'}
                                        </p>
                                    </div>
                                </div>

                                {/* JTBD Elements Column */}
                                <div>
                                    <h3 className="text-lg font-bold mb-4">9 JTBD Elements</h3>
                                    <div className="space-y-4">
                                        {jtbdFields.map(field => (
                                            <div key={field.key}>
                                                <label className="block font-semibold text-gray-700 mb-1">
                                                    {field.label}
                                                </label>
                                                <p className="text-xs text-gray-500 mb-2">{field.description}</p>
                                                <textarea 
                                                    className="w-full p-3 border border-gray-300 rounded-md text-sm"
                                                    rows="3" 
                                                    value={analysisData[field.key] || ''}
                                                    onChange={(e) => setAnalysisData(prev => ({
                                                        ...prev,
                                                        [field.key]: e.target.value
                                                    }))}
                                                    placeholder={`AI analysis will appear here...`}
                                                />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div className="flex justify-end space-x-4 p-6 border-t">
                            <button 
                                onClick={onClose}
                                className="px-6 py-2 border border-gray-300 rounded-lg font-semibold text-gray-700 hover:bg-gray-50"
                            >
                                Cancel
                            </button>
                            <button 
                                onClick={onSave}
                                className="px-6 py-2 scale-green-bg text-white font-bold rounded-lg hover:bg-opacity-90"
                            >
                                Save Structured JTBD
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // F-8: Pillar Generation Modal Component
        const PillarGenerationModal = ({ isOpen, onClose, pillarGenState, onGeneratePillars, onAcceptPillar, onRefinePillar, onRefinementInputChange }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50">
                    <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="p-6 border-b border-gray-200">
                            <div className="flex items-center justify-between">
                                <h2 className="text-xl font-bold text-scale-dark-green">
                                    AI-Powered Pillar Generation
                                </h2>
                                <button 
                                    onClick={onClose}
                                    className="text-gray-500 hover:text-gray-700 text-xl font-bold"
                                >
                                    ×
                                </button>
                            </div>
                            <p className="text-sm text-gray-600 mt-2">
                                AI analyzes your value propositions to suggest strategic pillars with transparent reasoning.
                            </p>
                        </div>
                        
                        <div className="p-6">
                            {/* Loading State */}
                            {pillarGenState.isGenerating && (
                                <div className="text-center py-8">
                                    <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-scale-dark-green"></div>
                                    <p className="mt-4 text-gray-600">AI is analyzing your value propositions...</p>
                                </div>
                            )}
                            
                            {/* Error State */}
                            {pillarGenState.error && (
                                <div className="bg-red-50 border border-red-200 rounded-md p-4 mb-6">
                                    <p className="text-red-800">{pillarGenState.error}</p>
                                </div>
                            )}
                            
                            {/* Pillar Suggestions */}
                            {!pillarGenState.isGenerating && pillarGenState.suggestedPillars.length > 0 && (
                                <div className="space-y-6">
                                    <h3 className="text-lg font-bold text-scale-dark-green mb-4">
                                        AI-Suggested Strategic Pillars
                                    </h3>
                                    
                                    {pillarGenState.suggestedPillars.map((pillar, index) => (
                                        <div key={pillar.id} className="border border-gray-200 rounded-lg p-4 bg-gray-50">
                                            <div className="mb-4">
                                                <h4 className="font-bold text-scale-dark-green text-lg mb-2">
                                                    {pillar.pillarName}
                                                </h4>
                                                <p className="text-gray-700 mb-3">
                                                    {pillar.benefitStatement}
                                                </p>
                                                
                                                <div className="mb-3">
                                                    <h5 className="font-semibold text-gray-800 mb-1">AI Rationale:</h5>
                                                    <p className="text-sm text-gray-600 italic">
                                                        {pillar.rationale}
                                                    </p>
                                                </div>
                                                
                                                <div>
                                                    <h5 className="font-semibold text-gray-800 mb-2">Supporting Value Propositions:</h5>
                                                    <ul className="list-disc list-inside text-sm text-gray-600 space-y-1">
                                                        {pillar.supportingAttributeIds.map(id => {
                                                            const prop = (appState.positioningData.values || [])[id];
                                                            if (prop && (prop.val1 || prop.val2 || prop.val3)) {
                                                                return (
                                                                    <li key={id}>
                                                                        <strong>Attribute:</strong> {prop.val1} →
                                                                        <strong> Benefit:</strong> {prop.val2} →
                                                                        <strong> Value:</strong> {prop.val3}
                                                                    </li>
                                                                );
                                                            }
                                                            return null;
                                                        })}
                                                    </ul>
                                                </div>
                                            </div>
                                            
                                            <div className="flex flex-col space-y-3 pt-4 border-t border-gray-300">
                                                <div className="flex space-x-3">
                                                    <button 
                                                        onClick={() => onAcceptPillar(pillar)}
                                                        className="px-4 py-2 scale-green-bg text-white font-bold rounded-lg hover:bg-opacity-90"
                                                    >
                                                        Accept & Edit
                                                    </button>
                                                </div>
                                                
                                                <div className="flex flex-col space-y-2">
                                                    <label className="text-sm font-semibold text-gray-700">
                                                        Refine with AI:
                                                    </label>
                                                    <div className="flex space-x-2">
                                                        <input
                                                            type="text"
                                                            className="flex-1 p-2 border border-gray-300 rounded-md focus-ring-gold"
                                                            placeholder="e.g., 'Make this more technical' or 'Focus on cost savings'"
                                                            value={pillarGenState.refinementInputs[pillar.id] || ''}
                                                            onChange={(e) => onRefinementInputChange(pillar.id, e.target.value)}
                                                        />
                                                        <button 
                                                            onClick={() => onRefinePillar(pillar, pillarGenState.refinementInputs[pillar.id])}
                                                            disabled={!pillarGenState.refinementInputs[pillar.id]?.trim()}
                                                            className="px-4 py-2 bg-scale-blue text-white font-bold rounded-lg hover:bg-opacity-90 disabled:bg-gray-300 disabled:cursor-not-allowed"
                                                        >
                                                            Update
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                            
                            {/* Empty State */}
                            {!pillarGenState.isGenerating && pillarGenState.suggestedPillars.length === 0 && !pillarGenState.error && (
                                <div className="text-center py-8">
                                    <p className="text-gray-600 mb-4">
                                        Click "Generate Strategic Pillars" to begin AI analysis of your value propositions.
                                    </p>
                                </div>
                            )}
                        </div>
                        
                        <div className="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                            <button 
                                onClick={onClose}
                                className="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                            >
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Dynamic Field Components
        const RemovableRow = ({ index, item, onUpdate, onRemove, placeholder1, placeholder2, onAnalyze, analysisResult }) => (
            <div className="space-y-3">
                <div className="flex items-center space-x-2">
                    <input 
                        type="text" 
                        className="w-1/2 p-2 border border-gray-300 rounded-md focus-ring-gold"
                        placeholder={placeholder1}
                        value={item.val1}
                        onChange={(e) => onUpdate(index, 'val1', e.target.value)}
                    />
                    <textarea 
                        className="w-1/2 p-2 border border-gray-300 rounded-md focus-ring-gold"
                        rows="3" 
                        placeholder={placeholder2}
                        value={item.val2}
                        onChange={(e) => onUpdate(index, 'val2', e.target.value)}
                    ></textarea>
                    <div className="flex flex-col space-y-2">
                        <button 
                            onClick={() => onRemove(index)}
                            className="text-gray-400 hover:text-red-600 font-bold text-2xl transition-colors"
                        >
                            ×
                        </button>
                        {onAnalyze && (
                            <button 
                                onClick={() => onAnalyze(item, index)}
                                disabled={analysisResult?.isAnalyzing}
                                className="text-xs font-bold py-1 px-2 rounded transition-colors bg-blue-100 hover:bg-blue-200 text-blue-700 disabled:opacity-50"
                            >
                                {analysisResult?.isAnalyzing ? 'Analyzing...' : 'Analyze Weakness'}
                            </button>
                        )}
                    </div>
                </div>
                
                {analysisResult && !analysisResult.isAnalyzing && analysisResult.angles && (
                    <div className="bg-white p-4 rounded-md border-l-4 border-blue-500 shadow-sm">
                        <div className="flex items-center justify-between mb-3">
                            <h4 className="text-sm font-bold text-gray-800">Strategic Angles</h4>
                            <span className="text-xs text-gray-500">{analysisResult.angles.length} talking points</span>
                        </div>
                        <ul className="space-y-2">
                            {analysisResult.angles.map((angle, idx) => (
                                <li key={idx} className="text-sm text-gray-700 flex items-start">
                                    <span className="inline-block w-2 h-2 bg-blue-500 rounded-full mr-3 mt-1.5 flex-shrink-0"></span>
                                    <span>{angle}</span>
                                </li>
                            ))}
                        </ul>
                        <button 
                            onClick={() => {
                                const text = analysisResult.angles.join('\n• ');
                                navigator.clipboard.writeText(`Strategic angles for ${item.val1}:\n• ${text}`);
                            }}
                            className="mt-3 text-xs text-blue-600 hover:text-blue-800 font-medium"
                        >
                            Copy talking points
                        </button>
                    </div>
                )}
            </div>
        );

        const RemovableInput = ({ index, item, onUpdate, onRemove, placeholder }) => (
            <div className="flex items-center space-x-2">
                <input 
                    type="text" 
                    className="w-full p-2 border border-gray-300 rounded-md focus-ring-gold"
                    placeholder={placeholder}
                    value={item.value}
                    onChange={(e) => onUpdate(index, 'value', e.target.value)}
                />
                <button 
                    onClick={() => onRemove(index)}
                    className="text-gray-400 hover:text-red-600 font-bold text-2xl transition-colors"
                >
                    ×
                </button>
            </div>
        );

        const RemovableTriple = ({ index, item, onUpdate, onRemove, onGrade, gradingResult, onAnalyzeUniqueness, uniquenessResult, pillars }) => (
            <div className="p-4 border border-gray-200 rounded-lg space-y-3 bg-gray-50">
                <div className="flex items-start space-x-2">
                    <div className="flex-grow">
                        <label className="block text-sm font-semibold text-gray-700 mb-1">
                            Truly Unique Attribute: The Feature or Capability
                        </label>
                        <input 
                            type="text" 
                            className="w-full p-2 border border-gray-300 rounded-md focus-ring-gold"
                            placeholder="Example: Day-one insights from existing documents"
                            value={item.val1}
                            onChange={(e) => onUpdate(index, 'val1', e.target.value)}
                        />
                    </div>
                    <button 
                        onClick={() => onRemove(index)}
                        className="mt-6 text-gray-400 hover:text-red-600 font-bold text-2xl transition-colors"
                    >
                        ×
                    </button>
                </div>
                <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-1">
                        Benefit: What the attribute enables for a customer
                    </label>
                    <textarea 
                        className="w-full p-2 border border-gray-300 rounded-md focus-ring-gold"
                        rows="2" 
                        placeholder="Example: Enables immediate analysis without lengthy discovery interviews"
                        value={item.val2}
                        onChange={(e) => onUpdate(index, 'val2', e.target.value)}
                    ></textarea>
                </div>
                <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-1">
                        Value: The metrics and KPIs the customer use to measure value created by this attribute
                    </label>
                    <input 
                        type="text" 
                        className="w-full p-2 border border-gray-300 rounded-md focus-ring-gold"
                        placeholder="Example: Reduces transformation timeline by 6 months, saving $500k in consulting fees"
                        value={item.val3}
                        onChange={(e) => onUpdate(index, 'val3', e.target.value)}
                    />
                </div>
                <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-1">
                        Strategic Pillar
                    </label>
                    <select 
                        className="w-full p-2 border border-gray-300 rounded-md focus-ring-gold"
                        value={item.pillarId || ''}
                        onChange={(e) => onUpdate(index, 'pillarId', e.target.value ? parseInt(e.target.value) : null)}
                    >
                        <option value="">Select a pillar...</option>
                        {(pillars || []).map((pillar) => (
                            <option key={pillar.id} value={pillar.id}>
                                {pillar.name || `Pillar ${pillar.id}`}
                            </option>
                        ))}
                    </select>
                </div>
                <div className="pt-2 space-y-3">
                    <div className="flex space-x-2">
                        <button 
                            className="text-sm font-bold py-2 px-3 rounded-lg transition-colors bg-gray-200 hover:bg-gray-300 text-gray-700 disabled:opacity-50"
                            onClick={() => onGrade(item, index)}
                            disabled={gradingResult?.isGrading}
                        >
                            {gradingResult?.isGrading ? 'Grading...' : 'Grade Proposition'}
                        </button>
                        <button 
                            className="text-sm font-bold py-2 px-3 rounded-lg transition-colors scale-blue-bg hover:bg-blue-700 text-white disabled:opacity-50"
                            onClick={() => onAnalyzeUniqueness(item.val1, index)}
                            disabled={uniquenessResult?.isAnalyzing || !item.val1?.trim()}
                        >
                            {uniquenessResult?.isAnalyzing ? 'Analyzing market...' : 'Analyze Uniqueness'}
                        </button>
                    </div>
                    
                    {gradingResult && !gradingResult.isGrading && gradingResult.score && (
                        <div className="bg-white p-3 rounded-md border border-gray-300">
                            <div className="flex items-center justify-between mb-2">
                                <span className="text-sm font-bold text-gray-700">AI Grade:</span>
                                <span 
                                    className={`text-lg font-bold px-2 py-1 rounded ${ 
                                        gradingResult.score.startsWith('A') ? 'bg-green-100 text-green-800' :
                                        gradingResult.score.startsWith('B') ? 'bg-yellow-100 text-yellow-800' :
                                        'bg-red-100 text-red-800'
                                    }`}
                                >
                                    {gradingResult.score}
                                </span>
                            </div>
                            <p className="text-sm text-gray-600 leading-relaxed">
                                {gradingResult.feedback}
                            </p>
                        </div>
                    )}

                    {uniquenessResult && !uniquenessResult.isAnalyzing && (
                        <div className="bg-white p-3 rounded-md border border-gray-300">
                            <div className="mb-2">
                                <span className="text-sm font-bold text-gray-700">Uniqueness Analysis:</span>
                            </div>
                            {uniquenessResult.error ? (
                                <div className="text-sm text-red-600">
                                    {uniquenessResult.error}
                                </div>
                            ) : uniquenessResult.results && uniquenessResult.results.length > 0 ? (
                                <div className="space-y-2">
                                    {uniquenessResult.results.slice(0, 3).map((result, idx) => (
                                        <div key={idx} className="text-sm text-gray-600">
                                            <a href={result.url} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:text-blue-800 font-medium">
                                                {result.title}
                                            </a>
                                            <p className="text-xs text-gray-500 mt-1">{result.description}</p>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="text-sm text-green-600 font-medium">
                                    No similar claims found - this appears to be a unique attribute!
                                </div>
                            )}
                        </div>
                    )}
                </div>
            </div>
        );

        // SegmentFoundationTool Component
        const SegmentFoundationTool = ({ appState, setAppState, onNavigate }) => {
            console.log('SegmentFoundationTool rendering, appState:', appState);
            const [exportModalOpen, setExportModalOpen] = useState(false);
            const [exportContent, setExportContent] = useState('');
            
            // AI Draft State Variables
            const [aiDraftLoading, setAiDraftLoading] = useState(false);
            const [aiDraftsAvailable, setAiDraftsAvailable] = useState(false);
            const [aiDraftError, setAiDraftError] = useState(null);
            
            // WTP AI Draft State Variables
            const [wtpDraftLoading, setWtpDraftLoading] = useState(false);
            const [wtpDraftsAvailable, setWtpDraftsAvailable] = useState(false);
            const [wtpDraftError, setWtpDraftError] = useState(null);

            const handleReset = () => {
                if (window.confirm('Are you sure you want to reset all segment data? This action cannot be undone.')) {
                    setAppState(prev => ({ ...prev, segmentData: {} }));
                }
            };

            const generateExportContent = () => {
                const formatSection = (title, fields) => {
                    let section = `## ${title}\n`;
                    fields.forEach(field => {
                        const value = appState.segmentData[field] || 'Not provided';
                        section += `**${field}:** ${value}\n\n`;
                    });
                    return section;
                };
                
                let summary = `# Segment Foundation Summary\n\n`;
                
                summary += formatSection('Jobs To Be Done', [
                    'Context',
                    'Struggling Moments', 
                    'Pushes & Pulls',
                    'Anxieties & Habits',
                    'Desired Outcomes',
                    'Basic Quality (Table Stakes)',
                    'Hiring Criteria',
                    'Firing Criteria',
                    'Key Trade-offs'
                ]);
                
                summary += formatSection('Customer Value', [
                    'Table Stakes',
                    'Functional Value',
                    'Ease of Doing Business', 
                    'Individual Value',
                    'Aspirational Value'
                ]);
                
                summary += formatSection('Willingness to Pay', [
                    'Ability to Pay',
                    'Economic Justification',
                    'Relative Value vs. Alternatives',
                    'Risk',
                    'Market Reference Points'
                ]);
                
                return summary;
            };
            
            const handleExport = () => {
                const content = generateExportContent();
                setExportContent(content);
                setExportModalOpen(true);
            };
            
            // AI Customer Value Generation Handler
            const handleGenerateCustomerValue = async () => {
                setAiDraftLoading(true);
                setAiDraftError(null);
                
                try {
                    const jtbdFields = ['Context', 'Struggling Moments', 'Pushes & Pulls', 'Anxieties & Habits', 'Desired Outcomes', 'Basic Quality (Table Stakes)', 'Hiring Criteria', 'Firing Criteria', 'Key Trade-offs'];
                    const filledFields = jtbdFields.filter(field => appState.segmentData[field]?.trim());
                    
                    if (filledFields.length < 3) {
                        setAiDraftError('Please complete at least 3 Jobs-to-be-Done fields before using the AI assistant.');
                        setAiDraftLoading(false);
                        return;
                    }
                    
                    const response = await fetch('/api/draft-customer-value', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            jtbdData: appState.segmentData
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API call failed: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success && data.drafts) {
                        // Update segmentData with AI-generated drafts
                        setAppState(prev => ({
                            ...prev,
                            segmentData: {
                                ...prev.segmentData,
                                'Table Stakes': data.drafts['Table Stakes'],
                                'Functional Value': data.drafts['Functional Value'],
                                'Ease of Doing Business': data.drafts['Ease of Doing Business'],
                                'Individual Value': data.drafts['Individual Value'],
                                'Aspirational Value': data.drafts['Aspirational Value']
                            }
                        }));
                        
                        setAiDraftsAvailable(true);
                    } else {
                        throw new Error(data.error || 'AI generation failed');
                    }
                } catch (error) {
                    console.error('AI Customer Value Generation Error:', error);
                    setAiDraftError(error.message || 'AI assistant is currently unavailable. Please try again later.');
                }
                
                setAiDraftLoading(false);
            };
            
            // AI WTP Generation Handler
            const handleGenerateWTP = async () => {
                setWtpDraftLoading(true);
                setWtpDraftError(null);
                
                try {
                    const customerValueFields = ['Table Stakes', 'Functional Value', 'Ease of Doing Business', 'Individual Value', 'Aspirational Value'];
                    const hasCustomerValue = customerValueFields.some(field => appState.segmentData[field]?.trim());
                    
                    if (!hasCustomerValue) {
                        setWtpDraftError('Please complete the Customer Value section first before generating WTP drivers.');
                        setWtpDraftLoading(false);
                        return;
                    }
                    
                    const response = await fetch('/api/draft-wtp-value', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            jtbdData: appState.segmentData,
                            customerValueData: {
                                'Table Stakes': appState.segmentData['Table Stakes'],
                                'Functional Value': appState.segmentData['Functional Value'],
                                'Ease of Doing Business': appState.segmentData['Ease of Doing Business'],
                                'Individual Value': appState.segmentData['Individual Value'],
                                'Aspirational Value': appState.segmentData['Aspirational Value']
                            }
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API call failed: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success && data.drafts) {
                        // Update segmentData with AI-generated WTP drafts
                        setAppState(prev => ({
                            ...prev,
                            segmentData: {
                                ...prev.segmentData,
                                'Ability to Pay': data.drafts['Ability to Pay'],
                                'Economic Justification': data.drafts['Economic Justification'],
                                'Relative Value vs. Alternatives': data.drafts['Relative Value vs. Alternatives'],
                                'Risk': data.drafts['Risk'],
                                'Market Reference Points': data.drafts['Market Reference Points']
                            }
                        }));
                        
                        setWtpDraftsAvailable(true);
                    } else {
                        throw new Error(data.error || 'AI generation failed');
                    }
                } catch (error) {
                    console.error('AI WTP Generation Error:', error);
                    setWtpDraftError(error.message || 'AI assistant is currently unavailable. Please try again later.');
                }
                
                setWtpDraftLoading(false);
            };

            return (
                <div className="container mx-auto px-4 sm:px-6 lg:px-8 min-h-screen pb-16">
                    <header className="sticky-header">
                        <div className="flex justify-between items-center py-3">
                            <div className="flex items-center space-x-4">
                                <button onClick={() => onNavigate('home')} className="text-gray-600 hover:scale-gold-text">← Back to Home</button>
                                <h1 className="text-xl sm:text-2xl font-bold scale-green-text">Part 1: Segment Foundation</h1>
                            </div>
                            <div className="flex items-center space-x-2">
                                <button onClick={handleReset} className="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Reset</button>
                                <button onClick={handleExport} className="scale-green-bg text-white font-bold py-2 px-4 rounded-lg hover:bg-opacity-90 mr-2">Export</button>
                                <button onClick={() => { onNavigate('icp'); window.scrollTo(0, 0); }} className="scale-green-bg text-white font-bold py-2 px-4 rounded-lg hover:bg-opacity-90">Continue to Part 2: ICP Definition →</button>
                            </div>
                        </div>
                    </header>

                    <div className="mt-8">
                        <div className="lg:flex lg:space-x-8">
                            <nav className="hidden lg:block w-1/4 sticky top-28 self-start">
                                <div className="bg-white p-4 rounded-lg shadow-md">
                                    <h3 className="font-bold scale-green-text mb-2 text-lg">Sections</h3>
                                    <ul className="space-y-1">
                                        <li><a href="#segment-definition-section" className="nav-link block p-2 rounded text-gray-700 font-semibold">0. How Segments are Designed</a></li>
                                        <li><a href="#jtbd-section" className="nav-link block p-2 rounded text-gray-700 font-semibold">1. Jobs To Be Done</a></li>
                                        <li><a href="#value-section" className="nav-link block p-2 rounded text-gray-700 font-semibold">2. Customer Value</a></li>
                                        <li><a href="#wtp-section" className="nav-link block p-2 rounded text-gray-700 font-semibold">3. Willingness to Pay</a></li>
                                    </ul>
                                    <div className="mt-4 pt-4 border-t">
                                        <button onClick={() => { onNavigate('icp'); window.scrollTo(0, 0); }} className="text-sm text-gray-600 hover:scale-gold-text font-semibold w-full text-left">
                                            Continue to Part 2: ICP Definition →
                                        </button>
                                    </div>
                                </div>
                            </nav>

                            <main className="w-full lg:w-3/4">
                                <div className="space-y-8">
                        {/* Market Segment Definition Header */}
                        <div id="segment-definition-section" className="bg-white p-8 rounded-lg shadow-md scroll-mt-24">
                            <div className="text-center mb-8">
                                <p className="text-lg text-gray-700 mb-8 max-w-4xl mx-auto">
                                    A true market segment is composed of customers who share a common Job to be Done, 
                                    perceive value similarly, and have a similar Willingness to Pay.
                                </p>
                                
                                {/* Custom SVG Funnel Diagram */}
                                <div className="flex justify-center">
                                    <svg width="400" height="450" viewBox="0 0 400 450" className="max-w-full h-auto">
                                        <defs>
                                            <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                                                    refX="9" refY="3.5" orient="auto">
                                                <polygon points="0 0, 10 3.5, 0 7" fill="#224f41"/>
                                            </marker>
                                        </defs>
                                        
                                        {/* Top of Funnel - Total Market */}
                                        <rect x="50" y="20" width="300" height="60" fill="#e5ecea" stroke="#224f41" strokeWidth="2" rx="4"/>
                                        <text x="200" y="55" textAnchor="middle" fill="#224f41" fontSize="16" fontWeight="600">
                                            Total Market of Buyers
                                        </text>
                                        
                                        {/* Arrow 1 */}
                                        <line x1="200" y1="80" x2="200" y2="110" stroke="#224f41" strokeWidth="2" markerEnd="url(#arrowhead)"/>
                                        
                                        {/* Filter Gate 1 - Job to be Done */}
                                        <rect x="80" y="115" width="240" height="50" fill="#7da399" stroke="#224f41" strokeWidth="2" rx="4"/>
                                        <text x="200" y="135" textAnchor="middle" fill="white" fontSize="14" fontWeight="500">
                                            Shared Job to be Done
                                        </text>
                                        <text x="200" y="150" textAnchor="middle" fill="white" fontSize="12">
                                            (Common Context &amp; Struggling Moments)
                                        </text>
                                        
                                        {/* Arrow 2 */}
                                        <line x1="200" y1="165" x2="200" y2="195" stroke="#224f41" strokeWidth="2" markerEnd="url(#arrowhead)"/>
                                        
                                        {/* Filter Gate 2 - Perceived Value */}
                                        <rect x="110" y="200" width="180" height="50" fill="#528577" stroke="#224f41" strokeWidth="2" rx="4"/>
                                        <text x="200" y="220" textAnchor="middle" fill="white" fontSize="14" fontWeight="500">
                                            Commonly Perceived Value
                                        </text>
                                        <text x="200" y="235" textAnchor="middle" fill="white" fontSize="12">
                                            (Similar Value Priorities)
                                        </text>
                                        
                                        {/* Arrow 3 */}
                                        <line x1="200" y1="250" x2="200" y2="280" stroke="#224f41" strokeWidth="2" markerEnd="url(#arrowhead)"/>
                                        
                                        {/* Filter Gate 3 - Willingness to Pay */}
                                        <rect x="140" y="285" width="120" height="50" fill="#224f41" stroke="#224f41" strokeWidth="2" rx="4"/>
                                        <text x="200" y="305" textAnchor="middle" fill="white" fontSize="14" fontWeight="500">
                                            Similar Willingness
                                        </text>
                                        <text x="200" y="320" textAnchor="middle" fill="white" fontSize="14" fontWeight="500">
                                            to Pay
                                        </text>
                                        
                                        {/* Arrow 4 */}
                                        <line x1="200" y1="335" x2="200" y2="365" stroke="#224f41" strokeWidth="2" markerEnd="url(#arrowhead)"/>
                                        
                                        {/* Bottom of Funnel - True Market Segment */}
                                        <rect x="160" y="370" width="80" height="60" fill="#e5a819" stroke="#224f41" strokeWidth="2" rx="4"/>
                                        <text x="200" y="390" textAnchor="middle" fill="#224f41" fontSize="14" fontWeight="600">
                                            A True
                                        </text>
                                        <text x="200" y="405" textAnchor="middle" fill="#224f41" fontSize="14" fontWeight="600">
                                            Market
                                        </text>
                                        <text x="200" y="420" textAnchor="middle" fill="#224f41" fontSize="14" fontWeight="600">
                                            Segment
                                        </text>
                                        
                                        {/* Side Labels */}
                                        <text x="30" y="225" textAnchor="middle" fill="#224f41" fontSize="12" transform="rotate(-90, 30, 225)">
                                            Filtering Process
                                        </text>
                                        <text x="370" y="225" textAnchor="middle" fill="#224f41" fontSize="12" transform="rotate(90, 370, 225)">
                                            Strategic Focus
                                        </text>
                                    </svg>
                                </div>
                                
                                <p className="text-sm text-gray-600 mt-6 max-w-3xl mx-auto">
                                    The three input sections below help you define each filter criterion to identify your true market segment.
                                </p>
                            </div>
                        </div>
                        
                        {/* Jobs To Be Done Section */}
                        <div id="jtbd-section" className="bg-white p-8 rounded-lg shadow-md scroll-mt-24">
                            <h2 className="text-2xl font-bold scale-green-text mb-6">Jobs To Be Done</h2>
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-lg font-semibold text-gray-800 mb-2">Context</label>
                                    <p className="text-gray-600 text-sm mb-3">The business situation or operating environment.</p>
                                    <textarea
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                        rows="3"
                                        value={appState.segmentData['Context'] || ''}
                                        onChange={(e) => {
                                            const newSegmentData = { ...appState.segmentData, 'Context': e.target.value };
                                            setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                        }}
                                        placeholder="Quarterly close process across distributed finance teams."
                                    />
                                </div>

                                <div>
                                    <label className="block text-lg font-semibold text-gray-800 mb-2">Struggling Moments</label>
                                    <p className="text-gray-600 text-sm mb-3">Breakdowns, inefficiencies, or risks that trigger the search.</p>
                                    <textarea
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                        rows="3"
                                        value={appState.segmentData['Struggling Moments'] || ''}
                                        onChange={(e) => {
                                            const newSegmentData = { ...appState.segmentData, 'Struggling Moments': e.target.value };
                                            setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                        }}
                                        placeholder="Errors in revenue recognition delaying financial reporting."
                                    />
                                </div>

                                <div>
                                    <label className="block text-lg font-semibold text-gray-800 mb-2">Pushes & Pulls</label>
                                    <p className="text-gray-600 text-sm mb-3">Internal and external forces moving them toward or away from change.</p>
                                    <textarea
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                        rows="3"
                                        value={appState.segmentData['Pushes & Pulls'] || ''}
                                        onChange={(e) => {
                                            const newSegmentData = { ...appState.segmentData, 'Pushes & Pulls': e.target.value };
                                            setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                        }}
                                        placeholder="CFO pressure to modernize systems vs. IT reluctance to add new vendors."
                                    />
                                </div>

                                <div>
                                    <label className="block text-lg font-semibold text-gray-800 mb-2">Anxieties & Habits</label>
                                    <p className="text-gray-600 text-sm mb-3">Concerns about adopting something new, and inertia with current processes/tools.</p>
                                    <textarea
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                        rows="3"
                                        value={appState.segmentData['Anxieties & Habits'] || ''}
                                        onChange={(e) => {
                                            const newSegmentData = { ...appState.segmentData, 'Anxieties & Habits': e.target.value };
                                            setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                        }}
                                        placeholder="Fear of migration failure; comfort with spreadsheets."
                                    />
                                </div>

                                <div>
                                    <label className="block text-lg font-semibold text-gray-800 mb-2">Desired Outcomes</label>
                                    <p className="text-gray-600 text-sm mb-3">We will refine this outcome into specific types of value in the **Customer Value** section</p>
                                    <textarea
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                        rows="3"
                                        value={appState.segmentData['Desired Outcomes'] || ''}
                                        onChange={(e) => {
                                            const newSegmentData = { ...appState.segmentData, 'Desired Outcomes': e.target.value };
                                            setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                        }}
                                        placeholder="Reduce audit prep time by 50%; ensure SOX compliance."
                                    />
                                </div>

                                <div>
                                    <label className="block text-lg font-semibold text-gray-800 mb-2">Basic Quality (Table Stakes)</label>
                                    <p className="text-gray-600 text-sm mb-3">Minimum standards a solution must meet to even be considered.</p>
                                    <textarea
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                        rows="3"
                                        value={appState.segmentData['Basic Quality (Table Stakes)'] || ''}
                                        onChange={(e) => {
                                            const newSegmentData = { ...appState.segmentData, 'Basic Quality (Table Stakes)': e.target.value };
                                            setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                        }}
                                        placeholder="SOC2 compliance, API integrations with ERP, enterprise-grade security."
                                    />
                                </div>

                                <div>
                                    <label className="block text-lg font-semibold text-gray-800 mb-2">Hiring Criteria</label>
                                    <p className="text-gray-600 text-sm mb-3">Differentiators that make them select one vendor.</p>
                                    <textarea
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                        rows="3"
                                        value={appState.segmentData['Hiring Criteria'] || ''}
                                        onChange={(e) => {
                                            const newSegmentData = { ...appState.segmentData, 'Hiring Criteria': e.target.value };
                                            setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                        }}
                                        placeholder="Proven implementation playbook; reference customers in financial services."
                                    />
                                </div>

                                <div>
                                    <label className="block text-lg font-semibold text-gray-800 mb-2">Firing Criteria</label>
                                    <p className="text-gray-600 text-sm mb-3">Triggers that get a vendor rejected or replaced.</p>
                                    <textarea
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                        rows="3"
                                        value={appState.segmentData['Firing Criteria'] || ''}
                                        onChange={(e) => {
                                            const newSegmentData = { ...appState.segmentData, 'Firing Criteria': e.target.value };
                                            setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                        }}
                                        placeholder="System downtime; lack of role-based access control."
                                    />
                                </div>

                                <div>
                                    <label className="block text-lg font-semibold text-gray-800 mb-2">Key Trade-offs</label>
                                    <p className="text-gray-600 text-sm mb-3">Acceptable compromises or limits.</p>
                                    <textarea
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                        rows="3"
                                        value={appState.segmentData['Key Trade-offs'] || ''}
                                        onChange={(e) => {
                                            const newSegmentData = { ...appState.segmentData, 'Key Trade-offs': e.target.value };
                                            setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                        }}
                                        placeholder="May sacrifice customization for faster time to value."
                                    />
                                </div>
                            </div>
                        </div>

                        {/* Customer Value Section */}
                        <div id="value-section" className="bg-white p-8 rounded-lg shadow-md scroll-mt-24">
                            <h2 className="text-2xl font-bold scale-green-text mb-6">Customer Value</h2>
                            
                            {/* Golden Thread: JTBD → Customer Value */}
                            <div className="mb-6 p-3 bg-gray-50 border-l-4 border-blue-500 rounded-r-lg">
                                <p className="text-sm font-medium text-blue-700 mb-1">Source: Desired Outcomes</p>
                                <p className="text-sm text-gray-600 italic">
                                    {appState.segmentData['Desired Outcomes'] || 'No content yet...'}
                                </p>
                            </div>
                            
                            {/* AI Assistant State: Before Analysis */}
                            {!aiDraftsAvailable && !aiDraftLoading && (
                                <div className="mb-8 p-6 bg-blue-50 border border-blue-200 rounded-lg">
                                    <div className="flex items-start space-x-4">
                                        <div className="flex-shrink-0">
                                            <div className="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                                                <span className="text-white font-bold text-sm">AI</span>
                                            </div>
                                        </div>
                                        <div className="flex-1">
                                            <h3 className="text-lg font-semibold text-blue-900 mb-2">AI Customer Value Drafter</h3>
                                            <p className="text-blue-700 mb-4">Let AI analyze your Jobs-to-be-Done insights and draft Customer Value propositions tailored to your segment. You can edit all AI-generated content afterward.</p>
                                            <button 
                                                onClick={handleGenerateCustomerValue}
                                                className="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors"
                                            >
                                                Analyze JTBD & Draft Customer Value
                                            </button>
                                            <p className="text-blue-600 text-sm mt-2">Requires at least 3 completed Jobs-to-be-Done fields</p>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {/* AI Assistant State: Loading */}
                            {aiDraftLoading && (
                                <div className="mb-8 p-6 bg-blue-50 border border-blue-200 rounded-lg">
                                    <div className="flex items-start space-x-4">
                                        <div className="flex-shrink-0">
                                            <div className="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                                                <div className="animate-spin">
                                                    <span className="text-white font-bold text-sm">⚡</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="flex-1">
                                            <h3 className="text-lg font-semibold text-blue-900 mb-2">Analyzing Your Market Segment...</h3>
                                            <div className="space-y-2 text-blue-700 text-sm">
                                                <p>• Analyzing Jobs-to-be-Done context and pain points</p>
                                                <p>• Researching industry value proposition patterns</p>
                                                <p>• Generating tailored Customer Value drafts</p>
                                            </div>
                                            <div className="mt-3 bg-blue-200 rounded-full h-2">
                                                <div className="bg-blue-600 h-2 rounded-full animate-pulse" style={{width: '75%'}}></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {/* AI Assistant State: Error */}
                            {aiDraftError && (
                                <div className="mb-8 p-6 bg-red-50 border border-red-200 rounded-lg">
                                    <div className="flex items-start space-x-4">
                                        <div className="flex-shrink-0">
                                            <div className="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center">
                                                <span className="text-white font-bold text-sm">!</span>
                                            </div>
                                        </div>
                                        <div className="flex-1">
                                            <h3 className="text-lg font-semibold text-red-900 mb-2">AI Assistant Unavailable</h3>
                                            <p className="text-red-700 mb-4">{aiDraftError}</p>
                                            <button 
                                                onClick={() => {
                                                    setAiDraftError(null);
                                                    handleGenerateCustomerValue();
                                                }}
                                                className="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors mr-3"
                                            >
                                                Try Again
                                            </button>
                                            <button 
                                                onClick={() => setAiDraftError(null)}
                                                className="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors"
                                            >
                                                Continue Manually
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {/* Customer Value Fields - Always show if AI drafts available or manual mode */}
                            {(aiDraftsAvailable || aiDraftError) && (
                                <>
                                    {aiDraftsAvailable && (
                                        <div className="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                                            <div className="flex items-center space-x-2">
                                                <div className="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                                                    <span className="text-white font-bold text-xs">✓</span>
                                                </div>
                                                <p className="text-green-700 font-medium">AI drafts generated! Review and edit the content below as needed.</p>
                                            </div>
                                        </div>
                                    )}
                                    
                                    <div className="space-y-6">
                                        <div>
                                            <label className="block text-lg font-semibold text-gray-800 mb-2">Table Stakes</label>
                                            <p className="text-gray-600 text-sm mb-3">The non-negotiables for credibility. If you don't have them, you're out. These are compliance, security, reliability, and integration standards every enterprise expects.</p>
                                            <textarea
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                rows="3"
                                                value={appState.segmentData['Table Stakes'] || ''}
                                                onChange={(e) => {
                                                    const newSegmentData = { ...appState.segmentData, 'Table Stakes': e.target.value };
                                                    setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                }}
                                                placeholder="SOC2 certification, ERP integration, 99.9% uptime SLAs."
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-lg font-semibold text-gray-800 mb-2">Functional Value</label>
                                            <p className="text-gray-600 text-sm mb-3">The tangible, measurable business outcomes. This is the hard ROI—efficiency gains, cost savings, revenue growth, or risk mitigation.</p>
                                            <textarea
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                rows="3"
                                                value={appState.segmentData['Functional Value'] || ''}
                                                onChange={(e) => {
                                                    const newSegmentData = { ...appState.segmentData, 'Functional Value': e.target.value };
                                                    setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                }}
                                                placeholder="\$500K OpEx savings validated by faster close cycles and error-rate reduction."
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-lg font-semibold text-gray-800 mb-2">Ease of Doing Business</label>
                                            <p className="text-gray-600 text-sm mb-3">How simple you make adoption and use. Enterprise buyers weigh friction. A solution that's easier to buy, implement, and run often beats a "better" product.</p>
                                            <textarea
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                rows="3"
                                                value={appState.segmentData['Ease of Doing Business'] || ''}
                                                onChange={(e) => {
                                                    const newSegmentData = { ...appState.segmentData, 'Ease of Doing Business': e.target.value };
                                                    setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                }}
                                                placeholder="Fast implementation playbook, role-based onboarding, 24/7 enterprise support."
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-lg font-semibold text-gray-800 mb-2">Individual Value</label>
                                            <p className="text-gray-600 text-sm mb-3">What matters to each stakeholder in the buying group. Individual Value addresses what each one personally gains—status, confidence, workload relief, or career upside.</p>
                                            <textarea
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                rows="3"
                                                value={appState.segmentData['Individual Value'] || ''}
                                                onChange={(e) => {
                                                    const newSegmentData = { ...appState.segmentData, 'Individual Value': e.target.value };
                                                    setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                }}
                                                placeholder="CFO is seen as innovator; IT leader feels secure in system stability; end users save hours of manual work."
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-lg font-semibold text-gray-800 mb-2">Aspirational Value</label>
                                            <p className="text-gray-600 text-sm mb-3">Alignment with vision and purpose. Higher-order motivations that make a vendor strategic.</p>
                                            <textarea
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                rows="3"
                                                value={appState.segmentData['Aspirational Value'] || ''}
                                                onChange={(e) => {
                                                    const newSegmentData = { ...appState.segmentData, 'Aspirational Value': e.target.value };
                                                    setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                }}
                                                placeholder="Supports ESG reporting goals; positions company as a digital leader; signals innovation to board and investors."
                                            />
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>

                        {/* Willingness to Pay Section */}
                        <div id="wtp-section" className="bg-white p-8 rounded-lg shadow-md scroll-mt-24">
                            <h2 className="text-2xl font-bold scale-green-text mb-6">Willingness to Pay</h2>
                            
                            {/* Pre-analysis State: Show button when WTP data is empty */}
                            {!wtpDraftsAvailable && !wtpDraftLoading && !wtpDraftError && (
                                <div className="text-center py-12">
                                    <div className="mb-6">
                                        <div className="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <span className="text-2xl">💰</span>
                                        </div>
                                        <h3 className="text-xl font-semibold text-gray-800 mb-2">Ready to Draft WTP Drivers</h3>
                                        <p className="text-gray-600 max-w-2xl mx-auto">
                                            I'll analyze your refined Customer Value propositions alongside your JTBD context to generate contextual Willingness to Pay drivers with industry pricing intelligence.
                                        </p>
                                    </div>
                                    <button
                                        onClick={handleGenerateWTP}
                                        disabled={wtpDraftLoading}
                                        className="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        <span className="mr-2">🧠</span>
                                        Analyze Value & Draft WTP Drivers
                                    </button>
                                    <p className="text-sm text-gray-500 mt-3">
                                        Requires completed JTBD and Customer Value sections
                                    </p>
                                </div>
                            )}

                            {/* Loading State */}
                            {wtpDraftLoading && (
                                <div className="text-center py-12">
                                    <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-yellow-600 mb-4"></div>
                                    <h3 className="text-lg font-semibold text-gray-800 mb-2">Generating WTP Analysis...</h3>
                                    <p className="text-gray-600">Analyzing pricing intelligence and market benchmarks</p>
                                    <div className="mt-4 bg-gray-50 rounded-lg p-4 max-w-md mx-auto">
                                        <div className="flex items-center justify-center space-x-2 text-sm text-gray-500">
                                            <span className="animate-pulse">🔍 Researching market pricing data...</span>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Error State */}
                            {wtpDraftError && (
                                <div className="text-center py-12">
                                    <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <span className="text-2xl">⚠️</span>
                                    </div>
                                    <h3 className="text-xl font-semibold text-gray-800 mb-2">Generation Failed</h3>
                                    <p className="text-gray-600 mb-4">{wtpDraftError}</p>
                                    <button
                                        onClick={handleGenerateWTP}
                                        className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 mr-3"
                                    >
                                        Try Again
                                    </button>
                                    <button
                                        onClick={() => {
                                            setWtpDraftError(null);
                                            setWtpDraftsAvailable(false);
                                        }}
                                        className="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500"
                                    >
                                        Fill Manually
                                    </button>
                                </div>
                            )}

                            {/* Success State: Show AI-generated content in editable textareas */}
                            {wtpDraftsAvailable && !wtpDraftLoading && (
                                <>
                                    {/* Success Header */}
                                    <div className="mb-6">
                                        <div className="flex items-center justify-center mb-4">
                                            <div className="flex items-center bg-green-100 text-green-800 px-4 py-2 rounded-full">
                                                <div className="w-5 h-5 bg-green-500 rounded-full flex items-center justify-center mr-2">
                                                    <span className="text-white font-bold text-xs">✓</span>
                                                </div>
                                                <p className="text-green-700 font-medium">WTP drafts generated! Review and edit the content below as needed.</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="space-y-6">
                                        <div>
                                            <label className="block text-lg font-semibold text-gray-800 mb-2">Ability to Pay</label>
                                            <p className="text-gray-600 text-sm mb-3">Whether the customer has budget and capacity to spend. Even high-value solutions fail without available budget or a way to fund them.</p>
                                            <textarea
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                rows="3"
                                                value={appState.segmentData['Ability to Pay'] || ''}
                                                onChange={(e) => {
                                                    const newSegmentData = { ...appState.segmentData, 'Ability to Pay': e.target.value };
                                                    setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                }}
                                                placeholder="Line item already approved in FY25 budget for compliance automation."
                                            />
                                        </div>

                                        {/* Golden Thread: Customer Value → WTP (Functional) */}
                                        <div className="mb-4 p-3 bg-gray-50 border-l-4 border-blue-500 rounded-r-lg">
                                            <p className="text-sm font-medium text-blue-700 mb-1">Source: Functional Value</p>
                                            <p className="text-sm text-gray-600 italic">
                                                {appState.segmentData['Functional Value'] || 'No content yet...'}
                                            </p>
                                        </div>

                                        <div>
                                            <label className="block text-lg font-semibold text-gray-800 mb-2">Economic Justification</label>
                                            <p className="text-gray-600 text-sm mb-3">Whether the ROI and payback case makes financial sense. Customers want proof the investment will pay for itself within an acceptable time horizon.</p>
                                            <textarea
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                rows="3"
                                                value={appState.segmentData['Economic Justification'] || ''}
                                                onChange={(e) => {
                                                    const newSegmentData = { ...appState.segmentData, 'Economic Justification': e.target.value };
                                                    setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                }}
                                                placeholder="Pays for itself in under 12 months through \$1M annual cost avoidance."
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-lg font-semibold text-gray-800 mb-2">Relative Value vs. Alternatives</label>
                                            <p className="text-gray-600 text-sm mb-3">How your solution compares to competitors or the status quo. If your product delivers clearer, differentiated outcomes, willingness to pay rises.</p>
                                            <textarea
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                rows="3"
                                                value={appState.segmentData['Relative Value vs. Alternatives'] || ''}
                                                onChange={(e) => {
                                                    const newSegmentData = { ...appState.segmentData, 'Relative Value vs. Alternatives': e.target.value };
                                                    setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                }}
                                                placeholder="Automates 80% of manual work versus consultant-heavy models."
                                            />
                                        </div>

                                        {/* Golden Thread: Customer Value → WTP (Ease) */}
                                        <div className="mb-6 p-3 bg-gray-50 border-l-4 border-blue-500 rounded-r-lg">
                                            <p className="text-sm font-medium text-blue-700 mb-1">Source: Ease of Doing Business</p>
                                            <p className="text-sm text-gray-600 italic">
                                                {appState.segmentData['Ease of Doing Business'] || 'No content yet...'}
                                            </p>
                                        </div>

                                        <div>
                                            <label className="block text-lg font-semibold text-gray-800 mb-2">Risk</label>
                                            <p className="text-gray-600 text-sm mb-3">How much risk or friction they see in making the change. Higher risk perception or switching pain lowers willingness to pay; clear mitigation raises it.</p>
                                            <textarea
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                rows="3"
                                                value={appState.segmentData['Risk'] || ''}
                                                onChange={(e) => {
                                                    const newSegmentData = { ...appState.segmentData, 'Risk': e.target.value };
                                                    setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                }}
                                                placeholder="Migration takes days, not months; vendor assumes implementation risk."
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-lg font-semibold text-gray-800 mb-2">Market Reference Points</label>
                                            <p className="text-gray-600 text-sm mb-3">The pricing anchors customers bring from prior spend or competitors. Buyers rarely assess value in a vacuum; they benchmark against what "similar" tools cost.</p>
                                            <textarea
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                rows="3"
                                                value={appState.segmentData['Market Reference Points'] || ''}
                                                onChange={(e) => {
                                                    const newSegmentData = { ...appState.segmentData, 'Market Reference Points': e.target.value };
                                                    setAppState(prev => ({ ...prev, segmentData: newSegmentData }));
                                                }}
                                                placeholder="Analytics platforms in this space usually run $100K–$150K annually."
                                            />
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>
                                </div>
                            </main>
                        </div>
                    </div>

                    <ExportModal 
                        isOpen={exportModalOpen}
                        onClose={() => setExportModalOpen(false)}
                        title="Segment Foundation Summary"
                        content={exportContent}
                        appState={appState}
                        filename="segment-foundation-export"
                    />
                </div>
            );
        };

        // ICPDefinitionTool Component
        const ICPDefinitionTool = ({ appState, setAppState, onNavigate }) => {
            const [exportModal, setExportModal] = useState({ isOpen: false, content: '', title: '' });
            const [gradingState, setGradingState] = useState({});
            const [analysisState, setAnalysisState] = useState({});
            const [uniquenessResults, setUniquenessResults] = useState({});
            const [trendAnalysisResults, setTrendAnalysisResults] = useState({});
            
            // F-8: Pillar Generation Modal State
            const [pillarGenModalOpen, setPillarGenModalOpen] = useState(false);
            const [pillarGenState, setPillarGenState] = useState({
                isGenerating: false,
                suggestedPillars: [],
                error: null,
                refinementInputs: {}
            });
            
            // Simulate AI grading for value propositions
            const simulateAIGrading = async (proposition, index) => {
                const { val1, val2, val3 } = proposition;
                
                // Set loading state
                setGradingState(prev => ({
                    ...prev,
                    [index]: { isGrading: true, score: null, feedback: null }
                }));
                
                // Simulate network delay
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Analyze proposition quality
                let score = 'C';
                let feedback = [];
                
                // Check attribute quality
                if (!val1 || val1.length < 10) {
                    feedback.push('Attribute needs more specificity and detail');
                } else if (val1.includes('AI') || val1.includes('intelligent') || val1.includes('automated')) {
                    score = score < 'B' ? 'B' : score;
                    feedback.push('Good use of compelling technology terms');
                }
                
                // Check benefit quality
                if (!val2 || val2.length < 15) {
                    feedback.push('Benefit statement should explain customer impact more clearly');
                } else if (val2.includes('reduces') || val2.includes('increases') || val2.includes('enables')) {
                    score = score < 'B+' ? 'B+' : score;
                    feedback.push('Strong benefit articulation with clear outcomes');
                }
                
                // Check value quality
                if (!val3 || val3.length < 10) {
                    feedback.push('Value statement needs quantifiable outcomes or proof points');
                } else if (val3.match(/\$|%|months?|weeks?|days?|hours?|\d+/)) {
                    score = 'A-';
                    feedback.push('Excellent quantifiable value with specific metrics');
                }
                
                // Assign final score
                if (val1 && val2 && val3 && val1.length > 10 && val2.length > 15 && val3.length > 15) {
                    if (score === 'C') score = 'B';
                }
                
                // Create final feedback
                const finalFeedback = feedback.length > 0 
                    ? feedback.join('. ') + '.'
                    : 'Complete all three fields with more specific details for better grading.';
                
                // Update grading state with results
                setGradingState(prev => ({
                    ...prev,
                    [index]: {
                        isGrading: false,
                        score,
                        feedback: finalFeedback,
                        timestamp: new Date().toISOString()
                    }
                }));
            };

            // Analyze uniqueness using web search API
            const analyzeUniqueness = async (attributeText, index) => {
                if (!attributeText || !attributeText.trim()) {
                    return;
                }

                setUniquenessResults(prev => ({
                    ...prev,
                    [index]: { isAnalyzing: true, results: null }
                }));

                try {
                    const response = await fetch('/api/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            query: `"${attributeText.trim()}" software features capabilities`
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const searchData = await response.json();
                    
                    // Extract relevant results for display
                    const results = searchData.web?.results?.slice(0, 3).map(result => ({
                        title: result.title,
                        description: result.description || result.snippet || 'No description available',
                        url: result.url
                    })) || [];

                    setUniquenessResults(prev => ({
                        ...prev,
                        [index]: {
                            isAnalyzing: false,
                            results,
                            timestamp: new Date().toISOString()
                        }
                    }));

                } catch (error) {
                    console.error('Uniqueness analysis error:', error);
                    setUniquenessResults(prev => ({
                        ...prev,
                        [index]: {
                            isAnalyzing: false,
                            error: 'Analysis unavailable - please try again later',
                            timestamp: new Date().toISOString()
                        }
                    }));
                }
            };
            
            // Analyze trend validation using web search
            const analyzeTrend = async (trendText, index) => {
                if (!trendText || !trendText.trim()) {
                    return;
                }

                setTrendAnalysisResults(prev => ({
                    ...prev,
                    [index]: { isAnalyzing: true, results: null }
                }));

                try {
                    const response = await fetch('/api/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            query: `"${trendText.trim()}" market trend industry analysis`
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const searchData = await response.json();
                    
                    // Extract relevant results for display
                    const results = searchData.web?.results?.slice(0, 3).map(result => ({
                        title: result.title,
                        description: result.description || result.snippet || 'No description available',
                        url: result.url
                    })) || [];

                    setTrendAnalysisResults(prev => ({
                        ...prev,
                        [index]: {
                            isAnalyzing: false,
                            results,
                            timestamp: new Date().toISOString()
                        }
                    }));

                } catch (error) {
                    console.error('Trend analysis error:', error);
                    setTrendAnalysisResults(prev => ({
                        ...prev,
                        [index]: {
                            isAnalyzing: false,
                            error: 'No strong evidence found for this trend. Consider rephrasing.',
                            timestamp: new Date().toISOString()
                        }
                    }));
                }
            };
            
            // Simulate AI competitive weakness analysis
            const simulateCompetitiveAnalysis = async (alternative, index) => {
                const { val1, val2 } = alternative;
                
                setAnalysisState(prev => ({
                    ...prev,
                    [index]: { isAnalyzing: true, angles: null }
                }));
                
                await new Promise(resolve => setTimeout(resolve, 1800));
                
                let angles = [];
                
                if (!val1 || !val2) {
                    angles = ["Add competitor name and weakness for detailed analysis"];
                } else {
                    const weakness = val2.toLowerCase();
                    
                    if (weakness.includes("slow") || weakness.includes("outdated") || weakness.includes("legacy")) {
                        angles.push(`Emphasize your speed advantage over ${val1}'s legacy systems`);
                        angles.push(`Position as future-ready while ${val1} requires modernization`);
                    }
                    
                    if (weakness.includes("expensive") || weakness.includes("cost") || weakness.includes("price")) {
                        angles.push(`Highlight cost benefits vs ${val1}'s hidden fees`);
                        angles.push(`Demonstrate faster ROI vs ${val1}'s expensive implementation`);
                    }
                    
                    if (weakness.includes("complex") || weakness.includes("difficult") || weakness.includes("hard")) {
                        angles.push(`Showcase intuitive UX vs ${val1}'s complexity`);
                        angles.push(`Emphasize rapid deployment vs ${val1}'s lengthy setup`);
                    }
                    
                    if (weakness.includes("limited") || weakness.includes("lacking") || weakness.includes("missing")) {
                        angles.push(`Highlight comprehensive features vs ${val1}'s gaps`);
                        angles.push(`Position as complete solution vs ${val1}'s limitations`);
                    }
                    
                    angles.push(`Frame conversation around outcomes ${val1} struggles to deliver`);
                    
                    if (angles.length < 3) {
                        angles.push(`Leverage ${val1}'s weakness in competitive positioning`);
                        angles.push(`Use case studies showing success where ${val1} failed`);
                    }
                    
                    angles = angles.slice(0, 4);
                }
                
                setAnalysisState(prev => ({
                    ...prev,
                    [index]: {
                        isAnalyzing: false,
                        angles,
                        timestamp: new Date().toISOString()
                    }
                }));
            };

            // Simulate AI JTBD analysis using bottom-up breadcrumb approach
            const simulateJTBDAnalysis = async (originalText) => {
                if (!originalText.trim()) {
                    return {
                        context: '',
                        strugglingMoments: '',
                        desiredOutcomes: '',
                        currentSolutions: '',
                        constraints: '',
                        successCriteria: '',
                        emotionalDrivers: '',
                        socialDimensions: ''
                    };
                }

                // Simulate network delay
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Apply bottom-up breadcrumb approach - identify signals and cluster them
                const text = originalText.toLowerCase();
                const breadcrumbs = {
                    contextClues: [],
                    struggleSignals: [],
                    outcomeSignals: [],
                    solutionMentions: [],
                    constraintSignals: [],
                    metricSignals: [],
                    emotionWords: [],
                    stakeholderMentions: []
                };

                // Identify breadcrumbs (signals) in the text
                if (text.includes('when') || text.includes('during') || text.includes('while')) {
                    breadcrumbs.contextClues.push('timing-based triggers identified');
                }
                if (text.includes('need') || text.includes('require') || text.includes('must')) {
                    breadcrumbs.struggleSignals.push('urgency language detected');
                }
                if (text.includes('achieve') || text.includes('reach') || text.includes('goal')) {
                    breadcrumbs.outcomeSignals.push('outcome-oriented language');
                }
                if (text.includes('currently') || text.includes('using') || text.includes('tool')) {
                    breadcrumbs.solutionMentions.push('existing solution references');
                }
                if (text.includes('budget') || text.includes('time') || text.includes('resource')) {
                    breadcrumbs.constraintSignals.push('resource constraint mentions');
                }
                if (text.includes('measure') || text.includes('track') || text.includes('metric')) {
                    breadcrumbs.metricSignals.push('measurement focus detected');
                }
                if (text.includes('frustrated') || text.includes('worried') || text.includes('confident')) {
                    breadcrumbs.emotionWords.push('emotional language identified');
                }
                if (text.includes('team') || text.includes('stakeholder') || text.includes('customer')) {
                    breadcrumbs.stakeholderMentions.push('multiple parties involved');
                }

                // Cluster breadcrumbs into 9 JTBD elements (B2B/Enterprise focused)
                return {
                    context: breadcrumbs.contextClues.length > 0 
                        ? `Analysis reveals a complex business operating environment with interdependent systems and evolving regulatory requirements. Organizations are managing distributed teams and need solutions that integrate with existing infrastructure.`
                        : `The business is operating in a dynamic market environment where manual processes and legacy systems are creating operational bottlenecks that impact competitiveness.`,
                    
                    strugglingMoments: breadcrumbs.struggleSignals.length > 0
                        ? `Critical breakdowns are occurring in workflow efficiency, data accuracy, and compliance processes. These operational failures are triggering urgent evaluation of new solutions to prevent business disruption.`
                        : `Organizations are experiencing systematic inefficiencies and increased error rates that signal their current approach is unsustainable and requires immediate modernization.`,
                    
                    pushesPulls: breadcrumbs.contextClues.length > 0 || breadcrumbs.stakeholderMentions.length > 0
                        ? `Internal forces include executive mandates for digital transformation and team frustration with current tools. External pressures include competitive threats, regulatory changes, and customer expectations for faster service.`
                        : `The organization faces internal pressure from leadership to reduce costs and external pressure from competitors who are moving faster with modern technology stacks.`,
                    
                    anxietiesHabits: breadcrumbs.emotionWords.length > 0
                        ? `Teams express concerns about data migration risks, learning curve for new systems, and potential disruption to critical operations. There's organizational inertia around familiar but inefficient processes.`
                        : `The organization worries about implementation failure, vendor lock-in, and change management challenges while showing strong attachment to existing workflows despite their limitations.`,
                    
                    desiredOutcomes: breadcrumbs.outcomeSignals.length > 0
                        ? `Primary business goals include reducing operational costs by 30-40%, achieving 99.9% uptime, ensuring full regulatory compliance, and enabling data-driven decision making across all departments.`
                        : `The organization seeks measurable improvements in efficiency metrics, reduced audit findings, faster time-to-market, and enhanced visibility into business operations.`,
                    
                    basicQuality: breadcrumbs.metricSignals.length > 0 || breadcrumbs.constraintSignals.length > 0
                        ? `Non-negotiable requirements include SOC2/ISO certifications, 99.9% SLA guarantees, enterprise SSO, role-based access controls, API integrations with existing ERP/CRM systems, and 24/7 support.`
                        : `Minimum viable standards include enterprise-grade security, compliance with industry regulations, seamless data migration capabilities, and proven scalability for growing organizations.`,
                    
                    hiringCriteria: breadcrumbs.solutionMentions.length > 0
                        ? `Differentiating factors include industry-specific expertise, white-glove implementation services, reference customers in similar verticals, and demonstrated ROI within 6-12 months.`
                        : `Selection criteria emphasize vendor financial stability, implementation methodology maturity, customer success track record, and ability to customize for unique business requirements.`,
                    
                    firingCriteria: breadcrumbs.struggleSignals.length > 0 || breadcrumbs.constraintSignals.length > 0
                        ? `Deal-breakers include any unplanned downtime affecting operations, data security breaches, inability to meet compliance requirements, or lack of responsive technical support during critical issues.`
                        : `Vendors get rejected for hidden costs, inability to scale with growth, poor integration capabilities, or failure to deliver promised functionality within agreed timelines.`,
                    
                    keyTradeoffs: breadcrumbs.constraintSignals.length > 0
                        ? `The organization is willing to accept longer implementation timelines for better long-term fit, and may sacrifice some customization flexibility for faster time-to-value and lower TCO.`
                        : `Acceptable compromises include adopting standard workflows over custom processes, phased rollouts over big-bang deployments, and cloud-based solutions over on-premise for better scalability.`
                };
            };

            // F-8: AI-Powered Pillar Generation (Glass Box)
            const generatePillarsFromValueProps = async (valueProps, refinementText = null, pillarIndex = null) => {
                // Simulate AI thematic analysis and clustering
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Filter out empty value props
                const validProps = valueProps.filter(prop => 
                    prop.val1?.trim() || prop.val2?.trim() || prop.val3?.trim()
                );
                
                if (validProps.length === 0) {
                    throw new Error("No value propositions found. Please add some value propositions first.");
                }
                
                if (validProps.length === 1) {
                    // For single prop, create one pillar
                    return [{
                        id: 1,
                        pillarName: "Core Value Driver",
                        benefitStatement: "Our primary strategic advantage that delivers measurable business impact",
                        rationale: "With only one value proposition defined, we've created a focused pillar that highlights your core differentiator.",
                        supportingAttributeIds: [0]
                    }];
                }
                
                // For refinement, update only the specific pillar
                if (refinementText && pillarIndex !== null) {
                    // Simulate refined generation based on user feedback
                    const refinedPillar = generateRefinedPillar(validProps, refinementText, pillarIndex);
                    return [refinedPillar];
                }
                
                // Perform thematic clustering for 2-3 pillars
                const pillars = [];
                const usedProps = new Set();
                
                // Analyze themes in value props
                const themes = analyzeValuePropThemes(validProps);
                
                themes.forEach((theme, index) => {
                    const supportingIds = theme.propIndices.filter(id => !usedProps.has(id));
                    
                    if (supportingIds.length > 0) {
                        supportingIds.forEach(id => usedProps.add(id));
                        
                        pillars.push({
                            id: index + 1,
                            pillarName: theme.name,
                            benefitStatement: theme.benefit,
                            rationale: theme.rationale,
                            supportingAttributeIds: supportingIds
                        });
                    }
                });
                
                return pillars;
            };
            
            const analyzeValuePropThemes = (valueProps) => {
                const themes = [];
                const categories = {
                    technology: { keywords: ['AI', 'automated', 'intelligent', 'machine learning', 'algorithm', 'data', 'analytics', 'real-time'], props: [] },
                    efficiency: { keywords: ['reduces', 'faster', 'streamlines', 'automates', 'eliminates', 'accelerates', 'optimizes'], props: [] },
                    security: { keywords: ['secure', 'compliant', 'protected', 'encrypted', 'audit', 'governance', 'risk'], props: [] },
                    scale: { keywords: ['scalable', 'enterprise', 'global', 'unlimited', 'massive', 'extensive'], props: [] },
                    insight: { keywords: ['insights', 'visibility', 'analysis', 'intelligence', 'understanding', 'clarity'], props: [] },
                    integration: { keywords: ['integrates', 'connects', 'unified', 'seamless', 'workflow', 'ecosystem'], props: [] }
                };
                
                // Categorize props by theme
                valueProps.forEach((prop, index) => {
                    const text = `${prop.val1} ${prop.val2} ${prop.val3}`.toLowerCase();
                    let bestMatch = null;
                    let maxScore = 0;
                    
                    for (const [category, data] of Object.entries(categories)) {
                        const score = data.keywords.reduce((count, keyword) => 
                            count + (text.includes(keyword.toLowerCase()) ? 1 : 0), 0);
                        
                        if (score > maxScore) {
                            maxScore = score;
                            bestMatch = category;
                        }
                    }
                    
                    if (bestMatch && maxScore > 0) {
                        categories[bestMatch].props.push(index);
                    } else {
                        // Default to efficiency theme
                        categories.efficiency.props.push(index);
                    }
                });
                
                // Create themes from categories with props
                const themeMap = {
                    technology: {
                        name: "Advanced Technology",
                        benefit: "Leverages cutting-edge technology to deliver superior capabilities and outcomes",
                        rationale: "These value propositions share a common theme of technological sophistication and innovation"
                    },
                    efficiency: {
                        name: "Operational Excellence", 
                        benefit: "Streamlines processes and eliminates inefficiencies to maximize productivity",
                        rationale: "These value propositions focus on improving speed, reducing effort, and optimizing workflows"
                    },
                    security: {
                        name: "Enterprise Security",
                        benefit: "Ensures robust security and compliance without compromising functionality",
                        rationale: "These value propositions emphasize security, compliance, and risk mitigation capabilities"
                    },
                    scale: {
                        name: "Enterprise Scale",
                        benefit: "Handles enterprise-level complexity and volume requirements effortlessly",
                        rationale: "These value propositions highlight scalability and enterprise-grade capabilities"
                    },
                    insight: {
                        name: "Strategic Intelligence",
                        benefit: "Provides deep insights and visibility to enable data-driven decision making",
                        rationale: "These value propositions center on delivering clarity, understanding, and actionable insights"
                    },
                    integration: {
                        name: "Seamless Integration",
                        benefit: "Connects seamlessly with existing systems and workflows",
                        rationale: "These value propositions focus on integration capabilities and workflow connectivity"
                    }
                };
                
                // Build final themes (max 3)
                const sortedCategories = Object.entries(categories)
                    .filter(([_, data]) => data.props.length > 0)
                    .sort(([_, a], [__, b]) => b.props.length - a.props.length)
                    .slice(0, 3);
                    
                sortedCategories.forEach(([category, data]) => {
                    themes.push({
                        ...themeMap[category],
                        propIndices: data.props
                    });
                });
                
                // If no clear themes, create default groupings
                if (themes.length === 0) {
                    const midpoint = Math.ceil(valueProps.length / 2);
                    themes.push({
                        name: "Core Capabilities",
                        benefit: "Primary features that deliver essential business value",
                        rationale: "These value propositions represent your core product capabilities",
                        propIndices: valueProps.slice(0, midpoint).map((_, i) => i)
                    });
                    
                    if (valueProps.length > midpoint) {
                        themes.push({
                            name: "Strategic Advantages",
                            benefit: "Differentiating factors that provide competitive edge",
                            rationale: "These value propositions highlight your unique competitive advantages",
                            propIndices: valueProps.slice(midpoint).map((_, i) => i + midpoint)
                        });
                    }
                }
                
                return themes;
            };
            
            const generateRefinedPillar = (valueProps, refinementText, pillarIndex) => {
                // Simple refinement simulation based on user input
                const keywords = refinementText.toLowerCase().split(' ').filter(word => word.length > 3);
                
                let pillarName = "Refined Strategic Pillar";
                let benefit = "Delivers strategic value aligned with your specific requirements";
                let rationale = `Based on your feedback: "${refinementText}", we've adjusted this pillar to better reflect your strategic intent.`;
                
                // Try to incorporate user keywords into the name
                if (keywords.includes('security') || keywords.includes('secure')) {
                    pillarName = "Enhanced Security Framework";
                    benefit = "Provides comprehensive security and compliance capabilities";
                } else if (keywords.includes('efficiency') || keywords.includes('fast')) {
                    pillarName = "Operational Efficiency Engine";
                    benefit = "Maximizes operational efficiency and reduces time-to-value";
                } else if (keywords.includes('scale') || keywords.includes('enterprise')) {
                    pillarName = "Enterprise Scale Platform";
                    benefit = "Handles enterprise-level requirements with seamless scalability";
                } else if (keywords.includes('insight') || keywords.includes('analytics')) {
                    pillarName = "Strategic Intelligence Hub";
                    benefit = "Transforms data into actionable strategic insights";
                } else if (keywords.includes('integration') || keywords.includes('connect')) {
                    pillarName = "Unified Integration Layer";
                    benefit = "Seamlessly integrates with existing systems and workflows";
                }
                
                return {
                    id: pillarIndex + 1,
                    pillarName,
                    benefitStatement: benefit,
                    rationale,
                    supportingAttributeIds: [pillarIndex] // Simplified for refinement
                };
            };
            
            // F-8: Handler for generating pillars
            const handleGeneratePillars = async () => {
                try {
                    setPillarGenModalOpen(true);
                    setPillarGenState(prev => ({
                        ...prev,
                        isGenerating: true,
                        suggestedPillars: [],
                        error: null,
                        refinementInputs: {}
                    }));
                    
                    const suggestedPillars = await generatePillarsFromValueProps(appState.positioningData.values || []);
                    
                    setPillarGenState(prev => ({
                        ...prev,
                        isGenerating: false,
                        suggestedPillars,
                        refinementInputs: Object.fromEntries(suggestedPillars.map(p => [p.id, '']))
                    }));
                    
                } catch (error) {
                    setPillarGenState(prev => ({
                        ...prev,
                        isGenerating: false,
                        error: error.message
                    }));
                }
            };
            
            // F-8: Handler for accepting a pillar
            const handleAcceptPillar = (pillar) => {
                const maxId = Math.max(0, ...(appState.positioningData.pillars || []).map(p => p.id));
                const newPillar = {
                    id: maxId + 1,
                    name: pillar.pillarName,
                    benefit: pillar.benefitStatement
                };
                
                // Add pillar to state
                const newPillars = [...(appState.positioningData.pillars || []), newPillar];
                
                // Update pillarId for supporting value props
                const newValues = (appState.positioningData.values || []).map((val, index) => {
                    if (pillar.supportingAttributeIds.includes(index)) {
                        return { ...val, pillarId: newPillar.id };
                    }
                    return val;
                });
                
                setAppState(prev => ({
                    ...prev,
                    positioningData: {
                        ...prev.positioningData,
                        pillars: newPillars,
                        values: newValues
                    }
                }));
                
                // Close modal
                setPillarGenModalOpen(false);
            };
            
            // F-8: Handler for refining a pillar
            const handleRefinePillar = async (pillarId, refinementText) => {
                if (!refinementText.trim()) return;
                
                try {
                    setPillarGenState(prev => ({
                        ...prev,
                        isGenerating: true
                    }));
                    
                    const refinedPillars = await generatePillarsFromValueProps(
                        appState.positioningData.values || [],
                        refinementText,
                        pillarId - 1
                    );
                    
                    if (refinedPillars.length > 0) {
                        const refinedPillar = refinedPillars[0];
                        
                        setPillarGenState(prev => ({
                            ...prev,
                            isGenerating: false,
                            suggestedPillars: prev.suggestedPillars.map(p => 
                                p.id === pillarId ? { ...refinedPillar, id: pillarId } : p
                            ),
                            refinementInputs: {
                                ...prev.refinementInputs,
                                [pillarId]: ''
                            }
                        }));
                    }
                } catch (error) {
                    setPillarGenState(prev => ({
                        ...prev,
                        isGenerating: false,
                        error: error.message
                    }));
                }
            };

            const updateNestedValue = (section, index, key, value) => {
                const newData = { ...appState.positioningData };
                if (!newData[section]) newData[section] = [];
                if (!newData[section][index]) newData[section][index] = {};
                newData[section][index][key] = value;
                setAppState(prev => ({ ...prev, positioningData: newData }));
            };

            const addItem = (section, template) => {
                const newData = { ...appState.positioningData };
                if (!newData[section]) newData[section] = [];
                newData[section].push(template);
                setAppState(prev => ({ ...prev, positioningData: newData }));
            };

            const removeItem = (section, index) => {
                const newData = { ...appState.positioningData };
                if (newData[section]) {
                    newData[section].splice(index, 1);
                    setAppState(prev => ({ ...prev, positioningData: newData }));
                    // Clear grading state for removed item
                    setGradingState(prev => {
                        const newState = { ...prev };
                        delete newState[index];
                        return newState;
                    });
                    setAnalysisState(prev => {
                        const newState = { ...prev };
                        delete newState[index];
                        return newState;
                    });
                }
            };

            const handleExport = () => {
                const formatSection = (title, content) => `## ${title}\n${content || 'N/A'}\n\n`;
                const formatList = (items, k1, k2) => items.map(item => `- ${item[k1]}: ${item[k2]}`).join('\n');
                
                let summary = `Part 1: ICP & Positioning Blueprint\n======================================\n\n`;
                summary += `## 1. Ideal Customer Profile (ICP)\n`;
                summary += `- Segment Foundation: See Part 1 export for complete segment data\n`;
                summary += `- Quick Decision Making: ${appState.positioningData.icp_quick_decision_making || 'N/A'}\n`;
                summary += `- Prioritized Requirements: ${appState.positioningData.icp_prioritized_requirements || 'N/A'}\n`;
                summary += `- Implementation Readiness: ${appState.positioningData.icp_implementation_readiness || 'N/A'}\n`;
                summary += `- Firmographic: ${appState.positioningData.icp_firmographic || 'N/A'}\n`;
                summary += `- Technographic: ${appState.positioningData.icp_technographic || 'N/A'}\n`;
                summary += `- Behavioral: ${appState.positioningData.icp_behavioral || 'N/A'}\n\n`;

                summary += formatSection('2. Competitive Alternatives', appState.positioningData.alternatives ? formatList(appState.positioningData.alternatives, 'val1', 'val2') : 'N/A');
                summary += formatSection('5. Summarize Target Market', appState.positioningData.icp_summary || 'N/A');
                let marketContext = appState.positioningData['market-context'] === 'Other' ? appState.positioningData['market-context-other'] : appState.positioningData['market-context'];
                summary += formatSection('6. Market Context (Today)', marketContext);
                let trendsContent = '';
                if (appState.positioningData.trend1_desc) trendsContent += `- Industry Trend 1: ${appState.positioningData.trend1_desc}\n`;
                if (appState.positioningData.trend2_desc) trendsContent += `- Industry Trend 2: ${appState.positioningData.trend2_desc}\n`;
                if (appState.positioningData.trend3_desc) trendsContent += `- Industry Trend 3: ${appState.positioningData.trend3_desc}\n`;
                if (appState.positioningData.trend4_desc) trendsContent += `- Industry Trend 4: ${appState.positioningData.trend4_desc}\n`;
                summary += formatSection('4. Relevant Trends', trendsContent || 'N/A');

                setExportModal({ isOpen: true, content: summary, title: 'Positioning Summary' });
            };

            return (
                <div className="container mx-auto px-4 sm:px-6 lg:px-8 min-h-screen pb-16">
                    <header className="sticky-header">
                        <div className="flex justify-between items-center py-3">
                            <div className="flex items-center space-x-4">
                                <button onClick={() => onNavigate('segment')} className="text-gray-600 hover:scale-gold-text">← Back to Segment Foundation</button>
                                <h1 className="text-xl sm:text-2xl font-bold scale-green-text">Part 2: ICP Definition</h1>
                            </div>
                            <div className="flex items-center space-x-2">
                                <button
                                    onClick={() => {
                                        if (window.confirm("Are you sure you want to reset all data for Part 1? This will clear all ICP and Positioning fields.")) {
                                            setAppState(prev => ({
                                                ...prev,
                                                positioningData: getInitialState().positioningData
                                            }));
                                        }
                                    }}
                                    className="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 text-sm"
                                >
                                    Reset
                                </button>
                                <button onClick={handleExport} className="scale-green-bg text-white font-bold py-2 px-4 rounded-lg hover:bg-opacity-90">Export</button>
                            </div>
                        </div>
                    </header>

                    <div className="mt-8">
                        <div className="lg:flex lg:space-x-8">
                            <nav className="hidden lg:block w-1/4 sticky top-28 self-start">
                                <div className="bg-white p-4 rounded-lg shadow-md">
                                    <h3 className="font-bold scale-green-text mb-2 text-lg">Sections</h3>
                                    <ul className="space-y-1">
                                        <li><a href="#section-1" className="nav-link block p-2 rounded text-gray-700 font-semibold">1. Define Your ICP</a></li>
                                        <li><a href="#section-2" className="nav-link block p-2 rounded text-gray-700 font-semibold">2. Competitive Alternatives</a></li>
                                        <li><a href="#section-3" className="nav-link block p-2 rounded text-gray-700 font-semibold">3. Value and Proof</a></li>
                                        <li><a href="#section-4" className="nav-link block p-2 rounded text-gray-700 font-semibold">4. Relevant Trends</a></li>
                                        <li><a href="#section-5" className="nav-link block p-2 rounded text-gray-700 font-semibold">5. Strategic Pillars</a></li>
                                    </ul>
                                    <div className="mt-4 pt-4 border-t">
                                        <button onClick={() => { onNavigate('icp'); window.scrollTo(0, 0); }} className="text-sm text-gray-600 hover:scale-gold-text font-semibold w-full text-left">
                                            Continue to Part 2: ICP Definition →
                                        </button>
                                    </div>
                                </div>
                            </nav>

                            <main className="w-full lg:w-3/4">
                                <div className="space-y-8">
                        <div id="section-1" className="bg-white p-8 rounded-lg shadow-md scroll-mt-24">
                            <h2 className="text-2xl font-bold scale-green-text mb-2">1. Define Your Ideal Customer Profile (ICP)</h2>
                            <p className="text-gray-600 mb-6">This is the foundation. A precise ICP provides the lens through which all other positioning elements are viewed. Be specific and use data where possible.</p>
                            
                            {/* Segment Foundation Summary */}
                            <div className="mb-8 p-6 bg-green-50 border border-green-200 rounded-lg">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold scale-green-text">Segment Foundation Summary</h3>
                                    <button 
                                        onClick={() => onNavigate('segment')}
                                        className="text-sm text-green-600 hover:text-green-800 font-semibold flex items-center gap-1"
                                    >
                                        ← Edit Segment Foundation
                                    </button>
                                </div>
                                
                                {/* Check if segment data exists */}
                                {appState.segmentData && Object.keys(appState.segmentData).some(key => appState.segmentData[key]?.trim()) ? (
                                    <div className="space-y-4">
                                        {/* Jobs to be Done Summary */}
                                        {appState.segmentData['Desired Outcomes'] && (
                                            <div>
                                                <h4 className="font-semibold text-gray-700 mb-1">Desired Outcomes</h4>
                                                <p className="text-sm text-gray-600 bg-white p-3 rounded border">
                                                    {appState.segmentData['Desired Outcomes']}
                                                </p>
                                            </div>
                                        )}
                                        
                                        {/* Customer Value Summary */}
                                        <div className="grid md:grid-cols-2 gap-4">
                                            {appState.segmentData['Functional Value'] && (
                                                <div>
                                                    <h4 className="font-semibold text-gray-700 mb-1">Functional Value</h4>
                                                    <p className="text-sm text-gray-600 bg-white p-3 rounded border">
                                                        {appState.segmentData['Functional Value']}
                                                    </p>
                                                </div>
                                            )}
                                            
                                            {appState.segmentData['Economic Justification'] && (
                                                <div>
                                                    <h4 className="font-semibold text-gray-700 mb-1">Economic Justification</h4>
                                                    <p className="text-sm text-gray-600 bg-white p-3 rounded border">
                                                        {appState.segmentData['Economic Justification']}
                                                    </p>
                                                </div>
                                            )}
                                            
                                            {appState.segmentData['Table Stakes'] && (
                                                <div>
                                                    <h4 className="font-semibold text-gray-700 mb-1">Table Stakes</h4>
                                                    <p className="text-sm text-gray-600 bg-white p-3 rounded border">
                                                        {appState.segmentData['Table Stakes']}
                                                    </p>
                                                </div>
                                            )}
                                            
                                            {appState.segmentData['Ease of Doing Business'] && (
                                                <div>
                                                    <h4 className="font-semibold text-gray-700 mb-1">Ease of Doing Business</h4>
                                                    <p className="text-sm text-gray-600 bg-white p-3 rounded border">
                                                        {appState.segmentData['Ease of Doing Business']}
                                                    </p>
                                                </div>
                                            )}
                                        </div>
                                        
                                        {/* Additional context fields if available */}
                                        {(appState.segmentData['Context'] || appState.segmentData['Struggling Moments']) && (
                                            <div className="pt-4 border-t border-green-200">
                                                <h4 className="font-semibold text-gray-700 mb-2">Business Context</h4>
                                                <div className="space-y-2">
                                                    {appState.segmentData['Context'] && (
                                                        <p className="text-sm text-gray-600">
                                                            <span className="font-medium">Context:</span> {appState.segmentData['Context']}
                                                        </p>
                                                    )}
                                                    {appState.segmentData['Struggling Moments'] && (
                                                        <p className="text-sm text-gray-600">
                                                            <span className="font-medium">Struggling Moments:</span> {appState.segmentData['Struggling Moments']}
                                                        </p>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <div className="text-center py-8">
                                        <div className="text-gray-500 mb-3">
                                            <span className="text-2xl">📝</span>
                                        </div>
                                        <h4 className="font-semibold text-gray-700 mb-2">No Segment Data Yet</h4>
                                        <p className="text-sm text-gray-600 mb-4">
                                            Complete Part 1 (Segment Foundation) to see your market segment data here.
                                        </p>
                                        <button 
                                            onClick={() => onNavigate('segment')}
                                            className="scale-green-bg text-white font-semibold py-2 px-4 rounded-lg hover:bg-opacity-90"
                                        >
                                            Go to Part 1: Segment Foundation
                                        </button>
                                    </div>
                                )}
                            </div>
                            
                            <div className="space-y-6">
                                <div>
                                    <label className="block font-bold text-gray-700">Quick Decision Making</label>
                                    <p className="text-sm text-gray-500 mb-2">Who is the economic buyer and can they approve the purchase efficiently?</p>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="3" 
                                        placeholder="Example: The VP of Finance is the economic buyer. They have budget authority up to $250k for transformation projects and can sign off without a lengthy committee review."
                                        value={appState.positioningData.icp_quick_decision_making || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, icp_quick_decision_making: e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Prioritized Requirements</label>
                                    <p className="text-sm text-gray-500 mb-2">What do they value most in a solution for this problem?</p>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="3" 
                                        placeholder="Example: Speed-to-insight is #1. We cannot wait 6 months for consultants. #2 is accuracy; the data must be audit-grade. #3 is ease of use for our internal team."
                                        value={appState.positioningData.icp_prioritized_requirements || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, icp_prioritized_requirements: e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Implementation Readiness</label>
                                    <p className="text-sm text-gray-500 mb-2">Can they adopt and get value from the product today?</p>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="3" 
                                        placeholder="Example: They have a dedicated transformation team ready to start. All relevant contracts and process documents are digitized and accessible."
                                        value={appState.positioningData.icp_implementation_readiness || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, icp_implementation_readiness: e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Firmographic</label>
                                    <p className="text-sm text-gray-500 mb-2">What are the key company attributes (size, industry, revenue)?</p>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="3" 
                                        placeholder="Example: Publicly traded B2B SaaS company, >$1B in annual revenue, 2000+ employees. Headquartered in North America."
                                        value={appState.positioningData.icp_firmographic || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, icp_firmographic: e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Technographic</label>
                                    <p className="text-sm text-gray-500 mb-2">What is their current technology stack?</p>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="3" 
                                        placeholder="Example: Currently using NetSuite, Salesforce, and Coupa. Moving to Oracle Fusion. Internal BI uses Tableau."
                                        value={appState.positioningData.icp_technographic || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, icp_technographic: e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Behavioral</label>
                                    <p className="text-sm text-gray-500 mb-2">How do they act, buy, and use technology?</p>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="3" 
                                        placeholder="Example: They are early adopters of AI technology in their finance stack. They prefer to buy best-of-breed solutions over suite extensions. They have a history of successful, large-scale software implementations."
                                        value={appState.positioningData.icp_behavioral || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, icp_behavioral: e.target.value } }))}
                                    />
                                </div>
                            </div>
                        </div>

                        <div id="section-2" className="bg-white p-8 rounded-lg shadow-md scroll-mt-24">
                            <h2 className="text-2xl font-bold scale-green-text mb-2">2. Competitive Alternatives</h2>
                            <div className="space-y-4">
                                {(appState.positioningData.alternatives || []).map((item, index) => (
                                    <RemovableRow 
                                        key={index}
                                        index={index}
                                        item={item}
                                        onUpdate={(idx, key, value) => updateNestedValue('alternatives', idx, key, value)}
                                        onRemove={(idx) => removeItem('alternatives', idx)}
                                        placeholder1="Alternative"
                                        placeholder2="Why it's inadequate"
                                        onAnalyze={(item, idx) => simulateCompetitiveAnalysis(item, idx)}
                                        analysisResult={analysisState[index]}
                                    />
                                ))}
                                <button 
                                    onClick={() => addItem('alternatives', { val1: '', val2: '' })}
                                    className="text-sm scale-green-bg text-white font-bold py-2 px-3 rounded-lg hover:bg-opacity-90"
                                >
                                    + Add Alternative
                                </button>
                            </div>
                        </div>

                        <div id="section-3" className="bg-white p-8 rounded-lg shadow-md scroll-mt-24">
                            <h2 className="text-2xl font-bold scale-green-text mb-2">3. Value and Proof</h2>
                            <div className="space-y-6">
                                {(() => {
                                    // Group values by pillarId
                                    const groupedValues = {};
                                    const ungroupedValues = [];
                                    
                                    (appState.positioningData.values || []).forEach((item, index) => {
                                        if (item.pillarId) {
                                            if (!groupedValues[item.pillarId]) {
                                                groupedValues[item.pillarId] = [];
                                            }
                                            groupedValues[item.pillarId].push({ item, index });
                                        } else {
                                            ungroupedValues.push({ item, index });
                                        }
                                    });
                                    
                                    return (
                                        <>
                                            {/* Render ungrouped values first */}
                                            {ungroupedValues.length > 0 && (
                                                <div className="space-y-4">
                                                    {ungroupedValues.length > 0 && (
                                                        <div className="text-sm font-medium text-gray-500 border-b border-gray-200 pb-2 mb-4">
                                                            Unassigned Value Propositions
                                                        </div>
                                                    )}
                                                    {ungroupedValues.map(({ item, index }) => (
                                                        <RemovableTriple 
                                                            key={index}
                                                            index={index}
                                                            item={item}
                                                            onUpdate={(idx, key, value) => updateNestedValue('values', idx, key, value)}
                                                            onRemove={(idx) => removeItem('values', idx)}
                                                            onGrade={(item, idx) => simulateAIGrading(item, idx)}
                                                            gradingResult={gradingState[index]}
                                                            onAnalyzeUniqueness={(attributeText, idx) => analyzeUniqueness(attributeText, idx)}
                                                            uniquenessResult={uniquenessResults[index]}
                                                            pillars={appState.positioningData.pillars}
                                                        />
                                                    ))}
                                                </div>
                                            )}
                                            
                                            {/* Render grouped values by pillar */}
                                            {(appState.positioningData.pillars || []).map((pillar) => {
                                                const pillarValues = groupedValues[pillar.id] || [];
                                                if (pillarValues.length === 0) return null;
                                                
                                                return (
                                                    <div key={pillar.id} className="space-y-4">
                                                        <div className="border-l-4 border-blue-500 pl-4 py-2 bg-blue-50">
                                                            <h3 className="text-lg font-bold text-gray-800">
                                                                {pillar.name || `Strategic Pillar ${pillar.id}`}
                                                            </h3>
                                                            {pillar.benefit && (
                                                                <p className="text-sm text-gray-600 mt-1">{pillar.benefit}</p>
                                                            )}
                                                        </div>
                                                        <div className="space-y-4 ml-4">
                                                            {pillarValues.map(({ item, index }) => (
                                                                <RemovableTriple 
                                                                    key={index}
                                                                    index={index}
                                                                    item={item}
                                                                    onUpdate={(idx, key, value) => updateNestedValue('values', idx, key, value)}
                                                                    onRemove={(idx) => removeItem('values', idx)}
                                                                    onGrade={(item, idx) => simulateAIGrading(item, idx)}
                                                                    gradingResult={gradingState[index]}
                                                                    onAnalyzeUniqueness={(attributeText, idx) => analyzeUniqueness(attributeText, idx)}
                                                                    uniquenessResult={uniquenessResults[index]}
                                                                    pillars={appState.positioningData.pillars}
                                                                />
                                                            ))}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </>
                                    );
                                })()}
                                
                                <button 
                                    onClick={() => addItem('values', { val1: '', val2: '', val3: '', pillarId: null })}
                                    className="text-sm scale-green-bg text-white font-bold py-2 px-3 rounded-lg hover:bg-opacity-90"
                                >
                                    + Add Value Point
                                </button>
                            </div>
                        </div>

                        <div id="section-4" className="bg-white p-8 rounded-lg shadow-md scroll-mt-24">
                            <h2 className="text-2xl font-bold scale-green-text mb-2">4. Relevant Trends</h2>
                            <p className="font-semibold text-gray-600 mb-2">Question: What macro trends create urgency for our solution *right now*?</p>
                            <p className="text-gray-600 mb-6">Guidance: Tying your solution to an undeniable trend creates urgency.</p>
                            <div className="space-y-6">
                                <div>
                                    <label className="block font-bold text-gray-700">Industry Trend 1</label>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="2" 
                                        placeholder="How this trend aligns with and enhances your product"
                                        value={appState.positioningData.trend1_desc || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, trend1_desc: e.target.value } }))}
                                    />
                                    <div className="mt-2 space-y-3">
                                        <button 
                                            className="text-sm font-bold py-2 px-3 rounded-lg transition-colors scale-blue-bg hover:bg-blue-700 text-white disabled:opacity-50"
                                            onClick={() => analyzeTrend(appState.positioningData.trend1_desc, 0)}
                                            disabled={trendAnalysisResults[0]?.isAnalyzing || !appState.positioningData.trend1_desc?.trim()}
                                        >
                                            {trendAnalysisResults[0]?.isAnalyzing ? 'Analyzing trend...' : 'Analyze Trend'}
                                        </button>
                                        
                                        {trendAnalysisResults[0] && !trendAnalysisResults[0].isAnalyzing && (
                                            <div className="bg-white p-3 rounded-md border border-gray-300">
                                                <div className="mb-2">
                                                    <span className="text-sm font-bold text-gray-700">Trend Analysis:</span>
                                                </div>
                                                {trendAnalysisResults[0].error ? (
                                                    <div className="text-sm text-red-600">
                                                        {trendAnalysisResults[0].error}
                                                    </div>
                                                ) : trendAnalysisResults[0].results && trendAnalysisResults[0].results.length > 0 ? (
                                                    <div className="space-y-2">
                                                        {trendAnalysisResults[0].results.slice(0, 3).map((result, idx) => (
                                                            <div key={idx} className="text-sm text-gray-600">
                                                                <a href={result.url} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:text-blue-800 font-medium">
                                                                    {result.title}
                                                                </a>
                                                                <p className="text-xs text-gray-500 mt-1">{result.description}</p>
                                                            </div>
                                                        ))}
                                                    </div>
                                                ) : (
                                                    <div className="text-sm text-red-600">
                                                        No strong evidence found for this trend. Consider rephrasing.
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Industry Trend 2</label>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="2" 
                                        placeholder="How this trend makes your product more appealing"
                                        value={appState.positioningData.trend2_desc || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, trend2_desc: e.target.value } }))}
                                    />
                                    <div className="mt-2 space-y-3">
                                        <button 
                                            className="text-sm font-bold py-2 px-3 rounded-lg transition-colors scale-blue-bg hover:bg-blue-700 text-white disabled:opacity-50"
                                            onClick={() => analyzeTrend(appState.positioningData.trend2_desc, 1)}
                                            disabled={trendAnalysisResults[1]?.isAnalyzing || !appState.positioningData.trend2_desc?.trim()}
                                        >
                                            {trendAnalysisResults[1]?.isAnalyzing ? 'Analyzing trend...' : 'Analyze Trend'}
                                        </button>
                                        
                                        {trendAnalysisResults[1] && !trendAnalysisResults[1].isAnalyzing && (
                                            <div className="bg-white p-3 rounded-md border border-gray-300">
                                                <div className="mb-2">
                                                    <span className="text-sm font-bold text-gray-700">Trend Analysis:</span>
                                                </div>
                                                {trendAnalysisResults[1].error ? (
                                                    <div className="text-sm text-red-600">
                                                        {trendAnalysisResults[1].error}
                                                    </div>
                                                ) : trendAnalysisResults[1].results && trendAnalysisResults[1].results.length > 0 ? (
                                                    <div className="space-y-2">
                                                        {trendAnalysisResults[1].results.slice(0, 3).map((result, idx) => (
                                                            <div key={idx} className="text-sm text-gray-600">
                                                                <a href={result.url} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:text-blue-800 font-medium">
                                                                    {result.title}
                                                                </a>
                                                                <p className="text-xs text-gray-500 mt-1">{result.description}</p>
                                                            </div>
                                                        ))}
                                                    </div>
                                                ) : (
                                                    <div className="text-sm text-red-600">
                                                        No strong evidence found for this trend. Consider rephrasing.
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Industry Trend 3 (Optional)</label>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="2" 
                                        placeholder="How this trend creates urgency for your product"
                                        value={appState.positioningData.trend3_desc || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, trend3_desc: e.target.value } }))}
                                    />
                                    <div className="mt-2 space-y-3">
                                        <button 
                                            className="text-sm font-bold py-2 px-3 rounded-lg transition-colors scale-blue-bg hover:bg-blue-700 text-white disabled:opacity-50"
                                            onClick={() => analyzeTrend(appState.positioningData.trend3_desc, 2)}
                                            disabled={trendAnalysisResults[2]?.isAnalyzing || !appState.positioningData.trend3_desc?.trim()}
                                        >
                                            {trendAnalysisResults[2]?.isAnalyzing ? 'Analyzing trend...' : 'Analyze Trend'}
                                        </button>
                                        
                                        {trendAnalysisResults[2] && !trendAnalysisResults[2].isAnalyzing && (
                                            <div className="bg-white p-3 rounded-md border border-gray-300">
                                                <div className="mb-2">
                                                    <span className="text-sm font-bold text-gray-700">Trend Analysis:</span>
                                                </div>
                                                {trendAnalysisResults[2].error ? (
                                                    <div className="text-sm text-red-600">
                                                        {trendAnalysisResults[2].error}
                                                    </div>
                                                ) : trendAnalysisResults[2].results && trendAnalysisResults[2].results.length > 0 ? (
                                                    <div className="space-y-2">
                                                        {trendAnalysisResults[2].results.slice(0, 3).map((result, idx) => (
                                                            <div key={idx} className="text-sm text-gray-600">
                                                                <a href={result.url} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:text-blue-800 font-medium">
                                                                    {result.title}
                                                                </a>
                                                                <p className="text-xs text-gray-500 mt-1">{result.description}</p>
                                                            </div>
                                                        ))}
                                                    </div>
                                                ) : (
                                                    <div className="text-sm text-red-600">
                                                        No strong evidence found for this trend. Consider rephrasing.
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">Industry Trend 4 (Optional)</label>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="2" 
                                        placeholder="How this trend impacts the need for your product"
                                        value={appState.positioningData.trend4_desc || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, positioningData: { ...prev.positioningData, trend4_desc: e.target.value } }))}
                                    />
                                    <div className="mt-2 space-y-3">
                                        <button 
                                            className="text-sm font-bold py-2 px-3 rounded-lg transition-colors scale-blue-bg hover:bg-blue-700 text-white disabled:opacity-50"
                                            onClick={() => analyzeTrend(appState.positioningData.trend4_desc, 3)}
                                            disabled={trendAnalysisResults[3]?.isAnalyzing || !appState.positioningData.trend4_desc?.trim()}
                                        >
                                            {trendAnalysisResults[3]?.isAnalyzing ? 'Analyzing trend...' : 'Analyze Trend'}
                                        </button>
                                        
                                        {trendAnalysisResults[3] && !trendAnalysisResults[3].isAnalyzing && (
                                            <div className="bg-white p-3 rounded-md border border-gray-300">
                                                <div className="mb-2">
                                                    <span className="text-sm font-bold text-gray-700">Trend Analysis:</span>
                                                </div>
                                                {trendAnalysisResults[3].error ? (
                                                    <div className="text-sm text-red-600">
                                                        {trendAnalysisResults[3].error}
                                                    </div>
                                                ) : trendAnalysisResults[3].results && trendAnalysisResults[3].results.length > 0 ? (
                                                    <div className="space-y-2">
                                                        {trendAnalysisResults[3].results.slice(0, 3).map((result, idx) => (
                                                            <div key={idx} className="text-sm text-gray-600">
                                                                <a href={result.url} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:text-blue-800 font-medium">
                                                                    {result.title}
                                                                </a>
                                                                <p className="text-xs text-gray-500 mt-1">{result.description}</p>
                                                            </div>
                                                        ))}
                                                    </div>
                                                ) : (
                                                    <div className="text-sm text-red-600">
                                                        No strong evidence found for this trend. Consider rephrasing.
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="section-5" className="bg-white p-8 rounded-lg shadow-md scroll-mt-24">
                            <h2 className="text-2xl font-bold scale-green-text mb-2">5. Strategic Pillars</h2>
                            <p className="text-gray-600 mb-6">Organize your value propositions under strategic pillars to create a coherent narrative. Each pillar represents a core benefit theme that groups related value propositions.</p>
                            <div className="space-y-4">
                                {(appState.positioningData.pillars || []).map((pillar, index) => (
                                    <div key={pillar.id} className="p-4 border border-gray-200 rounded-lg space-y-3 bg-gray-50">
                                        <div className="flex items-start justify-between">
                                            <div className="flex-grow space-y-3">
                                                <div>
                                                    <label className="block text-sm font-semibold text-gray-700 mb-1">
                                                        Pillar Name
                                                    </label>
                                                    <input 
                                                        type="text" 
                                                        className="w-full p-2 border border-gray-300 rounded-md focus-ring-gold"
                                                        placeholder="Example: Enterprise-Grade Security"
                                                        value={pillar.name || ''}
                                                        onChange={(e) => {
                                                            const newPillars = [...(appState.positioningData.pillars || [])];
                                                            newPillars[index] = { ...newPillars[index], name: e.target.value };
                                                            setAppState(prev => ({
                                                                ...prev,
                                                                positioningData: { ...prev.positioningData, pillars: newPillars }
                                                            }));
                                                        }}
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-semibold text-gray-700 mb-1">
                                                        Benefit Statement
                                                    </label>
                                                    <textarea 
                                                        className="w-full p-2 border border-gray-300 rounded-md focus-ring-gold"
                                                        rows="2"
                                                        placeholder="Example: Ensures your data meets the highest security standards without slowing down innovation"
                                                        value={pillar.benefit || ''}
                                                        onChange={(e) => {
                                                            const newPillars = [...(appState.positioningData.pillars || [])];
                                                            newPillars[index] = { ...newPillars[index], benefit: e.target.value };
                                                            setAppState(prev => ({
                                                                ...prev,
                                                                positioningData: { ...prev.positioningData, pillars: newPillars }
                                                            }));
                                                        }}
                                                    />
                                                </div>
                                            </div>
                                            {(appState.positioningData.pillars || []).length > 1 && (
                                                <button 
                                                    onClick={() => {
                                                        const newPillars = appState.positioningData.pillars.filter((_, i) => i !== index);
                                                        // Reset pillarId for any values that were assigned to this pillar
                                                        const newValues = appState.positioningData.values.map(val => 
                                                            val.pillarId === pillar.id ? { ...val, pillarId: null } : val
                                                        );
                                                        setAppState(prev => ({
                                                            ...prev,
                                                            positioningData: { 
                                                                ...prev.positioningData, 
                                                                pillars: newPillars,
                                                                values: newValues
                                                            }
                                                        }));
                                                    }}
                                                    className="ml-3 text-red-500 hover:text-red-700 font-bold text-lg"
                                                >
                                                    ×
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                ))}
                                <div className="flex space-x-3">
                                    <button 
                                        onClick={handleGeneratePillars}
                                        className="text-sm bg-scale-blue text-white font-bold py-2 px-4 rounded-lg hover:bg-opacity-90"
                                    >
                                        🤖 Generate Strategic Pillars
                                    </button>
                                    <button 
                                        onClick={() => {
                                            const maxId = Math.max(0, ...(appState.positioningData.pillars || []).map(p => p.id));
                                            const newPillar = { id: maxId + 1, name: '', benefit: '' };
                                            setAppState(prev => ({
                                                ...prev,
                                                positioningData: {
                                                    ...prev.positioningData,
                                                    pillars: [...(prev.positioningData.pillars || []), newPillar]
                                                }
                                            }));
                                        }}
                                        className="text-sm scale-green-bg text-white font-bold py-2 px-3 rounded-lg hover:bg-opacity-90"
                                    >
                                        + Add Strategic Pillar
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="text-center mt-12 pb-24">
                            <button 
                                onClick={() => onNavigate('category')}
                                className="scale-gold-bg text-white font-bold py-4 px-8 rounded-lg hover:bg-opacity-90 text-lg"
                            >
                                Continue to Part 3: Category Design →
                            </button>
                        </div>
                                </div>
                            </main>
                        </div>
                    </div>

                    <ExportModal 
                        isOpen={exportModal.isOpen}
                        onClose={() => setExportModal(prev => ({ ...prev, isOpen: false }))}
                        title={exportModal.title}
                        content={exportModal.content}
                        appState={appState}
                        filename="positioning-blueprint"
                    />
                    
                    <PillarGenerationModal 
                        isOpen={pillarGenModalOpen}
                        onClose={() => setPillarGenModalOpen(false)}
                        pillarGenState={pillarGenState}
                        onGeneratePillars={handleGeneratePillars}
                        onAcceptPillar={handleAcceptPillar}
                        onRefinePillar={handleRefinePillar}
                        onRefinementInputChange={(pillarId, value) => {
                            setPillarGenState(prev => ({
                                ...prev,
                                refinementInputs: { ...prev.refinementInputs, [pillarId]: value }
                            }));
                        }}
                    />
                    
                </div>
            );
        };

        // CategoryDesignTool Component
        const CategoryDesignTool = ({ appState, setAppState, onNavigate }) => {
            const [exportModal, setExportModal] = useState({ isOpen: false, content: '', title: '' });
            const [showSuggestions, setShowSuggestions] = useState(false);
            const [isLoadingNames, setIsLoadingNames] = useState(false);
            const [suggestedNames, setSuggestedNames] = useState([]);
            
            // AI Category State Variables
            const [aiCategoryLoading, setAiCategoryLoading] = useState(false);
            const [aiCategoryError, setAiCategoryError] = useState(null);
            
            // AI Category Drafter API Integration
            const handleGenerateCategory = async (context) => {
                setAiCategoryLoading(true);
                setAiCategoryError(null);
                
                try {
                    const response = await fetch('/api/draft-category', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            icpSummary: context.icpSummary,
                            valueProps: context.valueProps,
                            fromStatement: context.fromStatement,
                            toStatement: context.toStatement
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    return data.categories || [];
                } catch (error) {
                    console.error('Category generation failed:', error);
                    setAiCategoryError(error.message);
                    // Fallback names on error
                    return [
                        'Digital Transformation Platform',
                        'Business Intelligence Suite', 
                        'Operational Excellence System',
                        'Market Innovation Engine',
                        'Growth Acceleration Framework'
                    ];
                } finally {
                    setAiCategoryLoading(false);
                }
            };

            const handleExport = () => {
                const formatSection = (title, content) => `## ${title}\n${content || 'N/A'}\n\n`;
                
                let summary = `Part 2: Category Design Blueprint\n==================================\n\n`;
                summary += `## Positioning Foundation (from Part 1)\n`;
                summary += `- ICP Summary: ${appState.positioningData.icp_summary || 'N/A'}\n`;
                summary += `- Unique Value: ${appState.positioningData.values ? appState.positioningData.values.map(v => v.val2).join('; ') : 'N/A'}\n\n`;

                summary += `## 5. The Point of View (The "From/To" Shift)\n- From: ${appState.categoryData['from-statement'] || 'N/A'}\n- To: ${appState.categoryData['to-statement'] || 'N/A'}\n\n`;
                summary += formatSection('6. The New Opportunity', appState.categoryData['new-opportunity']);
                summary += `## 7. Category Name & Definition\n- Name: ${appState.categoryData['category-name'] || 'N/A'}\n- Definition: ${appState.categoryData['category-definition'] || 'N/A'}\n\n`;
                summary += formatSection('8. The Manifesto', appState.categoryData['manifesto']);

                setExportModal({ isOpen: true, content: summary, title: 'Category Design Summary' });
            };

            return (
                <div className="container mx-auto px-4 sm:px-6 lg:px-8">
                    <header className="sticky-header">
                        <div className="flex justify-between items-center py-3">
                            <div className="flex items-center space-x-4">
                                <button onClick={() => { onNavigate('icp'); window.scrollTo(0, 0); }} className="text-gray-600 hover:scale-gold-text">← Back to ICP Definition</button>
                                <h1 className="text-xl sm:text-2xl font-bold scale-green-text">Part 3: Category Design</h1>
                            </div>
                            <div className="flex items-center space-x-2">
                                <button
                                    onClick={() => {
                                        if (window.confirm("Are you sure you want to reset all data for Part 2? This will clear all Category Design fields.")) {
                                            setAppState(prev => ({
                                                ...prev,
                                                categoryData: getInitialState().categoryData
                                            }));
                                        }
                                    }}
                                    className="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 text-sm"
                                >
                                    Reset
                                </button>
                                <button onClick={handleExport} className="scale-green-bg text-white font-bold py-2 px-4 rounded-lg hover:bg-opacity-90">Export</button>
                            </div>
                        </div>
                    </header>

                    <div className="mt-8">
                        <div className="lg:flex lg:space-x-8">
                            <nav className="hidden lg:block w-1/4 sticky top-28 self-start">
                                <div className="bg-white p-4 rounded-lg shadow-md">
                                    <h3 className="font-bold scale-green-text mb-2 text-lg">Sections</h3>
                                    <ul className="space-y-1">
                                        <li><a href="#section-5" className="nav-link block p-2 rounded text-gray-700 font-semibold">5. The Point of View</a></li>
                                        <li><a href="#section-6" className="nav-link block p-2 rounded text-gray-700 font-semibold">6. The New Opportunity</a></li>
                                        <li><a href="#section-7" className="nav-link block p-2 rounded text-gray-700 font-semibold">7. Category Name</a></li>
                                        <li><a href="#section-8" className="nav-link block p-2 rounded text-gray-700 font-semibold">8. The Manifesto</a></li>
                                    </ul>
                                    <div className="mt-4 pt-4 border-t">
                                        <button onClick={() => onNavigate('icp')} className="text-sm text-gray-600 hover:scale-gold-text font-semibold w-full text-left">
                                            ← Back to Part 2: ICP Definition
                                        </button>
                                    </div>
                                </div>
                            </nav>

                            <main className="w-full lg:w-3/4">
                                <div className="space-y-8">
                        <div className="bg-green-50 border-l-4 border-green-600 p-6 rounded-r-lg shadow-sm">
                            <h3 className="text-xl font-bold text-green-800 mb-3">Positioning Foundation</h3>
                            <p className="text-green-700 mb-4">This category design exercise builds upon the positioning work from Part 1. Here is a summary of your key inputs:</p>
                            <div className="bg-white p-4 rounded-md border border-green-200">
                                <h4 className="font-bold text-gray-800">Ideal Customer Profile (Summary)</h4>
                                <p className="text-sm text-gray-600 mt-1 italic">{appState.positioningData.icp_summary || 'Complete Part 1 first'}</p>
                                <h4 className="font-bold text-gray-800 mt-3">Unique Value</h4>
                                <div className="text-sm text-gray-600 mt-1">
                                    {(appState.positioningData.values && appState.positioningData.values[0]?.val1) ? (
                                        <ul className="list-disc pl-5 space-y-2">
                                            {appState.positioningData.values.map((item, index) => (
                                                item.val1 && <li key={index}><strong>{item.val1}:</strong> <span className="italic">{item.val3}</span></li>
                                            ))}
                                        </ul>
                                    ) : (
                                        <span className="italic">Complete Part 1 first</span>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div id="section-5" className="bg-white p-8 rounded-lg shadow-md scroll-mt-24">
                            <h2 className="text-2xl font-bold scale-green-text mb-2">5. The Point of View (The "From/To" Shift)</h2>
                            <p className="font-semibold text-gray-600 mb-2">Question: What is the old, broken way of thinking, and what is our new, better way?</p>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label className="block font-bold text-gray-700">From (The Old, Broken Way)</label>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="4" 
                                        placeholder="Example: Business transformation is a series of slow, high-risk, episodic projects."
                                        value={appState.categoryData['from-statement'] || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'from-statement': e.target.value } }))}
                                    />
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">To (Our New, Better Way)</label>
                                    <textarea 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        rows="4" 
                                        placeholder="Example: Operational excellence is a continuous, automated, data-driven business function."
                                        value={appState.categoryData['to-statement'] || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'to-statement': e.target.value } }))}
                                    />
                                </div>
                            </div>
                        </div>

                        <div id="section-6" className="bg-white p-8 rounded-lg shadow-md scroll-mt-24">
                            <h2 className="text-2xl font-bold scale-green-text mb-2">6. The New Opportunity</h2>
                            <p className="font-semibold text-gray-600 mb-2">Question: What becomes possible for businesses that adopt our point of view?</p>
                            <textarea 
                                className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                rows="4" 
                                placeholder="Example: Businesses can now move beyond reactive, crisis-driven change and achieve continuous transformation..."
                                value={appState.categoryData['new-opportunity'] || ''}
                                onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'new-opportunity': e.target.value } }))}
                            />
                        </div>

                        <div id="section-7" className="bg-white p-8 rounded-lg shadow-md scroll-mt-24">
                            <h2 className="text-2xl font-bold scale-green-text mb-2">7. Category Name & Definition</h2>
                            <div className="space-y-4">
                                <div>
                                    <label className="block font-bold text-gray-700">Category Name</label>
                                    <div className="flex gap-2 mt-1">
                                        <input 
                                            type="text" 
                                            className="flex-1 p-2 border border-gray-300 rounded-md"
                                            placeholder="Example: Continuous Transformation"
                                            value={appState.categoryData['category-name'] || ''}
                                            onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'category-name': e.target.value } }))}
                                        />
                                        <button 
                                            className="px-4 py-2 text-white font-bold rounded-md transition-colors hover:opacity-90 disabled:opacity-50"
                                            style={{backgroundColor: '#e5a819'}}
                                            onClick={async () => {
                                                // Gather strategic inputs from appState
                                                const icpSummary = appState.positioningData.icp_summary || '';
                                                const valueProps = appState.positioningData.values 
                                                    ? appState.positioningData.values
                                                        .filter(v => v.val3)
                                                        .map(v => v.val3)
                                                    : [];
                                                const fromStatement = appState.categoryData['from-statement'] || '';
                                                const toStatement = appState.categoryData['to-statement'] || '';
                                                
                                                // Construct context for AI
                                                const context = {
                                                    icpSummary,
                                                    valueProps,
                                                    fromStatement,
                                                    toStatement
                                                };
                                                
                                                // Show loading state
                                                setShowSuggestions(true);
                                                setIsLoadingNames(true);
                                                
                                                try {
                                                    // Call AI Category Drafter API
                                                    const names = await handleGenerateCategory(context);
                                                    setSuggestedNames(names);
                                                } catch (error) {
                                                    console.error('Failed to generate names:', error);
                                                    setSuggestedNames(['Error generating names']);
                                                } finally {
                                                    setIsLoadingNames(false);
                                                }
                                            }}
                                            disabled={isLoadingNames}
                                        >
                                            {isLoadingNames ? 'Brainstorming...' : 'Brainstorm with AI'}
                                        </button>
                                    </div>
                                    {showSuggestions && (
                                        <div className="mt-2 p-3 bg-gray-50 border border-gray-200 rounded-md">
                                            {isLoadingNames ? (
                                                <p className="text-sm text-gray-600 italic">Analyzing your strategic context and generating category names...</p>
                                            ) : (
                                                <>
                                                    <p className="text-sm font-medium text-gray-700 mb-2">Select a category name:</p>
                                                    <div className="space-y-1">
                                                        {suggestedNames.map((name, index) => (
                                                    <button
                                                        key={index}
                                                        className="block w-full text-left px-3 py-2 text-sm rounded-md hover:bg-gray-100 transition-colors"
                                                        onClick={() => {
                                                            setAppState(prev => ({
                                                                ...prev, 
                                                                categoryData: {
                                                                    ...prev.categoryData, 
                                                                    'category-name': name 
                                                                }
                                                            }));
                                                            setShowSuggestions(false);
                                                        }}
                                                    >
                                                        {name}
                                                    </button>
                                                ))}
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    )}
                                </div>
                                <div>
                                    <label className="block font-bold text-gray-700">One-Sentence Definition</label>
                                    <input 
                                        type="text" 
                                        className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                        placeholder="Example: The practice of using AI to continuously analyze and optimize business processes in real-time."
                                        value={appState.categoryData['category-definition'] || ''}
                                        onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'category-definition': e.target.value } }))}
                                    />
                                </div>
                            </div>
                        </div>

                        <div id="section-8" className="bg-white p-8 rounded-lg shadow-md scroll-mt-24">
                            <h2 className="text-2xl font-bold scale-green-text mb-2">8. The Manifesto</h2>
                            <p className="font-semibold text-gray-600 mb-2">Question: What is our story?</p>
                            <textarea 
                                className="w-full mt-1 p-2 border border-gray-300 rounded-md"
                                rows="8" 
                                placeholder="Enter your manifesto here..."
                                value={appState.categoryData['manifesto'] || ''}
                                onChange={(e) => setAppState(prev => ({ ...prev, categoryData: { ...prev.categoryData, 'manifesto': e.target.value } }))}
                            />
                        </div>
                                </div>
                            </main>
                        </div>
                    </div>

                    <ExportModal 
                        isOpen={exportModal.isOpen}
                        onClose={() => setExportModal(prev => ({ ...prev, isOpen: false }))}
                        title={exportModal.title}
                        content={exportModal.content}
                        appState={appState}
                        filename="category-design-blueprint"
                    />
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const [appState, setAppState] = useState(() => {
                const savedState = loadAppState();
                return savedState || getInitialState();
            });

            useEffect(() => {
                saveAppState(appState);
            }, [appState]);

            const navigate = (view) => {
                setAppState(prev => ({ ...prev, currentView: view }));
            };

            const renderCurrentView = () => {
                switch (appState.currentView) {
                    case 'segment':
                        return <SegmentFoundationTool appState={appState} setAppState={setAppState} onNavigate={navigate} />;
                    case 'icp':
                        return <ICPDefinitionTool appState={appState} setAppState={setAppState} onNavigate={navigate} />;
                    case 'category':
                        return <CategoryDesignTool appState={appState} setAppState={setAppState} onNavigate={navigate} />;
                    default:
                        return <Home onNavigate={navigate} />;
                }
            };

            return <div>{renderCurrentView()}</div>;
        };

        // Render the app using React 18 createRoot API
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>